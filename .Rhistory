scale_colour_manual(" ", values = c("blue", "red")) +
scale_fill_manual(" ", values = c("blue", "red")) +
scale_y_continuous("HIV incidence rate per 1000 (15-49y)",
labels = (function(l) {round(l*1e3,2)}),breaks = c(0, 0.0010, 0.0050, 0.010, 0.015, 0.020)) +
ggtitle("")
}
# example plot
plot_hiv_inc_from_summary(condom_usage_inc, 2025, 20)
plot_hiv_inc_from_summary <- function(df, reduction_year, pitc_reduction){
df %>%
mutate(intervention_year = as.factor(intervention_year)) %>%
filter(intervention_year == reduction_year, #2099 reduction is used as a baseline / no reduction
test_reduction == pitc_reduction | test_reduction == 0) %>% #pitc_reduction is used to show the percentage reduced - 100% = complete cessation
mutate(test_reduction = factor(test_reduction, levels = c(pitc_reduction, 0))) %>%
ggplot(aes(year, mean, group = test_reduction)) +
geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.25, show.legend = F) +
geom_line(aes(colour = test_reduction), show.legend = F) +
geom_hline(aes(yintercept = 0.001), lty = 2, colour = 1) +
xlab(" ") +
expand_limits(y=0) + theme_classic() + theme(axis.text = element_text(size = 14), axis.title.y = element_text(size = 14), axis.title.x = element_text(size = 14)) +
scale_colour_manual(" ", values = c("blue", "red")) +
scale_fill_manual(" ", values = c("blue", "red")) +
scale_y_continuous("HIV incidence rate per 1000 (15-49y)",
labels = (function(l) {round(l*1e3,2)}),breaks = c(0, 0.0010, 0.0050, 0.010, 0.015, 0.020)) +
ggtitle("")
}
# example plot
plot_hiv_inc_from_summary(condom_usage_inc, 2025, 20)
df %>%
mutate(intervention_year = as.factor(intervention_year)) %>%
filter(intervention_year == reduction_year, #2099 reduction is used as a baseline / no reduction
test_reduction == pitc_reduction | test_reduction == 0) %>% #pitc_reduction is used to show the percentage reduced - 100% = complete cessation
mutate(test_reduction = factor(test_reduction, levels = c(pitc_reduction, 0))) %>%
ggplot(aes(year, mean, group = test_reduction)) +
geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.25, show.legend = F) +
geom_line(aes(colour = test_reduction), show.legend = F) +
geom_hline(aes(yintercept = 0.001), lty = 2, colour = 1) +
xlab(" ") +
expand_limits(y=0) + theme_classic() + theme(axis.text = element_text(size = 14), axis.title.y = element_text(size = 14), axis.title.x = element_text(size = 14)) +
scale_colour_manual(" ", values = c("red", "blue")) +
scale_fill_manual(" ", values = c("red", "blue")) +
scale_y_continuous("HIV incidence rate per 1000 (15-49y)",
labels = (function(l) {round(l*1e3,2)}),breaks = c(0, 0.0010, 0.0050, 0.010, 0.015, 0.020)) +
ggtitle("")
plot_hiv_inc_from_summary <- function(df, reduction_year, pitc_reduction){
df %>%
mutate(intervention_year = as.factor(intervention_year)) %>%
filter(intervention_year == reduction_year, #2099 reduction is used as a baseline / no reduction
test_reduction == pitc_reduction | test_reduction == 0) %>% #pitc_reduction is used to show the percentage reduced - 100% = complete cessation
mutate(test_reduction = factor(test_reduction, levels = c(pitc_reduction, 0))) %>%
ggplot(aes(year, mean, group = test_reduction)) +
geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.25, show.legend = F) +
geom_line(aes(colour = test_reduction), show.legend = F) +
geom_hline(aes(yintercept = 0.001), lty = 2, colour = 1) +
xlab(" ") +
expand_limits(y=0) + theme_classic() + theme(axis.text = element_text(size = 14), axis.title.y = element_text(size = 14), axis.title.x = element_text(size = 14)) +
scale_colour_manual(" ", values = c("red", "blue")) +
scale_fill_manual(" ", values = c("red", "blue")) +
scale_y_continuous("HIV incidence rate per 1000 (15-49y)",
labels = (function(l) {round(l*1e3,2)}),breaks = c(0, 0.0010, 0.0050, 0.010, 0.015, 0.020)) +
ggtitle("")
}
# example plot
plot_hiv_inc_from_summary(condom_usage_inc, 2025, 20)
# example plot
plot_hiv_inc_from_summary(condom_usage_inc, 2025, 40)
# example plot
plot_hiv_inc_from_summary(condom_usage_inc, 2025, 60)
# example plot
plot_hiv_inc_from_summary(condom_usage_inc, 2025, 80)
# example plot
plot_hiv_inc_from_summary(condom_usage_inc, 2025, 100)
# example plot
plot_hiv_inc_from_summary(condom_usage_inc, 2050, 0)
# example plot
plot_hiv_inc_from_summary(condom_usage_inc, 2050, 20)
# example plot
plot_hiv_inc_from_summary(condom_usage_inc, 2050, 20)
# example plot
plot_hiv_inc_from_summary(condom_usage_inc, 2050, 40)
# example plot
plot_hiv_inc_from_summary(condom_usage_inc, 2050, 46)
# example plot
plot_hiv_inc_from_summary(condom_usage_inc, 2050, 60)
# example plot
plot_hiv_inc_from_summary(condom_usage_inc, 2050, 80)
# example plot
plot_hiv_inc_from_summary(condom_usage_inc, 2050, 100)
cumulative_values <- calc_all_cumulatives(intervention_years, 50)
cumulative_values <- cumulative_values %>%
pivot_wider(names_from = scenario, values_from = cumulative) %>%
mutate(percent_change = ((intervention - baseline)/baseline)*100) %>%
mutate(absolute_dif = intervention - baseline) %>%
pivot_longer(-(indicator:test_reduction), names_to = "scenario")
# Plotting cumulative HIV infections over 40 year
cumulative_values %>% filter(
scenario == "absolute_dif", indicator == "NewAdultHIV", intervention_year == 2025) %>%
group_by(indicator, intervention_year, test_reduction, scenario) %>%
summarise(mean = mean(value), upper_CI = quantile(value, probs = 0.975),
lower_CI = quantile(value, probs = 0.025)) %>%
mutate(intervention_year = as.factor(intervention_year)) %>%
ggplot(aes(test_reduction, mean)) +
geom_line(aes(), show.legend = F) +
geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI), alpha = 0.10, show.legend = F) +
xlab("PITC reduction (%)") + scale_y_continuous("Additional HIV infections (millions)", labels = (function(l) {round(l/1e6,1)}))  +
# facet_wrap(nrow = 1, vars(indicator), scales = "free_y",
#            labeller = labeller(indicator = c(
#              "TotalAIDSdeathsadult" = "AIDS-related mortality",
#              "TotalHIVtests" = "Total HIV tests",
#              "NewAdultHIV" = "New HIV infections",
#              "SWsexActs" = "FSW sex acts",
#              "SWsexActsProt" = "Protected FSW sex acts",
#              "TotProtSexActs" = "Total protected sex acts",
#              "TotSexActs" = "Total sex acts"
#            ))) +
expand_limits(y=0) + theme_classic() + ggtitle(" ") + theme(axis.text = element_text(size = 14), axis.title.y = element_text(size = 14), axis.title.x = element_text(size = 14)) +
scale_fill_discrete("Condom usage \nreduction \nstart year") + scale_color_discrete("Condom usage \nreduction \nstart year")
df <- read.csv("results/condom_reduction_2030.csv") # this is read again so that test_reduction can be used as an integer
df$test_reduction <- 100 - as.integer(df$test_reduction)
cumulative_values <- calc_all_cumulatives(intervention_years, 50)
cumulative_values <- cumulative_values %>%
pivot_wider(names_from = scenario, values_from = cumulative) %>%
mutate(percent_change = ((intervention - baseline)/baseline)*100) %>%
mutate(absolute_dif = intervention - baseline) %>%
pivot_longer(-(indicator:test_reduction), names_to = "scenario")
# Plotting cumulative HIV infections over 40 year
cumulative_values %>% filter(
scenario == "absolute_dif", indicator == "NewAdultHIV", intervention_year == 2025) %>%
group_by(indicator, intervention_year, test_reduction, scenario) %>%
summarise(mean = mean(value), upper_CI = quantile(value, probs = 0.975),
lower_CI = quantile(value, probs = 0.025)) %>%
mutate(intervention_year = as.factor(intervention_year)) %>%
ggplot(aes(test_reduction, mean)) +
geom_line(aes(), show.legend = F) +
geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI), alpha = 0.10, show.legend = F) +
xlab("PITC reduction (%)") + scale_y_continuous("Additional HIV infections (millions)", labels = (function(l) {round(l/1e6,1)}))  +
# facet_wrap(nrow = 1, vars(indicator), scales = "free_y",
#            labeller = labeller(indicator = c(
#              "TotalAIDSdeathsadult" = "AIDS-related mortality",
#              "TotalHIVtests" = "Total HIV tests",
#              "NewAdultHIV" = "New HIV infections",
#              "SWsexActs" = "FSW sex acts",
#              "SWsexActsProt" = "Protected FSW sex acts",
#              "TotProtSexActs" = "Total protected sex acts",
#              "TotSexActs" = "Total sex acts"
#            ))) +
expand_limits(y=0) + theme_classic() + ggtitle(" ") + theme(axis.text = element_text(size = 14), axis.title.y = element_text(size = 14), axis.title.x = element_text(size = 14)) +
scale_fill_discrete("Condom usage \nreduction \nstart year") + scale_color_discrete("Condom usage \nreduction \nstart year")
# Plotting cumulative HIV infections over 40 year
cumulative_values %>% filter(
scenario == "absolute_dif", indicator == "NewAdultHIV", intervention_year == 2050) %>%
group_by(indicator, intervention_year, test_reduction, scenario) %>%
summarise(mean = mean(value), upper_CI = quantile(value, probs = 0.975),
lower_CI = quantile(value, probs = 0.025)) %>%
mutate(intervention_year = as.factor(intervention_year)) %>%
ggplot(aes(test_reduction, mean)) +
geom_line(aes(), show.legend = F) +
geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI), alpha = 0.10, show.legend = F) +
xlab("PITC reduction (%)") + scale_y_continuous("Additional HIV infections (millions)", labels = (function(l) {round(l/1e6,1)}))  +
# facet_wrap(nrow = 1, vars(indicator), scales = "free_y",
#            labeller = labeller(indicator = c(
#              "TotalAIDSdeathsadult" = "AIDS-related mortality",
#              "TotalHIVtests" = "Total HIV tests",
#              "NewAdultHIV" = "New HIV infections",
#              "SWsexActs" = "FSW sex acts",
#              "SWsexActsProt" = "Protected FSW sex acts",
#              "TotProtSexActs" = "Total protected sex acts",
#              "TotSexActs" = "Total sex acts"
#            ))) +
expand_limits(y=0) + theme_classic() + ggtitle(" ") + theme(axis.text = element_text(size = 14), axis.title.y = element_text(size = 14), axis.title.x = element_text(size = 14)) +
scale_fill_discrete("Condom usage \nreduction \nstart year") + scale_color_discrete("Condom usage \nreduction \nstart year")
View(calc_all_cumulatives)
output_names <- c("MarriedM17to49", "MarriedF17to49")
dir.create("results", FALSE, TRUE)
# model input parameters
intervention_years <- c(2099) # establish years PITC changes occur
base_rate_reduction = 1 # proportion of PITC base rate
sliding_scale_reduction = 100 # 1000x percentage of sliding scale reduction
fsw_condom_usage_decrease = 0 # this is amount that fsw condom usage decreases by each year
st_condom_usage_decrease = 0 # this is amount that st condom usage decreases by each year
lt_condom_usage_decrease = 0 # this is amount that the condom usage decreases by each year
fsw_condom_usage_init = 0 # this is the value of the first year's fsw decrease
st_condom_usage_init = 0 # this is the value of the first year's st decrease
lt_condom_usage_init = 0 # this is the value of the first year's lt decrease
condom_incr_years = NA # these are the year for which condom usage decreases
condom_maintenance_years = NA # maintains condom usage at these values after reduction
art_interrupt_incr = NA # this is amount that the art interruption rate decreases by each year
art_interrupt_init = NA # this is the value of the first year's art interruption rate decrease
art_incr_years = NA # these are the year for which art interruption rate decreases
# for loop that changes testing rate at different years and saves outputs
for (percentage_value in sliding_scale_reduction){
percentage_value <- 100
one_scenario <- run_thembisa_scenario_prev_year(intervention_year = intervention_year,
fsw_condom_usage_decrease = fsw_condom_usage_decrease,
st_condom_usage_decrease = st_condom_usage_decrease,
lt_condom_usage_decrease = lt_condom_usage_decrease,
condom_incr_years = condom_incr_years,
condom_maintenance_years = condom_maintenance_years,
art_interrupt_incr = art_interrupt_incr,
art_incr_years = art_incr_years,
output_names = output_names,
base_rate_reduction = base_rate_reduction)
write.csv(one_scenario, paste0("results/scenario_", intervention_year, "_", percentage_value,".csv"),
row.names = FALSE)
}
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(here)
source(here("scripts/modify_rollout.R"))
source(here("R/read_and_run.R"))
output_names <- c("MarriedM17to49", "MarriedF17to49")
dir.create("results", FALSE, TRUE)
# model input parameters
intervention_years <- c(2099) # establish years PITC changes occur
base_rate_reduction = 1 # proportion of PITC base rate
sliding_scale_reduction = 100 # 1000x percentage of sliding scale reduction
fsw_condom_usage_decrease = 0 # this is amount that fsw condom usage decreases by each year
st_condom_usage_decrease = 0 # this is amount that st condom usage decreases by each year
lt_condom_usage_decrease = 0 # this is amount that the condom usage decreases by each year
fsw_condom_usage_init = 0 # this is the value of the first year's fsw decrease
st_condom_usage_init = 0 # this is the value of the first year's st decrease
lt_condom_usage_init = 0 # this is the value of the first year's lt decrease
condom_incr_years = NA # these are the year for which condom usage decreases
condom_maintenance_years = NA # maintains condom usage at these values after reduction
art_interrupt_incr = NA # this is amount that the art interruption rate decreases by each year
art_interrupt_init = NA # this is the value of the first year's art interruption rate decrease
art_incr_years = NA # these are the year for which art interruption rate decreases
# run baseline model
baseline <- run_thembisa_scenario_prev_year(intervention_year = NA,
fsw_condom_usage_decrease <- NA,
st_condom_usage_decrease <- NA,
lt_condom_usage_decrease <- NA,
condom_incr_years <- NA,
condom_maintenance_years <- NA,
art_interrupt_incr = NA,
art_incr_years = art_incr_years,
output_names = output_names,
base_rate_reduction = base_rate_reduction)
# save baseline outputs
write.csv(baseline, "results/baseline.csv", row.names = FALSE)
# for loop that changes testing rate at different years and saves outputs
for (percentage_value in sliding_scale_reduction){
percentage_value <- 100
one_scenario <- run_thembisa_scenario_prev_year(intervention_year = intervention_year,
fsw_condom_usage_decrease = fsw_condom_usage_decrease,
st_condom_usage_decrease = st_condom_usage_decrease,
lt_condom_usage_decrease = lt_condom_usage_decrease,
condom_incr_years = condom_incr_years,
condom_maintenance_years = condom_maintenance_years,
art_interrupt_incr = art_interrupt_incr,
art_incr_years = art_incr_years,
output_names = output_names,
base_rate_reduction = base_rate_reduction)
write.csv(one_scenario, paste0("results/scenario_", intervention_year, "_", percentage_value,".csv"),
row.names = FALSE)
}
# make a new data frame joining all results
df <- read_thembisa_results_sliding_scale(intervention_years, sliding_scale_reduction)
df <- df %>%
pivot_wider(names_from = indicator) %>%
mutate(TotalAIDSdeathsadult = AIDSdeathsAdultF + AIDSdeathsAdultM) %>%
pivot_longer(-(intervention_year:scenario), names_to = "indicator")
# make a new data frame joining all results
df <- read_thembisa_results_sliding_scale(intervention_years, sliding_scale_reduction)
df %>% filter(
scenario == "baseline",
indicator == "MarriedM17to49",
year >= 1985,
year <= 2020) %>%
group_by(year, intervention_year, test_reduction) %>%
summarise(mean = mean(value), upper_CI = quantile(value, probs = 0.975),
lower_CI = quantile(value, probs = 0.025)) %>%
mutate(intervention_year = as.factor(intervention_year)) %>%
ggplot(aes(year, mean, group = intervention_year)) +
geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI), alpha = 0.10, show.legend = F) +
geom_line(aes()) +
xlab("Years") +
ylab("Number of married men (17-49y)")
df %>% filter(
scenario == "baseline",
indicator == "MarriedM17to49",
year >= 1985,
year <= 2020)
View(df)
View(baseline)
baseline %>% filter(
indicator == "MarriedM17to49",
year >= 1985,
year <= 2020) %>%
group_by(year) %>%
summarise(mean = mean(value), upper_CI = quantile(value, probs = 0.975),
lower_CI = quantile(value, probs = 0.025)) %>%
ggplot(aes(year, mean)) +
geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI), alpha = 0.10, show.legend = F) +
geom_line(aes()) +
xlab("Years") +
ylab("Number of married men (17-49y)")
baseline %>% filter(
indicator == "MarriedM17to49",
year >= 1985,
year <= 2100) %>%
group_by(year) %>%
summarise(mean = mean(value), upper_CI = quantile(value, probs = 0.975),
lower_CI = quantile(value, probs = 0.025)) %>%
ggplot(aes(year, mean)) +
geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI), alpha = 0.10, show.legend = F) +
geom_line(aes()) +
xlab("Years") +
ylab("Number of married men (17-49y)")
baseline %>% filter(
indicator == "MarriedM17to49",
year >= 1985,
year <= 2100) %>%
group_by(year) %>%
summarise(mean = mean(value), upper_CI = quantile(value, probs = 0.975),
lower_CI = quantile(value, probs = 0.025)) %>%
ggplot(aes(year, mean)) +
geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI), alpha = 0.10, show.legend = F) +
geom_line(aes()) +
xlab("Years") +
ylab("Number of married men (17-49y)") + theme_classic()
baseline %>% filter(
indicator == "MarriedM17to49",
year >= 1985,
year <= 2100) %>%
group_by(year) %>%
summarise(mean = mean(value), upper_CI = quantile(value, probs = 0.975),
lower_CI = quantile(value, probs = 0.025)) %>%
ggplot(aes(year, mean)) +
geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI), alpha = 0.10, show.legend = F) +
geom_line(aes()) +
xlab("Years") +
ylab("Number of married men (17-49y)") + theme_classic() + scale_y_continuous(labels = (function(l) {round(l*1e3,2)}))
baseline %>% filter(
indicator == "MarriedM17to49",
year >= 1985,
year <= 2100) %>%
group_by(year) %>%
summarise(mean = mean(value), upper_CI = quantile(value, probs = 0.975),
lower_CI = quantile(value, probs = 0.025)) %>%
ggplot(aes(year, mean)) +
geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI), alpha = 0.10, show.legend = F) +
geom_line(aes()) +
xlab("Years") +
ylab("Number of married men (17-49y)") + theme_classic() + scale_y_continuous(labels = (function(l) {round(l*1e6,2)}))
baseline %>% filter(
indicator == "MarriedM17to49",
year >= 1985,
year <= 2100) %>%
group_by(year) %>%
summarise(mean = mean(value), upper_CI = quantile(value, probs = 0.975),
lower_CI = quantile(value, probs = 0.025)) %>%
ggplot(aes(year, mean)) +
geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI), alpha = 0.10, show.legend = F) +
geom_line(aes()) +
xlab("Years") +
ylab("Number of married men (17-49y)") + theme_classic() + scale_y_continuous(labels = (function(l) {round(l/1e6,2)}))
baseline %>% filter(
indicator == "MarriedM17to49",
year >= 1985,
year <= 2100) %>%
group_by(year) %>%
summarise(mean = mean(value), upper_CI = quantile(value, probs = 0.975),
lower_CI = quantile(value, probs = 0.025)) %>%
ggplot(aes(year, mean)) +
geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI), alpha = 0.10, show.legend = F) +
geom_line(aes()) +
xlab("Years") +
ylab("Number of married men (millions)") + theme_classic() + scale_y_continuous(labels = (function(l) {round(l/1e6,2)}))
baseline %>% filter(
indicator == "MarriedM17to49",
year >= 1985,
year <= 2100) %>%
group_by(year) %>%
summarise(mean = mean(value), upper_CI = quantile(value, probs = 0.975),
lower_CI = quantile(value, probs = 0.025)) %>%
ggplot(aes(year, mean)) +
geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI), alpha = 0.10, show.legend = F) +
geom_line(aes()) +
xlab("Years") +
ylab("Number of married men (millions)") + theme_classic() + scale_y_continuous(labels = (function(l) {round(l/1e6,2)}))
baseline %>% filter(
indicator == "MarriedF17to49",
year >= 1985,
year <= 2100) %>%
group_by(year) %>%
summarise(mean = mean(value), upper_CI = quantile(value, probs = 0.975),
lower_CI = quantile(value, probs = 0.025)) %>%
ggplot(aes(year, mean)) +
geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI), alpha = 0.10, show.legend = F) +
geom_line(aes()) +
xlab("Years") +
ylab("Number of married men (millions)") + theme_classic() + scale_y_continuous(labels = (function(l) {round(l/1e6,2)}))
# install.packages("drat") # installer for adding "mrc-ide"
# drat:::add("mrc-ide")
# install.packages("didehpc")
library(didehpc) # load the didehpc support package
# to edit the .rprofile load the following package
library(usethis)
config <- didehpc::didehpc_config(credentials = list(username = "spr21", password = "Wednesday123!"))
config
install.packages("drat") # installer for adding "mrc-ide"
drat:::add("mrc-ide")
install.packages("didehpc")
library(didehpc) # load the didehpc support package
# to edit the .rprofile load the following package
library(usethis)
config <- didehpc::didehpc_config(credentials = list(username = "spr21", password = "Wednesday123!"))
config
packages <- "ggplot2"
packages <- "ggplot2"
library(ggplot2)
library("dplyr")
library("rstan")
ctx <- context::context_save("contexts", packages = packages)
obj <- didehpc::queue_didehpc(context = ctx)
obj <- didehpc::queue_didehpc(context = ctx, config = config)
install.packages("pkgdepends")
obj <- didehpc::queue_didehpc(context = ctx, config = config)
obj$install_packages("ggplot2")
t <- obj$enqueue(packageVersion("ggplot2"))
t$wait(10)
ctx <- context::context_save("contexts", packages = packages, sources = "mysources.R")
obj <- didehpc::queue_didehpc(context = ctx, config = config)
obj$install_packages("ggplot2")
t <- obj$enqueue(packageVersion("ggplot2"))
t$wait(10)
x <- obj$enqueue(random_walk(1, 10))
x$wait(60)
ctx <- context::context_save("contexts", packages = packages, sources = "mysources.R")
library(here)
## setwd(here("THEMBISAv18"))
system("g++ -std=c++14 THEMBISAv18/THEMBISA.cpp THEMBISAv18/StatFunctions.cpp THEMBISAv18/mersenne.cpp -o THEMBISAv18/thembisa -O2")
system("./THEMBISAv18/thembisa")
setwd(here())
config <- didehpc::didehpc_config(credentials = list(username = "spr21", password = "Wednesday123!"))
config
## setwd(here("THEMBISAv18"))
system("g++ -std=c++14 THEMBISAv18/THEMBISA.cpp THEMBISAv18/StatFunctions.cpp THEMBISAv18/mersenne.cpp -o THEMBISAv18/thembisa -O2")
system("./THEMBISAv18/thembisa")
setwd(here())
getwd()
# homedir <- "/Volumes/jwe08"
workdir <- "Q:/Git/HIV_EndGame_SA"
dir.create(workdir)
# dir.create(workdir)
# file.copy(".", workdir, recursive = TRUE, overwrite = TRUE)
mrc_config <- didehpc::didehpc_config(credentials = "spr21", workdir=workdir, cluster="mrc")
ctx <- context::context_save(path = workdir, packages = c("dplyr", "here", "ggplot2", "gridExtra"), sources = "R/read_and_run.R")
mrcq <- didehpc::queue_didehpc(ctx, config=mrc_config)
s <- mrcq$enqueue(sessionInfo())
s
h <- mrcq$enqueue(here::here())
h
s
h
t <- mrcq$enqueue(run_thembisa())
t
d <- mrcq$enqueue(system("g++ -std=c++14 THEMBISA.cpp StatFunctions.cpp mersenne.cpp -o thembisa -O2"))
d
f <- mrcq$enqueue(print(fit_tmb))
f
f <- mrcq$enqueue(print(fit_tmb))
d$wait(10)
s
s$wait(10)
h$wait(10)
t$wait(10)
d$wait(10)
t <- mrcq$enqueue(run_thembisa())
t$wait(10)
t$wait(10)
t$wait(10)
run_thembisa()
library(here)
library(dplyr)
library(ggplot2)
library(gridExtra)
run_thembisa()
TotBirths_local <- read_thembisa_output("TotBirths")
library(here)
library(dplyr)
library(ggplot2)
library(gridExtra)
TotBirths_local <- read_thembisa_output("TotBirths")
library(tidyr)
TotBirths_local <- read_thembisa_output("TotBirths")
View(TotBirths_local)
getwd()
read_thembisa_output_cluster <- function(output_name){
output_txt <- paste(output_name, "txt", sep = ".")
output_txt <- paste("cluster_outputs", output_txt, sep = "/")
output <- read.delim(output_txt, header=FALSE, row.names = 1)
output <- output %>% select(-V2)
t_output <- t(output)
output_new <- as.data.frame(as_tibble(t_output))
names(output_new) <- seq_along(output_new)
output_new$year <- seq(1985, 2100)
pivot_longer(output_new, -year, names_to = "parameter_set")
}
TotBirths_cluster <- read_thembisa_output_cluster("TotBirths")
TotBirths_join <- inner_join(TotBirths_local, TotBirths_cluster, by = c("year", "parameter_set"), suffix = c("local", "cluster"))
View(TotBirths_join)
TotBirths_join$equal <- TotBirths_join$valuelocal == TotBirths_join$valuecluster
sum(TotBirths_join$equal)
DiagnosedHIV_M_local <- read_thembisa_output("DiagnosedHIV_M")
DiagnosedHIV_M_cluster <- read_thembisa_output_cluster("DiagnosedHIV_M")
DiagnosedHIV_M_join <- inner_join(DiagnosedHIV_M_local, DiagnosedHIV_M_cluster, by = c("year", "parameter_set"), suffix = c("local", "cluster"))
DiagnosedHIV_M_join$equal <- DiagnosedHIV_M_join$valuelocal == DiagnosedHIV_M_join$valuecluster
sum(DiagnosedHIV_M_join$equal)
