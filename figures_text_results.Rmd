---
title: "Figures and text results"
output: html_document
date: "2023-05-22"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(dplyr)
library(tidyr)
library(readr)
library(ggplot2)
library(gridExtra)
library(metR)
library(ggpubr)
library(ggfx)

```
# Figures 
## Figure 1

load data
```{r fig1 data, echo = TRUE, include=FALSE,eval = TRUE}
setwd("/Users/stefan/Documents/HIV_EndGame_SA/")
test_reduction_only <- read_csv("results/test_reduction_only_summary.csv")
```

### Figure 1a

Incidence over time

```{r fig1a, eval=TRUE}
fig1a <- test_reduction_only %>% mutate(test_reduction = as.factor(test_reduction)) %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "HIVinc15to49",
         year > 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100)) %>% 
  ggplot(aes(year, mean, group = test_reduction, fill = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_hline(aes(yintercept = 0.001), lty = "dotted") +
  scale_x_continuous("", expand = c(0, 0)) +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  scale_y_continuous("HIV incidence", labels =(function(l) {round(l*1e3,1)}), breaks = c(0, 0.001, 0.002, 0.003, 0.004, 0.005, 0.006, 0.007),expand = c(0, 0)) +
  scale_fill_discrete("General\nHTC\nreduction", labels = c("None", "25%", "50%", "75%", "100%"),) + 
  scale_color_discrete("General\nHTC\nreduction", labels = c("None", "25%", "50%", "75%", "100%")) + 
  ggtitle("HIV incidence \n(per 1000; 15-49 years)") 
```

### Figure 1b

Prevalence over time

```{r fig1b, echo=FALSE}
fig1b <- test_reduction_only %>% mutate(test_reduction = as.factor(test_reduction)) %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "Prev15to49",
         year > 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100)) %>% 
  ggplot(aes(year, mean, group = test_reduction, fill = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  scale_x_continuous("") +
  expand_limits(y=c(0, 0.2), x = 2020) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  scale_y_continuous("HIV prevalence (%)", labels =(function(l) {round(l*1e2,1)})) +
  scale_fill_discrete("General\nHTC\nreduction", labels = c("None", "25%", "50%", "75%", "100%"),) + 
  scale_color_discrete("General\nHTC\nreduction", labels = c("None", "25%", "50%", "75%", "100%")) + 
  ggtitle("HIV prevalence\n(15-49 years)")
```

### Figure 1c

ART coverage over time

```{r fig1c, echo=FALSE}
fig1c <- test_reduction_only %>% mutate(test_reduction = as.factor(test_reduction)) %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "ARTcoverageAdult",
         year > 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100)) %>% 
  ggplot(aes(year, mean, group = test_reduction, fill = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  xlab("") +
  theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  scale_y_continuous("ART coverage (%) ", labels =(function(l) {round(l*1e2,1)}), limits = c(0,1)) +
  scale_fill_discrete("General\nHTC\nreduction",labels = c("None", "25%", "50%", "75%", "100%"),) + 
  scale_color_discrete("General\nHTC\nreduction",labels = c("None", "25%", "50%", "75%", "100%"))+ 
  ggtitle("ART coverage\n(15+ years)")
```

### Figure 1d

Tests per 100 adults

```{r fig1d, echo=FALSE}
fig1d <- test_reduction_only %>% mutate(test_reduction = as.factor(test_reduction)) %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "TestsPerAdult",
         year > 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100)) %>% 
  ggplot(aes(year, mean, group = test_reduction, fill = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  xlab("") +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  scale_y_continuous("HIV tests per 100 adults", labels =(function(l) {round(l*1e2,1)})) +
  scale_fill_discrete("General\nHTC\nreduction",labels = c("None", "25%", "50%", "75%", "100%"),) + 
  scale_color_discrete("General\nHTC\nreduction",labels = c("None", "25%", "50%", "75%", "100%")) + 
  ggtitle("HIV tests per 100 adults\n(15+ years)")

```

### Combined figure 1

``` {r fig1, echo = FALSE}

fig1 <- ggarrange(fig1a, fig1b, fig1c, fig1d, nrow = 2, ncol = 2, common.legend = TRUE, legend = "right", labels = "AUTO", font.label = list(size = 14))
ggsave(filename = "figures/fig1.pdf", plot = fig1, device = "pdf", width = 20, units = "cm")
ggsave(filename = "figures/fig1.png", plot = fig1, device = "png", width = 20, units = "cm")
```

## Figure 2

Impact of timing of testing reductions on long-term incidence and epi costs

load data
``` {r fig2 data, include = FALSE}
test_reduction_cumulative <- read_csv("results/test_reduction_only_cumulative.csv")

```

### Figure 2a

Incidence in 2100 when testing reduced at different times 

```{r fig2a, include = FALSE}

fig2a <- test_reduction_only %>% 
  mutate(pitc_reduction_year = as.factor(pitc_reduction_year), 
         test_reduction = as.factor(test_reduction)) %>% 
  filter(test_reduction %in% c(0, 25, 50, 75, 100),
         year == 2100, 
         scenario == "intervention", 
         indicator == "HIVinc15to49") %>% 
  ggplot(aes(test_reduction, mean, group = pitc_reduction_year, fill = pitc_reduction_year)) + 
  geom_col(aes(color = pitc_reduction_year), position =  position_dodge(width = 0.85), width = 0.85, alpha = 0.75) +
  geom_errorbar(aes(ymin = lower_CI, ymax = upper_CI), show.legend = F, position =  position_dodge(width = 0.85), alpha = 0.5) +
  xlab("General HTC reduction (%)") + 
  theme_classic() + 
  scale_y_continuous("", labels = (function(l) {round(l*1e3,1)})) + 
  expand_limits(y = 0) +
  geom_hline(aes(yintercept = 0.001), lty = "dotted") +
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 11.5, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11),
        plot.margin = margin(0,0,0,0)) +
  scale_color_brewer("Year HTC\nreduced",palette = "Dark2",direction = -1) +
  scale_fill_brewer("Year HTC\nreduced", palette = "Dark2",direction = -1) +
  ggtitle("HIV incidence in 2100\n(per 1000; 15-49 years)")
fig2a
```

### Figure 2b 

Additional HIV infections when testing reduced at different times

``` {r fig2b, echo = FALSE}

fig2b <- test_reduction_cumulative %>% 
  filter(indicator == "NewAdultHIV", 
         scenario == "absolute_dif", 
         test_reduction %in% c(0, 25, 50, 75, 100)) %>% 
  mutate(pitc_reduction_year = as.factor(pitc_reduction_year), 
         test_reduction = as.factor(test_reduction)) %>% 
  ggplot(aes(test_reduction, mean, group = pitc_reduction_year, fill = pitc_reduction_year)) +
  geom_col(aes(color = pitc_reduction_year), position =  position_dodge(width = 0.85), width = 0.85, alpha = 0.75) +
  geom_errorbar(aes(ymin = lower_CI, ymax = upper_CI), show.legend = F, position =  position_dodge(width = 0.85), alpha = 0.5) +
  scale_y_continuous("", 
                     labels = (function(l) {round(l/1e6,1)})) +
  scale_color_brewer("Year HTC\nreduced",palette = "Dark2",direction = -1) +
  scale_fill_brewer("Year HTC\nreduced", palette = "Dark2",direction = -1) +
  xlab("General HTC reduction (%)") + theme_classic() +
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 11.5, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11),
        plot.margin = margin(0,0,0,0)) +
  ggtitle("Additional HIV infections\n2025-2075 (millions)")
fig2b
```

### Figure 2c 

Additional AIDS-related deaths when testing reduced at different times

``` {r fig2c, echo = FALSE}

fig2c <- test_reduction_cumulative %>% 
  filter(indicator == "TotalAIDSdeathsadult", 
         scenario == "absolute_dif", 
         test_reduction %in% c(0, 25, 50, 75, 100)) %>% 
  mutate(pitc_reduction_year = as.factor(pitc_reduction_year), 
         test_reduction = as.factor(test_reduction)) %>% 
  ggplot(aes(test_reduction, mean, group = pitc_reduction_year, fill = pitc_reduction_year)) +
  geom_col(aes(color = pitc_reduction_year), position =  position_dodge(width = 0.85), width = 0.85, alpha = 0.75) +
  geom_errorbar(aes(ymin = lower_CI, ymax = upper_CI), show.legend = F, position =  position_dodge(width = 0.85), alpha = 0.5) +
  scale_y_continuous("", labels = (function(l) {round(l/1e6,1)})) +
  scale_color_brewer("Year HTC\nreduced",palette = "Dark2",direction = -1) +
  scale_fill_brewer("Year HTC\nreduced", palette = "Dark2",direction = -1) +
  xlab("General HTC reduction (%)") + theme_classic() +
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 11.5, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11),
        plot.margin = margin(0,0,0,0)) +
  ggtitle("Additional AIDS deaths\n2025-2075 (millions)")
fig2c
```

### Combined figure 2

``` {r fig2, echo = FALSE}

fig2 <- ggarrange(fig2a, fig2b, fig2c, nrow = 1, ncol = 3, common.legend = TRUE, legend = "right", labels = "AUTO", 
                  font.label = list(size = 14), align = "v")
fig2
ggsave(filename = "figures/fig2.pdf", plot = fig2, device = "pdf", width = 20, height = 8, units = "cm")
ggsave(filename = "figures/fig2.png", plot = fig2, device = "png", width = 20, height = 8, units = "cm")
```

## Figure 3

Effect of altered ART coverage on impact of testing reductions

load data of decrease and increase scenarios and combine

``` {r combined art change summary, echo = FALSE}
decrease_art_retention_summary_2025 <- read_csv("results/art_deterioration_summary.csv")
decrease_art_retention_summary_2030 <- read_csv("results/art_deterioration_2030_summary.csv")
decrease_art_retention_summary_2035 <- read_csv("results/art_deterioration_2035_summary.csv")
decrease_art_retention_summary_2040 <- read_csv("results/art_deterioration_2040_summary.csv")
decrease_art_retention_summary_2045 <- read_csv("results/art_deterioration_2045_summary.csv")
decrease_art_retention_summary_2050 <- read_csv("results/art_deterioration_2050_summary.csv")

decrease_art_retention_summary <- bind_rows(decrease_art_retention_summary_2025, decrease_art_retention_summary_2030, decrease_art_retention_summary_2035, decrease_art_retention_summary_2040, decrease_art_retention_summary_2045, decrease_art_retention_summary_2050)

increase_art_retention_summary_2025 <- read_csv("results/art_improvement_summary.csv")
increase_art_retention_summary_2030 <- read_csv("results/art_improvement_2030_summary.csv")
increase_art_retention_summary_2035 <- read_csv("results/art_improvement_2035_summary.csv")
increase_art_retention_summary_2040 <- read_csv("results/art_improvement_2040_summary.csv")
increase_art_retention_summary_2045 <- read_csv("results/art_improvement_2045_summary.csv")
increase_art_retention_summary_2050 <- read_csv("results/art_improvement_2050_summary.csv")

increase_art_retention_summary <- bind_rows(increase_art_retention_summary_2025, increase_art_retention_summary_2030, increase_art_retention_summary_2035, increase_art_retention_summary_2040, increase_art_retention_summary_2045, increase_art_retention_summary_2050)

art_change_summary <- bind_rows(increase_art_retention_summary, decrease_art_retention_summary)
art_change_summary <- art_change_summary %>% mutate(art_int_rate = case_when(
  future_variability == "art_deterioration" ~ (0.1486*((1+(as.numeric(future_value)))**10)),
  future_variability == "art_improvement" ~ (0.1486*((1-(as.numeric(future_value)))**10))))
art_change_summary <- art_change_summary %>% mutate(art_ret_rate = 1 - art_int_rate)
write_csv(art_change_summary,"results/art_change_summary.csv")

decrease_art_retention_cumulative_2025 <- read_csv("results/art_deterioration_cumulative.csv")
decrease_art_retention_cumulative_2030 <- read_csv("results/art_deterioration_2030_cumulative.csv")
decrease_art_retention_cumulative_2035 <- read_csv("results/art_deterioration_2035_cumulative.csv")
decrease_art_retention_cumulative_2040 <- read_csv("results/art_deterioration_2040_cumulative.csv")
decrease_art_retention_cumulative_2045 <- read_csv("results/art_deterioration_2045_cumulative.csv")
decrease_art_retention_cumulative_2050 <- read_csv("results/art_deterioration_2050_cumulative.csv")

increase_art_retention_cumulative_2025 <- read_csv("results/art_improvement_cumulative.csv")
increase_art_retention_cumulative_2030 <- read_csv("results/art_improvement_2030_cumulative.csv")
increase_art_retention_cumulative_2035 <- read_csv("results/art_improvement_2035_cumulative.csv")
increase_art_retention_cumulative_2040 <- read_csv("results/art_improvement_2040_cumulative.csv")
increase_art_retention_cumulative_2045 <- read_csv("results/art_improvement_2045_cumulative.csv")
increase_art_retention_cumulative_2050 <- read_csv("results/art_improvement_2050_cumulative.csv")

cumulative_art_change <- bind_rows(increase_art_retention_cumulative_2025, increase_art_retention_cumulative_2030, increase_art_retention_cumulative_2035, increase_art_retention_cumulative_2040, increase_art_retention_cumulative_2045, increase_art_retention_cumulative_2050, decrease_art_retention_cumulative_2025, decrease_art_retention_cumulative_2030, decrease_art_retention_cumulative_2035, decrease_art_retention_cumulative_2040, decrease_art_retention_cumulative_2045, decrease_art_retention_cumulative_2050)

cumulative_art_change <- cumulative_art_change %>% 
  mutate(art_int_rate = case_when(
  future_variability == "art_deterioration" ~ (0.1486*((1+(as.numeric(future_value)))**10)),
  future_variability == "art_improvement" ~ (0.1486*((1-(as.numeric(future_value)))**10)))) %>% 
  mutate(art_ret_rate = 1 - art_int_rate)

write_csv(cumulative_art_change, "results/art_change_cumulative.csv")
```

Summary: Add column for ART coverage in 2035
``` {r add columns art summary, echo = FALSE}
art_coverage_range <- art_change_summary %>% filter(indicator == "ARTcoverageAdult", 
                                                    test_reduction == 0, pitc_reduction_year == 2025,
                                                    year == 2035, scenario == "intervention") %>% select(mean)
art_coverage_labels <- round(art_coverage_range$mean,3)
unique_future_values_art <- unique(art_change_summary$future_value)
art_change_summary <- art_change_summary %>% mutate(art_coverage_2035 = case_when(future_value == unique_future_values_art[1] & future_variability == "art_improvement" ~ art_coverage_labels[1],
                                                                                  future_value == unique_future_values_art[2]  & future_variability == "art_improvement" ~ art_coverage_labels[2],
                                                                                  future_value == unique_future_values_art[3]  & future_variability == "art_improvement" ~ art_coverage_labels[3],
                                                                                  future_value == unique_future_values_art[4]  & future_variability == "art_improvement" ~ art_coverage_labels[4],
                                                                                  future_value == unique_future_values_art[5]  & future_variability == "art_improvement" ~ art_coverage_labels[5],
                                                                                  future_value == unique_future_values_art[6]  & future_variability == "art_improvement" ~ art_coverage_labels[6],
                                                                                  future_value == unique_future_values_art[7]  & future_variability == "art_improvement" ~ art_coverage_labels[7],
                                                                                  future_value == unique_future_values_art[8]  & future_variability == "art_improvement" ~ art_coverage_labels[8],
                                                                                  future_value == unique_future_values_art[9]  & future_variability == "art_improvement" ~ art_coverage_labels[9],
                                                                                  future_value == unique_future_values_art[10]  & future_variability == "art_improvement" ~ art_coverage_labels[10],
                                                                                  future_value == unique_future_values_art[11]  & future_variability == "art_improvement" ~ art_coverage_labels[11],
                                                                                  future_value == unique_future_values_art[12]  & future_variability == "art_improvement" ~ art_coverage_labels[12],
                                                                                  future_value == unique_future_values_art[13]  & future_variability == "art_improvement" ~ art_coverage_labels[13],
                                                                                  future_value == unique_future_values_art[14]  & future_variability == "art_improvement" ~ art_coverage_labels[14],
                                                                                  future_value == unique_future_values_art[15]  & future_variability == "art_improvement" ~ art_coverage_labels[15],
                                                                                  future_value == unique_future_values_art[16]  & future_variability == "art_improvement" ~ art_coverage_labels[16],
                                                                                  future_value == unique_future_values_art[17]  & future_variability == "art_improvement" ~ art_coverage_labels[17],
                                                                                  future_value == unique_future_values_art[18]  & future_variability == "art_improvement" ~ art_coverage_labels[18],
                                                                                  future_value == unique_future_values_art[19]  & future_variability == "art_improvement" ~ art_coverage_labels[19],
                                                                                  future_value == unique_future_values_art[20]  & future_variability == "art_improvement" ~ art_coverage_labels[20],
                                                                                  future_value == unique_future_values_art[21]  & future_variability == "art_improvement" ~ art_coverage_labels[21],
                                                                                  future_value == unique_future_values_art[22]  & future_variability == "art_improvement" ~ art_coverage_labels[22],
                                                                                  future_value == unique_future_values_art[23]  & future_variability == "art_improvement" ~ art_coverage_labels[23],
                                                                                  future_value == unique_future_values_art[24]  & future_variability == "art_improvement" ~ art_coverage_labels[24],
                                                                                  future_value == unique_future_values_art[25]  & future_variability == "art_improvement" ~ art_coverage_labels[25],
                                                                                  future_value == unique_future_values_art[26]  & future_variability == "art_improvement" ~ art_coverage_labels[26],
                                                                                  future_value == unique_future_values_art[27]  & future_variability == "art_improvement" ~ art_coverage_labels[27],
                                                                                  future_value == unique_future_values_art[28]  & future_variability == "art_improvement" ~ art_coverage_labels[28],
                                                                                  future_value == unique_future_values_art[29]  & future_variability == "art_improvement" ~ art_coverage_labels[29],
                                                                                  future_value == unique_future_values_art[1] & future_variability == "art_deterioration" ~ art_coverage_labels[30],
                                                                                  future_value == unique_future_values_art[2]  & future_variability == "art_deterioration" ~ art_coverage_labels[31],
                                                                                  future_value == unique_future_values_art[3]  & future_variability == "art_deterioration" ~ art_coverage_labels[32],
                                                                                  future_value == unique_future_values_art[4]  & future_variability == "art_deterioration" ~ art_coverage_labels[33],
                                                                                  future_value == unique_future_values_art[5]  & future_variability == "art_deterioration" ~ art_coverage_labels[34],
                                                                                  future_value == unique_future_values_art[6]  & future_variability == "art_deterioration" ~ art_coverage_labels[35],
                                                                                  future_value == unique_future_values_art[7]  & future_variability == "art_deterioration" ~ art_coverage_labels[36],
                                                                                  future_value == unique_future_values_art[8]  & future_variability == "art_deterioration" ~ art_coverage_labels[37],
                                                                                  future_value == unique_future_values_art[9]  & future_variability == "art_deterioration" ~ art_coverage_labels[38],
                                                                                  future_value == unique_future_values_art[10]  & future_variability == "art_deterioration" ~ art_coverage_labels[39],
                                                                                  future_value == unique_future_values_art[11]  & future_variability == "art_deterioration" ~ art_coverage_labels[40],
                                                                                  future_value == unique_future_values_art[12]  & future_variability == "art_deterioration" ~ art_coverage_labels[41],
                                                                                  future_value == unique_future_values_art[13]  & future_variability == "art_deterioration" ~ art_coverage_labels[42],
                                                                                  future_value == unique_future_values_art[14]  & future_variability == "art_deterioration" ~ art_coverage_labels[43],
                                                                                  future_value == unique_future_values_art[15]  & future_variability == "art_deterioration" ~ art_coverage_labels[44],
                                                                                  future_value == unique_future_values_art[16]  & future_variability == "art_deterioration" ~ art_coverage_labels[45],
                                                                                  future_value == unique_future_values_art[17]  & future_variability == "art_deterioration" ~ art_coverage_labels[46],
                                                                                  future_value == unique_future_values_art[18]  & future_variability == "art_deterioration" ~ art_coverage_labels[47],
                                                                                  future_value == unique_future_values_art[19]  & future_variability == "art_deterioration" ~ art_coverage_labels[48],
                                                                                  future_value == unique_future_values_art[20]  & future_variability == "art_deterioration" ~ art_coverage_labels[49],
                                                                                  future_value == unique_future_values_art[21]  & future_variability == "art_deterioration" ~ art_coverage_labels[50],
                                                                                  future_value == unique_future_values_art[22]  & future_variability == "art_deterioration" ~ art_coverage_labels[51],
                                                                                  future_value == unique_future_values_art[23]  & future_variability == "art_deterioration" ~ art_coverage_labels[52],
                                                                                  future_value == unique_future_values_art[24]  & future_variability == "art_deterioration" ~ art_coverage_labels[53],
                                                                                  future_value == unique_future_values_art[25]  & future_variability == "art_deterioration" ~ art_coverage_labels[54],
                                                                                  future_value == unique_future_values_art[26]  & future_variability == "art_deterioration" ~ art_coverage_labels[55],
                                                                                  future_value == unique_future_values_art[27]  & future_variability == "art_deterioration" ~ art_coverage_labels[56],
                                                                                  future_value == unique_future_values_art[28]  & future_variability == "art_deterioration" ~ art_coverage_labels[57],
                                                                                  future_value == unique_future_values_art[29]  & future_variability == "art_deterioration" ~ art_coverage_labels[58]))

write_csv(art_change_summary, "results/art_change_summary.csv")
```

Cumulative: Add column for ART coverage in 2035
```{r add cols art_cumulative, echo = FALSE}
cumulative_art_change <- cumulative_art_change %>% mutate(art_coverage_2035 = case_when(future_value == unique_future_values_art[1] & future_variability == "art_improvement" ~ art_coverage_labels[1],
                                                                                  future_value == unique_future_values_art[2]  & future_variability == "art_improvement" ~ art_coverage_labels[2],
                                                                                  future_value == unique_future_values_art[3]  & future_variability == "art_improvement" ~ art_coverage_labels[3],
                                                                                  future_value == unique_future_values_art[4]  & future_variability == "art_improvement" ~ art_coverage_labels[4],
                                                                                  future_value == unique_future_values_art[5]  & future_variability == "art_improvement" ~ art_coverage_labels[5],
                                                                                  future_value == unique_future_values_art[6]  & future_variability == "art_improvement" ~ art_coverage_labels[6],
                                                                                  future_value == unique_future_values_art[7]  & future_variability == "art_improvement" ~ art_coverage_labels[7],
                                                                                  future_value == unique_future_values_art[8]  & future_variability == "art_improvement" ~ art_coverage_labels[8],
                                                                                  future_value == unique_future_values_art[9]  & future_variability == "art_improvement" ~ art_coverage_labels[9],
                                                                                  future_value == unique_future_values_art[10]  & future_variability == "art_improvement" ~ art_coverage_labels[10],
                                                                                  future_value == unique_future_values_art[11]  & future_variability == "art_improvement" ~ art_coverage_labels[11],
                                                                                  future_value == unique_future_values_art[12]  & future_variability == "art_improvement" ~ art_coverage_labels[12],
                                                                                  future_value == unique_future_values_art[13]  & future_variability == "art_improvement" ~ art_coverage_labels[13],
                                                                                  future_value == unique_future_values_art[14]  & future_variability == "art_improvement" ~ art_coverage_labels[14],
                                                                                  future_value == unique_future_values_art[15]  & future_variability == "art_improvement" ~ art_coverage_labels[15],
                                                                                  future_value == unique_future_values_art[16]  & future_variability == "art_improvement" ~ art_coverage_labels[16],
                                                                                  future_value == unique_future_values_art[17]  & future_variability == "art_improvement" ~ art_coverage_labels[17],
                                                                                  future_value == unique_future_values_art[18]  & future_variability == "art_improvement" ~ art_coverage_labels[18],
                                                                                  future_value == unique_future_values_art[19]  & future_variability == "art_improvement" ~ art_coverage_labels[19],
                                                                                  future_value == unique_future_values_art[20]  & future_variability == "art_improvement" ~ art_coverage_labels[20],
                                                                                  future_value == unique_future_values_art[21]  & future_variability == "art_improvement" ~ art_coverage_labels[21],
                                                                                  future_value == unique_future_values_art[22]  & future_variability == "art_improvement" ~ art_coverage_labels[22],
                                                                                  future_value == unique_future_values_art[23]  & future_variability == "art_improvement" ~ art_coverage_labels[23],
                                                                                  future_value == unique_future_values_art[24]  & future_variability == "art_improvement" ~ art_coverage_labels[24],
                                                                                  future_value == unique_future_values_art[25]  & future_variability == "art_improvement" ~ art_coverage_labels[25],
                                                                                  future_value == unique_future_values_art[26]  & future_variability == "art_improvement" ~ art_coverage_labels[26],
                                                                                  future_value == unique_future_values_art[27]  & future_variability == "art_improvement" ~ art_coverage_labels[27],
                                                                                  future_value == unique_future_values_art[28]  & future_variability == "art_improvement" ~ art_coverage_labels[28],
                                                                                  future_value == unique_future_values_art[29]  & future_variability == "art_improvement" ~ art_coverage_labels[29],
                                                                                  future_value == unique_future_values_art[1] & future_variability == "art_deterioration" ~ art_coverage_labels[30],
                                                                                  future_value == unique_future_values_art[2]  & future_variability == "art_deterioration" ~ art_coverage_labels[31],
                                                                                  future_value == unique_future_values_art[3]  & future_variability == "art_deterioration" ~ art_coverage_labels[32],
                                                                                  future_value == unique_future_values_art[4]  & future_variability == "art_deterioration" ~ art_coverage_labels[33],
                                                                                  future_value == unique_future_values_art[5]  & future_variability == "art_deterioration" ~ art_coverage_labels[34],
                                                                                  future_value == unique_future_values_art[6]  & future_variability == "art_deterioration" ~ art_coverage_labels[35],
                                                                                  future_value == unique_future_values_art[7]  & future_variability == "art_deterioration" ~ art_coverage_labels[36],
                                                                                  future_value == unique_future_values_art[8]  & future_variability == "art_deterioration" ~ art_coverage_labels[37],
                                                                                  future_value == unique_future_values_art[9]  & future_variability == "art_deterioration" ~ art_coverage_labels[38],
                                                                                  future_value == unique_future_values_art[10]  & future_variability == "art_deterioration" ~ art_coverage_labels[39],
                                                                                  future_value == unique_future_values_art[11]  & future_variability == "art_deterioration" ~ art_coverage_labels[40],
                                                                                  future_value == unique_future_values_art[12]  & future_variability == "art_deterioration" ~ art_coverage_labels[41],
                                                                                  future_value == unique_future_values_art[13]  & future_variability == "art_deterioration" ~ art_coverage_labels[42],
                                                                                  future_value == unique_future_values_art[14]  & future_variability == "art_deterioration" ~ art_coverage_labels[43],
                                                                                  future_value == unique_future_values_art[15]  & future_variability == "art_deterioration" ~ art_coverage_labels[44],
                                                                                  future_value == unique_future_values_art[16]  & future_variability == "art_deterioration" ~ art_coverage_labels[45],
                                                                                  future_value == unique_future_values_art[17]  & future_variability == "art_deterioration" ~ art_coverage_labels[46],
                                                                                  future_value == unique_future_values_art[18]  & future_variability == "art_deterioration" ~ art_coverage_labels[47],
                                                                                  future_value == unique_future_values_art[19]  & future_variability == "art_deterioration" ~ art_coverage_labels[48],
                                                                                  future_value == unique_future_values_art[20]  & future_variability == "art_deterioration" ~ art_coverage_labels[49],
                                                                                  future_value == unique_future_values_art[21]  & future_variability == "art_deterioration" ~ art_coverage_labels[50],
                                                                                  future_value == unique_future_values_art[22]  & future_variability == "art_deterioration" ~ art_coverage_labels[51],
                                                                                  future_value == unique_future_values_art[23]  & future_variability == "art_deterioration" ~ art_coverage_labels[52],
                                                                                  future_value == unique_future_values_art[24]  & future_variability == "art_deterioration" ~ art_coverage_labels[53],
                                                                                  future_value == unique_future_values_art[25]  & future_variability == "art_deterioration" ~ art_coverage_labels[54],
                                                                                  future_value == unique_future_values_art[26]  & future_variability == "art_deterioration" ~ art_coverage_labels[55],
                                                                                  future_value == unique_future_values_art[27]  & future_variability == "art_deterioration" ~ art_coverage_labels[56],
                                                                                  future_value == unique_future_values_art[28]  & future_variability == "art_deterioration" ~ art_coverage_labels[57],
                                                                                  future_value == unique_future_values_art[29]  & future_variability == "art_deterioration" ~ art_coverage_labels[58]))
write_csv(cumulative_art_change, "results/art_change_cumulative.csv")
```

Load combined ART change data
``` {r fig 3 data, echo = FALSE}
art_change_summary <- read_csv("results/art_change_summary.csv")
cumulative_art_change <- read_csv("results/art_change_cumulative.csv")
```

### Figure 3a
Heatmap of 2100 incidence under altered ART coverage

``` {r fig3a, echo = FALSE}

temp3a <- art_change_summary %>% 
  mutate(art_coverage_2035 = as.numeric(art_coverage_2035),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(pitc_reduction_year == 2025,
         year == 2100, 
         scenario == "intervention", 
         indicator == "HIVinc15to49")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp3a, test_reduction == i)$art_coverage_2035
  mean_incidence_2100 <- filter(temp3a, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y =  mean_incidence_2100, 
                                    xout = 
                                      seq(min(art_change_summary$art_coverage_2035),
                                          max(art_change_summary$art_coverage_2035),
                                          length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2025, 
           test_reduction = i)
  temp3a <- bind_rows(temp3a, interpolated) 
}

temp3a <- temp3a[which(is.na(temp3a$future_value)),]

fig3a <- temp3a %>% 
  ggplot(aes(test_reduction, art_coverage_2035)) + 
  with_blur(
    geom_raster(aes(fill = log(1000*mean)), interpolate = TRUE),
    sigma = 0
  ) +
  geom_contour(aes(z = 1000*mean), color = "black", binwidth = 0.5) + 
  geom_contour(aes(z = 1000*mean), color = "black", breaks = 1, linewidth = 0.80) + 
  geom_text_contour(aes(z = 1000*mean),skip = 0, stroke = 0.1, stroke.colour = "white",label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.767), lty = "dotted") +
  scale_fill_gradient2("",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red",
                       midpoint = 0,
                       labels = (function(l) {round(exp(l),2)})
  ) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  annotate(geom = "text", x=10, y=0.767, label="Baseline", parse = TRUE) + 
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("HIV incidence in 2100\n(per 1000; 15-49 years)")
fig3a
```

### Figure 3b 
Heatmap of HIV elimination year under altered ART coverage

```{r fig3b, echo = FALSE}
temp3b <- cumulative_art_change %>% 
  mutate(art_coverage_2035 = as.numeric(art_coverage_2035),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(indicator == "elimination_year", 
         pitc_reduction_year == 2025, 
         scenario == "intervention") %>% 
  arrange(desc(art_coverage_2035)) 

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp3b, test_reduction == i)$art_coverage_2035
  elimination_year <- filter(temp3b, test_reduction == i)$median
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = elimination_year, xout = seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(median = y) %>% 
    mutate(pitc_reduction_year = 2025, 
           test_reduction = i)
  temp3b <- bind_rows(temp3b, interpolated) 
}

temp3b <- temp3b[which(is.na(temp3b$future_value)),]

temp3b[which(temp3b$median == Inf),] <- NA

fig3b <- temp3b %>% 
  mutate(pitc_reduction_year = as.factor(pitc_reduction_year)) %>% 
  filter(pitc_reduction_year == 2025) %>% 
  ggplot(aes(x = test_reduction, y = art_coverage_2035, z = median)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = median), 
                        interpolate = TRUE)
  ) + 
  geom_contour(color = "black") + 
  geom_text_contour(skip = 0, stroke = 0.1, 
                    stroke.colour = "white",check_overlap = TRUE,min.size = 100,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.767), lty = "dotted") +
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 2055) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  annotate(geom = "text", x=90, y=0.767, label="Baseline", parse = TRUE) + 
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("HIV elimination year\n")
fig3b
```

### Figure 3c
Heatmap of additional HIV infections under altered ART coverage

``` {r fig3c, echo = FALSE}

temp3c <- cumulative_art_change %>% 
  filter(indicator == "NewAdultHIV", 
         scenario == "absolute_dif")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp3c, test_reduction == i)$art_coverage_2035
  mean <- filter(temp3c, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = mean, 
                                    xout =  seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2025, 
           test_reduction = i)
  temp3c <- bind_rows(temp3c, interpolated) 
}

temp3c <- temp3c[which(is.na(temp3c$future_value)),]

fig3c <- temp3c %>% 
  ggplot(aes(test_reduction, art_coverage_2035, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(),breaks = c(0, 2.5),show.legend = FALSE, color = "black") + 
  geom_contour(aes(),breaks = c(2.5, 5),show.legend = FALSE, color = "grey") +
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, breaks = c(0, 2.5, 5),skip = 0,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.768), lty = "dotted") +
  annotate(geom = "text", x=50, y=0.768, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional HIV infections\n2025-2075 (millions)")
fig3c
```


### Figure 3d
Heatmap of additional AIDS-related deaths under altered ART coverage

```{r fig3d, echo=FALSE}

temp3d <- cumulative_art_change %>% 
  filter(indicator == "TotalAIDSdeathsadult", 
         scenario == "absolute_dif")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp3d, test_reduction == i)$art_coverage_2035
  mean <- filter(temp3d, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = mean, 
                                    xout = seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2025, 
           test_reduction = i)
  temp3d <- bind_rows(temp3d, interpolated) 
}

temp3d <- temp3d[which(is.na(temp3d$future_value)),]

fig3d <- temp3d %>% 
  ggplot(aes(test_reduction, art_coverage_2035, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(),breaks = 0, color = "black", show.legend = FALSE) +
  geom_contour(aes(),breaks = c(0.5, 1, 1.5), color = "grey",show.legend = FALSE) +
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, breaks = c(0,0.5, 1, 1.5), skip = 0,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.768), lty = "dotted") +
  annotate(geom = "text", x=50, y=0.768, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional AIDS deaths\n2025-2075 (millions)")
fig3d
```

### Combined Figure 3

```{r fig3, echo = FALSE}

fig3 <- ggarrange(fig3a, fig3b, fig3c, fig3d, nrow = 2, ncol = 2, labels = "AUTO", align = "v")
fig3
ggsave(filename = "figures/fig3.pdf", plot = fig3, device = "pdf", width = 20, units = "cm")
ggsave(filename = "figures/fig3.png", plot = fig3, device = "png", width = 20, units = "cm")
```


## Figure 4

Effect of altered condom usage on impact of testing reductions

laod reduction and promotion scenarios and combine

```{r condom combine scenarios, echo = FALSE}

#### read csv from cluster ####
condom_reduction_summary_2025 <- read_csv("results/condom_reduction_summary.csv")
condom_reduction_summary_2030 <- read_csv("results/condom_reduction_2030_summary.csv")
condom_reduction_summary_2035 <- read_csv("results/condom_reduction_2035_summary.csv")
condom_reduction_summary_2040 <- read_csv("results/condom_reduction_2040_summary.csv")
condom_reduction_summary_2045 <- read_csv("results/condom_reduction_2045_summary.csv")
condom_reduction_summary_2050 <- read_csv("results/condom_reduction_2050_summary.csv")
condom_reduction_summary <- bind_rows(condom_reduction_summary_2025, condom_reduction_summary_2030, condom_reduction_summary_2035, condom_reduction_summary_2040, condom_reduction_summary_2045, condom_reduction_summary_2050)
unique_future_values <- unique(condom_reduction_summary$future_value)


#### calculating absolute condom usage values
overall_condom_usage_range <- condom_reduction_summary %>% filter(indicator == "CondomUsage", 
                                                                  test_reduction == 0, pitc_reduction_year == 2025,
                                                                  year == 2035, scenario == "intervention") %>% select(mean)
condom_usage_reduction_labels <- round(overall_condom_usage_range$mean,1)

condom_reduction_summary <- condom_reduction_summary %>% mutate(overall_condom_usage = case_when(future_value == unique_future_values[1] ~ condom_usage_reduction_labels[1],
                                                                                                 future_value == unique_future_values[2] ~ condom_usage_reduction_labels[2],
                                                                                                 future_value == unique_future_values[3] ~ condom_usage_reduction_labels[3],
                                                                                                 future_value == unique_future_values[4] ~ condom_usage_reduction_labels[4],
                                                                                                 future_value == unique_future_values[5] ~ condom_usage_reduction_labels[5],
                                                                                                 future_value == unique_future_values[6] ~ condom_usage_reduction_labels[6],
                                                                                                 future_value == unique_future_values[7] ~ condom_usage_reduction_labels[7],
                                                                                                 future_value == unique_future_values[8] ~ condom_usage_reduction_labels[8],
                                                                                                 future_value == unique_future_values[9] ~ condom_usage_reduction_labels[9],
                                                                                                 future_value == unique_future_values[10] ~ condom_usage_reduction_labels[10],
                                                                                                 future_value == unique_future_values[11] ~ condom_usage_reduction_labels[11],
                                                                                                 future_value == unique_future_values[12] ~ condom_usage_reduction_labels[12],
                                                                                                 future_value == unique_future_values[13] ~ condom_usage_reduction_labels[13],
                                                                                                 future_value == unique_future_values[14] ~ condom_usage_reduction_labels[14],
                                                                                                 future_value == unique_future_values[15] ~ condom_usage_reduction_labels[15],
                                                                                                 future_value == unique_future_values[16] ~ condom_usage_reduction_labels[16],
                                                                                                 future_value == unique_future_values[17] ~ condom_usage_reduction_labels[17],
                                                                                                 future_value == unique_future_values[18] ~ condom_usage_reduction_labels[18],
                                                                                                 future_value == unique_future_values[19] ~ condom_usage_reduction_labels[19],
                                                                                                 future_value == unique_future_values[20] ~ condom_usage_reduction_labels[20],
                                                                                                 future_value == unique_future_values[21] ~ condom_usage_reduction_labels[21],
                                                                                                 future_value == unique_future_values[22] ~ condom_usage_reduction_labels[22],
                                                                                                 future_value == unique_future_values[23] ~ condom_usage_reduction_labels[23],
                                                                                                 future_value == unique_future_values[24] ~ condom_usage_reduction_labels[24],
                                                                                                 future_value == unique_future_values[25] ~ condom_usage_reduction_labels[25],
                                                                                                 future_value == unique_future_values[26] ~ condom_usage_reduction_labels[26],
                                                                                                 future_value == unique_future_values[27] ~ condom_usage_reduction_labels[27],
                                                                                                 future_value == unique_future_values[28] ~ condom_usage_reduction_labels[28],
                                                                                                 future_value == unique_future_values[29] ~ condom_usage_reduction_labels[29],
                                                                                                 future_value == unique_future_values[30] ~ condom_usage_reduction_labels[30]))

#### condom promotion ####

#### read csv from cluster ####
condom_promotion_summary_2025 <- read_csv("results/condom_promotion_summary.csv")
condom_promotion_summary_2030 <- read_csv("results/condom_promotion_2030_summary.csv")
condom_promotion_summary_2035 <- read_csv("results/condom_promotion_2035_summary.csv")
condom_promotion_summary_2040 <- read_csv("results/condom_promotion_2040_summary.csv")
condom_promotion_summary_2045 <- read_csv("results/condom_promotion_2045_summary.csv")
condom_promotion_summary_2050 <- read_csv("results/condom_promotion_2050_summary.csv")

condom_promotion_summary <- bind_rows(condom_promotion_summary_2025, condom_promotion_summary_2030, condom_promotion_summary_2035, condom_promotion_summary_2040, condom_promotion_summary_2045, condom_promotion_summary_2050)

unique_future_values <- unique(condom_promotion_summary$future_value)
overall_condom_usage_range <- condom_promotion_summary %>% filter(indicator == "CondomUsage", 
                                                                  test_reduction == 5, pitc_reduction_year == 2025,
                                                                  year == 2035, scenario == "intervention") %>% select(mean)
condom_usage_reduction_labels <- round(overall_condom_usage_range$mean,1)
condom_promotion_summary <- condom_promotion_summary %>% mutate(overall_condom_usage = case_when(future_value == unique_future_values[1] ~ condom_usage_reduction_labels[1],
                                                                                                 future_value == unique_future_values[2] ~ condom_usage_reduction_labels[2],
                                                                                                 future_value == unique_future_values[3] ~ condom_usage_reduction_labels[3],
                                                                                                 future_value == unique_future_values[4] ~ condom_usage_reduction_labels[4],
                                                                                                 future_value == unique_future_values[5] ~ condom_usage_reduction_labels[5],
                                                                                                 future_value == unique_future_values[6] ~ condom_usage_reduction_labels[6],
                                                                                                 future_value == unique_future_values[7] ~ condom_usage_reduction_labels[7],
                                                                                                 future_value == unique_future_values[8] ~ condom_usage_reduction_labels[8],
                                                                                                 future_value == unique_future_values[9] ~ condom_usage_reduction_labels[9],
                                                                                                 future_value == unique_future_values[10] ~ condom_usage_reduction_labels[10],
                                                                                                 future_value == unique_future_values[11] ~ condom_usage_reduction_labels[11],
                                                                                                 future_value == unique_future_values[12] ~ condom_usage_reduction_labels[12],
                                                                                                 future_value == unique_future_values[13] ~ condom_usage_reduction_labels[13],
                                                                                                 future_value == unique_future_values[14] ~ condom_usage_reduction_labels[14],
                                                                                                 future_value == unique_future_values[15] ~ condom_usage_reduction_labels[15],
                                                                                                 future_value == unique_future_values[16] ~ condom_usage_reduction_labels[16],
                                                                                                 future_value == unique_future_values[17] ~ condom_usage_reduction_labels[17],
                                                                                                 future_value == unique_future_values[18] ~ condom_usage_reduction_labels[18],
                                                                                                 future_value == unique_future_values[19] ~ condom_usage_reduction_labels[19],
                                                                                                 future_value == unique_future_values[20] ~ condom_usage_reduction_labels[20],
                                                                                                 future_value == unique_future_values[21] ~ condom_usage_reduction_labels[21],
                                                                                                 future_value == unique_future_values[22] ~ condom_usage_reduction_labels[22],
                                                                                                 future_value == unique_future_values[23] ~ condom_usage_reduction_labels[23],
                                                                                                 future_value == unique_future_values[24] ~ condom_usage_reduction_labels[24],
                                                                                                 future_value == unique_future_values[25] ~ condom_usage_reduction_labels[25],
                                                                                                 future_value == unique_future_values[26] ~ condom_usage_reduction_labels[26],
                                                                                                 future_value == unique_future_values[27] ~ condom_usage_reduction_labels[27],
                                                                                                 future_value == unique_future_values[28] ~ condom_usage_reduction_labels[28],
                                                                                                 future_value == unique_future_values[29] ~ condom_usage_reduction_labels[29],
                                                                                                 future_value == unique_future_values[30] ~ condom_usage_reduction_labels[30]))

#### condom usage cumulative ####
# reduction
condom_reduction_cumulative_2025 <- read_csv("results/condom_reduction_cumulative.csv")
condom_reduction_cumulative_2030 <- read_csv("results/condom_reduction_2030_cumulative.csv")
condom_reduction_cumulative_2035 <- read_csv("results/condom_reduction_2035_cumulative.csv")
condom_reduction_cumulative_2040 <- read_csv("results/condom_reduction_2040_cumulative.csv")
condom_reduction_cumulative_2045 <- read_csv("results/condom_reduction_2045_cumulative.csv")
condom_reduction_cumulative_2050 <- read_csv("results/condom_reduction_2050_cumulative.csv")

condom_reduction_cumulative <- bind_rows(condom_reduction_cumulative_2025, condom_reduction_cumulative_2030, condom_reduction_cumulative_2035, condom_reduction_cumulative_2040, condom_reduction_cumulative_2045, condom_reduction_cumulative_2050)

unique_future_values <- unique(condom_reduction_summary$future_value)
overall_condom_usage_range <- condom_reduction_summary %>% filter(indicator == "CondomUsage", 
                                                                  test_reduction == 0, pitc_reduction_year == 2025,
                                                                  year == 2035, scenario == "intervention") %>% select(mean)
condom_usage_reduction_labels <- round(overall_condom_usage_range$mean,1)
condom_reduction_cumulative <- condom_reduction_cumulative %>% mutate(overall_condom_usage = case_when(future_value == unique_future_values[1] ~ condom_usage_reduction_labels[1],
                                                                                                 future_value == unique_future_values[2] ~ condom_usage_reduction_labels[2],
                                                                                                 future_value == unique_future_values[3] ~ condom_usage_reduction_labels[3],
                                                                                                 future_value == unique_future_values[4] ~ condom_usage_reduction_labels[4],
                                                                                                 future_value == unique_future_values[5] ~ condom_usage_reduction_labels[5],
                                                                                                 future_value == unique_future_values[6] ~ condom_usage_reduction_labels[6],
                                                                                                 future_value == unique_future_values[7] ~ condom_usage_reduction_labels[7],
                                                                                                 future_value == unique_future_values[8] ~ condom_usage_reduction_labels[8],
                                                                                                 future_value == unique_future_values[9] ~ condom_usage_reduction_labels[9],
                                                                                                 future_value == unique_future_values[10] ~ condom_usage_reduction_labels[10],
                                                                                                 future_value == unique_future_values[11] ~ condom_usage_reduction_labels[11],
                                                                                                 future_value == unique_future_values[12] ~ condom_usage_reduction_labels[12],
                                                                                                 future_value == unique_future_values[13] ~ condom_usage_reduction_labels[13],
                                                                                                 future_value == unique_future_values[14] ~ condom_usage_reduction_labels[14],
                                                                                                 future_value == unique_future_values[15] ~ condom_usage_reduction_labels[15],
                                                                                                 future_value == unique_future_values[16] ~ condom_usage_reduction_labels[16],
                                                                                                 future_value == unique_future_values[17] ~ condom_usage_reduction_labels[17],
                                                                                                 future_value == unique_future_values[18] ~ condom_usage_reduction_labels[18],
                                                                                                 future_value == unique_future_values[19] ~ condom_usage_reduction_labels[19],
                                                                                                 future_value == unique_future_values[20] ~ condom_usage_reduction_labels[20],
                                                                                                 future_value == unique_future_values[21] ~ condom_usage_reduction_labels[21],
                                                                                                 future_value == unique_future_values[22] ~ condom_usage_reduction_labels[22],
                                                                                                 future_value == unique_future_values[23] ~ condom_usage_reduction_labels[23],
                                                                                                 future_value == unique_future_values[24] ~ condom_usage_reduction_labels[24],
                                                                                                 future_value == unique_future_values[25] ~ condom_usage_reduction_labels[25],
                                                                                                 future_value == unique_future_values[26] ~ condom_usage_reduction_labels[26],
                                                                                                 future_value == unique_future_values[27] ~ condom_usage_reduction_labels[27],
                                                                                                 future_value == unique_future_values[28] ~ condom_usage_reduction_labels[28],
                                                                                                 future_value == unique_future_values[29] ~ condom_usage_reduction_labels[29],
                                                                                                 future_value == unique_future_values[30] ~ condom_usage_reduction_labels[30]))

# promotion
condom_promotion_cumulative_2025 <- read_csv("results/condom_promotion_cumulative.csv")
condom_promotion_cumulative_2030 <- read_csv("results/condom_promotion_2030_cumulative.csv")
condom_promotion_cumulative_2035 <- read_csv("results/condom_promotion_2035_cumulative.csv")
condom_promotion_cumulative_2040 <- read_csv("results/condom_promotion_2040_cumulative.csv")
condom_promotion_cumulative_2045 <- read_csv("results/condom_promotion_2045_cumulative.csv")
condom_promotion_cumulative_2050 <- read_csv("results/condom_promotion_2050_cumulative.csv")

condom_promotion_cumulative <- bind_rows(condom_promotion_cumulative_2025, condom_promotion_cumulative_2030, condom_promotion_cumulative_2035, condom_promotion_cumulative_2040, condom_promotion_cumulative_2045, condom_promotion_cumulative_2050)

unique_future_values <- unique(condom_promotion_summary$future_value)
overall_condom_usage_range <- condom_promotion_summary %>% filter(indicator == "CondomUsage", 
                                                                  test_reduction == 0, pitc_reduction_year == 2025,
                                                                  year == 2035, scenario == "intervention") %>% select(mean)


unique_future_values <- unique(condom_promotion_summary$future_value)
overall_condom_usage_range <- condom_promotion_summary %>% filter(indicator == "CondomUsage", 
                                                                  test_reduction == 5, pitc_reduction_year == 2025,
                                                                  year == 2035, scenario == "intervention") %>% select(mean)
condom_usage_promotion_labels <- round(overall_condom_usage_range$mean,1)
condom_promotion_cumulative <- condom_promotion_cumulative %>% mutate(overall_condom_usage = case_when(future_value == unique_future_values[1] ~ condom_usage_promotion_labels[1],
                                                                                                       future_value == unique_future_values[2] ~ condom_usage_promotion_labels[2],
                                                                                                       future_value == unique_future_values[3] ~ condom_usage_promotion_labels[3],
                                                                                                       future_value == unique_future_values[4] ~ condom_usage_promotion_labels[4],
                                                                                                       future_value == unique_future_values[5] ~ condom_usage_promotion_labels[5],
                                                                                                       future_value == unique_future_values[6] ~ condom_usage_promotion_labels[6],
                                                                                                       future_value == unique_future_values[7] ~ condom_usage_promotion_labels[7],
                                                                                                       future_value == unique_future_values[8] ~ condom_usage_promotion_labels[8],
                                                                                                       future_value == unique_future_values[9] ~ condom_usage_promotion_labels[9],
                                                                                                       future_value == unique_future_values[10] ~ condom_usage_promotion_labels[10],
                                                                                                       future_value == unique_future_values[11] ~ condom_usage_promotion_labels[11],
                                                                                                       future_value == unique_future_values[12] ~ condom_usage_promotion_labels[12],
                                                                                                       future_value == unique_future_values[13] ~ condom_usage_promotion_labels[13],
                                                                                                       future_value == unique_future_values[14] ~ condom_usage_promotion_labels[14],
                                                                                                       future_value == unique_future_values[15] ~ condom_usage_promotion_labels[15],
                                                                                                       future_value == unique_future_values[16] ~ condom_usage_promotion_labels[16],
                                                                                                       future_value == unique_future_values[17] ~ condom_usage_promotion_labels[17],
                                                                                                       future_value == unique_future_values[18] ~ condom_usage_promotion_labels[18],
                                                                                                       future_value == unique_future_values[19] ~ condom_usage_promotion_labels[19],
                                                                                                       future_value == unique_future_values[20] ~ condom_usage_promotion_labels[20],
                                                                                                       future_value == unique_future_values[21] ~ condom_usage_promotion_labels[21],
                                                                                                       future_value == unique_future_values[22] ~ condom_usage_promotion_labels[22],
                                                                                                       future_value == unique_future_values[23] ~ condom_usage_promotion_labels[23],
                                                                                                       future_value == unique_future_values[24] ~ condom_usage_promotion_labels[24],
                                                                                                       future_value == unique_future_values[25] ~ condom_usage_promotion_labels[25],
                                                                                                       future_value == unique_future_values[26] ~ condom_usage_promotion_labels[26],
                                                                                                       future_value == unique_future_values[27] ~ condom_usage_promotion_labels[27],
                                                                                                       future_value == unique_future_values[28] ~ condom_usage_promotion_labels[28],
                                                                                                       future_value == unique_future_values[29] ~ condom_usage_promotion_labels[29],
                                                                                                       future_value == unique_future_values[30] ~ condom_usage_promotion_labels[30]))

#### joining condom usage dfs ####

condom_change_summary <- bind_rows(condom_promotion_summary,
                                   condom_reduction_summary)

condom_change_cumulative <- bind_rows(condom_promotion_cumulative, 
                                      condom_reduction_cumulative)

write_csv(condom_change_summary, "results/condom_change_summary.csv")

write_csv(condom_change_cumulative, "results/condom_change_cumulative.csv")

```

load combined condom data

``` {r fig4 data, echo = FALSE}
condom_change_summary <- read_csv("results/condom_change_summary.csv")

condom_change_cumulative <- read_csv("results/condom_change_cumulative.csv")

```


### Figure 4a

Heatmap of 2100 incidence under altered condom usage 

``` {r fig4a, echo = FALSE}

temp4a <- condom_change_summary %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(pitc_reduction_year == 2025,
         year == 2100, 
         scenario == "intervention", 
         indicator == "HIVinc15to49")

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp4a, test_reduction == i)$overall_condom_usage
  mean_incidence_2100 <- filter(temp4a, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean_incidence_2100, 
                                    xout = seq(min(condom_change_summary$overall_condom_usage), max(condom_change_summary$overall_condom_usage),length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2025, 
           test_reduction = i)
  
  
  temp4a <- bind_rows(temp4a, interpolated) 
}
temp4a <- temp4a[which(is.na(temp4a$future_value)),]

fig4a <- temp4a %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction), 
         log_incidence = log(1000*mean)) %>% 
  ggplot(aes(x = test_reduction, y = overall_condom_usage)) + 
  with_blur(geom_raster(aes(fill = as.numeric(log_incidence)), 
                        interpolate = TRUE),sigma=0) + 
  geom_contour(aes(z = 1000*mean), 
               color = "black", breaks = c(0.5, 1, 2, 3, 4, 5, 6, 7, 8, 9)) + 
  geom_contour(aes(z = 1000*mean), 
               color = "black", breaks = 1, linewidth = 0.80) +
  geom_text_contour(aes(z = 1000*mean),
                    skip = 0, stroke = 0.1, 
                    stroke.colour = "white",
                    breaks = c(0.5, 1, 2, 3, 4, 5, 6, 7, 8, 9), 
                    label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted")+
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red",
                       midpoint = 0,
                       labels = (function(l) {round(exp(l),2)})
  ) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("General HTC reduced from 2025") +
  annotate(geom = "text", x = 15, y = 33.9, label = "Baseline")
fig4a
```

### Figure 4b

Heatmap of HIV elimination year under altered condom usage 

``` {r fig4b, echo = FALSE}

temp4b <- condom_change_cumulative %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(indicator == "elimination_year", 
         pitc_reduction_year == 2025, 
         scenario == "intervention") %>% 
  arrange(desc(overall_condom_usage)) 

temp4b[which(temp4b$median == Inf),] <- NA

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp4b, test_reduction == i)$overall_condom_usage
  elimination_year <- filter(temp4b, test_reduction == i)$median
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = elimination_year, seq(min(condom_change_cumulative$overall_condom_usage), max(condom_change_cumulative$overall_condom_usage),length.out = 1000), 
                                    method = "linear", na.rm = FALSE)) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(median = y) %>% 
    mutate(pitc_reduction_year = 2025, 
           test_reduction = i)
  temp4b <- bind_rows(temp4b, interpolated) 
}

temp4b <- temp4b[which(is.na(temp4b$future_value)),]

temp4b[which(temp4b$median == Inf),] <- NA

fig4b <- temp4b %>% 
  ggplot(aes(x = test_reduction, y = overall_condom_usage)) +
  with_blur(geom_raster(aes(fill = median), interpolate = TRUE, na.rm = TRUE), sigma = 0) +
  geom_contour(aes(z = median),color = "black") + 
  geom_text_contour(aes(z = median), skip = 0, 
                    stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, 
                    min.size = 100, 
                    label.placer = label_placer_fraction())+
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 2055) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted")+
  annotate(geom = "text", x=90, y=33.9, label="Baseline", parse = TRUE) + 
  ggtitle("General HTC reduced from 2025")
fig4b
```

### Figure 4c

Heatmap of additional HIV infections under altered condom usage 

``` {r fig4c, echo = FALSE}

temp4c <- condom_change_cumulative %>% 
  filter(indicator == "NewAdultHIV", 
         scenario == "absolute_dif")

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp4c, test_reduction == i)$overall_condom_usage
  mean <- filter(temp4c, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean, 
                                    xout = seq(min(condom_change_cumulative$overall_condom_usage),
                                               max(condom_change_cumulative$overall_condom_usage), length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2025, 
           test_reduction = i)
  temp4c <- bind_rows(temp4c, interpolated) 
}

temp4c <- temp4c[which(is.na(temp4c$future_value)),]

fig4c <- temp4c %>% 
ggplot(aes(test_reduction, overall_condom_usage, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(), color = "black",breaks = 0,show.legend = FALSE) + 
  geom_contour(aes(), color = "grey",breaks = c(2.5, 5, 7.5, 10),show.legend = FALSE) + 
  geom_text_contour(stroke = 0.1, 
                    stroke.colour = "white",
                    check_overlap = TRUE, 
                    breaks = c(0,2.5, 5, 7.5, 10),
                    label.placer = label_placer_fraction(), skip = 0) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted") +
  annotate(geom = "text", x=50, y=33.9, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional HIV infections\n2025-2075 (millions)")
fig4c

```

### Figure 4d

Heatmap of additional AIDS-related deaths under altered condom usage 

``` {r fig4d, echo = FALSE}

temp4d <- condom_change_cumulative %>% 
  filter(indicator == "TotalAIDSdeathsadult", 
         scenario == "absolute_dif")

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp4d, test_reduction == i)$overall_condom_usage
  mean <- filter(temp4d, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean, 
                                    xout = seq(min(condom_change_cumulative$overall_condom_usage), max(condom_change_cumulative$overall_condom_usage), length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2025, 
           test_reduction = i)
  temp4d <- bind_rows(temp4d, interpolated) 
}

temp4d <- temp4d[which(is.na(temp4d$future_value)),]

fig4d <- temp4d %>% 
  ggplot(aes(test_reduction, overall_condom_usage, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(), color = "black",breaks = 0,show.legend = FALSE) + 
  geom_contour(aes(), color = "grey",breaks = c(0.5, 1.0, 1.5, 2.0),show.legend = FALSE) + 
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, 
                    breaks = c(0, 0.5, 1.0, 1.5, 2.0), skip = 0,
                    label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted") +
  annotate(geom = "text", x=50, y=33.9, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) +
  ggtitle("Additional AIDS deaths\n2025-2075 (millions)")
fig4d
```

### Combined Figure 4

``` {r fig4, echo = FALSE}
fig4 <- ggarrange(fig4a, fig4b, fig4c, fig4d, nrow = 2, ncol = 2, legend = "right", labels = "AUTO")
fig4
ggsave(filename = "figures/fig4.pdf", plot = fig4, device = "pdf", width = 20, units = "cm")
ggsave(filename = "figures/fig4.png", plot = fig4, device = "png", width = 20, units = "cm")
```

## Supplementary Figure 1
Incidence when testing is reduced at different times

``` {r supp fig 1, echo = FALSE}

suppfig1 <- test_reduction_only %>% mutate(test_reduction = as.factor(test_reduction)) %>% 
  filter(scenario == "intervention", 
         indicator == "HIVinc15to49",
         year > 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100)) %>% 
  ggplot(aes(year, mean, group = test_reduction, fill = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_hline(aes(yintercept = 0.001), lty = "dotted") +
  xlab("") +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 12), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12),
        strip.text = element_text(size = 12),
        plot.title = element_text(face = "bold", size = 14, hjust = 0.5)) +
  scale_y_continuous("HIV incidence per 1000 (15-49 years)", labels =(function(l) {round(l*1e3,1)}), breaks = c(0, 0.001, 0.002, 0.003, 0.004, 0.005, 0.006, 0.007)) +
  scale_fill_discrete(labels = c("None", "25%", "50%", "75%", "100%"),) + 
  scale_color_discrete(labels = c("None", "25%", "50%", "75%", "100%")) + 
  theme(legend.title = element_blank()) + 
  facet_wrap(vars(pitc_reduction_year),labeller = as_labeller(c(`2025` = "Testing reduced from 2025",
                                                                `2030` = "Testing reduced from 2030",
                                                                `2035` = "Testing reduced from 2035",
                                                                `2040` = "Testing reduced from 2040", 
                                                                `2045` = "Testing reduced from 2045", 
                                                                `2050` = "Testing reduced from 2050"))) +
  ggtitle("HIV incidence")

suppfig1
```


## Supplementary Figure 2
Prevalence when testing is reduced at different times

``` {r supp fig 2, echo = FALSE}

suppfig2 <- test_reduction_only %>% mutate(test_reduction = as.factor(test_reduction)) %>% 
  filter(scenario == "intervention", 
         indicator == "Prev15to49",
         year > 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100)) %>% 
  ggplot(aes(year, mean, group = test_reduction, fill = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  xlab("") +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 12), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12),
        strip.text = element_text(size = 12),
        plot.title = element_text(face = "bold", size = 14, hjust = 0.5)) +
  scale_y_continuous("HIV prevalence (%) (15-49 years)", labels =(function(l) {round(l*1e2,1)})) +
  scale_fill_discrete(labels = c("None", "25%", "50%", "75%", "100%"),) + 
  scale_color_discrete(labels = c("None", "25%", "50%", "75%", "100%")) + 
  theme(legend.title = element_blank()) +
  facet_wrap(vars(pitc_reduction_year),labeller = as_labeller(c(`2025` = "Testing reduced from 2025",
                                                                `2030` = "Testing reduced from 2030",
                                                                `2035` = "Testing reduced from 2035",
                                                                `2040` = "Testing reduced from 2040", 
                                                                `2045` = "Testing reduced from 2045", 
                                                                `2050` = "Testing reduced from 2050"))) +
  ggtitle("HIV prevalence")

```

## Supplementary Figure 3
ART coverage when testing is reduced at different times

```{r, supp fig 3, echo = FALSE}
suppfig3 <- test_reduction_only %>% mutate(test_reduction = as.factor(test_reduction)) %>% 
  filter(scenario == "intervention", 
         indicator == "ARTcoverageAdult",
         year > 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100)) %>% 
  ggplot(aes(year, mean, group = test_reduction, fill = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.25, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  xlab("") +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 12), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12),
        strip.text = element_text(size = 12),
        plot.title = element_text(face = "bold", size = 14, hjust = 0.5)) +
  scale_y_continuous("ART coverage (15+ years)", limits = c(0.5, 1)) +
  scale_fill_discrete(labels = c("None", "25%", "50%", "75%", "100%"),) + 
  scale_color_discrete(labels = c("None", "25%", "50%", "75%", "100%")) + 
  theme(legend.title = element_blank()) + 
  facet_wrap(vars(pitc_reduction_year),labeller = as_labeller(c(`2025` = "Testing reduced in 2025",
                                                                `2030` = "Testing reduced in 2030",
                                                                `2035` = "Testing reduced in 2035",
                                                                `2040` = "Testing reduced in 2040", 
                                                                `2045` = "Testing reduced in 2045", 
                                                                `2050` = "Testing reduced in 2050"))) +
  ggtitle("ART coverage")
```
## Supplementary figure 4 

HIV tests per 100 adults when testing is reduced at different times 

```{r, supp fig 4, echo = FALSE}

suppfig4 <- test_reduction_only %>% mutate(test_reduction = as.factor(test_reduction)) %>% 
  filter(scenario == "intervention", 
         indicator == "TestsPerAdult",
         year > 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100)) %>% 
  ggplot(aes(year, mean, group = test_reduction, fill = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.25, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  xlab("") +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 12), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12),
        strip.text = element_text(size = 12),
        plot.title = element_text(face = "bold", size = 14, hjust = 0.5)) +
  scale_y_continuous("HIV tests per 100 (over 15 years)", labels =(function(l) {round(l*1e2,1)})) +
  scale_fill_discrete(labels = c("None", "25%", "50%", "75%", "100%"),) + 
  scale_color_discrete(labels = c("None", "25%", "50%", "75%", "100%")) + 
  theme(legend.title = element_blank()) +
  facet_wrap(vars(pitc_reduction_year),labeller = as_labeller(c(`2025` = "Testing reduced in 2025",
                                                                `2030` = "Testing reduced in 2030",
                                                                `2035` = "Testing reduced in 2035",
                                                                `2040` = "Testing reduced in 2040", 
                                                                `2045` = "Testing reduced in 2045", 
                                                                `2050` = "Testing reduced in 2050"))) + 
  ggtitle("HIV tests per 100 adults")

```
## Supplementary figure 5a
Increased ART coverage to 85.8%

```{r, supp fig 5a, echo=FALSE}

# palette for manual scale fill found here: colorbrewer2.org

art_change_summary <- art_change_summary %>% mutate(test_reduction = factor(test_reduction,labels = seq(0, 100, 5), levels = as.character(seq(0, 100, 5)))) 

suppfig5a <- art_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "HIVinc15to49",
         year > 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100),
         future_value == 0.07, 
         future_variability == "art_improvement"
         ) %>% mutate(test_reduction = factor(as.character(test_reduction), labels = c("0", "25", "50", "75", "100"), levels = c("0", "25", "50", "75", "100"))) %>% 
  ggplot(aes(year, mean, group = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_line(data = filter(art_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "HIVinc15to49",
              year > 2020,
              test_reduction %in% c(0),
              future_value == 0.07,
              future_variability == "art_improvement"),
            aes(year, mean, colour = scenario)) +
  geom_ribbon(data = filter(art_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "HIVinc15to49",
              year > 2020,
              test_reduction %in% c(0),
              future_value == 0.07,
              future_variability == "art_improvement"),
              aes(ymin = lower_CI, ymax = upper_CI, fill = scenario), alpha = 0.10, show.legend = F) +
  geom_hline(aes(yintercept = 0.001), lty = "dotted") +
  xlab("") +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 12), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12), 
        plot.title = element_text(size = 14, face = "bold", hjust = 0.5)) +
  scale_y_continuous("HIV incidence per 1000 \n(15-49 years)\n", labels =(function(l) {round(l*1e3,1)}), breaks = c(0, 0.001, 0.002, 0.003, 0.004, 0.005, 0.006, 0.007)) +
  scale_fill_manual(name = "", breaks = c("baseline", "0", "25", "50", "75", "100"), values = c("baseline" = "black", "0" = "#e41a1c", "25" = "#377eb8", "50" = "#4daf4a", "75" = "#984ea3",  "100" = "#ff7f00"), labels= c("Status quo", "None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill")) + 
  theme(legend.title = element_blank()) + ggtitle("HIV incidence")

```

## Supplementary Figure 5b

```{r, supp fig 5b, echo=FALSE}

art_change_summary <- art_change_summary %>% mutate(test_reduction = factor(test_reduction,labels = seq(0, 100, 5), levels = as.character(seq(0, 100, 5)))) 

suppfig5b <- art_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "Prev15to49",
         year > 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100),
         future_value == 0.07, 
         future_variability == "art_improvement"
         ) %>% mutate(test_reduction = factor(as.character(test_reduction), labels = c("0", "25", "50", "75", "100"), levels = c("0", "25", "50", "75", "100"))) %>% 
  ggplot(aes(year, mean, group = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_line(data = filter(art_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "Prev15to49",
              year > 2020,
              test_reduction %in% c(0),
              future_value == 0.07,
              future_variability == "art_improvement"),
            aes(year, mean, colour = scenario)) +
  geom_ribbon(data = filter(art_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "Prev15to49",
              year > 2020,
              test_reduction %in% c(0),
              future_value == 0.07,
              future_variability == "art_improvement"),
              aes(ymin = lower_CI, ymax = upper_CI, fill = scenario), alpha = 0.10, show.legend = F) +
  xlab("") +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 12), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12), 
        plot.title = element_text(size = 14, face = "bold", hjust = 0.5)) +
  scale_y_continuous("HIV prevalence (%) \n(15-49 years)", labels =(function(l) {round(l*1e2,1)})) +
  scale_fill_manual(name = "", breaks = c("baseline", "0", "25", "50", "75", "100"), values = c("baseline" = "black", "0" = "#e41a1c", "25" = "#377eb8", "50" = "#4daf4a", "75" = "#984ea3",  "100" = "#ff7f00"), labels= c("Status quo", "None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill")) + 
  theme(legend.title = element_blank()) + ggtitle("HIV prevalence")
suppfig5b

```

## Supplementary Figure 5c

```{r, supp fig 5c, echo=FALSE}

art_change_summary <- art_change_summary %>% mutate(test_reduction = factor(test_reduction,labels = seq(0, 100, 5), levels = as.character(seq(0, 100, 5)))) 

suppfig5c <- art_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "ARTcoverageAdult",
         year > 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100),
         future_value == 0.07, 
         future_variability == "art_improvement"
         ) %>% mutate(test_reduction = factor(as.character(test_reduction), labels = c("0", "25", "50", "75", "100"), levels = c("0", "25", "50", "75", "100"))) %>% 
  ggplot(aes(year, mean, group = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_line(data = filter(art_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "ARTcoverageAdult",
              year > 2020,
              test_reduction %in% c(0),
              future_value == 0.07,
              future_variability == "art_improvement"),
            aes(year, mean, colour = scenario)) +
  geom_ribbon(data = filter(art_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "ARTcoverageAdult",
              year > 2020,
              test_reduction %in% c(0),
              future_value == 0.07,
              future_variability == "art_improvement"),
              aes(ymin = lower_CI, ymax = upper_CI, fill = scenario), alpha = 0.10, show.legend = F) + xlab("") +
  expand_limits(y=c(0.5, 1)) + theme_classic() + 
  theme(axis.text = element_text(size = 12), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12), 
        plot.title = element_text(size = 14, face = "bold", hjust = 0.5)) +
  scale_y_continuous("ART coverage (%) \n(15+ years)", labels =(function(l) {round(l*1e2,1)})) +
  scale_fill_manual(name = "", breaks = c("baseline", "0", "25", "50", "75", "100"), values = c("baseline" = "black", "0" = "#e41a1c", "25" = "#377eb8", "50" = "#4daf4a", "75" = "#984ea3",  "100" = "#ff7f00"), labels= c("Status quo", "None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill")) + 
  theme(legend.title = element_blank()) + ggtitle("ART coverage")
suppfig5c

```
## Supplementary Figure 5d

```{r, supp fig 5d, echo=FALSE}

art_change_summary <- art_change_summary %>% mutate(test_reduction = factor(test_reduction,labels = seq(0, 100, 5), levels = as.character(seq(0, 100, 5)))) 

suppfig5d <- art_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "TestsPerAdult",
         year > 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100),
         future_value == 0.07, 
         future_variability == "art_improvement"
         ) %>% mutate(test_reduction = factor(as.character(test_reduction), labels = c("0", "25", "50", "75", "100"), levels = c("0", "25", "50", "75", "100"))) %>% 
  ggplot(aes(year, mean, group = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_line(data = filter(art_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "TestsPerAdult",
              year > 2020,
              test_reduction %in% c(0),
              future_value == 0.07,
              future_variability == "art_improvement"),
            aes(year, mean, colour = scenario)) +
  geom_ribbon(data = filter(art_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "TestsPerAdult",
              year > 2020,
              test_reduction %in% c(0),
              future_value == 0.07,
              future_variability == "art_improvement"),
              aes(ymin = lower_CI, ymax = upper_CI, fill = scenario), alpha = 0.10, show.legend = F) + xlab("") +
  expand_limits(y=c(0)) + theme_classic() + 
  theme(axis.text = element_text(size = 12), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12), 
        plot.title = element_text(size = 14, face = "bold", hjust = 0.5)) +
  scale_y_continuous("Annual HIV tests per 100 \n(15+ years)", labels =(function(l) {round(l*1e2,1)})) +
  scale_fill_manual(name = "", breaks = c("baseline", "0", "25", "50", "75", "100"), values = c("baseline" = "black", "0" = "#e41a1c", "25" = "#377eb8", "50" = "#4daf4a", "75" = "#984ea3",  "100" = "#ff7f00"), labels= c("Status quo", "None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill")) + 
  theme(legend.title = element_blank()) + ggtitle("HIV tests per 100 adults")
suppfig5d

```

## Supplementary figure 5 combined 

``` {r supp fig 5, echo = FALSE}

suppfig5 <- ggarrange(suppfig5a, suppfig5b, suppfig5c, suppfig5d, nrow = 2, ncol = 2, common.legend = TRUE, legend = "right", labels = "AUTO")

```

## Supplementary figure 6a
Decreased ART coverage to 64.2%

```{r, supp fig 6a, echo=FALSE}

art_change_summary <- art_change_summary %>% mutate(test_reduction = factor(test_reduction,labels = seq(0, 100, 5), levels = as.character(seq(0, 100, 5)))) 

suppfig6a <- art_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "HIVinc15to49",
         year > 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100),
         future_value == 0.07, 
         future_variability == "art_deterioration"
         ) %>% mutate(test_reduction = factor(as.character(test_reduction), labels = c("0", "25", "50", "75", "100"), levels = c("0", "25", "50", "75", "100"))) %>% 
  ggplot(aes(year, mean, group = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_line(data = filter(art_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "HIVinc15to49",
              year > 2020,
              test_reduction %in% c(0),
              future_value == 0.07,
              future_variability == "art_deterioration"),
            aes(year, mean, colour = scenario)) +
  geom_ribbon(data = filter(art_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "HIVinc15to49",
              year > 2020,
              test_reduction %in% c(0),
              future_value == 0.07,
              future_variability == "art_deterioration"),
              aes(ymin = lower_CI, ymax = upper_CI, fill = scenario), alpha = 0.10, show.legend = F) +
  geom_hline(aes(yintercept = 0.001), lty = "dotted") +
  xlab("") +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 12), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12), 
        plot.title = element_text(size = 14, face = "bold", hjust = 0.5)) +
  scale_y_continuous("HIV incidence per 1000 \n(15-49 years)\n", labels =(function(l) {round(l*1e3,1)}), breaks = c(0, 0.001, 0.002, 0.003, 0.004, 0.005, 0.006, 0.007)) +
  scale_fill_manual(name = "", breaks = c("baseline", "0", "25", "50", "75", "100"), values = c("baseline" = "black", "0" = "#e41a1c", "25" = "#377eb8", "50" = "#4daf4a", "75" = "#984ea3",  "100" = "#ff7f00"), labels= c("Status quo", "None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill")) + 
  theme(legend.title = element_blank()) + ggtitle("HIV incidence")

```

## Supplementary Figure 6b

```{r, supp fig 6b, echo=FALSE}

art_change_summary <- art_change_summary %>% mutate(test_reduction = factor(test_reduction,labels = seq(0, 100, 5), levels = as.character(seq(0, 100, 5)))) 

suppfig6b <- art_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "Prev15to49",
         year > 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100),
         future_value == 0.07, 
         future_variability == "art_deterioration"
         ) %>% mutate(test_reduction = factor(as.character(test_reduction), labels = c("0", "25", "50", "75", "100"), levels = c("0", "25", "50", "75", "100"))) %>% 
  ggplot(aes(year, mean, group = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_line(data = filter(art_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "Prev15to49",
              year > 2020,
              test_reduction %in% c(0),
              future_value == 0.07,
              future_variability == "art_deterioration"),
            aes(year, mean, colour = scenario)) +
  geom_ribbon(data = filter(art_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "Prev15to49",
              year > 2020,
              test_reduction %in% c(0),
              future_value == 0.07,
              future_variability == "art_deterioration"),
              aes(ymin = lower_CI, ymax = upper_CI, fill = scenario), alpha = 0.10, show.legend = F) +
  xlab("") +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 12), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12), 
        plot.title = element_text(size = 14, face = "bold", hjust = 0.5)) +
  scale_y_continuous("HIV prevalence (%) \n(15-49 years)", labels =(function(l) {round(l*1e2,1)})) +
  scale_fill_manual(name = "", breaks = c("baseline", "0", "25", "50", "75", "100"), values = c("baseline" = "black", "0" = "#e41a1c", "25" = "#377eb8", "50" = "#4daf4a", "75" = "#984ea3",  "100" = "#ff7f00"), labels= c("Status quo", "None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill")) + 
  theme(legend.title = element_blank()) + ggtitle("HIV prevalence")


```

## Supplementary Figure 6c

```{r, supp fig 6c, echo=FALSE}

art_change_summary <- art_change_summary %>% mutate(test_reduction = factor(test_reduction,labels = seq(0, 100, 5), levels = as.character(seq(0, 100, 5)))) 

suppfig6c <- art_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "ARTcoverageAdult",
         year > 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100),
         future_value == 0.07, 
         future_variability == "art_deterioration"
         ) %>% mutate(test_reduction = factor(as.character(test_reduction), labels = c("0", "25", "50", "75", "100"), levels = c("0", "25", "50", "75", "100"))) %>% 
  ggplot(aes(year, mean, group = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_line(data = filter(art_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "ARTcoverageAdult",
              year > 2020,
              test_reduction %in% c(0),
              future_value == 0.07,
              future_variability == "art_deterioration"),
            aes(year, mean, colour = scenario)) +
  geom_ribbon(data = filter(art_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "ARTcoverageAdult",
              year > 2020,
              test_reduction %in% c(0),
              future_value == 0.07,
              future_variability == "art_deterioration"),
              aes(ymin = lower_CI, ymax = upper_CI, fill = scenario), alpha = 0.10, show.legend = F) + xlab("") +
  expand_limits(y=c(0.5, 1)) + theme_classic() + 
  theme(axis.text = element_text(size = 12), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12), 
        plot.title = element_text(size = 14, face = "bold", hjust = 0.5)) +
  scale_y_continuous("ART coverage (%) \n(15+ years)", labels =(function(l) {round(l*1e2,1)})) +
  scale_fill_manual(name = "", breaks = c("baseline", "0", "25", "50", "75", "100"), values = c("baseline" = "black", "0" = "#e41a1c", "25" = "#377eb8", "50" = "#4daf4a", "75" = "#984ea3",  "100" = "#ff7f00"), labels= c("Status quo", "None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill")) + 
  theme(legend.title = element_blank()) + ggtitle("ART coverage")


```
## Supplementary Figure 6d

```{r, supp fig 6d, echo=FALSE}

art_change_summary <- art_change_summary %>% mutate(test_reduction = factor(test_reduction,labels = seq(0, 100, 5), levels = as.character(seq(0, 100, 5)))) 

suppfig6d <- art_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "TestsPerAdult",
         year > 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100),
         future_value == 0.07, 
         future_variability == "art_deterioration"
         ) %>% mutate(test_reduction = factor(as.character(test_reduction), labels = c("0", "25", "50", "75", "100"), levels = c("0", "25", "50", "75", "100"))) %>% 
  ggplot(aes(year, mean, group = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_line(data = filter(art_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "TestsPerAdult",
              year > 2020,
              test_reduction %in% c(0),
              future_value == 0.07,
              future_variability == "art_deterioration"),
            aes(year, mean, colour = scenario)) +
  geom_ribbon(data = filter(art_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "TestsPerAdult",
              year > 2020,
              test_reduction %in% c(0),
              future_value == 0.07,
              future_variability == "art_deterioration"),
              aes(ymin = lower_CI, ymax = upper_CI, fill = scenario), alpha = 0.10, show.legend = F) + xlab("") +
  expand_limits(y=c(0)) + theme_classic() + 
  theme(axis.text = element_text(size = 12), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12), 
        plot.title = element_text(size = 14, face = "bold", hjust = 0.5)) +
  scale_y_continuous("Annual HIV tests per 100 \n(15+ years)", labels =(function(l) {round(l*1e2,1)})) +
  scale_fill_manual(name = "", breaks = c("baseline", "0", "25", "50", "75", "100"), values = c("baseline" = "black", "0" = "#e41a1c", "25" = "#377eb8", "50" = "#4daf4a", "75" = "#984ea3",  "100" = "#ff7f00"), labels= c("Status quo", "None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill")) + 
  theme(legend.title = element_blank()) + ggtitle("HIV tests per 100 adults")
suppfig6d

```

## Supplementary figure 6 combined 

``` {r supp fig 6, echo = FALSE}

suppfig6 <- ggarrange(suppfig6a, suppfig6b, suppfig6c, suppfig6d, nrow = 2, ncol = 2, common.legend = TRUE, legend = "right", labels = "AUTO")

```

## Supplementary figure 7a
Increased condom usage to 45.9%

```{r, supp fig 7a, echo=FALSE}

condom_change_summary <- condom_change_summary %>% mutate(test_reduction = factor(test_reduction,labels = seq(0, 100, 5), levels = as.character(seq(0, 100, 5)))) 

suppfig7a <- condom_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "HIVinc15to49",
         year > 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100),
         future_value == 7, 
         future_variability == "condom_promotion"
         ) %>% mutate(test_reduction = factor(as.character(test_reduction), labels = c("0", "25", "50", "75", "100"), levels = c("0", "25", "50", "75", "100"))) %>% 
  ggplot(aes(year, mean, group = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_line(data = filter(condom_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "HIVinc15to49",
              year > 2020,
              test_reduction %in% c(0),
              future_value == 7,
              future_variability == "condom_promotion"),
            aes(year, mean, colour = scenario)) +
  geom_ribbon(data = filter(condom_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "HIVinc15to49",
              year > 2020,
              test_reduction %in% c(0),
              future_value == 7,
              future_variability == "condom_promotion"),
              aes(ymin = lower_CI, ymax = upper_CI, fill = scenario), alpha = 0.10, show.legend = F) +
  geom_hline(aes(yintercept = 0.001), lty = "dotted") +
  xlab("") +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 12), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12), 
        plot.title = element_text(size = 14, face = "bold", hjust = 0.5)) +
  scale_y_continuous("HIV incidence per 1000 \n(15-49 years)\n", labels =(function(l) {round(l*1e3,1)}), breaks = c(0, 0.001, 0.002, 0.003, 0.004, 0.005, 0.006, 0.007)) +
  scale_fill_manual(name = "", breaks = c("baseline", "0", "25", "50", "75", "100"), values = c("baseline" = "black", "0" = "#e41a1c", "25" = "#377eb8", "50" = "#4daf4a", "75" = "#984ea3",  "100" = "#ff7f00"), labels= c("Status quo", "None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill")) + 
  theme(legend.title = element_blank()) + ggtitle("HIV incidence")
suppfig7a
```

## Supplementary Figure 7b

```{r, supp fig 7b, echo=FALSE}

suppfig7b <- condom_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "Prev15to49",
         year > 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100),
         future_value == 7, 
         future_variability == "condom_promotion"
         ) %>% mutate(test_reduction = factor(as.character(test_reduction), labels = c("0", "25", "50", "75", "100"), levels = c("0", "25", "50", "75", "100"))) %>% 
  ggplot(aes(year, mean, group = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_line(data = filter(condom_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "Prev15to49",
              year > 2020,
              test_reduction %in% c(0),
              future_value == 7,
              future_variability == "condom_promotion"),
            aes(year, mean, colour = scenario)) +
  geom_ribbon(data = filter(condom_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "Prev15to49",
              year > 2020,
              test_reduction %in% c(0),
              future_value == 7,
              future_variability == "condom_promotion"),
              aes(ymin = lower_CI, ymax = upper_CI, fill = scenario), alpha = 0.10, show.legend = F) +
  xlab("") +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 12), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12), 
        plot.title = element_text(size = 14, face = "bold", hjust = 0.5)) +
  scale_y_continuous("HIV prevalence (%) \n(15-49 years)", labels =(function(l) {round(l*1e2,1)})) +
  scale_fill_manual(name = "", breaks = c("baseline", "0", "25", "50", "75", "100"), values = c("baseline" = "black", "0" = "#e41a1c", "25" = "#377eb8", "50" = "#4daf4a", "75" = "#984ea3",  "100" = "#ff7f00"), labels= c("Status quo", "None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill")) + 
  theme(legend.title = element_blank()) + ggtitle("HIV prevalence")
suppfig7b

```

## Supplementary Figure 7c

```{r, supp fig 7c, echo=FALSE}

suppfig7c <- condom_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "ARTcoverageAdult",
         year > 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100),
         future_value == 7, 
         future_variability == "condom_promotion"
         ) %>% mutate(test_reduction = factor(as.character(test_reduction), labels = c("0", "25", "50", "75", "100"), levels = c("0", "25", "50", "75", "100"))) %>% 
  ggplot(aes(year, mean, group = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_line(data = filter(condom_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "ARTcoverageAdult",
              year > 2020,
              test_reduction %in% c(0),
              future_value == 7,
              future_variability == "condom_promotion"),
            aes(year, mean, colour = scenario)) +
  geom_ribbon(data = filter(condom_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "ARTcoverageAdult",
              year > 2020,
              test_reduction %in% c(0),
              future_value == 7,
              future_variability == "condom_promotion"),
              aes(ymin = lower_CI, ymax = upper_CI, fill = scenario), alpha = 0.10, show.legend = F) + xlab("") +
  expand_limits(y=c(0.5, 1)) + theme_classic() + 
  theme(axis.text = element_text(size = 12), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12), 
        plot.title = element_text(size = 14, face = "bold", hjust = 0.5)) +
  scale_y_continuous("ART coverage (%) \n(15+ years)", labels =(function(l) {round(l*1e2,1)})) +
  scale_fill_manual(name = "", breaks = c("baseline", "0", "25", "50", "75", "100"), values = c("baseline" = "black", "0" = "#e41a1c", "25" = "#377eb8", "50" = "#4daf4a", "75" = "#984ea3",  "100" = "#ff7f00"), labels= c("Status quo", "None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill")) + 
  theme(legend.title = element_blank()) + ggtitle("ART coverage")
suppfig7c

```
## Supplementary Figure 7d

```{r, supp fig 7d, echo=FALSE}

suppfig7d <- condom_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "TestsPerAdult",
         year > 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100),
         future_value == 7, 
         future_variability == "condom_promotion"
         ) %>% mutate(test_reduction = factor(as.character(test_reduction), labels = c("0", "25", "50", "75", "100"), levels = c("0", "25", "50", "75", "100"))) %>% 
  ggplot(aes(year, mean, group = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_line(data = filter(condom_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "TestsPerAdult",
              year > 2020,
              test_reduction %in% c(0),
              future_value == 7,
              future_variability == "condom_promotion"),
            aes(year, mean, colour = scenario)) +
  geom_ribbon(data = filter(condom_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "TestsPerAdult",
              year > 2020,
              test_reduction %in% c(0),
              future_value == 7,
              future_variability == "condom_promotion"),
              aes(ymin = lower_CI, ymax = upper_CI, fill = scenario), alpha = 0.10, show.legend = F) + xlab("") +
  expand_limits(y=c(0)) + theme_classic() + 
  theme(axis.text = element_text(size = 12), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12), 
        plot.title = element_text(size = 14, face = "bold", hjust = 0.5)) +
  scale_y_continuous("Annual HIV tests per 100 \n(15+ years)", labels =(function(l) {round(l*1e2,1)})) +
  scale_fill_manual(name = "", breaks = c("baseline", "0", "25", "50", "75", "100"), values = c("baseline" = "black", "0" = "#e41a1c", "25" = "#377eb8", "50" = "#4daf4a", "75" = "#984ea3",  "100" = "#ff7f00"), labels= c("Status quo", "None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill")) + 
  theme(legend.title = element_blank()) + ggtitle("HIV tests per 1000 adults")
suppfig7d

```

## Supplementary figure 7 combined 

``` {r supp fig 7, echo = FALSE}

suppfig7 <- ggarrange(suppfig7a, suppfig7b, suppfig7c, suppfig7d, nrow = 2, ncol = 2, common.legend = TRUE, legend = "right", labels = "AUTO")

```


## Supplementary figure 8a
Decreased condom usage to 23.2%

```{r, supp fig 8a, echo=FALSE}

condom_change_summary <- condom_change_summary %>% mutate(test_reduction = factor(test_reduction,labels = seq(0, 100, 5), levels = as.character(seq(0, 100, 5)))) 

suppfig8a <- condom_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "HIVinc15to49",
         year > 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100),
         future_value == 7, 
         future_variability == "condom_reduction"
         ) %>% mutate(test_reduction = factor(as.character(test_reduction), labels = c("0", "25", "50", "75", "100"), levels = c("0", "25", "50", "75", "100"))) %>% 
  ggplot(aes(year, mean, group = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_line(data = filter(condom_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "HIVinc15to49",
              year > 2020,
              test_reduction %in% c(0),
              future_value == 7,
              future_variability == "condom_reduction"),
            aes(year, mean, colour = scenario)) +
  geom_ribbon(data = filter(condom_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "HIVinc15to49",
              year > 2020,
              test_reduction %in% c(0),
              future_value == 7,
              future_variability == "condom_reduction"),
              aes(ymin = lower_CI, ymax = upper_CI, fill = scenario), alpha = 0.10, show.legend = F) +
  geom_hline(aes(yintercept = 0.001), lty = "dotted") +
  xlab("") +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 12), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12), 
        plot.title = element_text(size = 14, face = "bold", hjust = 0.5)) +
  scale_y_continuous("HIV incidence per 1000 \n(15-49 years)\n", labels =(function(l) {round(l*1e3,1)}), breaks = c(0, 0.001, 0.002, 0.003, 0.004, 0.005, 0.006, 0.007)) +
  scale_fill_manual(name = "", breaks = c("baseline", "0", "25", "50", "75", "100"), values = c("baseline" = "black", "0" = "#e41a1c", "25" = "#377eb8", "50" = "#4daf4a", "75" = "#984ea3",  "100" = "#ff7f00"), labels= c("Status quo", "None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill")) + 
  theme(legend.title = element_blank()) + ggtitle("HIV incidence")
suppfig8a
```

## Supplementary Figure 8b

```{r, supp fig 8b, echo=FALSE}

suppfig8b <- condom_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "Prev15to49",
         year > 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100),
         future_value == 7, 
         future_variability == "condom_reduction"
         ) %>% mutate(test_reduction = factor(as.character(test_reduction), labels = c("0", "25", "50", "75", "100"), levels = c("0", "25", "50", "75", "100"))) %>% 
  ggplot(aes(year, mean, group = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_line(data = filter(condom_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "Prev15to49",
              year > 2020,
              test_reduction %in% c(0),
              future_value == 7,
              future_variability == "condom_reduction"),
            aes(year, mean, colour = scenario)) +
  geom_ribbon(data = filter(condom_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "Prev15to49",
              year > 2020,
              test_reduction %in% c(0),
              future_value == 7,
              future_variability == "condom_reduction"),
              aes(ymin = lower_CI, ymax = upper_CI, fill = scenario), alpha = 0.10, show.legend = F) +
  xlab("") +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 12), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12), 
        plot.title = element_text(size = 14, face = "bold", hjust = 0.5)) +
  scale_y_continuous("HIV prevalence (%) \n(15-49 years)", labels =(function(l) {round(l*1e2,1)})) +
  scale_fill_manual(name = "", breaks = c("baseline", "0", "25", "50", "75", "100"), values = c("baseline" = "black", "0" = "#e41a1c", "25" = "#377eb8", "50" = "#4daf4a", "75" = "#984ea3",  "100" = "#ff7f00"), labels= c("Status quo", "None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill")) + 
  theme(legend.title = element_blank()) + ggtitle("HIV prevalence")
suppfig8b

```

## Supplementary Figure 8c

```{r, supp fig 8c, echo=FALSE}

suppfig8c <- condom_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "ARTcoverageAdult",
         year > 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100),
         future_value == 7, 
         future_variability == "condom_reduction"
         ) %>% mutate(test_reduction = factor(as.character(test_reduction), labels = c("0", "25", "50", "75", "100"), levels = c("0", "25", "50", "75", "100"))) %>% 
  ggplot(aes(year, mean, group = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_line(data = filter(condom_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "ARTcoverageAdult",
              year > 2020,
              test_reduction %in% c(0),
              future_value == 7,
              future_variability == "condom_reduction"),
            aes(year, mean, colour = scenario)) +
  geom_ribbon(data = filter(condom_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "ARTcoverageAdult",
              year > 2020,
              test_reduction %in% c(0),
              future_value == 7,
              future_variability == "condom_reduction"),
              aes(ymin = lower_CI, ymax = upper_CI, fill = scenario), alpha = 0.10, show.legend = F) + xlab("") +
  expand_limits(y=c(0.5, 1)) + theme_classic() + 
  theme(axis.text = element_text(size = 12), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12), 
        plot.title = element_text(size = 14, face = "bold", hjust = 0.5)) +
  scale_y_continuous("ART coverage (%) \n(15+ years)", labels =(function(l) {round(l*1e2,1)})) +
  scale_fill_manual(name = "", breaks = c("baseline", "0", "25", "50", "75", "100"), values = c("baseline" = "black", "0" = "#e41a1c", "25" = "#377eb8", "50" = "#4daf4a", "75" = "#984ea3",  "100" = "#ff7f00"), labels= c("Status quo", "None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill")) + 
  theme(legend.title = element_blank()) + ggtitle("ART coverage")
suppfig8c

```
## Supplementary Figure 8d

```{r, supp fig 8d, echo=FALSE}

suppfig8d <- condom_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "TestsPerAdult",
         year > 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100),
         future_value == 7, 
         future_variability == "condom_reduction"
         ) %>% mutate(test_reduction = factor(as.character(test_reduction), labels = c("0", "25", "50", "75", "100"), levels = c("0", "25", "50", "75", "100"))) %>% 
  ggplot(aes(year, mean, group = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_line(data = filter(condom_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "TestsPerAdult",
              year > 2020,
              test_reduction %in% c(0),
              future_value == 7,
              future_variability == "condom_reduction"),
            aes(year, mean, colour = scenario)) +
  geom_ribbon(data = filter(condom_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "TestsPerAdult",
              year > 2020,
              test_reduction %in% c(0),
              future_value == 7,
              future_variability == "condom_reduction"),
              aes(ymin = lower_CI, ymax = upper_CI, fill = scenario), alpha = 0.10, show.legend = F) + xlab("") +
  expand_limits(y=c(0)) + theme_classic() + 
  theme(axis.text = element_text(size = 12), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12), 
        plot.title = element_text(size = 14, face = "bold", hjust = 0.5)) +
  scale_y_continuous("Annual HIV tests per 100 \n(15+ years)", labels =(function(l) {round(l*1e2,1)})) +
  scale_fill_manual(name = "", breaks = c("baseline", "0", "25", "50", "75", "100"), values = c("baseline" = "black", "0" = "#e41a1c", "25" = "#377eb8", "50" = "#4daf4a", "75" = "#984ea3",  "100" = "#ff7f00"), labels= c("Status quo", "None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill")) + 
  theme(legend.title = element_blank()) + ggtitle("HIV tests per 100 adults")
suppfig8d

```

## Supplementary figure 8 combined 

``` {r supp fig 8, echo = FALSE}

suppfig8 <- ggarrange(suppfig8a, suppfig8b, suppfig8c, suppfig8d, nrow = 2, ncol = 2, common.legend = TRUE, legend = "right", labels = "AUTO")

```

## Supplementary figure 9a

```{r supp fig 9a, echo=FALSE}
# paletter from colorbrewer2.org but #ffff33 was too light so switched to #yellow3
art_change_summary <- art_change_summary %>% mutate(art_coverage_2035 = as.factor(art_coverage_2035))

suppfig9a <- art_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "HIVinc15to49",
         year > 2020, 
         test_reduction == 0,
         art_coverage_2035 %in% c(0.499, 0.561, 0.622, 0.68, 0.734, 0.797, 0.858, 0.916)
         ) %>%
  ggplot(aes(year, mean, group = art_coverage_2035)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = art_coverage_2035), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = art_coverage_2035), show.legend = T) +
  geom_line(data = filter(art_change_summary,scenario == "intervention",
                   pitc_reduction_year == 2025,
                   indicator == "HIVinc15to49",
                   test_reduction == 0,
                   year > 2020,
                   art_coverage_2035 %in% c(0.767)), 
                   aes(year, mean, group = art_coverage_2035), linewidth = 0.75) +
  geom_ribbon(data = filter(art_change_summary,scenario == "intervention",
                   pitc_reduction_year == 2025,
                   indicator == "HIVinc15to49",
                   year > 2020,
                   test_reduction == 0,
                   art_coverage_2035 %in% c(0.767)
         ), aes(ymin = lower_CI, ymax = upper_CI, fill = art_coverage_2035), alpha = 0.10, show.legend = F) +
  geom_hline(aes(yintercept = 0.001), lty = "dotted") +
  xlab("") +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 12), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.title = element_text(size = 12)) + 
  ggtitle("HIV incidence") +
  scale_y_continuous("HIV incidence per 1000 \n(15-49 years)\n", labels =(function(l) {round(l*1e3,1)}), breaks = c(0, 0.001, 0.002, 0.003, 0.004, 0.005, 0.006, 0.007)) + 
  scale_fill_manual(name = "ART coverage \nin 2035", 
                    breaks = c(0.499, 0.561, 0.622, 0.68, 0.734, 0.767, 0.797, 0.858, 0.916), 
                    values = c(`0.499` = "#8dd3c7", `0.561` = "#ffffb3", `0.622` = "#bebada", `0.68` = "#fb8072", `0.734` = "#80b1d3", `0.767` = "black", `0.797` = "#fdb462", `0.858` = "#b3de69", `0.916` = "#fccde5"), 
                    labels= c("49.9%", "56.1%", "62.2%", "68.0%", "73.4%", "76.7% (baseline)", "79.7%", "85.8%", "91.6%"), 
                    aesthetics = c("colour", "fill"))
suppfig9a
```

## Supplementary figure 9b

```{r supp fig 9b, echo=FALSE}
suppfig9b <- art_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "Prev15to49",
         year > 2020, 
         test_reduction == 0,
         art_coverage_2035 %in% c(0.499, 0.561, 0.622, 0.68, 0.734, 0.797, 0.858, 0.916)
         ) %>% 
  ggplot(aes(year, mean, group = art_coverage_2035)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = art_coverage_2035), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = art_coverage_2035), show.legend = T) +
  geom_line(data = filter(art_change_summary,scenario == "intervention",
                   pitc_reduction_year == 2025,
                   indicator == "Prev15to49",
                   test_reduction == 0,
                   year > 2020,
                   art_coverage_2035 %in% c(0.767)), 
                   aes(year, mean, group = art_coverage_2035), linewidth = 0.75) +
  geom_ribbon(data = filter(art_change_summary,scenario == "intervention",
                   pitc_reduction_year == 2025,
                   indicator == "Prev15to49",
                   year > 2020,
                   test_reduction == 0,
                   art_coverage_2035 %in% c(0.767)
         ), aes(ymin = lower_CI, ymax = upper_CI, fill = art_coverage_2035), alpha = 0.10, show.legend = F) +
  xlab("") +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 12), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5)) + 
  ggtitle("HIV prevalence \n") +
  scale_y_continuous("HIV prevalence (%) \n(15-49 years) \n", labels =(function(l) {round(l*1e2,1)})) + 
  scale_fill_manual(name = "ART coverage \nin 2035", 
                    breaks = c(0.499, 0.561, 0.622, 0.68, 0.734, 0.767, 0.797, 0.858, 0.916), 
                    values = c(`0.499` = "#e41a1c", `0.561` = "#377eb8", `0.622` = "#4daf4a", `0.68` = "#984ea3", `0.734` = "#ff7f00", `0.767` = "black", `0.797` = "yellow3", `0.858` = "#a65628", `0.916` = "#f781bf"), 
                    labels= c("49.9%", "56.1%", "62.2%", "68.0%", "73.4%", "76.7% (baseline)", "79.7%", "85.8%", "91.6%"), 
                    aesthetics = c("colour", "fill"))

```

## Supplementary figure 9c

```{r supp fig 9c, echo=FALSE}
suppfig9c <- art_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "ARTcoverageAdult",
         year > 2020, 
         test_reduction == 0,
         art_coverage_2035 %in% c(0.499, 0.561, 0.622, 0.68, 0.734, 0.797, 0.858, 0.916)
         ) %>% 
  ggplot(aes(year, mean, group = art_coverage_2035)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = art_coverage_2035), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = art_coverage_2035), show.legend = T) +
  geom_line(data = filter(art_change_summary,scenario == "intervention",
                   pitc_reduction_year == 2025,
                   indicator == "ARTcoverageAdult",
                   test_reduction == 0,
                   year > 2020,
                   art_coverage_2035 %in% c(0.767)), 
                   aes(year, mean, group = art_coverage_2035), linewidth = 0.75) +
  geom_ribbon(data = filter(art_change_summary,scenario == "intervention",
                   pitc_reduction_year == 2025,
                   indicator == "ARTcoverageAdult",
                   year > 2020,
                   test_reduction == 0,
                   art_coverage_2035 %in% c(0.767)
         ), aes(ymin = lower_CI, ymax = upper_CI, fill = art_coverage_2035), alpha = 0.10, show.legend = F) +
  xlab("") +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 12), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5)) + 
  ggtitle("ART coverage") +
  scale_y_continuous("ART coverage (%) \n(15+ years)", labels =(function(l) {round(l*1e2,1)})) + 
  scale_fill_manual(name = "ART coverage \nin 2035", 
                    breaks = c(0.499, 0.561, 0.622, 0.68, 0.734, 0.767, 0.797, 0.858, 0.916), 
                    values = c(`0.499` = "#e41a1c", `0.561` = "#377eb8", `0.622` = "#4daf4a", `0.68` = "#984ea3", `0.734` = "#ff7f00", `0.767` = "black", `0.797` = "yellow3", `0.858` = "#a65628", `0.916` = "#f781bf"), 
                    labels= c("49.9%", "56.1%", "62.2%", "68.0%", "73.4%", "76.7% (baseline)", "79.7%", "85.8%", "91.6%"), 
                    aesthetics = c("colour", "fill"))

```

## Supplementary figure 9d

```{r supp fig 9d, echo=FALSE}
suppfig9d <- art_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "CondomUsage",
         year > 2020, 
         test_reduction == 0,
         art_coverage_2035 %in% c(0.499, 0.561, 0.622, 0.68, 0.734, 0.797, 0.858, 0.916)
         ) %>% 
  ggplot(aes(year, mean, group = art_coverage_2035)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = art_coverage_2035), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = art_coverage_2035), show.legend = T) +
  geom_line(data = filter(art_change_summary,scenario == "intervention",
                   pitc_reduction_year == 2025,
                   indicator == "CondomUsage",
                   test_reduction == 0,
                   year > 2020,
                   art_coverage_2035 %in% c(0.767)), 
                   aes(year, mean, group = art_coverage_2035), linewidth = 0.75) +
  geom_ribbon(data = filter(art_change_summary,scenario == "intervention",
                   pitc_reduction_year == 2025,
                   indicator == "CondomUsage",
                   year > 2020,
                   test_reduction == 0,
                   art_coverage_2035 %in% c(0.767)
         ), aes(ymin = lower_CI, ymax = upper_CI, fill = art_coverage_2035), alpha = 0.10, show.legend = F) +
  xlab("") +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 12), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5)) + 
  ggtitle("Condom usage") +
  scale_y_continuous("Condom usage (%) \n (15+ years) \n") + 
  scale_fill_manual(name = "ART coverage \nin 2035", 
                    breaks = c(0.499, 0.561, 0.622, 0.68, 0.734, 0.767, 0.797, 0.858, 0.916), 
                    values = c(`0.499` = "#e41a1c", `0.561` = "#377eb8", `0.622` = "#4daf4a", `0.68` = "#984ea3", `0.734` = "#ff7f00", `0.767` = "black", `0.797` = "yellow3", `0.858` = "#a65628", `0.916` = "#f781bf"), 
                    labels= c("49.9%", "56.1%", "62.2%", "68.0%", "73.4%", "76.7% (baseline)", "79.7%", "85.8%", "91.6%"),
                    aesthetics = c("colour", "fill"))

```

## Supplementary figure 9 combined 

```{r supp fig 9, echo = FALSE}

suppfig9 <- ggarrange(suppfig9a, suppfig9b, suppfig9c, suppfig9d, ncol = 2, nrow = 2, common.legend = TRUE, legend = "right", labels = "AUTO")
ggsave(filename = )
```


## Supplementary figure 10a

```{r supp fig 10a, echo=FALSE}

condom_change_summary <- condom_change_summary %>% mutate(overall_condom_usage = as.factor(overall_condom_usage))

suppfig10a <- condom_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "HIVinc15to49",
         year > 2020, 
         test_reduction == 0,
         overall_condom_usage %in% c(14.1, 20.4, 27.6, 42.4, 50.3, 58.2)
         ) %>% 
  ggplot(aes(year, mean, group = overall_condom_usage)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = overall_condom_usage), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = overall_condom_usage), show.legend = T) +
  geom_hline(aes(yintercept = 0.001), lty = "dotted") +
  geom_line(data = filter(condom_change_summary,scenario == "intervention",
                   pitc_reduction_year == 2025,
                   indicator == "HIVinc15to49",
                   test_reduction == 0,
                   year > 2020,
                   overall_condom_usage %in% c(33.9)), 
                   aes(year, mean, group = overall_condom_usage), linewidth = 0.75) +
  geom_ribbon(data = filter(condom_change_summary,scenario == "intervention",
                   pitc_reduction_year == 2025,
                   indicator == "HIVinc15to49",
                   year > 2020,
                   test_reduction == 0,
                   overall_condom_usage %in% c(33.9)
         ), aes(ymin = lower_CI, ymax = upper_CI, fill = overall_condom_usage), alpha = 0.10, show.legend = F) +
  xlab("") +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 12), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.title = element_text(size = 12)) +
  ggtitle("HIV incidence") +
  scale_y_continuous("HIV incidence per 1000 \n(15-49 years)\n", labels =(function(l) {round(l*1e3,1)}), breaks = c(0, 0.001, 0.002, 0.003, 0.004, 0.005, 0.006, 0.007)) + 
    scale_fill_manual(name = "Condom usage \nin 2035", 
                    breaks = c(14.1, 20.4, 27.6,33.9, 42.4, 50.3, 58.2), 
                    values = c(`14.1` = "#e41a1c", `20.4` = "#377eb8", `27.6` = "#4daf4a", `33.9` = "black", `42.4` = "#984ea3", `50.3` = "#ff7f00", `58.2` = "yellow3"), 
                    labels= c("14.1%", "20.4%", "27.6%", "33.9% (Baseline)", "42.4%", "50.3%", "58.2%"), 
                    aesthetics = c("colour", "fill")) 
suppfig10a
```

## Supplementary figure 10b

```{r supp fig 10b, echo=FALSE}
suppfig10b <- condom_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "Prev15to49",
         year > 2020, 
         test_reduction == 0,
         overall_condom_usage %in% c(14.1, 20.4, 27.6, 42.4, 50.3, 58.2)
         ) %>% 
  ggplot(aes(year, mean, group = overall_condom_usage)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = overall_condom_usage), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = overall_condom_usage), show.legend = T) +
  geom_line(data = filter(condom_change_summary,scenario == "intervention",
                   pitc_reduction_year == 2025,
                   indicator == "Prev15to49",
                   test_reduction == 0,
                   year > 2020,
                   overall_condom_usage %in% c(33.9)), 
                   aes(year, mean, group = overall_condom_usage), linewidth = 0.75) +
  geom_ribbon(data = filter(condom_change_summary,scenario == "intervention",
                   pitc_reduction_year == 2025,
                   indicator == "Prev15to49",
                   year > 2020,
                   test_reduction == 0,
                   overall_condom_usage %in% c(33.9)
         ), aes(ymin = lower_CI, ymax = upper_CI, fill = overall_condom_usage), alpha = 0.10, show.legend = F) +
  xlab("") +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 12), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5)) + 
  ggtitle("HIV prevalence") +
  scale_y_continuous("HIV prevalence (%) \n(15-49 years) \n", labels =(function(l) {round(l*1e2,1)})) +
  scale_fill_manual(name = "Condom usage \nin 2035", 
                    breaks = c(14.1, 20.4, 27.6,33.9, 42.4, 50.3, 58.2), 
                    values = c(`14.1` = "#e41a1c", `20.4` = "#377eb8", `27.6` = "#4daf4a", `33.9` = "black", `42.4` = "#984ea3", `50.3` = "#ff7f00", `58.2` = "yellow3"), 
                    labels= c("14.1%", "20.4%", "27.6%", "33.9% (Baseline)", "42.4%", "50.3%", "58.2%"), 
                    aesthetics = c("colour", "fill")) 
suppfig10b
```

## Supplementary figure 10c

```{r supp fig 10c, echo=FALSE}
suppfig10c <- condom_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "ARTcoverageAdult",
         year > 2020, 
         test_reduction == 0,
         overall_condom_usage %in% c(14.1, 20.4, 27.6, 42.4, 50.3, 58.2)
         ) %>% 
  ggplot(aes(year, mean, group = overall_condom_usage)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = overall_condom_usage), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = overall_condom_usage), show.legend = T) +
  geom_line(data = filter(condom_change_summary,scenario == "intervention",
                   pitc_reduction_year == 2025,
                   indicator == "ARTcoverageAdult",
                   test_reduction == 0,
                   year > 2020,
                   overall_condom_usage %in% c(33.9)), 
                   aes(year, mean, group = overall_condom_usage), linewidth = 0.75) +
  geom_ribbon(data = filter(condom_change_summary,scenario == "intervention",
                   pitc_reduction_year == 2025,
                   indicator == "ARTcoverageAdult",
                   year > 2020,
                   test_reduction == 0,
                   overall_condom_usage %in% c(33.9)
         ), aes(ymin = lower_CI, ymax = upper_CI, fill = overall_condom_usage), alpha = 0.10, show.legend = F) +
  xlab("") +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 12), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5)) + 
  ggtitle("Annual ART coverage") +
  scale_y_continuous("ART coverage (%) \n(15+ years) \n", labels =(function(l) {round(l*1e2,1)})) + 
  scale_fill_manual(name = "Condom usage \nin 2035", 
                    breaks = c(14.1, 20.4, 27.6,33.9, 42.4, 50.3, 58.2), 
                    values = c(`14.1` = "#e41a1c", `20.4` = "#377eb8", `27.6` = "#4daf4a", `33.9` = "black", `42.4` = "#984ea3", `50.3` = "#ff7f00", `58.2` = "yellow3"), 
                    labels= c("14.1%", "20.4%", "27.6%", "33.9% (Baseline)", "42.4%", "50.3%", "58.2%"), 
                    aesthetics = c("colour", "fill")) 

```

## Supplementary figure 10d

```{r supp fig 10d, echo=FALSE}
suppfig10d <- condom_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "CondomUsage",
         year > 2020, 
         test_reduction == 0,
         overall_condom_usage %in% c(14.1, 20.4, 27.6, 42.4, 50.3, 58.2)
         ) %>% 
  ggplot(aes(year, mean, group = overall_condom_usage)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = overall_condom_usage), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = overall_condom_usage), show.legend = T) +
  geom_line(data = filter(condom_change_summary,scenario == "intervention",
                   pitc_reduction_year == 2025,
                   indicator == "CondomUsage",
                   test_reduction == 0,
                   year > 2020,
                   overall_condom_usage %in% c(33.9)), 
                   aes(year, mean, group = overall_condom_usage), linewidth = 0.75) +
  geom_ribbon(data = filter(condom_change_summary,scenario == "intervention",
                   pitc_reduction_year == 2025,
                   indicator == "CondomUsage",
                   year > 2020,
                   test_reduction == 0,
                   overall_condom_usage %in% c(33.9)
         ), aes(ymin = lower_CI, ymax = upper_CI, fill = overall_condom_usage), alpha = 0.10, show.legend = F) +
  xlab("") +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 12), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5)) + 
  ggtitle("Annual condom usage") +
  scale_y_continuous("Condom usage (%) \n (15+ years) \n") + 
  scale_fill_manual(name = "Condom usage \nin 2035", 
                    breaks = c(14.1, 20.4, 27.6,33.9, 42.4, 50.3, 58.2), 
                    values = c(`14.1` = "#e41a1c", `20.4` = "#377eb8", `27.6` = "#4daf4a", `33.9` = "black", `42.4` = "#984ea3", `50.3` = "#ff7f00", `58.2` = "yellow3"), 
                    labels= c("14.1%", "20.4%", "27.6%", "33.9% (Baseline)", "42.4%", "50.3%", "58.2%"), 
                    aesthetics = c("colour", "fill")) 

```

## Supplementary figure 10 combined 

```{r supp fig 10, echo = FALSE}

suppfig10 <- ggarrange(suppfig10a, suppfig10b, suppfig10c, suppfig10d, ncol = 2, nrow = 2, common.legend = TRUE, legend = "right", labels = "AUTO")

```

## Supplementary figure 11a 

```{r supp fig11a, echo=FALSE}

temp11a <- art_change_summary %>% 
  mutate(art_coverage_2035 = as.numeric(art_coverage_2035),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(pitc_reduction_year == 2030,
         year == 2100, 
         scenario == "intervention", 
         indicator == "HIVinc15to49")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp11a, test_reduction == i)$art_coverage_2035
  mean_incidence_2100 <- filter(temp11a, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y =  mean_incidence_2100, 
                                    xout = 
                                      seq(min(art_change_summary$art_coverage_2035),
                                          max(art_change_summary$art_coverage_2035),
                                          length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2030, 
           test_reduction = i)
  temp11a <- bind_rows(temp11a, interpolated) 
}

temp11a <- temp11a[which(is.na(temp11a$future_value)),]

suppfig11a <- temp11a %>% 
  ggplot(aes(test_reduction, art_coverage_2035)) + 
  with_blur(
    geom_raster(aes(fill = log(1000*mean)), interpolate = TRUE),
    sigma = 0
  ) +
  geom_contour(aes(z = 1000*mean), color = "black", binwidth = 0.5) + 
  geom_contour(aes(z = 1000*mean), color = "black", breaks = 1, linewidth = 0.80) + 
  geom_text_contour(aes(z = 1000*mean),skip = 0, stroke = 0.1, stroke.colour = "white",label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.767), lty = "dotted") +
  scale_fill_gradient2("",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red",
                       midpoint = 0,
                       labels = (function(l) {round(exp(l),2)})
  ) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  annotate(geom = "text", x=10, y=0.767, label="Baseline", parse = TRUE) + 
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("HIV incidence in 2100\n(per 1000; 15-49 years)")
suppfig11a


```

## Supplementary figure 11b

```{r suppfig11b, echo=FALSE}
temp11b <- cumulative_art_change %>% 
  mutate(art_coverage_2035 = as.numeric(art_coverage_2035),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(indicator == "elimination_year", 
         pitc_reduction_year == 2030, 
         scenario == "intervention") %>% 
  arrange(desc(art_coverage_2035)) 

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp11b, test_reduction == i)$art_coverage_2035
  elimination_year <- filter(temp11b, test_reduction == i)$median
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = elimination_year, xout = seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(median = y) %>% 
    mutate(pitc_reduction_year = 2030, 
           test_reduction = i)
  temp11b <- bind_rows(temp11b, interpolated) 
}

temp11b <- temp11b[which(is.na(temp11b$future_value)),]

temp11b[which(temp11b$median == Inf),] <- NA

suppfig11b <- temp11b %>% 
  mutate(pitc_reduction_year = as.factor(pitc_reduction_year)) %>% 
  filter(pitc_reduction_year == 2030) %>% 
  ggplot(aes(x = test_reduction, y = art_coverage_2035, z = median)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = median), 
                        interpolate = TRUE)
  ) + 
  geom_contour(color = "black") + 
  geom_text_contour(skip = 0, stroke = 0.1, 
                    stroke.colour = "white",check_overlap = TRUE,min.size = 100,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.767), lty = "dotted") +
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 2055) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  annotate(geom = "text", x=90, y=0.767, label="Baseline", parse = TRUE) + 
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("HIV elimination year\n")
suppfig11b

```

## Supplementary figure 11c

``` {r suppfig11c, echo=FALSE}
temp11c <- cumulative_art_change %>% 
  filter(indicator == "NewAdultHIV", 
         scenario == "absolute_dif")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp11c, test_reduction == i)$art_coverage_2035
  mean <- filter(temp11c, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = mean, 
                                    xout =  seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2030, 
           test_reduction = i)
  temp11c <- bind_rows(temp11c, interpolated) 
}

temp11c <- temp11c[which(is.na(temp11c$future_value)),]

suppfig11c <- temp11c %>% 
  ggplot(aes(test_reduction, art_coverage_2035, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(),breaks = c(0, 2.5),show.legend = FALSE, color = "black") + 
  geom_contour(aes(),breaks = c(2.5, 5),show.legend = FALSE, color = "grey") +
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, breaks = c(0, 2.5, 5),skip = 0,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.768), lty = "dotted") +
  annotate(geom = "text", x=50, y=0.768, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional HIV infections\n2030-2080 (millions)")
suppfig11c
```

## Supplementary Figure 11d 
``` {r suppfig11d, echo = FALSE}
temp11d <- cumulative_art_change %>% 
  filter(indicator == "TotalAIDSdeathsadult", 
         scenario == "absolute_dif")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp11d, test_reduction == i)$art_coverage_2035
  mean <- filter(temp11d, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = mean, 
                                    xout = seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2030, 
           test_reduction = i)
  temp11d <- bind_rows(temp11d, interpolated) 
}

temp11d <- temp11d[which(is.na(temp11d$future_value)),]

suppfig11d <- temp11d %>% 
  ggplot(aes(test_reduction, art_coverage_2035, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(),breaks = 0, color = "black", show.legend = FALSE) +
  geom_contour(aes(),breaks = c(0.5, 1, 1.5), color = "grey",show.legend = FALSE) +
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, breaks = c(0,0.5, 1, 1.5), skip = 0,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.768), lty = "dotted") +
  annotate(geom = "text", x=50, y=0.768, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional AIDS deaths\n2030-2080 (millions)")
suppfig11d
```

## Combined supplementary figure 11 
```{r suppfig11, echo=FALSE}
suppfig11 <- ggarrange(suppfig11a, suppfig11b, suppfig11c, suppfig11d, nrow = 2, ncol = 2, labels = "AUTO", align = "v")
suppfig11
ggsave(filename = "figures/suppfig11.pdf", plot = suppfig11, device = "pdf", width = 20, units = "cm")
ggsave(filename = "figures/suppfig11.png", plot = suppfig11, device = "png", width = 20, units = "cm")
```

## Supplementary figure 12a 

```{r supp fig12a, echo=FALSE}

temp12a <- art_change_summary %>% 
  mutate(art_coverage_2035 = as.numeric(art_coverage_2035),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(pitc_reduction_year == 2035,
         year == 2100, 
         scenario == "intervention", 
         indicator == "HIVinc15to49")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp12a, test_reduction == i)$art_coverage_2035
  mean_incidence_2100 <- filter(temp12a, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y =  mean_incidence_2100, 
                                    xout = 
                                      seq(min(art_change_summary$art_coverage_2035),
                                          max(art_change_summary$art_coverage_2035),
                                          length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2035, 
           test_reduction = i)
  temp12a <- bind_rows(temp12a, interpolated) 
}

temp12a <- temp12a[which(is.na(temp12a$future_value)),]

suppfig12a <- temp12a %>% 
  ggplot(aes(test_reduction, art_coverage_2035)) + 
  with_blur(
    geom_raster(aes(fill = log(1000*mean)), interpolate = TRUE),
    sigma = 0
  ) +
  geom_contour(aes(z = 1000*mean), color = "black", binwidth = 0.5) + 
  geom_contour(aes(z = 1000*mean), color = "black", breaks = 1, linewidth = 0.80) + 
  geom_text_contour(aes(z = 1000*mean),skip = 0, stroke = 0.1, stroke.colour = "white",label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.767), lty = "dotted") +
  scale_fill_gradient2("",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red",
                       midpoint = 0,
                       labels = (function(l) {round(exp(l),2)})
  ) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  annotate(geom = "text", x=10, y=0.767, label="Baseline", parse = TRUE) + 
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("HIV incidence in 2100\n(per 1000; 15-49 years)")
suppfig12a


```

## Supplementary figure 12b

```{r suppfig12b, echo=FALSE}
temp12b <- cumulative_art_change %>% 
  mutate(art_coverage_2035 = as.numeric(art_coverage_2035),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(indicator == "elimination_year", 
         pitc_reduction_year == 2035, 
         scenario == "intervention") %>% 
  arrange(desc(art_coverage_2035)) 

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp12b, test_reduction == i)$art_coverage_2035
  elimination_year <- filter(temp12b, test_reduction == i)$median
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = elimination_year, xout = seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(median = y) %>% 
    mutate(pitc_reduction_year = 2035, 
           test_reduction = i)
  temp12b <- bind_rows(temp12b, interpolated) 
}

temp12b <- temp12b[which(is.na(temp12b$future_value)),]

temp12b[which(temp12b$median == Inf),] <- NA

suppfig12b <- temp12b %>% 
  mutate(pitc_reduction_year = as.factor(pitc_reduction_year)) %>% 
  filter(pitc_reduction_year == 2035) %>% 
  ggplot(aes(x = test_reduction, y = art_coverage_2035, z = median)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = median), 
                        interpolate = TRUE)
  ) + 
  geom_contour(color = "black") + 
  geom_text_contour(skip = 0, stroke = 0.1, 
                    stroke.colour = "white",check_overlap = TRUE,min.size = 100,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.767), lty = "dotted") +
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 2055) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  annotate(geom = "text", x=90, y=0.767, label="Baseline", parse = TRUE) + 
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("HIV elimination year\n")
suppfig12b

```

## Supplementary figure 12c

``` {r suppfig12c, echo=FALSE}
temp12c <- cumulative_art_change %>% 
  filter(indicator == "NewAdultHIV", 
         scenario == "absolute_dif")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp12c, test_reduction == i)$art_coverage_2035
  mean <- filter(temp12c, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = mean, 
                                    xout =  seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2035, 
           test_reduction = i)
  temp12c <- bind_rows(temp12c, interpolated) 
}

temp12c <- temp12c[which(is.na(temp12c$future_value)),]

suppfig12c <- temp12c %>% 
  ggplot(aes(test_reduction, art_coverage_2035, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(),breaks = c(0, 2.5),show.legend = FALSE, color = "black") + 
  geom_contour(aes(),breaks = c(2.5, 5),show.legend = FALSE, color = "grey") +
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, breaks = c(0, 2.5, 5),skip = 0,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.768), lty = "dotted") +
  annotate(geom = "text", x=50, y=0.768, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional HIV infections\n2035-2085 (millions)")
suppfig12c
```

## Supplementary Figure 12d 
``` {r suppfig12d, echo = FALSE}
temp12d <- cumulative_art_change %>% 
  filter(indicator == "TotalAIDSdeathsadult", 
         scenario == "absolute_dif")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp12d, test_reduction == i)$art_coverage_2035
  mean <- filter(temp12d, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = mean, 
                                    xout = seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2035, 
           test_reduction = i)
  temp12d <- bind_rows(temp12d, interpolated) 
}

temp12d <- temp12d[which(is.na(temp12d$future_value)),]

suppfig12d <- temp12d %>% 
  ggplot(aes(test_reduction, art_coverage_2035, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(),breaks = 0, color = "black", show.legend = FALSE) +
  geom_contour(aes(),breaks = c(0.5, 1, 1.5), color = "grey",show.legend = FALSE) +
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, breaks = c(0,0.5, 1, 1.5), skip = 0,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.768), lty = "dotted") +
  annotate(geom = "text", x=50, y=0.768, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional AIDS deaths\n2035-2085 (millions)")
suppfig12d
```

## Combined supplementary figure 12 
```{r suppfig12, echo=FALSE}
suppfig12 <- ggarrange(suppfig12a, suppfig12b, suppfig12c, suppfig12d, nrow = 2, ncol = 2, labels = "AUTO", align = "v")
suppfig12
ggsave(filename = "figures/suppfig12.pdf", plot = suppfig12, device = "pdf", width = 20, units = "cm")
ggsave(filename = "figures/suppfig12.png", plot = suppfig12, device = "png", width = 20, units = "cm")
```

## Supplementary figure 13a 

```{r supp fig13a, echo=FALSE}

temp13a <- art_change_summary %>% 
  mutate(art_coverage_2035 = as.numeric(art_coverage_2035),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(pitc_reduction_year == 2040,
         year == 2100, 
         scenario == "intervention", 
         indicator == "HIVinc15to49")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp13a, test_reduction == i)$art_coverage_2035
  mean_incidence_2100 <- filter(temp13a, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y =  mean_incidence_2100, 
                                    xout = 
                                      seq(min(art_change_summary$art_coverage_2035),
                                          max(art_change_summary$art_coverage_2035),
                                          length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2040, 
           test_reduction = i)
  temp13a <- bind_rows(temp13a, interpolated) 
}

temp13a <- temp13a[which(is.na(temp13a$future_value)),]

suppfig13a <- temp13a %>% 
  ggplot(aes(test_reduction, art_coverage_2035)) + 
  with_blur(
    geom_raster(aes(fill = log(1000*mean)), interpolate = TRUE),
    sigma = 0
  ) +
  geom_contour(aes(z = 1000*mean), color = "black", binwidth = 0.5) + 
  geom_contour(aes(z = 1000*mean), color = "black", breaks = 1, linewidth = 0.80) + 
  geom_text_contour(aes(z = 1000*mean),skip = 0, stroke = 0.1, stroke.colour = "white",label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.767), lty = "dotted") +
  scale_fill_gradient2("",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red",
                       midpoint = 0,
                       labels = (function(l) {round(exp(l),2)})
  ) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  annotate(geom = "text", x=10, y=0.767, label="Baseline", parse = TRUE) + 
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("HIV incidence in 2100\n(per 1000; 15-49 years)")
suppfig13a


```

## Supplementary figure 13b

```{r suppfig13b, echo=FALSE}
temp13b <- cumulative_art_change %>% 
  mutate(art_coverage_2035 = as.numeric(art_coverage_2035),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(indicator == "elimination_year", 
         pitc_reduction_year == 2040, 
         scenario == "intervention") %>% 
  arrange(desc(art_coverage_2035)) 

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp13b, test_reduction == i)$art_coverage_2035
  elimination_year <- filter(temp13b, test_reduction == i)$median
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = elimination_year, xout = seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(median = y) %>% 
    mutate(pitc_reduction_year = 2040, 
           test_reduction = i)
  temp13b <- bind_rows(temp13b, interpolated) 
}

temp13b <- temp13b[which(is.na(temp13b$future_value)),]

temp13b[which(temp13b$median == Inf),] <- NA

suppfig13b <- temp13b %>% 
  mutate(pitc_reduction_year = as.factor(pitc_reduction_year)) %>% 
  filter(pitc_reduction_year == 2040) %>% 
  ggplot(aes(x = test_reduction, y = art_coverage_2035, z = median)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = median), 
                        interpolate = TRUE)
  ) + 
  geom_contour(color = "black") + 
  geom_text_contour(skip = 0, stroke = 0.1, 
                    stroke.colour = "white",check_overlap = TRUE,min.size = 100,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.767), lty = "dotted") +
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 2055) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  annotate(geom = "text", x=90, y=0.767, label="Baseline", parse = TRUE) + 
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("HIV elimination year\n")
suppfig13b

```

## Supplementary figure 13c

``` {r suppfig13c, echo=FALSE}
temp13c <- cumulative_art_change %>% 
  filter(indicator == "NewAdultHIV", 
         scenario == "absolute_dif")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp13c, test_reduction == i)$art_coverage_2035
  mean <- filter(temp13c, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = mean, 
                                    xout =  seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2040, 
           test_reduction = i)
  temp13c <- bind_rows(temp13c, interpolated) 
}

temp13c <- temp13c[which(is.na(temp13c$future_value)),]

suppfig13c <- temp13c %>% 
  ggplot(aes(test_reduction, art_coverage_2035, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(),breaks = c(0, 2.5),show.legend = FALSE, color = "black") + 
  geom_contour(aes(),breaks = c(2.5, 5),show.legend = FALSE, color = "grey") +
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, breaks = c(0, 2.5, 5),skip = 0,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.768), lty = "dotted") +
  annotate(geom = "text", x=50, y=0.768, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional HIV infections\n2040-2090 (millions)")
suppfig13c
```

## Supplementary Figure 13d 
``` {r suppfig13d, echo = FALSE}
temp13d <- cumulative_art_change %>% 
  filter(indicator == "TotalAIDSdeathsadult", 
         scenario == "absolute_dif")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp13d, test_reduction == i)$art_coverage_2035
  mean <- filter(temp13d, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = mean, 
                                    xout = seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2040, 
           test_reduction = i)
  temp13d <- bind_rows(temp13d, interpolated) 
}

temp13d <- temp13d[which(is.na(temp13d$future_value)),]

suppfig13d <- temp13d %>% 
  ggplot(aes(test_reduction, art_coverage_2035, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(),breaks = 0, color = "black", show.legend = FALSE) +
  geom_contour(aes(),breaks = c(0.5, 1, 1.5), color = "grey",show.legend = FALSE) +
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, breaks = c(0,0.5, 1, 1.5), skip = 0,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.768), lty = "dotted") +
  annotate(geom = "text", x=50, y=0.768, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional AIDS deaths\n2040-2090 (millions)")
suppfig13d
```

## Combined supplementary figure 13 
```{r suppfig13, echo=FALSE}
suppfig13 <- ggarrange(suppfig13a, suppfig13b, suppfig13c, suppfig13d, nrow = 2, ncol = 2, labels = "AUTO", align = "v")
suppfig13
ggsave(filename = "figures/suppfig13.pdf", plot = suppfig13, device = "pdf", width = 20, units = "cm")
ggsave(filename = "figures/suppfig13.png", plot = suppfig13, device = "png", width = 20, units = "cm")
```

## Supplementary figure 14a 

```{r supp fig14a, echo=FALSE}

temp14a <- art_change_summary %>% 
  mutate(art_coverage_2035 = as.numeric(art_coverage_2035),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(pitc_reduction_year == 2045,
         year == 2100, 
         scenario == "intervention", 
         indicator == "HIVinc15to49")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp14a, test_reduction == i)$art_coverage_2035
  mean_incidence_2100 <- filter(temp14a, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y =  mean_incidence_2100, 
                                    xout = 
                                      seq(min(art_change_summary$art_coverage_2035),
                                          max(art_change_summary$art_coverage_2035),
                                          length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2045, 
           test_reduction = i)
  temp14a <- bind_rows(temp14a, interpolated) 
}

temp14a <- temp14a[which(is.na(temp14a$future_value)),]

suppfig14a <- temp14a %>% 
  ggplot(aes(test_reduction, art_coverage_2035)) + 
  with_blur(
    geom_raster(aes(fill = log(1000*mean)), interpolate = TRUE),
    sigma = 0
  ) +
  geom_contour(aes(z = 1000*mean), color = "black", binwidth = 0.5) + 
  geom_contour(aes(z = 1000*mean), color = "black", breaks = 1, linewidth = 0.80) + 
  geom_text_contour(aes(z = 1000*mean),skip = 0, stroke = 0.1, stroke.colour = "white",label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.767), lty = "dotted") +
  scale_fill_gradient2("",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red",
                       midpoint = 0,
                       labels = (function(l) {round(exp(l),2)})
  ) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  annotate(geom = "text", x=10, y=0.767, label="Baseline", parse = TRUE) + 
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("HIV incidence in 2100\n(per 1000; 15-49 years)")
suppfig14a


```

## Supplementary figure 14b

```{r suppfig14b, echo=FALSE}
temp14b <- cumulative_art_change %>% 
  mutate(art_coverage_2035 = as.numeric(art_coverage_2035),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(indicator == "elimination_year", 
         pitc_reduction_year == 2045, 
         scenario == "intervention") %>% 
  arrange(desc(art_coverage_2035)) 

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp14b, test_reduction == i)$art_coverage_2035
  elimination_year <- filter(temp14b, test_reduction == i)$median
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = elimination_year, xout = seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(median = y) %>% 
    mutate(pitc_reduction_year = 2045, 
           test_reduction = i)
  temp14b <- bind_rows(temp14b, interpolated) 
}

temp14b <- temp14b[which(is.na(temp14b$future_value)),]

temp14b[which(temp14b$median == Inf),] <- NA

suppfig14b <- temp14b %>% 
  mutate(pitc_reduction_year = as.factor(pitc_reduction_year)) %>% 
  filter(pitc_reduction_year == 2045) %>% 
  ggplot(aes(x = test_reduction, y = art_coverage_2035, z = median)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = median), 
                        interpolate = TRUE)
  ) + 
  geom_contour(color = "black") + 
  geom_text_contour(skip = 0, stroke = 0.1, 
                    stroke.colour = "white",check_overlap = TRUE,min.size = 100,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.767), lty = "dotted") +
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 2055) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  annotate(geom = "text", x=90, y=0.767, label="Baseline", parse = TRUE) + 
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("HIV elimination year\n")
suppfig14b

```

## Supplementary figure 14c

``` {r suppfig14c, echo=FALSE}
temp14c <- cumulative_art_change %>% 
  filter(indicator == "NewAdultHIV", 
         scenario == "absolute_dif")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp14c, test_reduction == i)$art_coverage_2035
  mean <- filter(temp14c, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = mean, 
                                    xout =  seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2035, 
           test_reduction = i)
  temp14c <- bind_rows(temp14c, interpolated) 
}

temp14c <- temp14c[which(is.na(temp14c$future_value)),]

suppfig14c <- temp14c %>% 
  ggplot(aes(test_reduction, art_coverage_2035, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(),breaks = c(0, 2.5),show.legend = FALSE, color = "black") + 
  geom_contour(aes(),breaks = c(2.5, 5),show.legend = FALSE, color = "grey") +
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, breaks = c(0, 2.5, 5),skip = 0,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.768), lty = "dotted") +
  annotate(geom = "text", x=50, y=0.768, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional HIV infections\n2045-2095 (millions)")
suppfig14c
```

## Supplementary Figure 14d 
``` {r suppfig14d, echo = FALSE}
temp14d <- cumulative_art_change %>% 
  filter(indicator == "TotalAIDSdeathsadult", 
         scenario == "absolute_dif")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp14d, test_reduction == i)$art_coverage_2035
  mean <- filter(temp14d, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = mean, 
                                    xout = seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2035, 
           test_reduction = i)
  temp14d <- bind_rows(temp14d, interpolated) 
}

temp14d <- temp14d[which(is.na(temp14d$future_value)),]

suppfig14d <- temp14d %>% 
  ggplot(aes(test_reduction, art_coverage_2035, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(),breaks = 0, color = "black", show.legend = FALSE) +
  geom_contour(aes(),breaks = c(0.5, 1, 1.5), color = "grey",show.legend = FALSE) +
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, breaks = c(0,0.5, 1, 1.5), skip = 0,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.768), lty = "dotted") +
  annotate(geom = "text", x=50, y=0.768, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional AIDS deaths\n2045-2095 (millions)")
suppfig14d
```

## Combined supplementary figure 14 
```{r suppfig14, echo=FALSE}
suppfig14 <- ggarrange(suppfig14a, suppfig14b, suppfig14c, suppfig14d, nrow = 2, ncol = 2, labels = "AUTO", align = "v")
suppfig14
ggsave(filename = "figures/suppfig14.pdf", plot = suppfig14, device = "pdf", width = 20, units = "cm")
ggsave(filename = "figures/suppfig14.png", plot = suppfig14, device = "png", width = 20, units = "cm")
```

## Supplementary figure 15a 

```{r supp fig15a, echo=FALSE}

temp15a <- art_change_summary %>% 
  mutate(art_coverage_2035 = as.numeric(art_coverage_2035),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(pitc_reduction_year == 2050,
         year == 2100, 
         scenario == "intervention", 
         indicator == "HIVinc15to49")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp15a, test_reduction == i)$art_coverage_2035
  mean_incidence_2100 <- filter(temp15a, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y =  mean_incidence_2100, 
                                    xout = 
                                      seq(min(art_change_summary$art_coverage_2035),
                                          max(art_change_summary$art_coverage_2035),
                                          length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2050, 
           test_reduction = i)
  temp15a <- bind_rows(temp15a, interpolated) 
}

temp15a <- temp15a[which(is.na(temp15a$future_value)),]

suppfig15a <- temp15a %>% 
  ggplot(aes(test_reduction, art_coverage_2035)) + 
  with_blur(
    geom_raster(aes(fill = log(1000*mean)), interpolate = TRUE),
    sigma = 0
  ) +
  geom_contour(aes(z = 1000*mean), color = "black", binwidth = 0.5) + 
  geom_contour(aes(z = 1000*mean), color = "black", breaks = 1, linewidth = 0.80) + 
  geom_text_contour(aes(z = 1000*mean),skip = 0, stroke = 0.1, stroke.colour = "white",label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.767), lty = "dotted") +
  scale_fill_gradient2("",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red",
                       midpoint = 0,
                       labels = (function(l) {round(exp(l),2)})
  ) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  annotate(geom = "text", x=10, y=0.767, label="Baseline", parse = TRUE) + 
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("HIV incidence in 2100\n(per 1000; 15-49 years)")
suppfig15a


```

## Supplementary figure 15b

```{r suppfig15b, echo=FALSE}
temp15b <- cumulative_art_change %>% 
  mutate(art_coverage_2035 = as.numeric(art_coverage_2035),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(indicator == "elimination_year", 
         pitc_reduction_year == 2050, 
         scenario == "intervention") %>% 
  arrange(desc(art_coverage_2035)) 

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp15b, test_reduction == i)$art_coverage_2035
  elimination_year <- filter(temp15b, test_reduction == i)$median
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = elimination_year, xout = seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(median = y) %>% 
    mutate(pitc_reduction_year = 2050, 
           test_reduction = i)
  temp15b <- bind_rows(temp15b, interpolated) 
}

temp15b <- temp15b[which(is.na(temp15b$future_value)),]

temp15b[which(temp15b$median == Inf),] <- NA

suppfig15b <- temp15b %>% 
  mutate(pitc_reduction_year = as.factor(pitc_reduction_year)) %>% 
  filter(pitc_reduction_year == 2050) %>% 
  ggplot(aes(x = test_reduction, y = art_coverage_2035, z = median)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = median), 
                        interpolate = TRUE)
  ) + 
  geom_contour(color = "black") + 
  geom_text_contour(skip = 0, stroke = 0.1, 
                    stroke.colour = "white",check_overlap = TRUE,min.size = 100,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.767), lty = "dotted") +
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 2055) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  annotate(geom = "text", x=90, y=0.767, label="Baseline", parse = TRUE) + 
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("HIV elimination year\n")
suppfig15b

```

## Supplementary figure 15c

``` {r suppfig15c, echo=FALSE}
temp15c <- cumulative_art_change %>% 
  filter(indicator == "NewAdultHIV", 
         scenario == "absolute_dif")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp15c, test_reduction == i)$art_coverage_2035
  mean <- filter(temp15c, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = mean, 
                                    xout =  seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2035, 
           test_reduction = i)
  temp15c <- bind_rows(temp15c, interpolated) 
}

temp15c <- temp15c[which(is.na(temp15c$future_value)),]

suppfig15c <- temp15c %>% 
  ggplot(aes(test_reduction, art_coverage_2035, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(),breaks = c(0, 2.5),show.legend = FALSE, color = "black") + 
  geom_contour(aes(),breaks = c(2.5, 5),show.legend = FALSE, color = "grey") +
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, breaks = c(0, 2.5, 5),skip = 0,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.768), lty = "dotted") +
  annotate(geom = "text", x=50, y=0.768, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional HIV infections\n2050-2100 (millions)")
suppfig15c
```

## Supplementary Figure 15d 
``` {r suppfig15d, echo = FALSE}
temp15d <- cumulative_art_change %>% 
  filter(indicator == "TotalAIDSdeathsadult", 
         scenario == "absolute_dif")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp15d, test_reduction == i)$art_coverage_2035
  mean <- filter(temp15d, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = mean, 
                                    xout = seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2035, 
           test_reduction = i)
  temp15d <- bind_rows(temp15d, interpolated) 
}

temp15d <- temp15d[which(is.na(temp15d$future_value)),]

suppfig15d <- temp15d %>% 
  ggplot(aes(test_reduction, art_coverage_2035, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(),breaks = 0, color = "black", show.legend = FALSE) +
  geom_contour(aes(),breaks = c(0.5, 1, 1.5), color = "grey",show.legend = FALSE) +
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, breaks = c(0,0.5, 1, 1.5), skip = 0,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.768), lty = "dotted") +
  annotate(geom = "text", x=50, y=0.768, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional AIDS deaths\n2050-2100 (millions)")
suppfig15d
```

## Combined supplementary figure 15 
```{r suppfig15, echo=FALSE}
suppfig15 <- ggarrange(suppfig15a, suppfig15b, suppfig15c, suppfig15d, nrow = 2, ncol = 2, labels = "AUTO", align = "v")
suppfig15
ggsave(filename = "figures/suppfig15.pdf", plot = suppfig15, device = "pdf", width = 20, units = "cm")
ggsave(filename = "figures/suppfig15.png", plot = suppfig15, device = "png", width = 20, units = "cm")
```

## Supplementary figure 16a

```{r suppfig16a, echo=FALSE}
temp16a <- condom_change_summary %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(pitc_reduction_year == 2030,
         year == 2100, 
         scenario == "intervention", 
         indicator == "HIVinc15to49")

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp16a, test_reduction == i)$overall_condom_usage
  mean_incidence_2100 <- filter(temp16a, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean_incidence_2100, 
                                    xout = seq(min(condom_change_summary$overall_condom_usage), max(condom_change_summary$overall_condom_usage),length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2030, 
           test_reduction = i)
  
  
  temp16a <- bind_rows(temp16a, interpolated) 
}
temp16a <- temp16a[which(is.na(temp16a$future_value)),]

suppfig16a <- temp16a %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction), 
         log_incidence = log(1000*mean)) %>% 
  ggplot(aes(x = test_reduction, y = overall_condom_usage)) + 
  with_blur(geom_raster(aes(fill = as.numeric(log_incidence)), 
                        interpolate = TRUE),sigma=0) + 
  geom_contour(aes(z = 1000*mean), 
               color = "black", breaks = c(0.5, 1, 2, 3, 4, 5, 6, 7, 8, 9)) + 
  geom_contour(aes(z = 1000*mean), 
               color = "black", breaks = 1, linewidth = 0.80) +
  geom_text_contour(aes(z = 1000*mean),
                    skip = 0, stroke = 0.1, 
                    stroke.colour = "white",
                    breaks = c(0.5, 1, 2, 3, 4, 5, 6, 7, 8, 9), 
                    label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted")+
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red",
                       midpoint = 0,
                       labels = (function(l) {round(exp(l),2)})
  ) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("General HTC reduced from 2030") +
  annotate(geom = "text", x = 15, y = 33.9, label = "Baseline")
suppfig16a
```

## Supplementary 16b

```{r suppfig16b, echo = FALSE}

temp16b <- condom_change_cumulative %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(indicator == "elimination_year", 
         pitc_reduction_year == 2030, 
         scenario == "intervention") %>% 
  arrange(desc(overall_condom_usage)) 

temp16b[which(temp16b$median == Inf),] <- NA

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp16b, test_reduction == i)$overall_condom_usage
  elimination_year <- filter(temp16b, test_reduction == i)$median
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = elimination_year, seq(min(condom_change_cumulative$overall_condom_usage), max(condom_change_cumulative$overall_condom_usage),length.out = 1000), 
                                    method = "linear", na.rm = FALSE)) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(median = y) %>% 
    mutate(pitc_reduction_year = 2030, 
           test_reduction = i)
  temp16b <- bind_rows(temp16b, interpolated) 
}

temp16b <- temp16b[which(is.na(temp16b$future_value)),]

temp16b[which(temp16b$median == Inf),] <- NA

suppfig16b <- temp16b %>% 
  ggplot(aes(x = test_reduction, y = overall_condom_usage)) +
  with_blur(geom_raster(aes(fill = median), interpolate = TRUE, na.rm = TRUE), sigma = 0) +
  geom_contour(aes(z = median),color = "black") + 
  geom_text_contour(aes(z = median), skip = 0, 
                    stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, 
                    min.size = 100, 
                    label.placer = label_placer_fraction())+
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 2055) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted")+
  annotate(geom = "text", x=90, y=33.9, label="Baseline", parse = TRUE) + 
  ggtitle("General HTC reduced from 2030")
suppfig16b
```

## Supplementary figure 16c

```{r suppfig16c, echo=FALSE}

temp16c <- condom_change_cumulative %>% 
  filter(indicator == "NewAdultHIV", 
         scenario == "absolute_dif", 
         pitc_reduction_year == 2030)

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp16c, test_reduction == i)$overall_condom_usage
  mean <- filter(temp16c, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean, 
                                    xout = seq(min(condom_change_cumulative$overall_condom_usage),
                                               max(condom_change_cumulative$overall_condom_usage), length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2030, 
           test_reduction = i)
  temp16c <- bind_rows(temp16c, interpolated) 
}

temp16c <- temp16c[which(is.na(temp16c$future_value)),]

suppfig16c <- temp16c %>% 
ggplot(aes(test_reduction, overall_condom_usage, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(), color = "black",breaks = 0,show.legend = FALSE) + 
  geom_contour(aes(), color = "grey",breaks = c(2.5, 5, 7.5, 10),show.legend = FALSE) + 
  geom_text_contour(stroke = 0.1, 
                    stroke.colour = "white",
                    check_overlap = TRUE, 
                    breaks = c(0,2.5, 5, 7.5, 10),
                    label.placer = label_placer_fraction(), skip = 0) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted") +
  annotate(geom = "text", x=50, y=33.9, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional HIV infections\n2030-2080 (millions)")
suppfig16c


```

## Supplementary figure 16d

```{r suppfig16d, echo = FALSE}

temp16d <- condom_change_cumulative %>% 
  filter(indicator == "TotalAIDSdeathsadult", 
         scenario == "absolute_dif", 
         pitc_reduction_year == 2030)

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp16d, test_reduction == i)$overall_condom_usage
  mean <- filter(temp16d, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean, 
                                    xout = seq(min(condom_change_cumulative$overall_condom_usage), max(condom_change_cumulative$overall_condom_usage), length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2030, 
           test_reduction = i)
  temp16d <- bind_rows(temp16d, interpolated) 
}

temp16d <- temp16d[which(is.na(temp16d$future_value)),]

suppfig16d <- temp16d %>% 
  ggplot(aes(test_reduction, overall_condom_usage, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(), color = "black",breaks = 0,show.legend = FALSE) + 
  geom_contour(aes(), color = "grey",breaks = c(0.5, 1.0, 1.5, 2.0),show.legend = FALSE) + 
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, 
                    breaks = c(0, 0.5, 1.0, 1.5, 2.0), skip = 0,
                    label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted") +
  annotate(geom = "text", x=50, y=33.9, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) +
  ggtitle("Additional AIDS deaths\n2030-2080 (millions)")
suppfig16d

```

### Combined Supplemntary Figure 16

``` {r suppfig16, echo = FALSE}
suppfig16<- ggarrange(suppfig16a, suppfig16b, suppfig16c, suppfig16d, nrow = 2, ncol = 2, legend = "right", labels = "AUTO")
suppfig16
ggsave(filename = "figures/suppfig16.pdf", plot = suppfig16, device = "pdf", width = 20, units = "cm")
ggsave(filename = "figures/suppfig16.png", plot = suppfig16, device = "png", width = 20, units = "cm")
```


## Supplementary figure 17a

```{r suppfig17a, echo=FALSE}
temp17a <- condom_change_summary %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(pitc_reduction_year == 2035,
         year == 2100, 
         scenario == "intervention", 
         indicator == "HIVinc15to49")

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp17a, test_reduction == i)$overall_condom_usage
  mean_incidence_2100 <- filter(temp17a, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean_incidence_2100, 
                                    xout = seq(min(condom_change_summary$overall_condom_usage), max(condom_change_summary$overall_condom_usage),length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2035, 
           test_reduction = i)
  
  
  temp17a <- bind_rows(temp17a, interpolated) 
}
temp17a <- temp17a[which(is.na(temp17a$future_value)),]

suppfig17a <- temp17a %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction), 
         log_incidence = log(1000*mean)) %>% 
  ggplot(aes(x = test_reduction, y = overall_condom_usage)) + 
  with_blur(geom_raster(aes(fill = as.numeric(log_incidence)), 
                        interpolate = TRUE),sigma=0) + 
  geom_contour(aes(z = 1000*mean), 
               color = "black", breaks = c(0.5, 1, 2, 3, 4, 5, 6, 7, 8, 9)) + 
  geom_contour(aes(z = 1000*mean), 
               color = "black", breaks = 1, linewidth = 0.80) +
  geom_text_contour(aes(z = 1000*mean),
                    skip = 0, stroke = 0.1, 
                    stroke.colour = "white",
                    breaks = c(0.5, 1, 2, 3, 4, 5, 6, 7, 8, 9), 
                    label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted")+
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red",
                       midpoint = 0,
                       labels = (function(l) {round(exp(l),2)})
  ) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("General HTC reduced from 2035") +
  annotate(geom = "text", x = 15, y = 33.9, label = "Baseline")
suppfig17a
```

## Supplementary 17b

```{r suppfig17b, echo = FALSE}

temp17b <- condom_change_cumulative %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(indicator == "elimination_year", 
         pitc_reduction_year == 2035, 
         scenario == "intervention") %>% 
  arrange(desc(overall_condom_usage)) 

temp17b[which(temp17b$median == Inf),] <- NA

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp17b, test_reduction == i)$overall_condom_usage
  elimination_year <- filter(temp17b, test_reduction == i)$median
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = elimination_year, seq(min(condom_change_cumulative$overall_condom_usage), max(condom_change_cumulative$overall_condom_usage),length.out = 1000), 
                                    method = "linear", na.rm = FALSE)) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(median = y) %>% 
    mutate(pitc_reduction_year = 2035, 
           test_reduction = i)
  temp17b <- bind_rows(temp17b, interpolated) 
}

temp17b <- temp17b[which(is.na(temp17b$future_value)),]

temp17b[which(temp17b$median == Inf),] <- NA

suppfig17b <- temp17b %>% 
  ggplot(aes(x = test_reduction, y = overall_condom_usage)) +
  with_blur(geom_raster(aes(fill = median), interpolate = TRUE, na.rm = TRUE), sigma = 0) +
  geom_contour(aes(z = median),color = "black") + 
  geom_text_contour(aes(z = median), skip = 0, 
                    stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, 
                    min.size = 100, 
                    label.placer = label_placer_fraction())+
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 2055) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted")+
  annotate(geom = "text", x=90, y=33.9, label="Baseline", parse = TRUE) + 
  ggtitle("General HTC reduced from 2035")
suppfig17b
```

## Supplementary figure 17c

```{r suppfig17c, echo=FALSE}

temp17c <- condom_change_cumulative %>% 
  filter(indicator == "NewAdultHIV", 
         scenario == "absolute_dif",
         pitc_reduction_year == 2035)

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp17c, test_reduction == i)$overall_condom_usage
  mean <- filter(temp17c, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean, 
                                    xout = seq(min(condom_change_cumulative$overall_condom_usage),
                                               max(condom_change_cumulative$overall_condom_usage), length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2035, 
           test_reduction = i)
  temp17c <- bind_rows(temp17c, interpolated) 
}

temp17c <- temp17c[which(is.na(temp17c$future_value)),]

suppfig17c <- temp17c %>% 
ggplot(aes(test_reduction, overall_condom_usage, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(), color = "black",breaks = 0,show.legend = FALSE) + 
  geom_contour(aes(), color = "grey",breaks = c(2.5, 5, 7.5, 10),show.legend = FALSE) + 
  geom_text_contour(stroke = 0.1, 
                    stroke.colour = "white",
                    check_overlap = TRUE, 
                    breaks = c(0,2.5, 5, 7.5, 10),
                    label.placer = label_placer_fraction(), skip = 0) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted") +
  annotate(geom = "text", x=50, y=33.9, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional HIV infections\n2035-2085 (millions)")
suppfig17c


```

## Supplementary figure 17d

```{r suppfig17d, echo = FALSE}

temp17d <- condom_change_cumulative %>% 
  filter(indicator == "TotalAIDSdeathsadult", 
         scenario == "absolute_dif",
         pitc_reduction_year == 2035)

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp17d, test_reduction == i)$overall_condom_usage
  mean <- filter(temp17d, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean, 
                                    xout = seq(min(condom_change_cumulative$overall_condom_usage), max(condom_change_cumulative$overall_condom_usage), length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2035, 
           test_reduction = i)
  temp17d <- bind_rows(temp17d, interpolated) 
}

temp17d <- temp17d[which(is.na(temp17d$future_value)),]

suppfig17d <- temp17d %>% 
  ggplot(aes(test_reduction, overall_condom_usage, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(), color = "black",breaks = 0,show.legend = FALSE) + 
  geom_contour(aes(), color = "grey",breaks = c(0.5, 1.0, 1.5, 2.0),show.legend = FALSE) + 
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, 
                    breaks = c(0, 0.5, 1.0, 1.5, 2.0), skip = 0,
                    label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted") +
  annotate(geom = "text", x=50, y=33.9, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) +
  ggtitle("Additional AIDS deaths\n2035-2085 (millions)")
suppfig17d

```

### Combined Supplemntary Figure 17

``` {r suppfig17, echo = FALSE}
suppfig17<- ggarrange(suppfig17a, suppfig17b, suppfig17c, suppfig17d, nrow = 2, ncol = 2, legend = "right", labels = "AUTO")
suppfig17
ggsave(filename = "figures/suppfig17.pdf", plot = suppfig17, device = "pdf", width = 20, units = "cm")
ggsave(filename = "figures/suppfig17.png", plot = suppfig17, device = "png", width = 20, units = "cm")
```

## Supplementary figure 18a

```{r suppfig18a, echo=FALSE}
temp18a <- condom_change_summary %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(pitc_reduction_year == 2040,
         year == 2100, 
         scenario == "intervention", 
         indicator == "HIVinc15to49")

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp18a, test_reduction == i)$overall_condom_usage
  mean_incidence_2100 <- filter(temp18a, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean_incidence_2100, 
                                    xout = seq(min(condom_change_summary$overall_condom_usage), max(condom_change_summary$overall_condom_usage),length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2040, 
           test_reduction = i)
  
  
  temp18a <- bind_rows(temp18a, interpolated) 
}
temp18a <- temp18a[which(is.na(temp18a$future_value)),]

suppfig18a <- temp18a %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction), 
         log_incidence = log(1000*mean)) %>% 
  ggplot(aes(x = test_reduction, y = overall_condom_usage)) + 
  with_blur(geom_raster(aes(fill = as.numeric(log_incidence)), 
                        interpolate = TRUE),sigma=0) + 
  geom_contour(aes(z = 1000*mean), 
               color = "black", breaks = c(0.5, 1, 2, 3, 4, 5, 6, 7, 8, 9)) + 
  geom_contour(aes(z = 1000*mean), 
               color = "black", breaks = 1, linewidth = 0.80) +
  geom_text_contour(aes(z = 1000*mean),
                    skip = 0, stroke = 0.1, 
                    stroke.colour = "white",
                    breaks = c(0.5, 1, 2, 3, 4, 5, 6, 7, 8, 9), 
                    label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted")+
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red",
                       midpoint = 0,
                       labels = (function(l) {round(exp(l),2)})
  ) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("General HTC reduced from 2040") +
  annotate(geom = "text", x = 15, y = 33.9, label = "Baseline")
suppfig18a
```

## Supplementary 18b

```{r suppfig18b, echo = FALSE}

temp18b <- condom_change_cumulative %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(indicator == "elimination_year", 
         pitc_reduction_year == 2040, 
         scenario == "intervention") %>% 
  arrange(desc(overall_condom_usage)) 

temp18b[which(temp18b$median == Inf),] <- NA

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp18b, test_reduction == i)$overall_condom_usage
  elimination_year <- filter(temp18b, test_reduction == i)$median
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = elimination_year, seq(min(condom_change_cumulative$overall_condom_usage), max(condom_change_cumulative$overall_condom_usage),length.out = 1000), 
                                    method = "linear", na.rm = FALSE)) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(median = y) %>% 
    mutate(pitc_reduction_year = 2040, 
           test_reduction = i)
  temp18b <- bind_rows(temp18b, interpolated) 
}

temp18b <- temp18b[which(is.na(temp18b$future_value)),]

temp18b[which(temp18b$median == Inf),] <- NA

suppfig18b <- temp18b %>% 
  ggplot(aes(x = test_reduction, y = overall_condom_usage)) +
  with_blur(geom_raster(aes(fill = median), interpolate = TRUE, na.rm = TRUE), sigma = 0) +
  geom_contour(aes(z = median),color = "black") + 
  geom_text_contour(aes(z = median), skip = 0, 
                    stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, 
                    min.size = 100, 
                    label.placer = label_placer_fraction())+
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 2055) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted")+
  annotate(geom = "text", x=90, y=33.9, label="Baseline", parse = TRUE) + 
  ggtitle("General HTC reduced from 2040")
suppfig18b
```

## Supplementary figure 18c

```{r suppfig18c, echo=FALSE}

temp18c <- condom_change_cumulative %>% 
  filter(indicator == "NewAdultHIV", 
         scenario == "absolute_dif",
         pitc_reduction_year == 2040)

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp18c, test_reduction == i)$overall_condom_usage
  mean <- filter(temp18c, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean, 
                                    xout = seq(min(condom_change_cumulative$overall_condom_usage),
                                               max(condom_change_cumulative$overall_condom_usage), length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2040, 
           test_reduction = i)
  temp18c <- bind_rows(temp18c, interpolated) 
}

temp18c <- temp18c[which(is.na(temp18c$future_value)),]

suppfig18c <- temp18c %>% 
ggplot(aes(test_reduction, overall_condom_usage, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(), color = "black",breaks = 0,show.legend = FALSE) + 
  geom_contour(aes(), color = "grey",breaks = c(2.5, 5, 7.5, 10),show.legend = FALSE) + 
  geom_text_contour(stroke = 0.1, 
                    stroke.colour = "white",
                    check_overlap = TRUE, 
                    breaks = c(0,2.5, 5, 7.5, 10),
                    label.placer = label_placer_fraction(), skip = 0) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted") +
  annotate(geom = "text", x=50, y=33.9, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional HIV infections\n2040-2090 (millions)")
suppfig18c


```

## Supplementary figure 18d

```{r suppfig18d, echo = FALSE}

temp18d <- condom_change_cumulative %>% 
  filter(indicator == "TotalAIDSdeathsadult", 
         scenario == "absolute_dif",
         pitc_reduction_year == 2040)

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp18d, test_reduction == i)$overall_condom_usage
  mean <- filter(temp18d, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean, 
                                    xout = seq(min(condom_change_cumulative$overall_condom_usage), max(condom_change_cumulative$overall_condom_usage), length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2040, 
           test_reduction = i)
  temp18d <- bind_rows(temp18d, interpolated) 
}

temp18d <- temp18d[which(is.na(temp18d$future_value)),]

suppfig18d <- temp18d %>% 
  ggplot(aes(test_reduction, overall_condom_usage, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(), color = "black",breaks = 0,show.legend = FALSE) + 
  geom_contour(aes(), color = "grey",breaks = c(0.5, 1.0, 1.5, 2.0),show.legend = FALSE) + 
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, 
                    breaks = c(0, 0.5, 1.0, 1.5, 2.0), skip = 0,
                    label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted") +
  annotate(geom = "text", x=50, y=33.9, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) +
  ggtitle("Additional AIDS deaths\n2040-2090 (millions)")
suppfig18d

```

### Combined Supplemntary Figure 18

``` {r suppfig18, echo = FALSE}
suppfig18<- ggarrange(suppfig18a, suppfig18b, suppfig18c, suppfig18d, nrow = 2, ncol = 2, legend = "right", labels = "AUTO")
suppfig18
ggsave(filename = "figures/suppfig18.pdf", plot = suppfig18, device = "pdf", width = 20, units = "cm")
ggsave(filename = "figures/suppfig18.png", plot = suppfig18, device = "png", width = 20, units = "cm")
```


## Supplementary figure 19a

```{r suppfig19a, echo=FALSE}
temp19a <- condom_change_summary %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(pitc_reduction_year == 2045,
         year == 2100, 
         scenario == "intervention", 
         indicator == "HIVinc15to49")

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp19a, test_reduction == i)$overall_condom_usage
  mean_incidence_2100 <- filter(temp19a, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean_incidence_2100, 
                                    xout = seq(min(condom_change_summary$overall_condom_usage), max(condom_change_summary$overall_condom_usage),length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2045, 
           test_reduction = i)
  
  
  temp19a <- bind_rows(temp19a, interpolated) 
}
temp19a <- temp19a[which(is.na(temp19a$future_value)),]

suppfig19a <- temp19a %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction), 
         log_incidence = log(1000*mean)) %>% 
  ggplot(aes(x = test_reduction, y = overall_condom_usage)) + 
  with_blur(geom_raster(aes(fill = as.numeric(log_incidence)), 
                        interpolate = TRUE),sigma=0) + 
  geom_contour(aes(z = 1000*mean), 
               color = "black", breaks = c(0.5, 1, 2, 3, 4, 5, 6, 7, 8, 9)) + 
  geom_contour(aes(z = 1000*mean), 
               color = "black", breaks = 1, linewidth = 0.80) +
  geom_text_contour(aes(z = 1000*mean),
                    skip = 0, stroke = 0.1, 
                    stroke.colour = "white",
                    breaks = c(0.5, 1, 2, 3, 4, 5, 6, 7, 8, 9), 
                    label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted")+
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red",
                       midpoint = 0,
                       labels = (function(l) {round(exp(l),2)})
  ) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("General HTC reduced from 2045") +
  annotate(geom = "text", x = 15, y = 33.9, label = "Baseline")
suppfig19a
```

## Supplementary 19b

```{r suppfig19b, echo = FALSE}

temp19b <- condom_change_cumulative %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(indicator == "elimination_year", 
         pitc_reduction_year == 2045, 
         scenario == "intervention") %>% 
  arrange(desc(overall_condom_usage)) 

temp19b[which(temp19b$median == Inf),] <- NA

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp19b, test_reduction == i)$overall_condom_usage
  elimination_year <- filter(temp19b, test_reduction == i)$median
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = elimination_year, seq(min(condom_change_cumulative$overall_condom_usage), max(condom_change_cumulative$overall_condom_usage),length.out = 1000), 
                                    method = "linear", na.rm = FALSE)) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(median = y) %>% 
    mutate(pitc_reduction_year = 2045, 
           test_reduction = i)
  temp19b <- bind_rows(temp19b, interpolated) 
}

temp19b <- temp19b[which(is.na(temp19b$future_value)),]

temp19b[which(temp19b$median == Inf),] <- NA

suppfig19b <- temp19b %>% 
  ggplot(aes(x = test_reduction, y = overall_condom_usage)) +
  with_blur(geom_raster(aes(fill = median), interpolate = TRUE, na.rm = TRUE), sigma = 0) +
  geom_contour(aes(z = median),color = "black") + 
  geom_text_contour(aes(z = median), skip = 0, 
                    stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, 
                    min.size = 20, 
                    label.placer = label_placer_fraction())+
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 2055) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted")+
  annotate(geom = "text", x=90, y=33.9, label="Baseline", parse = TRUE) + 
  ggtitle("General HTC reduced from 2045")
suppfig19b
```

## Supplementary figure 19c

```{r suppfig19c, echo=FALSE}

temp19c <- condom_change_cumulative %>% 
  filter(indicator == "NewAdultHIV", 
         scenario == "absolute_dif",
         pitc_reduction_year == 2045)

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp19c, test_reduction == i)$overall_condom_usage
  mean <- filter(temp19c, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean, 
                                    xout = seq(min(condom_change_cumulative$overall_condom_usage),
                                               max(condom_change_cumulative$overall_condom_usage), length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2045, 
           test_reduction = i)
  temp19c <- bind_rows(temp19c, interpolated) 
}

temp19c <- temp19c[which(is.na(temp19c$future_value)),]

suppfig19c <- temp19c %>% 
ggplot(aes(test_reduction, overall_condom_usage, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(), color = "black",breaks = 0,show.legend = FALSE) + 
  geom_contour(aes(), color = "grey",breaks = c(2.5, 5, 7.5, 10),show.legend = FALSE) + 
  geom_text_contour(stroke = 0.1, 
                    stroke.colour = "white",
                    check_overlap = TRUE, 
                    breaks = c(0,2.5, 5, 7.5, 10),
                    label.placer = label_placer_fraction(), skip = 0) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted") +
  annotate(geom = "text", x=50, y=33.9, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional HIV infections\n2045-2095 (millions)")
suppfig19c


```

## Supplementary figure 19d

```{r suppfig19d, echo = FALSE}

temp19d <- condom_change_cumulative %>% 
  filter(indicator == "TotalAIDSdeathsadult", 
         scenario == "absolute_dif",
         pitc_reduction_year == 2045)

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp19d, test_reduction == i)$overall_condom_usage
  mean <- filter(temp19d, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean, 
                                    xout = seq(min(condom_change_cumulative$overall_condom_usage), max(condom_change_cumulative$overall_condom_usage), length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2045, 
           test_reduction = i)
  temp19d <- bind_rows(temp19d, interpolated) 
}

temp19d <- temp19d[which(is.na(temp19d$future_value)),]

suppfig19d <- temp19d %>% 
  ggplot(aes(test_reduction, overall_condom_usage, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(), color = "black",breaks = 0,show.legend = FALSE) + 
  geom_contour(aes(), color = "grey",breaks = c(0.5, 1.0, 1.5, 2.0),show.legend = FALSE) + 
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, 
                    breaks = c(0, 0.5, 1.0, 1.5, 2.0), skip = 0,
                    label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted") +
  annotate(geom = "text", x=50, y=33.9, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) +
  ggtitle("Additional AIDS deaths\n2045-2095 (millions)")
suppfig19d

```

### Combined Supplemntary Figure 19

``` {r suppfig19, echo = FALSE}
suppfig19<- ggarrange(suppfig19a, suppfig19b, suppfig19c, suppfig19d, nrow = 2, ncol = 2, legend = "right", labels = "AUTO")
suppfig19
ggsave(filename = "figures/suppfig19.pdf", plot = suppfig19, device = "pdf", width = 20, units = "cm")
ggsave(filename = "figures/suppfig19.png", plot = suppfig19, device = "png", width = 20, units = "cm")
```

## Supplementary figure 20a

```{r suppfig20a, echo=FALSE}
temp20a <- condom_change_summary %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(pitc_reduction_year == 2050,
         year == 2100, 
         scenario == "intervention", 
         indicator == "HIVinc15to49")

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp20a, test_reduction == i)$overall_condom_usage
  mean_incidence_2100 <- filter(temp20a, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean_incidence_2100, 
                                    xout = seq(min(condom_change_summary$overall_condom_usage), max(condom_change_summary$overall_condom_usage),length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2050, 
           test_reduction = i)
  
  
  temp20a <- bind_rows(temp20a, interpolated) 
}
temp20a <- temp20a[which(is.na(temp20a$future_value)),]

suppfig20a <- temp20a %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction), 
         log_incidence = log(1000*mean)) %>% 
  ggplot(aes(x = test_reduction, y = overall_condom_usage)) + 
  with_blur(geom_raster(aes(fill = as.numeric(log_incidence)), 
                        interpolate = TRUE),sigma=0) + 
  geom_contour(aes(z = 1000*mean), 
               color = "black", breaks = c(0.5, 1, 2, 3, 4, 5, 6, 7, 8, 9)) + 
  geom_contour(aes(z = 1000*mean), 
               color = "black", breaks = 1, linewidth = 0.80) +
  geom_text_contour(aes(z = 1000*mean),
                    skip = 0, stroke = 0.1, 
                    stroke.colour = "white",
                    breaks = c(0.5, 1, 2, 3, 4, 5, 6, 7, 8, 9), 
                    label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted")+
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red",
                       midpoint = 0,
                       labels = (function(l) {round(exp(l),2)})
  ) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("General HTC reduced from 2050") +
  annotate(geom = "text", x = 15, y = 33.9, label = "Baseline")
suppfig20a
```

## Supplementary 20b

```{r suppfig20b, echo = FALSE}

temp20b <- condom_change_cumulative %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(indicator == "elimination_year", 
         pitc_reduction_year == 2050, 
         scenario == "intervention") %>% 
  arrange(desc(overall_condom_usage)) 

temp20b[which(temp20b$median == Inf),] <- NA

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp20b, test_reduction == i)$overall_condom_usage
  elimination_year <- filter(temp20b, test_reduction == i)$median
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = elimination_year, seq(min(condom_change_cumulative$overall_condom_usage), max(condom_change_cumulative$overall_condom_usage),length.out = 1000), 
                                    method = "linear", na.rm = FALSE)) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(median = y) %>% 
    mutate(pitc_reduction_year = 2050, 
           test_reduction = i)
  temp20b <- bind_rows(temp20b, interpolated) 
}

temp20b <- temp20b[which(is.na(temp20b$future_value)),]

temp20b[which(temp20b$median == Inf),] <- NA

suppfig20b <- temp20b %>% 
  ggplot(aes(x = test_reduction, y = overall_condom_usage)) +
  with_blur(geom_raster(aes(fill = median), interpolate = TRUE, na.rm = TRUE), sigma = 0) +
  geom_contour(aes(z = median),color = "black") + 
  geom_text_contour(aes(z = median), skip = 0, 
                    stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, 
                    min.size = 20, 
                    label.placer = label_placer_fraction())+
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 2055) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted")+
  annotate(geom = "text", x=90, y=33.9, label="Baseline", parse = TRUE) + 
  ggtitle("General HTC reduced from 2050")
suppfig20b
```

## Supplementary figure 20c

```{r suppfig20c, echo=FALSE}

temp20c <- condom_change_cumulative %>% 
  filter(indicator == "NewAdultHIV", 
         scenario == "absolute_dif",
         pitc_reduction_year == 2050)

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp20c, test_reduction == i)$overall_condom_usage
  mean <- filter(temp20c, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean, 
                                    xout = seq(min(condom_change_cumulative$overall_condom_usage),
                                               max(condom_change_cumulative$overall_condom_usage), length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2050, 
           test_reduction = i)
  temp20c <- bind_rows(temp20c, interpolated) 
}

temp20c <- temp20c[which(is.na(temp20c$future_value)),]

suppfig20c <- temp20c %>% 
ggplot(aes(test_reduction, overall_condom_usage, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(), color = "black",breaks = 0,show.legend = FALSE) + 
  geom_contour(aes(), color = "grey",breaks = c(2.5, 5, 7.5, 10),show.legend = FALSE) + 
  geom_text_contour(stroke = 0.1, 
                    stroke.colour = "white",
                    check_overlap = TRUE, 
                    breaks = c(0,2.5, 5, 7.5, 10),
                    label.placer = label_placer_fraction(), skip = 0) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted") +
  annotate(geom = "text", x=50, y=33.9, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional HIV infections\n2050-2100 (millions)")
suppfig20c

```

## Supplementary figure 20d

```{r suppfig20d, echo = FALSE}

temp20d <- condom_change_cumulative %>% 
  filter(indicator == "TotalAIDSdeathsadult", 
         scenario == "absolute_dif",
         pitc_reduction_year == 2050)

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp20d, test_reduction == i)$overall_condom_usage
  mean <- filter(temp20d, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean, 
                                    xout = seq(min(condom_change_cumulative$overall_condom_usage), max(condom_change_cumulative$overall_condom_usage), length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2050, 
           test_reduction = i)
  temp20d <- bind_rows(temp20d, interpolated) 
}

temp20d <- temp20d[which(is.na(temp20d$future_value)),]

suppfig20d <- temp20d %>% 
  ggplot(aes(test_reduction, overall_condom_usage, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(), color = "black",breaks = 0,show.legend = FALSE) + 
  geom_contour(aes(), color = "grey",breaks = c(0.5, 1.0, 1.5, 2.0),show.legend = FALSE) + 
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, 
                    breaks = c(0, 0.5, 1.0, 1.5, 2.0), skip = 0,
                    label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted") +
  annotate(geom = "text", x=50, y=33.9, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTC reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) +
  ggtitle("Additional AIDS deaths\n2050-2100 (millions)")
suppfig20d

```

### Combined Supplemntary Figure 20

``` {r suppfig20, echo = FALSE}
suppfig20<- ggarrange(suppfig20a, suppfig20b, suppfig20c, suppfig20d, nrow = 2, ncol = 2, legend = "right", labels = "AUTO")
suppfig20
ggsave(filename = "figures/suppfig20.pdf", plot = suppfig20, device = "pdf", width = 20, units = "cm")
ggsave(filename = "figures/suppfig20.png", plot = suppfig20, device = "png", width = 20, units = "cm")
```

### HIV incidence in 2100 by testing reduction year - condom change

```{r suppfig21, echo = FALSE}

suppfig21<- ggarrange(fig4a, suppfig16a, suppfig17a, suppfig18a, suppfig19a, suppfig20a, nrow = 3, ncol = 2, legend = "right", labels = "AUTO", common.legend = TRUE) 
suppfig21 <- annotate_figure(suppfig21, top = text_grob("HIV incidence in 2100 (per 1000; 15-49 years)", 
               color = "black", face = "bold", size = 15))
ggsave(filename = "figures/suppfig21.pdf", plot = suppfig21, device = "pdf", width = 20, height = 29, units = "cm")
ggsave(filename = "figures/suppfig21.png", plot = suppfig21, device = "png", width = 20, height = 29, units = "cm")

```

### Elimination year by testing reduction year - condom change

```{r suppfig22, echo = FALSE}

suppfig22<- ggarrange(fig4b, suppfig16b, suppfig17b, suppfig18b, suppfig19b, suppfig20b, nrow = 3, ncol = 2, legend = "right", labels = "AUTO", common.legend = TRUE) 
suppfig22 <- annotate_figure(suppfig22, top = text_grob("HIV elimination year", 
               color = "black", face = "bold", size = 15))
suppfig22
ggsave(filename = "figures/suppfig22.pdf", plot = suppfig22, device = "pdf", width = 20, height = 29, units = "cm")
ggsave(filename = "figures/suppfig22.png", plot = suppfig22, device = "png", width = 20, height = 29, units = "cm")

```

### Additional infections by testing reduction year - condom change

```{r suppfig23, echo = FALSE}

suppfig23<- ggarrange(fig4c, suppfig16c, suppfig17c, suppfig18c, suppfig19c, suppfig20c, nrow = 3, ncol = 2, legend = "right", labels = "AUTO", common.legend = TRUE) 
suppfig23 <- annotate_figure(suppfig23, top = text_grob("Additional HIV infections (millions)", 
               color = "black", face = "bold", size = 15))
suppfig23
ggsave(filename = "figures/suppfig23.pdf", plot = suppfig23, device = "pdf", width = 20, height = 29, units = "cm")
ggsave(filename = "figures/suppfig23.png", plot = suppfig23, device = "png", width = 20, height = 29, units = "cm")

```

### Additional infections by testing reduction year - condom change

```{r suppfig24, echo = FALSE}

suppfig24<- ggarrange(fig4d, suppfig16d, suppfig17d, suppfig18d, suppfig19d, suppfig20d, nrow = 3, ncol = 2, legend = "right", labels = "AUTO", common.legend = TRUE) 
suppfig24 <- annotate_figure(suppfig24, top = text_grob("Additional AIDS deaths (millions)", 
               color = "black", face = "bold", size = 15))
suppfig24
ggsave(filename = "figures/suppfig24.pdf", plot = suppfig24, device = "pdf", width = 20, height = 29, units = "cm")
ggsave(filename = "figures/suppfig24.png", plot = suppfig24, device = "png", width = 20, height = 29, units = "cm")

```

# Results in text

Baseline incidence in 2025 & 2100
``` {r result1}
test_reduction_only %>% filter(indicator == "HIVinc15to49", 
                               year %in% c(2025,2100), 
                               scenario == "baseline", 
                               test_reduction == 0,
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(1000*mean,2), 
         lower_CI = round(1000*lower_CI,2), 
         upper_CI = round(1000*upper_CI,2)) %>% 
  select(year, mean, lower_CI, upper_CI)
```

Baseline elimination year
```{r result2}
test_reduction_cumulative %>% filter(indicator == "elimination_year", 
                               scenario == "baseline", 
                               test_reduction == 0,
                               pitc_reduction_year == 2025) %>%
  select(median, lower_CI, upper_CI)
```

Baseline HIV prevalence in 2025, 2055 and 2100
``` {r results3}
test_reduction_only %>% filter(indicator == "Prev15to49", 
                               year %in% c(2025,2055,2100), 
                               scenario == "baseline", 
                               test_reduction == 0,
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(100*mean,2), 
         lower_CI = round(100*lower_CI,2), 
         upper_CI = round(100*upper_CI,2)) %>% 
  select(year, mean, lower_CI, upper_CI)
```

Baseline total HIV test in 2025, 2055 and 2100
``` {r results4}
test_reduction_only %>% filter(indicator == "TotalHIVtests", 
                               year %in% c(2025,2055,2100), 
                               scenario == "baseline", 
                               test_reduction == 0,
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(mean/10**6,2), 
         lower_CI = round(lower_CI/10**6,2), 
         upper_CI = round(upper_CI/10**6,2)) %>% 
  select(year, mean, lower_CI, upper_CI)
```

Baseline cumulative HIV infections and deaths between 2025 and 2075
```{r result4.5}
test_reduction_cumulative %>% filter(indicator%in% c("NewAdultHIV", "TotalAIDSdeathsadult"), 
                               scenario == "baseline", 
                               test_reduction == 0,
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(mean/10^6,2), 
         lower_CI = round(lower_CI/10^6,2), 
         upper_CI = round(upper_CI/10^6,2)) %>% 
  select(indicator, mean, lower_CI, upper_CI)
```

Baseline ART coverage in 2076 (max) and 2100
``` {r results5}
test_reduction_only %>% filter(indicator == "ARTcoverageAdult", 
                               year %in% c(2076, 2100), 
                               scenario == "baseline", 
                               test_reduction%in% 0,
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(mean*100,1), 
         lower_CI = round(lower_CI*100,1), 
         upper_CI = round(upper_CI*100,1)) %>% 
  select(year, mean, lower_CI, upper_CI)
```



Testing reduced ART coverage in 2100
``` {r results6}
test_reduction_only %>% filter(indicator == "ARTcoverageAdult", 
                               year %in% c(2100), 
                               scenario == "intervention", 
                               test_reduction%in% c(25, 50, 75, 100),
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(mean*100,1), 
         lower_CI = round(lower_CI*100,1), 
         upper_CI = round(upper_CI*100,1)) %>% 
  select(test_reduction, mean, lower_CI, upper_CI)
```
Testing reduced incidence in 2100
``` {r results7}
test_reduction_only %>% filter(indicator == "HIVinc15to49", 
                               year %in% c(2100), 
                               scenario == "intervention", 
                               test_reduction%in% c(25, 50, 75, 100),
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(mean*1000,2), 
         lower_CI = round(lower_CI*1000,2), 
         upper_CI = round(upper_CI*1000,2)) %>% 
  select(test_reduction, mean, lower_CI, upper_CI)
```

HIV elimination year delay when testing reduced

``` {r results8}
test_reduction_cumulative %>% filter(indicator == "elimination_year",
                               scenario == "intervention", 
                               test_reduction%in% c(25, 50, 75, 100),
                               pitc_reduction_year == 2025) %>%
  mutate(median = round(median-2055,2)) %>% 
  select(test_reduction, median)
```

Baseline prevalence in 2025

``` {r results9}
test_reduction_only %>% filter(indicator == "Prev15to49", 
                               year %in% c(2025), 
                               scenario == "baseline", 
                               test_reduction%in% c(0),
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(mean*100,2), 
         lower_CI = round(lower_CI*100,2), 
         upper_CI = round(upper_CI*100,2)) %>% 
  select(year, mean, lower_CI, upper_CI)
```


Testing reduced prevalence in 2100
``` {r results10}
test_reduction_only %>% filter(indicator == "Prev15to49", 
                               year %in% c(2100), 
                               scenario == "intervention", 
                               test_reduction%in% c(0, 25, 50, 75, 100),
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(mean*100,2), 
         lower_CI = round(lower_CI*100,2), 
         upper_CI = round(upper_CI*100,2)) %>% 
  select(year, test_reduction, mean, lower_CI, upper_CI)
```

Baseline cumulative HIV infections (millions) over 50 years

``` {r results11}
test_reduction_cumulative %>% filter(indicator == "NewAdultHIV",
                                     scenario == "baseline",
                               test_reduction%in% c(0),
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(mean/10**6,2),
         lower_CI = round(lower_CI/10**6,2), 
         upper_CI = round(upper_CI/10**6,2)) %>% 
  select(scenario, mean, lower_CI, upper_CI)
```

Baseline cumulative deaths (millions) over 50 years

``` {r results12}
test_reduction_cumulative %>% filter(indicator == "TotalAIDSdeathsadult",
                                     scenario == "baseline",
                               test_reduction%in% c(0),
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(mean/10**6,2),
         lower_CI = round(lower_CI/10**6,2), 
         upper_CI = round(upper_CI/10**6,2)) %>% 
  select(scenario, mean, lower_CI, upper_CI)
```

Testing reduced additional HIV infections (thousands) over 50 years

``` {r results13}
test_reduction_cumulative %>% filter(indicator == "NewAdultHIV",
                                     scenario == "absolute_dif",
                               test_reduction%in% c(25, 50, 75, 100),
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(mean/10**3,0),
         lower_CI = round(lower_CI/10**3,0), 
         upper_CI = round(upper_CI/10**3,0)) %>% 
  select(test_reduction, mean, lower_CI, upper_CI)
```

Testing reduced additional AIDS deaths (thousands) over 50 years
```{r results14}
test_reduction_cumulative %>% filter(indicator == "TotalAIDSdeathsadult",
                                     scenario == "absolute_dif",
                               test_reduction%in% c(25, 50, 75, 100),
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(mean/10**3,0),
         lower_CI = round(lower_CI/10**3,0), 
         upper_CI = round(upper_CI/10**3,0)) %>% 
  select(test_reduction, mean, lower_CI, upper_CI)
```

Testing reduced by 50% in 2050 vs 2025 HIV incidence in 2100
```{r results15}
test_reduction_only %>% filter(indicator == "HIVinc15to49", 
                               year %in% c(2100), 
                               scenario == "intervention", 
                               test_reduction %in% c(50),
                               pitc_reduction_year %in% c(2025,2050)) %>%
  mutate(mean = round(mean*1000,2), 
         lower_CI = round(lower_CI*1000,2), 
         upper_CI = round(upper_CI*1000,2)) %>% 
  select(pitc_reduction_year, mean, lower_CI, upper_CI)

```

Testing reduced by 50% in 2025 & 2030 additional HIV infections
```{r results16}
additional_2025 <- test_reduction_cumulative %>% 
  filter(indicator %in% c("NewAdultHIV"),
         scenario == "absolute_dif",
         test_reduction%in% c(50),
         pitc_reduction_year %in% c(2025)) %>%
  select(indicator, pitc_reduction_year, mean, lower_CI, upper_CI)
additional_2025 %>% mutate(mean = round(mean/10**3,0),
         lower_CI = round(lower_CI/10**3,0), 
         upper_CI = round(upper_CI/10**3,0))
additional_2030 <- test_reduction_cumulative %>% 
  filter(indicator %in% c("NewAdultHIV"),
         scenario == "absolute_dif",
         test_reduction%in% c(50),
         pitc_reduction_year %in% c(2030)) %>%
  select(indicator, pitc_reduction_year, mean, lower_CI, upper_CI)
additional_2030 %>% mutate(mean = round(mean/10**3,0),
         lower_CI = round(lower_CI/10**3,0), 
         upper_CI = round(upper_CI/10**3,0))
paste0("Decreased by ", round(((additional_2025$mean - additional_2030$mean) / additional_2025$mean)*100,0), "%")
```

Testing reduced by 50% in 2025 & 2030 additional AIDS deaths
```{r results17}
additional_2025 <- test_reduction_cumulative %>% 
  filter(indicator %in% c("TotalAIDSdeathsadult"),
         scenario == "absolute_dif",
         test_reduction%in% c(50),
         pitc_reduction_year %in% c(2025)) %>%
  select(indicator, pitc_reduction_year, mean, lower_CI, upper_CI)
additional_2025 %>% mutate(mean = round(mean/10**3,0),
         lower_CI = round(lower_CI/10**3,0), 
         upper_CI = round(upper_CI/10**3,0))
additional_2030 <- test_reduction_cumulative %>% 
  filter(indicator %in% c("TotalAIDSdeathsadult"),
         scenario == "absolute_dif",
         test_reduction%in% c(50),
         pitc_reduction_year %in% c(2030)) %>%
  select(indicator, pitc_reduction_year, mean, lower_CI, upper_CI)
additional_2030 %>% mutate(mean = round(mean/10**3,0),
         lower_CI = round(lower_CI/10**3,0), 
         upper_CI = round(upper_CI/10**3,0))
paste0("Decreased by ", round(((additional_2025$mean - additional_2030$mean) / additional_2025$mean)*100,0), "%")
```

Testing reduced by 50% in 2025 & 2050 additional HIV infections
```{r results18}
additional_2025 <- test_reduction_cumulative %>% 
  filter(indicator %in% c("NewAdultHIV"),
         scenario == "absolute_dif",
         test_reduction%in% c(50),
         pitc_reduction_year %in% c(2025)) %>%
  select(indicator, pitc_reduction_year, mean, lower_CI, upper_CI)
additional_2025 %>% mutate(mean = round(mean/10**3,0),
         lower_CI = round(lower_CI/10**3,0), 
         upper_CI = round(upper_CI/10**3,0))
additional_2050 <- test_reduction_cumulative %>% 
  filter(indicator %in% c("NewAdultHIV"),
         scenario == "absolute_dif",
         test_reduction%in% c(50),
         pitc_reduction_year %in% c(2050)) %>%
  select(indicator, pitc_reduction_year, mean, lower_CI, upper_CI)
additional_2050 %>% mutate(mean = round(mean/10**3,0),
         lower_CI = round(lower_CI/10**3,0), 
         upper_CI = round(upper_CI/10**3,0))
paste0("Decreased by ", round(((additional_2025$mean - additional_2050$mean) / additional_2025$mean)*100,0), "%")
```

Testing reduced by 50% in 2025 & 2050 additional AIDS deaths
```{r results19}
additional_2025 <- test_reduction_cumulative %>% 
  filter(indicator %in% c("TotalAIDSdeathsadult"),
         scenario == "absolute_dif",
         test_reduction%in% c(50),
         pitc_reduction_year %in% c(2025)) %>%
  select(indicator, pitc_reduction_year, mean, lower_CI, upper_CI)
additional_2025 %>% mutate(mean = round(mean/10**3,0),
         lower_CI = round(lower_CI/10**3,0), 
         upper_CI = round(upper_CI/10**3,0))
additional_2050 <- test_reduction_cumulative %>% 
  filter(indicator %in% c("TotalAIDSdeathsadult"),
         scenario == "absolute_dif",
         test_reduction%in% c(50),
         pitc_reduction_year %in% c(2050)) %>%
  select(indicator, pitc_reduction_year, mean, lower_CI, upper_CI)
additional_2050 %>% mutate(mean = round(mean/10**3,0),
         lower_CI = round(lower_CI/10**3,0), 
         upper_CI = round(upper_CI/10**3,0))
paste0("Decreased by ", round(((additional_2025$mean - additional_2050$mean) / additional_2025$mean)*100,0), "%")
```

ART change lowest ART coverage in 2035

```{r results20}

min(art_coverage_range)

```

50% ART coverage with no testing reduction 2100 incidence in 2025 vs 2100

``` {r results21}
art_change_summary %>% filter(indicator == "HIVinc15to49",
                              pitc_reduction_year %in% c(2025),
                              test_reduction == 0,
                              year %in% c(2025, 2100),
                              scenario == "intervention",
                              future_variability == "art_deterioration",
                              future_value == 0.14
                              ) %>% 
  mutate(mean = round(mean*1000,2), 
         lower_CI = round(lower_CI*1000,2), 
         upper_CI = round(upper_CI*1000,2)) %>% 
  select(pitc_reduction_year, mean, lower_CI, upper_CI, art_coverage_2035)
```

Elimination year closest to 2070 ART interruption, coverage and elimination year

``` {r results22} 

cumulative_art_change %>% filter(indicator == "elimination_year",
                              pitc_reduction_year %in% c(2025),
                              test_reduction == 0,
                              scenario %in% c("intervention"),
                              future_variability == "art_deterioration",
                              future_value %in% c(0,0.065)) %>% 
  select(median, lower_CI, upper_CI, art_int_rate, art_coverage_2035)
# this needs updating once final results are in 
```


ART coverage at 80% test reduction at 25%, elimination year

``` {r results23}
cumulative_art_change %>% filter(indicator == "elimination_year",
                              pitc_reduction_year %in% c(2025),
                              test_reduction == 25,
                              scenario == "intervention",
                              future_variability == "art_improvement",
                              future_value == 0.025)%>% 
  select(scenario, test_reduction, median, lower_CI, upper_CI, art_coverage_2035)

```

ART coverage at 90% test reduction at 25%, elimination year

``` {r results23}
cumulative_art_change %>% filter(indicator == "elimination_year",
                              pitc_reduction_year %in% c(2025),
                              test_reduction == 100,
                              scenario == "intervention",
                              future_variability == "art_improvement",
                              future_value == 0.12)%>% 
  select(scenario, test_reduction, median, lower_CI, upper_CI, art_coverage_2035)

```
ART change Calculate slope additional deaths 

``` {r results24, echo = FALSE}

max_coverage <- temp3d %>% 
  filter(test_reduction == 60, 
         mean < 1000, 
         mean >-1) %>% 
  select(art_coverage_2035)
60 / (max_coverage$art_coverage_2035 - 0.767) / 100


```


Condom usage reduced to 14% - decline in HIV incidence 

```{r results25}

condom_change_summary %>% filter(indicator == "HIVinc15to49",
                              pitc_reduction_year %in% c(2025),
                              test_reduction == 0,
                              year %in% c(2025, 2100),
                              scenario == "intervention",
                              future_variability == "condom_reduction",
                              future_value == 14
                              ) %>% 
  mutate(mean = round(mean*1000,2), 
         lower_CI = round(lower_CI*1000,2), 
         upper_CI = round(upper_CI*1000,2)) %>% 
  select(year, mean, lower_CI, upper_CI, overall_condom_usage)

```

Condom usage reduced to delay elimination to 2070 and prevent it

```{r results26}

condom_change_cumulative %>% 
  filter(indicator == "elimination_year",
                              pitc_reduction_year %in% c(2025),
                              test_reduction == 0,
                              scenario == "intervention",
                              future_variability == "condom_reduction",
                              future_value %in% c(5,8.5)) %>% 
  select(scenario, test_reduction, median, lower_CI, upper_CI, overall_condom_usage)
  

```
Min and max condom usage additional infections and deaths no testing reduction 

```{r results27}

condom_change_cumulative %>% 
  filter(indicator %in% c("NewAdultHIV", "TotalAIDSdeathsadult"),
                              pitc_reduction_year %in% c(2025),
                              test_reduction == 0,
                              scenario == "absolute_dif",
                              future_value %in% c(14)) %>% 
  mutate(mean = round(mean/1000, 0),
         lower_CI = round(lower_CI/1000,0),
         upper_CI = round(upper_CI/1000,0)) %>% 
  select(indicator, test_reduction, mean, lower_CI, upper_CI, overall_condom_usage)
  

```


```{r results28}

condom_change_cumulative %>% 
  filter(indicator %in% c("NewAdultHIV", "TotalAIDSdeathsadult"),
                              pitc_reduction_year %in% c(2025),
                              test_reduction == 100,
                              scenario == "absolute_dif",
                              future_value %in% c(14)) %>% 
  mutate(mean = round(mean/1000, 0),
         lower_CI = round(lower_CI/1000,0),
         upper_CI = round(upper_CI/1000,0)) %>% 
  select(indicator, test_reduction, mean, lower_CI, upper_CI, overall_condom_usage)
  

```

Condom change Calculate slope additional deaths 

``` {r resultsxx, echo = FALSE}

max_condom <- temp4d %>% 
  filter(test_reduction == 60, 
         mean < 500, 
         mean >-1) %>% 
  select(overall_condom_usage)
60 / (max_condom$overall_condom_usage - 33.9) 


```