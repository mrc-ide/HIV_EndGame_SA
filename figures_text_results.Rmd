---
title: "Figures and text results"
output: html_document
date: "2023-05-22"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)

library(dplyr)
library(tidyr)
library(readr)
library(ggplot2)
library(gridExtra)
library(metR)
library(ggpubr)
library(ggfx)
library(RColorBrewer)

```

# Load data 
## test_reduction_summary from csvs
```{r fig1 data, include=FALSE}
# setwd("/Users/stefan/Documents/HIV_EndGame_SA/")
test_reduction_only <- read_csv("results/test_reduction_only_summary.csv")
```

## Testing reductions with ART need and costs

```{r fig2 data, include = FALSE}

cost_summary <- read_csv("results/cost_summary.csv")
cumulative_costs <- read_csv("results/cumulative_costs.csv")

```

## test_reduction_cumulative  from csvs
``` {r fig3 data, include = FALSE}
test_reduction_cumulative <- read_csv("results/test_reduction_only_cumulative.csv")
```

## combined ART change data
``` {r fig4 data, include = FALSE}
art_change_summary <- read_csv("results/art_change_summary.csv")
cumulative_art_change <- read_csv("results/art_change_cumulative.csv")
```
## Combined condom change data

``` {r fig5 data, include = FALSE}
condom_change_summary <- read_csv("results/condom_change_summary.csv")
condom_change_cumulative <- read_csv("results/condom_change_cumulative.csv")
```

# Figures

## Figure 1

### Figure 1a

Incidence over time

```{r fig1a, echo=FALSE}
fig1a <- test_reduction_only %>% mutate(test_reduction = as.factor(test_reduction)) %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "HIVinc15to49",
         year >= 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100)) %>% 
  ggplot(aes(year, mean, group = test_reduction, fill = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_hline(aes(yintercept = 0.001), lty = "dotted") +
  scale_x_continuous("", expand = c(0, 0)) +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  scale_y_continuous("HIV incidence per 1000", labels =(function(l) {round(l*1e3,1)}), breaks = c(0, 0.001, 0.002, 0.003, 0.004, 0.005, 0.006, 0.007, 0.008),expand = c(0, 0)) +
  scale_fill_brewer("General\nHTS\nreduction", labels = c("None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill"), palette = "Set1") + 
  ggtitle("HIV incidence \n(per 1000; 15-49 years)") 
```

### Figure 1b

Prevalence over time

```{r fig1b, echo=FALSE}
fig1b <- test_reduction_only %>% mutate(test_reduction = as.factor(test_reduction)) %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "Prev15to49",
         year >= 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100)) %>% 
  ggplot(aes(year, mean, group = test_reduction, fill = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  scale_x_continuous("",expand = c(0, 0)) +
  expand_limits(y=c(0, 0.2)) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  scale_y_continuous("HIV prevalence (%)", labels =(function(l) {round(l*1e2,1)}), expand = c(0,0)) +
  scale_fill_brewer("General\nHTS\nreduction", labels = c("None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill"), palette = "Set1") + 
  ggtitle("HIV prevalence\n(15-49 years)")
```

### Figure 1c

ART coverage over time

```{r fig1c, echo=FALSE}
fig1c <- test_reduction_only %>% mutate(test_reduction = as.factor(test_reduction)) %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "ARTcoverageAdult",
         year >= 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100)) %>% 
  ggplot(aes(year, mean, group = test_reduction, fill = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  scale_x_continuous("",expand = c(0, 0)) +
  theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  scale_y_continuous("ART coverage (%) ", labels =(function(l) {round(l*1e2,1)}), limits = c(0,1), expand = c(0,0)) +
  scale_fill_brewer("General\nHTS\nreduction", labels = c("None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill"), palette = "Set1") + 
  ggtitle("ART coverage\n(15+ years)")
```

### Figure 1d

Tests per 100 adults

```{r fig1d, echo=FALSE}
fig1d <- test_reduction_only %>% mutate(test_reduction = as.factor(test_reduction)) %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "TestsPerAdult",
         year >= 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100)) %>% 
  ggplot(aes(year, mean, group = test_reduction, fill = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  scale_x_continuous("",expand = c(0, 0)) +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  scale_y_continuous("HIV tests per 100 adults", labels =(function(l) {round(l*1e2,1)}),expand = c(0, 0)) +
  scale_fill_brewer("General\nHTS\nreduction", labels = c("None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill"), palette = "Set1") + 
  ggtitle("HIV tests per 100 adults\n(15+ years)")

```

### Combined figure 1

``` {r fig1, echo = FALSE}

fig1 <- ggarrange(fig1a, fig1b, fig1c, fig1d, nrow = 2, ncol = 2, common.legend = TRUE, legend = "right", labels = "AUTO", font.label = list(size = 14))
ggsave(filename = "figures/fig1.pdf", plot = fig1, device = "pdf", width = 20, units = "cm")
ggsave(filename = "figures/fig1.png", plot = fig1, device = "png", width = 20, units = "cm")
fig1
```
## Figure 2 

Cost analysis 

### Figure 2a annual cost difference from baseline by cost source

```{r fig2a, echo = FALSE}

### annual costs ####

annual_cost_25 <- cost_summary %>% 
  mutate(test_reduction = as.factor(test_reduction)) %>% 
  filter(indicator %in% c("cost_total_testing", "cost_total_treatment", "cost_total_care"),
         scenario %in% c("annual_absolute_dif"), 
         pitc_reduction_year == 2025,
         year >= 2025,
         year <=2100,
         test_reduction %in% c(25),
         discount == "undiscounted") %>% 
  ggplot(aes(year, mean, fill = indicator)) +
  geom_bar(aes(colour = indicator), position = "stack", stat = "identity",show.legend=FALSE) + 
  geom_hline(aes(yintercept = 0), lty = "solid", colour = "black") +
  geom_line(data = filter(cost_summary,
                          indicator %in% c("cost_total"),
                          scenario %in% c("annual_absolute_dif"),
                          year >= 2025,
                          test_reduction %in% c(25),
                          discount == "undiscounted") %>%
              mutate(pitc_reduction_year = as.factor(pitc_reduction_year),
                     test_reduction = as.factor(test_reduction)),
            aes(year, mean, fill = NULL, linetype = scenario), show.legend=FALSE, color = "black") +
  geom_ribbon(data = filter(cost_summary,
                          indicator %in% c("cost_total"),
                          scenario %in% c("annual_absolute_dif"),
                          year >= 2025,
                          test_reduction %in% c(25),
                          discount == "undiscounted") %>%
              mutate(pitc_reduction_year = as.factor(pitc_reduction_year),
                     test_reduction = as.factor(test_reduction)),
            aes(year, ymin = lower_CI, ymax = upper_CI, fill = NULL, linetype = scenario), show.legend = FALSE, alpha = 0.25, fill = "black") +
  scale_y_continuous(" ",
                     labels = (function(l) {paste0("$",round(l/1e6,1),"m")}),
                     breaks = seq(-400e6, 400e6, 200e6), limits = c(-300e6, 400e6)) + 
  scale_fill_brewer("",
                    palette = "Dark2",
                    direction = -1, 
                    labels = c("Care", "Testing", "Treatment"),
                    aesthetics = c("colour", "fill")) +
  scale_linetype_manual(values = c("annual_absolute_dif" = "dashed"), 
                        name = "",
                        breaks = c("annual_absolute_dif"),
                        labels = c("Total")) +
  scale_x_continuous(" ", breaks = seq(2025, 2100, 25)) + theme_classic() +
  theme(axis.text.y = element_text(size = 10), 
        axis.text.x = element_text(size = 10),
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 10, hjust = 0.5,vjust = -0.30),
        aspect.ratio=1,
        strip.text = element_text(size = 11, vjust = 1, face = "bold"),
        strip.background = element_blank(),
        strip.placement = "outside",
        legend.title = element_blank(),
        plot.margin = margin(0,0,0,0),
        legend.spacing.y = unit(-0.36, "cm"),
        legend.justification="left"
  ) +
  ggtitle(" ") +
  facet_wrap(~test_reduction, ncol =1, scale = "free_x", labeller = as_labeller(c("25" = "25% General\nHTS reduction",
                                                                                  "50" = "50% General\nHTS reduction",
                                                                                  "75" = "75% General\nHTS reduction",
                                                                                  "100" = "100% General\nHTS reduction")),
             strip.position = "left") + 
  theme(plot.margin = unit(c(0,0.3,0,0), "cm"))

annual_cost_50 <- cost_summary %>% 
  mutate(test_reduction = as.factor(test_reduction)) %>% 
  filter(indicator %in% c("cost_total_testing", "cost_total_treatment", "cost_total_care"),
         scenario %in% c("annual_absolute_dif"), 
         pitc_reduction_year == 2025,
         year >= 2025,
         year <=2100,
         test_reduction %in% c(50),
         discount == "undiscounted") %>% 
  ggplot(aes(year, mean, fill = indicator)) +
  geom_bar(aes(colour = indicator), position = "stack", stat = "identity",show.legend=FALSE) + 
  geom_hline(aes(yintercept = 0), lty = "solid", colour = "black") +
  geom_line(data = filter(cost_summary,
                          indicator %in% c("cost_total"),
                          scenario %in% c("annual_absolute_dif"),
                          year >= 2025,
                          test_reduction %in% c(50),
                          discount == "undiscounted") %>%
              mutate(pitc_reduction_year = as.factor(pitc_reduction_year),
                     test_reduction = as.factor(test_reduction)),
            aes(year, mean, fill = NULL, linetype = scenario), show.legend=FALSE, color = "black") +
  geom_ribbon(data = filter(cost_summary,
                            indicator %in% c("cost_total"),
                            scenario %in% c("annual_absolute_dif"),
                            year >= 2025,
                            test_reduction %in% c(50),
                            discount == "undiscounted") %>%
                mutate(pitc_reduction_year = as.factor(pitc_reduction_year),
                       test_reduction = as.factor(test_reduction)),
              aes(year, ymin = lower_CI, ymax = upper_CI, fill = NULL, linetype = scenario), show.legend = FALSE, alpha = 0.25, fill = "black") +
  scale_y_continuous(" ",
                     labels = (function(l) {paste0("$",round(l/1e6,1),"m")}),
                     breaks = seq(-400e6, 400e6, 200e6), limits = c(-300e6, 400e6)) + 
  scale_fill_brewer("",
                    palette = "Dark2",
                    direction = -1, 
                    labels = c("Care", "Testing", "Treatment"),
                    aesthetics = c("colour", "fill")) +
  scale_linetype_manual(values = c("annual_absolute_dif" = "dashed"), 
                        name = "",
                        breaks = c("annual_absolute_dif"),
                        labels = c("Total")) +
  scale_x_continuous(" ", breaks = seq(2025, 2100, 25)) + theme_classic() +
  theme(axis.text.y = element_text(size = 11), 
        axis.text.x = element_text(size = 10),
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 10, hjust = 0.5,vjust = -0.25),
        aspect.ratio=1,
        strip.text = element_text(size = 11, vjust = 1, face = "bold"),
        strip.background = element_blank(),
        strip.placement = "outside",
        legend.title = element_blank(),
        plot.margin = margin(0,0,0,0),
        legend.spacing.y = unit(-0.36, "cm"),
        legend.justification="left"
  ) +
  ggtitle(" ") +
  facet_wrap(~test_reduction, ncol =1, scale = "free_x", labeller = as_labeller(c("25" = "25% General\nHTS reduction",
                                                                                  "50" = "50% General\nHTS reduction",
                                                                                  "75" = "75% General\nHTS reduction",
                                                                                  "100" = "100% General\nHTS reduction")),
             strip.position = "left") + 
  theme(plot.margin = unit(c(0,0.3,0,0), "cm"))

annual_cost_75 <- cost_summary %>% 
  mutate(test_reduction = as.factor(test_reduction)) %>% 
  filter(indicator %in% c("cost_total_testing", "cost_total_treatment", "cost_total_care"),
         scenario %in% c("annual_absolute_dif"), 
         pitc_reduction_year == 2025,
         year >= 2025,
         year <=2100,
         test_reduction %in% c(75),
         discount == "undiscounted") %>% 
  ggplot(aes(year, mean, fill = indicator)) +
  geom_bar(aes(colour = indicator), position = "stack", stat = "identity",show.legend=FALSE) + 
  geom_hline(aes(yintercept = 0), lty = "solid", colour = "black") +
  geom_line(data = filter(cost_summary,
                          indicator %in% c("cost_total"),
                          scenario %in% c("annual_absolute_dif"),
                          year >= 2025,
                          test_reduction %in% c(75),
                          discount == "undiscounted") %>%
              mutate(pitc_reduction_year = as.factor(pitc_reduction_year),
                     test_reduction = as.factor(test_reduction)),
            aes(year, mean, fill = NULL, linetype = scenario), show.legend=FALSE, color = "black") +
  geom_ribbon(data = filter(cost_summary,
                            indicator %in% c("cost_total"),
                            scenario %in% c("annual_absolute_dif"),
                            year >= 2025,
                            test_reduction %in% c(75),
                            discount == "undiscounted") %>%
                mutate(pitc_reduction_year = as.factor(pitc_reduction_year),
                       test_reduction = as.factor(test_reduction)),
              aes(year, ymin = lower_CI, ymax = upper_CI, fill = NULL, linetype = scenario), show.legend = FALSE, alpha = 0.25, fill = "black") +
  scale_y_continuous(" ",
                     labels = (function(l) {paste0("$",round(l/1e6,1),"m")}),
                     breaks = seq(-400e6, 400e6, 200e6), limits = c(-300e6, 400e6)) + 
  scale_fill_brewer("",
                    palette = "Dark2",
                    direction = -1, 
                    labels = c("Care", "Testing", "Treatment"),
                    aesthetics = c("colour", "fill")) +
  scale_linetype_manual(values = c("annual_absolute_dif" = "dashed"), 
                        name = "",
                        breaks = c("annual_absolute_dif"),
                        labels = c("Total")) +
  scale_x_continuous(" ", breaks = seq(2025, 2100, 25)) + theme_classic() +
  theme(axis.text.y = element_text(size = 11), 
        axis.text.x = element_text(size = 10),
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 10, hjust = 0.5,vjust = -0.25),
        aspect.ratio=1,
        strip.text = element_text(size = 11, vjust = 1, face = "bold"),
        strip.background = element_blank(),
        strip.placement = "outside",
        legend.title = element_blank(),
        plot.margin = margin(0,0,0,0),
        legend.spacing.y = unit(-0.36, "cm"),
        legend.justification="left"
  ) +
  ggtitle(" ") +
  facet_wrap(~test_reduction, ncol =1, scale = "free_x", labeller = as_labeller(c("25" = "25% General\nHTS reduction",
                                                                                  "50" = "50% General\nHTS reduction",
                                                                                  "75" = "75% General\nHTS reduction",
                                                                                  "100" = "100% General\nHTS reduction")),
             strip.position = "left") + 
  theme(plot.margin = unit(c(0,0.3,0,0), "cm"))

annual_cost_100 <- cost_summary %>% 
  mutate(test_reduction = as.factor(test_reduction)) %>% 
  filter(indicator %in% c("cost_total_testing", "cost_total_treatment", "cost_total_care"),
         scenario %in% c("annual_absolute_dif"), 
         pitc_reduction_year == 2025,
         year >= 2025,
         year <=2100,
         test_reduction %in% c(100),
         discount == "undiscounted") %>% 
  ggplot(aes(year, mean, fill = indicator)) +
  geom_bar(aes(colour = indicator), position = "stack", stat = "identity",show.legend=FALSE) + 
  geom_hline(aes(yintercept = 0), lty = "solid", colour = "black") +
  geom_line(data = filter(cost_summary,
                          indicator %in% c("cost_total"),
                          scenario %in% c("annual_absolute_dif"),
                          year >= 2025,
                          test_reduction %in% c(100),
                          discount == "undiscounted") %>%
              mutate(pitc_reduction_year = as.factor(pitc_reduction_year),
                     test_reduction = as.factor(test_reduction)),
            aes(year, mean, fill = NULL, linetype = scenario), show.legend=FALSE, color = "black") +
  geom_ribbon(data = filter(cost_summary,
                            indicator %in% c("cost_total"),
                            scenario %in% c("annual_absolute_dif"),
                            year >= 2025,
                            test_reduction %in% c(100),
                            discount == "undiscounted") %>%
                mutate(pitc_reduction_year = as.factor(pitc_reduction_year),
                       test_reduction = as.factor(test_reduction)),
              aes(year, ymin = lower_CI, ymax = upper_CI, fill = NULL, linetype = scenario), show.legend = FALSE, alpha = 0.25, fill = "black") +
  scale_y_continuous(" ",
                     labels = (function(l) {paste0("$",round(l/1e6,1),"m")}),
                     breaks = seq(-400e6, 400e6, 200e6), limits = c(-300e6, 400e6)) + 
  scale_fill_brewer("",
                    palette = "Dark2",
                    direction = -1, 
                    labels = c("Care", "Testing", "Treatment"),
                    aesthetics = c("colour", "fill")) +
  scale_linetype_manual(values = c("annual_absolute_dif" = "dashed"), 
                        name = "",
                        breaks = c("annual_absolute_dif"),
                        labels = c("Total")) +
  scale_x_continuous(" ", breaks = seq(2025, 2100, 25)) + theme_classic() +
  theme(axis.text.y = element_text(size = 11), 
        axis.text.x = element_text(size = 10),
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 10, hjust = 0.5,vjust = -0.25),
        aspect.ratio=1,
        strip.text = element_text(size = 11, vjust = 1, face = "bold"),
        strip.background = element_blank(),
        strip.placement = "outside",
        legend.title = element_blank(),
        plot.margin = margin(0,0,0,0),
        legend.spacing.y = unit(-0.36, "cm"),
        legend.justification="left"
  ) +
  ggtitle(" ") +
  facet_wrap(~test_reduction, ncol =1, scale = "free_x", labeller = as_labeller(c("25" = "25% General\nHTS reduction",
                                                                                  "50" = "50% General\nHTS reduction",
                                                                                  "75" = "75% General\nHTS reduction",
                                                                                  "100" = "100% General\nHTS reduction")),
             strip.position = "left") + 
  theme(plot.margin = unit(c(0,0.3,0,0), "cm"))

annual_cost_25
annual_cost_50
annual_cost_75
annual_cost_100

annual_cost_combo <- ggarrange(annual_cost_25, annual_cost_50, annual_cost_75, annual_cost_100,
                               ncol =1, common.legend = TRUE, legend = "right", align = "h")
annual_cost_combo <- annotate_figure(annual_cost_combo, top = text_grob("Annual cost difference\n(2023 US$; Undiscounted)", 
                                          color = "black", 
                                          face = "bold", size = 11.5, hjust = 0.32))
annual_cost_combo
```

## Figure 2b 

Cumulative percentage of total baseline costs by cost source

```{r fig2b, echo=FALSE}

#### cumulative_cost_from_summary ####

# baseline total cost

cost_cum_base <- cost_summary %>% 
  filter(indicator %in% c("cost_total"),
         scenario %in% c("baseline"),
         test_reduction %in% c(25, 50, 75, 100),
         year >= 2025) %>% 
  select(-c(upper_CI, lower_CI, future_variability, future_value)) %>% 
  group_by(scenario, indicator, pitc_reduction_year, test_reduction, discount) %>% 
  summarise(cumulative_mean = cumsum(mean))
cost_cum_base$year <- c(rep(seq(2025,2100,1), 12))
cost_cum_base <- cost_cum_base %>% 
  filter(year %in% c(2029, 2034, 2049, 2074)) %>% 
  mutate(cumulative_years = year - 2024) %>% 
  relocate(cumulative_years, .before = scenario) 

# intervention total cost 

cost_cum_intervention <- cost_summary %>% 
  filter(indicator %in% c("cost_total"),
         scenario %in% c("annual_absolute_dif"),
         test_reduction %in% c(25, 50, 75, 100),
         year >= 2025) %>% 
  select(-c(upper_CI, lower_CI, future_variability, future_value)) %>% 
  group_by(scenario, indicator, pitc_reduction_year, test_reduction, discount) %>% 
  summarise(cumulative_mean = cumsum(mean))
cost_cum_intervention$year <- c(rep(seq(2025,2100,1), 12))
cost_cum_intervention <- cost_cum_intervention %>% 
  filter(year %in% c(2029, 2034, 2049, 2074)) %>% 
  mutate(cumulative_years = year - 2024) %>% 
  relocate(cumulative_years, .before = scenario) 

# intervention testing cost

cost_cum_testing <- cost_summary %>% 
  filter(indicator %in% c("cost_total_testing"),
         scenario %in% c("annual_absolute_dif"),
         test_reduction %in% c(25, 50, 75, 100),
         year >= 2025) %>% 
  select(-c(upper_CI, lower_CI, future_variability, future_value)) %>% 
  group_by(scenario, indicator, pitc_reduction_year, test_reduction, discount) %>% 
  summarise(cumulative_mean = cumsum(mean))
cost_cum_testing$year <- c(rep(seq(2025,2100,1), 12))
cost_cum_testing <- cost_cum_testing %>% 
  filter(year %in% c(2029, 2034, 2049, 2074)) %>% 
  mutate(cumulative_years = year - 2024) %>% 
  relocate(cumulative_years, .before = scenario) 

# intervention treatment cost

cost_cum_treatment <- cost_summary %>% 
  filter(indicator %in% c("cost_total_treatment"),
         scenario %in% c("annual_absolute_dif"),
         test_reduction %in% c(25, 50, 75, 100),
         year >= 2025) %>% 
  select(-c(upper_CI, lower_CI, future_variability, future_value)) %>% 
  group_by(scenario, indicator, pitc_reduction_year, test_reduction, discount) %>% 
  summarise(cumulative_mean = cumsum(mean))
cost_cum_treatment$year <- c(rep(seq(2025,2100,1), 12))
cost_cum_treatment <- cost_cum_treatment %>% 
  filter(year %in% c(2029, 2034, 2049, 2074)) %>% 
  mutate(cumulative_years = year - 2024) %>% 
  relocate(cumulative_years, .before = scenario) 

# intervention treatment inpatient

cost_cum_care <- cost_summary %>% 
  filter(indicator %in% c("cost_total_care"),
         scenario %in% c("annual_absolute_dif"),
         test_reduction %in% c(25, 50, 75, 100),
         year >= 2025) %>% 
  select(-c(upper_CI, lower_CI, future_variability, future_value)) %>% 
  group_by(scenario, indicator, pitc_reduction_year, test_reduction, discount) %>% 
  summarise(cumulative_mean = cumsum(mean))
cost_cum_care$year <- c(rep(seq(2025,2100,1), 12))
cost_cum_care <- cost_cum_care %>% 
  filter(year %in% c(2029, 2034, 2049, 2074)) %>% 
  mutate(cumulative_years = year - 2024) %>% 
  relocate(cumulative_years, .before = scenario) 

cost_cum_intervention$percentage_change_baseline <- (cost_cum_intervention$cumulative_mean  / cost_cum_base$cumulative_mean) * 100
cost_cum_care$percentage_change_baseline <- (cost_cum_care$cumulative_mean / cost_cum_base$cumulative_mean) * 100
cost_cum_testing$percentage_change_baseline <- (cost_cum_testing$cumulative_mean / cost_cum_base$cumulative_mean) * 100
cost_cum_treatment$percentage_change_baseline <- (cost_cum_treatment$cumulative_mean / cost_cum_base$cumulative_mean) * 100

cumulative_change_from_baseline_total <- bind_rows(cost_cum_intervention,cost_cum_testing,cost_cum_treatment,cost_cum_care)

cumulative_change_from_baseline_total <- cumulative_change_from_baseline_total %>% 
  mutate(indicator = factor(indicator,
                            labels = c("Total", "Testing", "Treatment", "Inpatient"),
                            levels = c("cost_total", "cost_total_testing", "cost_total_treatment", "cost_total_care")),
         scenario = factor(scenario, 
                           labels = c("Total")))

percent_change_25 <- cumulative_change_from_baseline_total %>% 
  filter(test_reduction == 25,
         indicator %in% c("Testing", "Treatment", "Inpatient")) %>% 
  mutate(pitc_reduction_year = as.factor(pitc_reduction_year), 
         test_reduction = as.factor(test_reduction),
         cumulative_years = as.factor(cumulative_years)) %>% 
  ggplot(aes(cumulative_years, percentage_change_baseline, fill = indicator)) +
  geom_bar(aes(), position =  "stack", stat = "identity", 
           #width = 0.85, alpha = 0.75
  ) +
  scale_y_continuous("",
                     breaks = seq(-6, 6, 3),
                     limits = c(-6,7),
                     labels = (function(l) {paste0(l,"%")})) + 
  geom_point(data = filter(cumulative_change_from_baseline_total,
                           indicator %in% c("Total"),
                           scenario == "Total",
                           test_reduction == 25) %>% 
               mutate(pitc_reduction_year = as.factor(pitc_reduction_year),
                      test_reduction = as.factor(test_reduction),
                      cumulative_years = as.factor(cumulative_years)),
             aes(cumulative_years, percentage_change_baseline, colour = scenario), shape = 15) +
  geom_hline(aes(yintercept = 0), lty = "solid", colour = "black") +
  scale_discrete_manual("",
                    breaks = c("Total", "Testing", "Treatment", "Inpatient"), 
                    values = c("Total" = "black", "Testing" = "#d95f02", "Treatment" = "#1b9e77", "Inpatient" = "#7570b3"), 
                    labels= c("Total", "Testing", "Treatment", "Inpatient"), 
                    aesthetics = c("fill", "colour", "shape")) +
  scale_x_discrete(" ", labels = c(5, 10, 25, 50)) + theme_classic() +
  theme(axis.text.y = element_text(size = 10),
        axis.text.x = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 11.5, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_blank(),
        plot.margin = unit(c(0,0,0,-0.4), "cm"),
        legend.spacing.y = unit(-0.15, "cm"),
        legend.text.align = 0,
        strip.text = element_text(size = 10, vjust = 0),
        strip.background = element_blank(),
        strip.placement = "inside") +
  facet_wrap(~factor(discount,levels = c("undiscounted", "3%", "6%", "8.25%")), 
             scale = "free_x", nrow = 1,
             labeller = as_labeller(c("undiscounted" = "Undiscounted",
                                      "3%" = "3% discount",
                                      "6%" = "6% discount",
                                      "8.25%" = "8.25% discount")),
             strip.position = "top")

percent_change_25

percent_change_50 <- cumulative_change_from_baseline_total %>% 
  filter(test_reduction == 50,
         indicator %in% c("Testing", "Treatment", "Inpatient")) %>% 
  mutate(pitc_reduction_year = as.factor(pitc_reduction_year), 
         test_reduction = as.factor(test_reduction),
         cumulative_years = as.factor(cumulative_years)) %>% 
  ggplot(aes(cumulative_years, percentage_change_baseline, fill = indicator)) +
  geom_bar(aes(), position =  "stack", stat = "identity", 
           #width = 0.85, alpha = 0.75
  ) +
  scale_y_continuous("",
                     breaks = seq(-6, 6, 3),
                     limits = c(-6,7),
                     labels = (function(l) {paste0(l,"%")})) + 
  geom_point(data = filter(cumulative_change_from_baseline_total,
                           indicator %in% c("Total"),
                           scenario == "Total",
                           test_reduction == 50) %>% 
               mutate(pitc_reduction_year = as.factor(pitc_reduction_year),
                      test_reduction = as.factor(test_reduction),
                      cumulative_years = as.factor(cumulative_years)),
             aes(cumulative_years, percentage_change_baseline, colour = scenario), shape = 15) +
  geom_hline(aes(yintercept = 0), lty = "solid", colour = "black") +
  scale_discrete_manual("",
                        breaks = c("Total", "Testing", "Treatment", "Inpatient"), 
                        values = c("Total" = "black", "Testing" = "#d95f02", "Treatment" = "#1b9e77", "Inpatient" = "#7570b3"), 
                        labels= c("Total", "Testing", "Treatment", "Inpatient"), 
                        aesthetics = c("fill", "colour", "shape")) +
  scale_x_discrete(" ", labels = c(5, 10, 25, 50)) + theme_classic() +
  theme(axis.text.y = element_text(size = 10),
        axis.text.x = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 11.5, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_blank(),
        plot.margin = unit(c(0,0,0,-0.4), "cm"),
        legend.spacing.y = unit(-0.15, "cm"),
        strip.text = element_text(size = 10, vjust = 0),
        strip.background = element_blank(),
        strip.placement = "inside") +
  facet_wrap(~factor(discount,levels = c("undiscounted", "3%", "6%", "8.25%")), 
             scale = "free_x", nrow = 1,
             labeller = as_labeller(c("undiscounted" = " ",
                                      "3%" = " ",
                                      "6%" = " ",
                                      "8.25%" = " ")),
             strip.position = "top")

percent_change_75 <- cumulative_change_from_baseline_total %>% 
  filter(test_reduction == 75,
         indicator %in% c("Testing", "Treatment", "Inpatient")) %>% 
  mutate(pitc_reduction_year = as.factor(pitc_reduction_year), 
         test_reduction = as.factor(test_reduction),
         cumulative_years = as.factor(cumulative_years)) %>% 
  ggplot(aes(cumulative_years, percentage_change_baseline, fill = indicator)) +
  geom_bar(aes(), position =  "stack", stat = "identity", 
           #width = 0.85, alpha = 0.75
  ) +
  scale_y_continuous("",
                     breaks = seq(-6, 6, 3),
                     limits = c(-6,7),
                     labels = (function(l) {paste0(l,"%")})) + 
  geom_point(data = filter(cumulative_change_from_baseline_total,
                           indicator %in% c("Total"),
                           scenario == "Total",
                           test_reduction == 75) %>% 
               mutate(pitc_reduction_year = as.factor(pitc_reduction_year),
                      test_reduction = as.factor(test_reduction),
                      cumulative_years = as.factor(cumulative_years)),
             aes(cumulative_years, percentage_change_baseline, colour = scenario), shape = 15) +
  geom_hline(aes(yintercept = 0), lty = "solid", colour = "black") +
  scale_discrete_manual("",
                        breaks = c("Total", "Testing", "Treatment", "Inpatient"), 
                        values = c("Total" = "black", "Testing" = "#d95f02", "Treatment" = "#1b9e77", "Inpatient" = "#7570b3"), 
                        labels= c("Total", "Testing", "Treatment", "Inpatient"), 
                        aesthetics = c("fill", "colour", "shape")) +
  scale_x_discrete(" ", labels = c(5, 10, 25, 50)) + theme_classic() +
  theme(axis.text.y = element_text(size = 10),
        axis.text.x = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 11.5, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_blank(),
        plot.margin = unit(c(0,0,0,-0.4), "cm"),
        legend.spacing.y = unit(-0.15, "cm"),
        strip.text = element_text(size = 10, vjust = 0),
        strip.background = element_blank(),
        strip.placement = "inside") +
  facet_wrap(~factor(discount,levels = c("undiscounted", "3%", "6%", "8.25%")), 
             scale = "free_x", nrow = 1,
             labeller = as_labeller(c("undiscounted" = " ",
                                      "3%" = " ",
                                      "6%" = " ",
                                      "8.25%" = " ")),
             strip.position = "top")

percent_change_100 <- cumulative_change_from_baseline_total %>% 
  filter(test_reduction == 100,
         indicator %in% c("Testing", "Treatment", "Inpatient")) %>% 
  mutate(pitc_reduction_year = as.factor(pitc_reduction_year), 
         test_reduction = as.factor(test_reduction),
         cumulative_years = as.factor(cumulative_years)) %>% 
  ggplot(aes(cumulative_years, percentage_change_baseline, fill = indicator)) +
  geom_bar(aes(), position =  "stack", stat = "identity", 
           #width = 0.85, alpha = 0.75
  ) +
  scale_y_continuous("",
                     breaks = seq(-6, 6, 3),
                     limits = c(-6,7),
                     labels = (function(l) {paste0(l,"%")})) + 
  geom_point(data = filter(cumulative_change_from_baseline_total,
                           indicator %in% c("Total"),
                           scenario == "Total",
                           test_reduction == 100) %>% 
               mutate(pitc_reduction_year = as.factor(pitc_reduction_year),
                      test_reduction = as.factor(test_reduction),
                      cumulative_years = as.factor(cumulative_years)),
             aes(cumulative_years, percentage_change_baseline, colour = scenario), shape = 15) +
  geom_hline(aes(yintercept = 0), lty = "solid", colour = "black") +
  scale_discrete_manual("",
                        breaks = c("Total", "Testing", "Treatment", "Inpatient"), 
                        values = c("Total" = "black", "Testing" = "#d95f02", "Treatment" = "#1b9e77", "Inpatient" = "#7570b3"), 
                        labels= c("Total", "Testing", "Treatment", "Inpatient"), 
                        aesthetics = c("fill", "colour", "shape")) +
  scale_x_discrete("Cumulative years from 2025", labels = c(5, 10, 25, 50)) + theme_classic() +
  theme(axis.text.y = element_text(size = 10),
        axis.text.x = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 11.5, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_blank(),
        plot.margin = unit(c(0,0,0,-0.4), "cm"),
        legend.spacing.y = unit(-0.15, "cm"),
        strip.text = element_text(size = 10, vjust = 0),
        strip.background = element_blank(),
        strip.placement = "inside") +
  facet_wrap(~factor(discount,levels = c("undiscounted", "3%", "6%")), 
             scale = "free_x", nrow = 1,
             labeller = as_labeller(c("undiscounted" = " ",
                                      "3%" = " ",
                                      "6%" = " ")),
             strip.position = "top")

percent_change_100

percent_change <- ggarrange(percent_change_25, percent_change_50, percent_change_75, percent_change_100,
          ncol =1, common.legend = TRUE, legend = "right", align = "h")

percent_change <- annotate_figure(percent_change, top = text_grob("Percentage of baseline\ncumulative cost", 
                                                   color = "black", face = "bold", size = 11.5, hjust = 0.70))


```

## Combined figure 2

```{r fig2combined, echo=FALSE}

percent_combo <- ggarrange(annual_cost_combo, percent_change, ncol = 2, common.legend = TRUE, legend = "right",
                           widths = c(4.175,8.3), heights = c(4.175,8.3), align = "hv", labels = "AUTO")

ggsave(plot = percent_combo, filename = "figures/fig2.png", device = "png", 
       units = "cm", height = 20, width = 20)

ggsave(plot = percent_combo, filename = "figures/fig2.pdf", device = "pdf", 
       units = "cm", height = 20, width = 20)

```

## Figure 3

Impact of timing of testing reductions on long-term incidence and epi costs

### Figure 3a

Incidence in 2100 when testing reduced at different times 

```{r fig3a, echo = FALSE}

fig2a <- test_reduction_only %>% 
  mutate(pitc_reduction_year = as.factor(pitc_reduction_year), 
         test_reduction = as.factor(test_reduction)) %>% 
  filter(test_reduction %in% c(0, 25, 50, 75, 100),
         year == 2100, 
         scenario == "intervention", 
         indicator == "HIVinc15to49") %>% 
  ggplot(aes(test_reduction, mean, group = pitc_reduction_year, fill = pitc_reduction_year)) + 
  geom_col(aes(color = pitc_reduction_year), position =  position_dodge(width = 0.85), width = 0.85, alpha = 0.75) +
  geom_errorbar(aes(ymin = lower_CI, ymax = upper_CI), show.legend = F, position =  position_dodge(width = 0.85), alpha = 0.5) +
  xlab("General HTS reduction (%)") + 
  theme_classic() + 
  scale_y_continuous("", labels = (function(l) {round(l*1e3,1)})) + 
  expand_limits(y = 0) +
  geom_hline(aes(yintercept = 0.001), lty = "dotted") +
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 11.5, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11),
        plot.margin = margin(0,0,0,0)) +
  scale_color_brewer("Year HTS\nreduced",palette = "Dark2",direction = -1) +
  scale_fill_brewer("Year HTS\nreduced", palette = "Dark2",direction = -1) +
  ggtitle("HIV incidence in 2100\n(per 1000; 15-49 years)\n")
fig3a
ggsave(filename = "figures/fig3a.png", plot = fig2a, device = "png", units = "cm", width = 11.69, height = 10.41)
```

### Figure 3b 

Additional HIV infections when testing reduced at different times

``` {r fig3b, echo = FALSE}

fig2b <- test_reduction_cumulative %>% 
  filter(indicator == "NewAdultHIV", 
         scenario == "absolute_dif", 
         test_reduction %in% c(0, 25, 50, 75, 100)) %>% 
  mutate(pitc_reduction_year = as.factor(pitc_reduction_year), 
         test_reduction = as.factor(test_reduction)) %>% 
  ggplot(aes(test_reduction, mean, group = pitc_reduction_year, fill = pitc_reduction_year)) +
  geom_col(aes(color = pitc_reduction_year), position =  position_dodge(width = 0.85), width = 0.85, alpha = 0.75) +
  geom_errorbar(aes(ymin = lower_CI, ymax = upper_CI), show.legend = F, position =  position_dodge(width = 0.85), alpha = 0.5) +
  scale_y_continuous("", 
                     labels = (function(l) {round(l/1e6,1)})) +
  scale_color_brewer("Year HTS\nreduced",palette = "Dark2",direction = -1) +
  scale_fill_brewer("Year HTS\nreduced", palette = "Dark2",direction = -1) +
  xlab("General HTS reduction (%)") + theme_classic() +
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 11.5, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11),
        plot.margin = margin(0,0,0,0)) +
  ggtitle("Additional HIV infections\nover 50-years\n(millions; 15+ years)")
fig2b
#ggsave(filename = "figures/fig3b.png", plot = fig2b, device = "png", units = "cm", width = 11.69, height = 10.41)
```

### Figure 3c 

Additional AIDS-related deaths when testing reduced at different times

``` {r fig3c, echo = FALSE}

fig2c <- test_reduction_cumulative %>% 
  filter(indicator == "TotalAIDSdeathsadult", 
         scenario == "absolute_dif", 
         test_reduction %in% c(0, 25, 50, 75, 100)) %>% 
  mutate(pitc_reduction_year = as.factor(pitc_reduction_year), 
         test_reduction = as.factor(test_reduction)) %>% 
  ggplot(aes(test_reduction, mean, group = pitc_reduction_year, fill = pitc_reduction_year)) +
  geom_col(aes(color = pitc_reduction_year), position =  position_dodge(width = 0.85), width = 0.85, alpha = 0.75) +
  geom_errorbar(aes(ymin = lower_CI, ymax = upper_CI), show.legend = F, position =  position_dodge(width = 0.85), alpha = 0.5) +
  scale_y_continuous("", labels = (function(l) {round(l/1e3,1)})) +
  scale_color_brewer("Year HTS\nreduced",palette = "Dark2",direction = -1) +
  scale_fill_brewer("Year HTS\nreduced", palette = "Dark2",direction = -1) +
  xlab("General HTS reduction (%)") + theme_classic() +
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 11.5, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11),
        plot.margin = margin(0,0,0,0)) +
  ggtitle("Additional AIDS deaths\nover 50-years\n(thousands; 15+ years)")
fig2c
#ggsave(filename = "figures/fig3c.png", plot = fig2c, device = "png", units = "cm", width = 11.69, height = 10.41)
```

### Combined figure 3

``` {r fig2, echo = FALSE}

fig2 <- ggarrange(fig2a, fig2b, fig2c, nrow = 1, ncol = 3, common.legend = TRUE, legend = "right", labels = "AUTO", 
                  font.label = list(size = 14), align = "v")
fig2
ggsave(filename = "figures/fig3.pdf", plot = fig2, device = "pdf", width = 20, height = 8, units = "cm")
ggsave(filename = "figures/fig3.png", plot = fig2, device = "png", width = 20, height = 8, units = "cm")

```

## Figure 4

Effect of altered ART coverage on impact of testing reductions

### Figure 4a
Heatmap of 2100 incidence under altered ART coverage

``` {r fig3a, echo = FALSE, warning = FALSE}

temp3a <- art_change_summary %>% 
  mutate(art_coverage_2035 = as.numeric(art_coverage_2035),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(pitc_reduction_year == 2025,
         year == 2100, 
         scenario == "intervention", 
         indicator == "HIVinc15to49")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp3a, test_reduction == i)$art_coverage_2035
  mean_incidence_2100 <- filter(temp3a, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y =  mean_incidence_2100, 
                                    xout = 
                                      seq(min(art_change_summary$art_coverage_2035),
                                          max(art_change_summary$art_coverage_2035),
                                          length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2025, 
           test_reduction = i)
  temp3a <- bind_rows(temp3a, interpolated) 
}

temp3a <- temp3a[which(is.na(temp3a$future_value)),]

fig3a <- temp3a %>% 
  ggplot(aes(test_reduction, art_coverage_2035)) + 
  with_blur(
    geom_raster(aes(fill = log(1000*mean)), interpolate = TRUE),
    sigma = 0
  ) +
  geom_contour(aes(z = 1000*mean), color = "black", binwidth = 0.5) + 
  geom_contour(aes(z = 1000*mean), color = "black", breaks = 1, linewidth = 0.80) + 
  geom_text_contour(aes(z = 1000*mean),skip = 0, stroke = 0.1, stroke.colour = "white",label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.767), lty = "dotted") +
  scale_fill_gradient2("",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red",
                       midpoint = 0,
                       labels = (function(l) {round(exp(l),2)})
  ) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  annotate(geom = "text", x=10, y=0.767, label="Baseline", parse = TRUE) + 
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("HIV incidence in 2100\n(per 1000; 15-49 years)")
fig3a
ggsave("figures/fig3a.png", plot = fig3a, device = "png", width = 11.69, height = 10.41, units = "cm")
```

### Figure 4b 
Heatmap of HIV elimination year under altered ART coverage

```{r fig3b, echo = FALSE, warning = FALSE}
temp3b <- cumulative_art_change %>% 
  mutate(art_coverage_2035 = as.numeric(art_coverage_2035),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(indicator == "elimination_year", 
         pitc_reduction_year == 2025, 
         scenario == "intervention") %>% 
  arrange(desc(art_coverage_2035)) 

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp3b, test_reduction == i)$art_coverage_2035
  elimination_year <- filter(temp3b, test_reduction == i)$median
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = elimination_year, xout = seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(median = y) %>% 
    mutate(pitc_reduction_year = 2025, 
           test_reduction = i)
  temp3b <- bind_rows(temp3b, interpolated) 
}

temp3b <- temp3b[which(is.na(temp3b$future_value)),]

temp3b[which(temp3b$median == Inf),] <- NA

fig3b <- temp3b %>% 
  mutate(pitc_reduction_year = as.factor(pitc_reduction_year)) %>% 
  filter(pitc_reduction_year == 2025) %>% 
  ggplot(aes(x = test_reduction, y = art_coverage_2035, z = median)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = median), 
                        interpolate = TRUE)
  ) + 
  geom_contour(color = "black") + 
  geom_text_contour(skip = 0, stroke = 0.1, 
                    stroke.colour = "white",check_overlap = TRUE,min.size = 100,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.767), lty = "dotted") +
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 2055) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  annotate(geom = "text", x=90, y=0.767, label="Baseline", parse = TRUE) + 
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("HIV elimination year\n(incidence <1/1000)")
fig3b

```

### Figure 4c
Heatmap of additional HIV infections under altered ART coverage

``` {r fig3c, echo = FALSE, warning = FALSE}

temp3c <- cumulative_art_change %>% 
  filter(indicator == "NewAdultHIV", 
         scenario == "absolute_dif")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp3c, test_reduction == i)$art_coverage_2035
  mean <- filter(temp3c, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = mean, 
                                    xout =  seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2025, 
           test_reduction = i)
  temp3c <- bind_rows(temp3c, interpolated) 
}

temp3c <- temp3c[which(is.na(temp3c$future_value)),]

fig3c <- temp3c %>% 
  ggplot(aes(test_reduction, art_coverage_2035, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(),breaks = c(0, 2.5),show.legend = FALSE, color = "black") + 
  geom_contour(aes(),breaks = c(2.5, 5),show.legend = FALSE, color = "grey") +
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, breaks = c(0, 2.5, 5),skip = 0,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.768), lty = "dotted") +
  annotate(geom = "text", x=50, y=0.768, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional HIV infections\n2025-2075 (millions)")
fig3c

ggsave("figures/fig3c.png", plot = fig3c, device = "png", height = 10.41, width = 11.69, units = "cm")
```


### Figure 4d
Heatmap of additional AIDS-related deaths under altered ART coverage

```{r fig3d, echo=FALSE, warning = FALSE}

temp3d <- cumulative_art_change %>% 
  filter(indicator == "TotalAIDSdeathsadult", 
         scenario == "absolute_dif")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp3d, test_reduction == i)$art_coverage_2035
  mean <- filter(temp3d, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = mean, 
                                    xout = seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2025, 
           test_reduction = i)
  temp3d <- bind_rows(temp3d, interpolated) 
}

temp3d <- temp3d[which(is.na(temp3d$future_value)),]

fig3d <- temp3d %>% 
  ggplot(aes(test_reduction, art_coverage_2035, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(),breaks = 0, color = "black", show.legend = FALSE) +
  geom_contour(aes(),breaks = c(0.5, 1, 1.5), color = "grey",show.legend = FALSE) +
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, breaks = c(0,0.5, 1, 1.5), skip = 0,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.768), lty = "dotted") +
  annotate(geom = "text", x=50, y=0.768, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional AIDS deaths\n2025-2075 (millions)")
fig3d
```

### Combined Figure 4

```{r fig3, echo = FALSE, warning = FALSE}

fig3 <- ggarrange(fig3a, fig3b, fig3c, fig3d, nrow = 2, ncol = 2, labels = "AUTO")
fig3
ggsave(filename = "figures/fig4.pdf", plot = fig3, device = "pdf", width = 20, height = 17.8, units = "cm")
ggsave(filename = "figures/fig4.png", plot = fig3, device = "png", width = 20, height = 17.8, units = "cm")
```


## Figure 5

Effect of altered condom usage on impact of testing reductions

### Figure 5a

Heatmap of 2100 incidence under altered condom usage 

``` {r fig4a, echo = FALSE, warning = FALSE}

temp4a <- condom_change_summary %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(pitc_reduction_year == 2025,
         year == 2100, 
         scenario == "intervention", 
         indicator == "HIVinc15to49")

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp4a, test_reduction == i)$overall_condom_usage
  mean_incidence_2100 <- filter(temp4a, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean_incidence_2100, 
                                    xout = seq(min(condom_change_summary$overall_condom_usage), max(condom_change_summary$overall_condom_usage),length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2025, 
           test_reduction = i)
  
  
  temp4a <- bind_rows(temp4a, interpolated) 
}
temp4a <- temp4a[which(is.na(temp4a$future_value)),]

fig4a <- temp4a %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction), 
         log_incidence = log(1000*mean)) %>% 
  ggplot(aes(x = test_reduction, y = overall_condom_usage)) + 
  with_blur(geom_raster(aes(fill = as.numeric(log_incidence)), 
                        interpolate = TRUE),sigma=0) + 
  geom_contour(aes(z = 1000*mean), 
               color = "black", breaks = c(0.5, 1, 2, 3, 4, 5, 6, 7, 8, 9)) + 
  geom_contour(aes(z = 1000*mean), 
               color = "black", breaks = 1, linewidth = 0.80) +
  geom_text_contour(aes(z = 1000*mean),
                    skip = 0, stroke = 0.1, 
                    stroke.colour = "white",
                    breaks = c(0.5, 1, 2, 3, 4, 5, 6, 7, 8, 9), 
                    label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted")+
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red",
                       midpoint = 0,
                       labels = (function(l) {round(exp(l),2)})
  ) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("HIV incidence in 2100\n(per 1000; 15-49 years)") +
  annotate(geom = "text", x = 15, y = 33.9, label = "Baseline")
fig4a
```

### Figure 5b

Heatmap of HIV elimination year under altered condom usage 

``` {r fig4b, echo = FALSE, warning = FALSE}

temp4b <- condom_change_cumulative %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(indicator == "elimination_year", 
         pitc_reduction_year == 2025, 
         scenario == "intervention") %>% 
  arrange(desc(overall_condom_usage)) 

temp4b[which(temp4b$median == Inf),] <- NA

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp4b, test_reduction == i)$overall_condom_usage
  elimination_year <- filter(temp4b, test_reduction == i)$median
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = elimination_year, seq(min(condom_change_cumulative$overall_condom_usage), max(condom_change_cumulative$overall_condom_usage),length.out = 1000), 
                                    method = "linear", na.rm = FALSE)) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(median = y) %>% 
    mutate(pitc_reduction_year = 2025, 
           test_reduction = i)
  temp4b <- bind_rows(temp4b, interpolated) 
}

temp4b <- temp4b[which(is.na(temp4b$future_value)),]

temp4b[which(temp4b$median == Inf),] <- NA

fig4b <- temp4b %>% 
  ggplot(aes(x = test_reduction, y = overall_condom_usage)) +
  with_blur(geom_raster(aes(fill = median), interpolate = TRUE, na.rm = TRUE), sigma = 0) +
  geom_contour(aes(z = median),color = "black") + 
  geom_text_contour(aes(z = median), skip = 0, 
                    stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, 
                    min.size = 100, 
                    label.placer = label_placer_fraction())+
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 2055) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted")+
  annotate(geom = "text", x=90, y=33.9, label="Baseline", parse = TRUE) + 
  ggtitle("HIV elimination year\n(incidence < 1/1000)")
fig4b
```

### Figure 5c

Heatmap of additional HIV infections under altered condom usage 

``` {r fig4c, echo = FALSE, warning = FALSE}

temp4c <- condom_change_cumulative %>% 
  filter(indicator == "NewAdultHIV", 
         scenario == "absolute_dif", 
         pitc_reduction_year == 2025)

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp4c, test_reduction == i)$overall_condom_usage
  mean <- filter(temp4c, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean, 
                                    xout = seq(min(condom_change_cumulative$overall_condom_usage),
                                               max(condom_change_cumulative$overall_condom_usage), length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2025, 
           test_reduction = i)
  temp4c <- bind_rows(temp4c, interpolated) 
}

temp4c <- temp4c[which(is.na(temp4c$future_value)),]

fig4c <- temp4c %>% 
ggplot(aes(test_reduction, overall_condom_usage, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(), color = "black",breaks = 0,show.legend = FALSE) + 
  geom_contour(aes(), color = "grey",breaks = c(2.5, 5, 7.5, 10),show.legend = FALSE) + 
  geom_text_contour(stroke = 0.1, 
                    stroke.colour = "white",
                    check_overlap = TRUE, 
                    breaks = c(0,2.5, 5, 7.5, 10),
                    label.placer = label_placer_fraction(), skip = 0) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted") +
  annotate(geom = "text", x=50, y=33.9, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional HIV infections\n2025-2075 (millions)")
fig4c

```

### Figure 5d

Heatmap of additional AIDS-related deaths under altered condom usage 

``` {r fig4d, echo = FALSE, warning = FALSE}

temp4d <- condom_change_cumulative %>% 
  filter(indicator == "TotalAIDSdeathsadult", 
         scenario == "absolute_dif", pitc_reduction_year == 2025)

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp4d, test_reduction == i)$overall_condom_usage
  mean <- filter(temp4d, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean, 
                                    xout = seq(min(condom_change_cumulative$overall_condom_usage), max(condom_change_cumulative$overall_condom_usage), length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2025, 
           test_reduction = i)
  temp4d <- bind_rows(temp4d, interpolated) 
}

temp4d <- temp4d[which(is.na(temp4d$future_value)),]

fig4d <- temp4d %>% 
  ggplot(aes(test_reduction, overall_condom_usage, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(), color = "black",breaks = 0,show.legend = FALSE) + 
  geom_contour(aes(), color = "grey",breaks = c(0.5, 1.0, 1.5, 2.0),show.legend = FALSE) + 
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, 
                    breaks = c(0, 0.5, 1.0, 1.5, 2.0), skip = 0,
                    label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted") +
  annotate(geom = "text", x=50, y=33.9, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) +
  ggtitle("Additional AIDS deaths\n2025-2075 (millions)")
fig4d
```

### Combined Figure 4

``` {r fig4, echo = FALSE, warning = FALSE}
fig4 <- ggarrange(fig4a, fig4b, fig4c, fig4d, nrow = 2, ncol = 2, legend = "right", labels = "AUTO")
fig4
ggsave(filename = "figures/fig5.pdf", plot = fig4, device = "pdf", width = 20, height = 17.8, units = "cm")
ggsave(filename = "figures/fig5.png", plot = fig4, device = "png", width = 20, height = 17.8, units = "cm")
```

## Supplementary Figure 1
Incidence when testing is reduced at different times

``` {r supp fig 1, echo = FALSE}

suppfig1 <- test_reduction_only %>% mutate(test_reduction = as.factor(test_reduction)) %>% 
  filter(scenario == "intervention", 
         indicator == "HIVinc15to49",
         year > 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100)) %>% 
  ggplot(aes(year, mean, group = test_reduction, fill = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_hline(aes(yintercept = 0.001), lty = "dotted") +
  scale_x_continuous("", expand = c(0,0)) +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11),
        strip.text = element_text(size = 11),
        strip.placement = "inside") +
  scale_y_continuous("HIV incidence per 1000", labels =(function(l) {round(l*1e3,1)}), breaks = c(0, 0.001, 0.002, 0.003, 0.004, 0.005, 0.006, 0.007,0.008), expand = c(0,0)) +
  scale_fill_brewer("General\nHTS\nreduction", labels = c("None", "25%", "50%", "75%", "100%"), 
                    aesthetics = c("colour", "fill"), palette = "Set1") +
  facet_wrap(vars(pitc_reduction_year),labeller = as_labeller(c(`2025` = "Reduced from 2025",
                                                                `2030` = "Reduced from 2030",
                                                                `2035` = "Reduced from 2035",
                                                                `2040` = "Reduced from 2040", 
                                                                `2045` = "Reduced from 2045", 
                                                                `2050` = "Reduced from 2050")),
             strip.position = "top") +
  ggtitle("HIV incidence\n(per 1000; 15-49 years)")
suppfig1
ggsave(filename = "figures/suppfig1.pdf", plot = suppfig1, device = "pdf", width = 20, height = 15, units = "cm")
ggsave(filename = "figures/suppfig1.png", plot = suppfig1, device = "png", width = 20, height = 15, units = "cm")
```


## Supplementary Figure 2
Prevalence when testing is reduced at different times

``` {r supp fig 2, echo = FALSE}

suppfig2 <- test_reduction_only %>% mutate(test_reduction = as.factor(test_reduction)) %>% 
  filter(scenario == "intervention", 
         indicator == "Prev15to49",
         year > 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100)) %>% 
  ggplot(aes(year, mean, group = test_reduction, fill = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  scale_x_continuous("", expand =c(0,0)) +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11),
        strip.text = element_text(size = 11)) +
  scale_y_continuous("HIV prevalence (%)", labels =(function(l) {round(l*1e2,1)}), expand = c(0,0)) +
  scale_fill_brewer("General\nHTS\nreduction", labels = c("None", "25%", "50%", "75%", "100%"), 
                    aesthetics = c("colour", "fill"), palette = "Set1") +
  facet_wrap(vars(pitc_reduction_year),labeller = as_labeller(c(`2025` = "Reduced from 2025",
                                                                `2030` = "Reduced from 2030",
                                                                `2035` = "Reduced from 2035",
                                                                `2040` = "Reduced from 2040", 
                                                                `2045` = "Reduced from 2045", 
                                                                `2050` = "Reduced from 2050"))) +
  ggtitle("HIV prevalence\n(15-49 years)")

ggsave(filename = "figures/suppfig2.pdf", plot = suppfig2, device = "pdf", width = 20, height = 15, units = "cm")
ggsave(filename = "figures/suppfig2.png", plot = suppfig2, device = "png", width = 20, height = 15, units = "cm")

```

## Supplementary Figure 3
ART coverage when testing is reduced at different times

```{r, supp fig 3, echo = FALSE}
suppfig3 <- test_reduction_only %>% mutate(test_reduction = as.factor(test_reduction)) %>% 
  filter(scenario == "intervention", 
         indicator == "ARTcoverageAdult",
         year > 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100)) %>% 
  ggplot(aes(year, mean, group = test_reduction, fill = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.25, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  scale_x_continuous("", expand =c(0,0)) +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11),
        strip.text = element_text(size = 11)) +
  scale_y_continuous("ART coverage (%)", limits = c(0.5, 1), labels =(function(l) {round(l*1e2,1)}), expand = c(0,0)) +
  scale_fill_brewer("General\nHTS\nreduction", labels = c("None", "25%", "50%", "75%", "100%"), 
                    aesthetics = c("colour", "fill"), palette = "Set1") +
  facet_wrap(vars(pitc_reduction_year),labeller = as_labeller(c(`2025` = "Reduced from 2025",
                                                                `2030` = "Reduced from 2030",
                                                                `2035` = "Reduced from 2035",
                                                                `2040` = "Reduced from 2040", 
                                                                `2045` = "Reduced from 2045", 
                                                                `2050` = "Reduced from 2050"))) +
  ggtitle("ART coverage\n(15+ years)") 

ggsave(filename = "figures/suppfig3.pdf", plot = suppfig3, device = "pdf", width = 20, height = 15, units = "cm")
ggsave(filename = "figures/suppfig3.png", plot = suppfig3, device = "png", width = 20, height = 15, units = "cm")
```
## Supplementary figure 4 

HIV tests per 100 adults when testing is reduced at different times 

```{r, supp fig 4, echo = FALSE}

suppfig4 <- test_reduction_only %>% mutate(test_reduction = as.factor(test_reduction)) %>% 
  filter(scenario == "intervention", 
         indicator == "TestsPerAdult",
         year > 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100)) %>% 
  ggplot(aes(year, mean, group = test_reduction, fill = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.25, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  scale_x_continuous("", expand =c(0,0)) +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11),
        strip.text = element_text(size = 11)) +
  scale_y_continuous("HIV tests per 100", labels =(function(l) {round(l*1e2,1)}),expand =c(0,0)) +
  scale_fill_brewer("General\nHTS\nreduction", labels = c("None", "25%", "50%", "75%", "100%"), 
                    aesthetics = c("colour", "fill"), palette = "Set1") +
  facet_wrap(vars(pitc_reduction_year),labeller = as_labeller(c(`2025` = "Reduced from 2025",
                                                                `2030` = "Reduced from 2030",
                                                                `2035` = "Reduced from 2035",
                                                                `2040` = "Reduced from 2040", 
                                                                `2045` = "Reduced from 2045", 
                                                                `2050` = "Reduced from 2050"))) + 
  ggtitle("HIV tests per 100 adults\n(15+ years)")

ggsave(filename = "figures/suppfig4.pdf", plot = suppfig4, device = "pdf", width = 20, height = 15, units = "cm")
ggsave(filename = "figures/suppfig4.png", plot = suppfig4, device = "png", width = 20, height = 15, units = "cm")
```
## Supplementary figure 5a
Increased ART coverage to 85.8%

```{r, supp fig 5a, echo=FALSE}

# palette for manual scale fill found here: colorbrewer2.org

art_change_summary <- art_change_summary %>% mutate(test_reduction = factor(test_reduction,labels = seq(0, 100, 5), levels = as.character(seq(0, 100, 5)))) 

suppfig5a <- art_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "HIVinc15to49",
         year >= 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100),
         future_value == 0.07, 
         future_variability == "art_improvement"
         ) %>% mutate(test_reduction = factor(as.character(test_reduction), labels = c("0", "25", "50", "75", "100"), levels = c("0", "25", "50", "75", "100"))) %>% 
  ggplot(aes(year, mean, group = test_reduction, lty = scenario)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_line(data = filter(art_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "HIVinc15to49",
              year >= 2020,
              test_reduction %in% c(0),
              future_value == 0.07,
              future_variability == "art_improvement"),
            aes(year, mean, lty = scenario)) +
  geom_ribbon(data = filter(art_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "HIVinc15to49",
              year >= 2020,
              test_reduction %in% c(0),
              future_value == 0.07,
              future_variability == "art_improvement"),
              aes(ymin = lower_CI, ymax = upper_CI), alpha = 0.10, show.legend = F) +
  geom_hline(aes(yintercept = 0.001), lty = "dotted") +
  scale_x_continuous("", expand =c(0,0)) +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  scale_y_continuous("HIV incidence per 1000", labels =(function(l) {round(l*1e3,1)}), breaks = c(0, 0.001, 0.002, 0.003, 0.004, 0.005, 0.006, 0.007, 0.008), expand =c(0,0)) +
  scale_fill_manual(name = "General\nHTS\nreduction", breaks = c("baseline", "0", "25", "50", "75", "100"), values = c("baseline" = "black", "0" = "#e41a1c", "25" = "#377eb8", "50" = "#4daf4a", "75" = "#984ea3",  "100" = "#ff7f00"), labels= c("Status quo", "None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill")) + 
  scale_linetype_manual(values = c("baseline" = "dashed", "intervention" = "solid"), 
                        name = "ART\ninterruption\nrate",
                        breaks = c("baseline", "intervention"),
                        labels = c("Status quo", "Reduced")) +
  ggtitle("HIV incidence\n(per 1000; 15-49 years)")
suppfig5a

```

## Supplementary Figure 5b

```{r, supp fig 5b, echo=FALSE}

suppfig5b <- art_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "Prev15to49",
         year >= 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100),
         future_value == 0.07, 
         future_variability == "art_improvement"
         ) %>% mutate(test_reduction = factor(as.character(test_reduction), labels = c("0", "25", "50", "75", "100"), levels = c("0", "25", "50", "75", "100"))) %>% 
  ggplot(aes(year, mean, group = test_reduction, lty = scenario)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_line(data = filter(art_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "Prev15to49",
              year >= 2020,
              test_reduction %in% c(0),
              future_value == 0.07,
              future_variability == "art_improvement"),
            aes(year, mean, lty = scenario)) +
  geom_ribbon(data = filter(art_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "Prev15to49",
              year >= 2020,
              test_reduction %in% c(0),
              future_value == 0.07,
              future_variability == "art_improvement"),
              aes(ymin = lower_CI, ymax = upper_CI), alpha = 0.10, show.legend = F) +
  scale_x_continuous("", expand =c(0,0)) +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  scale_y_continuous("HIV prevalence (%)", labels =(function(l) {round(l*1e2,1)}),expand =c(0,0),limits = c(0,0.2)) +
  scale_fill_manual(name = "General\nHTS\nreduction", breaks = c("baseline", "0", "25", "50", "75", "100"), values = c("baseline" = "black", "0" = "#e41a1c", "25" = "#377eb8", "50" = "#4daf4a", "75" = "#984ea3",  "100" = "#ff7f00"), labels= c("Status quo", "None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill")) + 
  scale_linetype_manual(values = c("baseline" = "dashed", "intervention" = "solid"), 
                        name = "ART\ninterruption\nrate",
                        breaks = c("baseline", "intervention"),
                        labels = c("Status quo", "Reduced")) +
  ggtitle("HIV prevalence\n(15-49 years)")
suppfig5b

```

## Supplementary Figure 5c

```{r, supp fig 5c, echo=FALSE}

suppfig5c <- art_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "ARTcoverageAdult",
         year >= 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100),
         future_value == 0.07, 
         future_variability == "art_improvement"
         ) %>% mutate(test_reduction = factor(as.character(test_reduction), labels = c("0", "25", "50", "75", "100"), levels = c("0", "25", "50", "75", "100"))) %>% 
  ggplot(aes(year, mean, group = test_reduction, lty = scenario)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_line(data = filter(art_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "ARTcoverageAdult",
              year >= 2020,
              test_reduction %in% c(0),
              future_value == 0.07,
              future_variability == "art_improvement"),
            aes(year, mean, lty = scenario)) +
  geom_ribbon(data = filter(art_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "ARTcoverageAdult",
              year >= 2020,
              test_reduction %in% c(0),
              future_value == 0.07,
              future_variability == "art_improvement"),
              aes(ymin = lower_CI, ymax = upper_CI), alpha = 0.10, show.legend = F) + 
  scale_x_continuous("", expand =c(0,0)) +
  expand_limits(y=c(0.5, 1)) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  scale_y_continuous("ART coverage (%)", labels =(function(l) {round(l*1e2,1)}),expand =c(0,0)) +
  scale_fill_manual(name = "General\nHTS\nreduction", breaks = c("baseline", "0", "25", "50", "75", "100"), values = c("baseline" = "black", "0" = "#e41a1c", "25" = "#377eb8", "50" = "#4daf4a", "75" = "#984ea3",  "100" = "#ff7f00"), labels= c("Status quo", "None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill")) + 
  scale_linetype_manual(values = c("baseline" = "dashed", "intervention" = "solid"), 
                        name = "ART\ninterruption\nrate",
                        breaks = c("baseline", "intervention"),
                        labels = c("Status quo", "Reduced")) +
  ggtitle("ART coverage\n(15+ years)")
suppfig5c

```
## Supplementary Figure 5d

```{r, supp fig 5d, echo=FALSE}

art_change_summary <- art_change_summary %>% mutate(test_reduction = factor(test_reduction,labels = seq(0, 100, 5), levels = as.character(seq(0, 100, 5)))) 

suppfig5d <- art_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "TestsPerAdult",
         year >= 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100),
         future_value == 0.07, 
         future_variability == "art_improvement"
         ) %>% mutate(test_reduction = factor(as.character(test_reduction), labels = c("0", "25", "50", "75", "100"), levels = c("0", "25", "50", "75", "100"))) %>% 
  ggplot(aes(year, mean, group = test_reduction, lty = scenario)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_line(data = filter(art_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "TestsPerAdult",
              year >= 2020,
              test_reduction %in% c(0),
              future_value == 0.07,
              future_variability == "art_improvement"),
            aes(year, mean, lty = scenario)) +
  geom_ribbon(data = filter(art_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "TestsPerAdult",
              year >= 2020,
              test_reduction %in% c(0),
              future_value == 0.07,
              future_variability == "art_improvement"),
              aes(ymin = lower_CI, ymax = upper_CI), alpha = 0.10, show.legend = F) + 
  scale_x_continuous("", expand =c(0,0)) +
  expand_limits(y=c(0)) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  scale_y_continuous("HIV tests per 100", labels =(function(l) {round(l*1e2,1)}),expand =c(0,0)) +
  scale_fill_manual(name = "General\nHTS\nreduction", breaks = c("baseline", "0", "25", "50", "75", "100"), values = c("baseline" = "black", "0" = "#e41a1c", "25" = "#377eb8", "50" = "#4daf4a", "75" = "#984ea3",  "100" = "#ff7f00"), labels= c("Status quo", "None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill")) + 
  scale_linetype_manual(values = c("baseline" = "dashed", "intervention" = "solid"), 
                        name = "ART\ninterruption\nrate",
                        breaks = c("baseline", "intervention"),
                        labels = c("Status quo", "Reduced")) +
  ggtitle("HIV tests per 100\n(15+ years)")
suppfig5d

```

## Supplementary figure 5 combined 

``` {r supp fig 5, echo = FALSE}

suppfig5 <- ggarrange(suppfig5a, suppfig5b, suppfig5c, suppfig5d, nrow = 2, ncol = 2, common.legend = TRUE, legend = "right", labels = "AUTO")
suppfig5 <- annotate_figure(suppfig5, top = text_grob("Reduced ART interruption rate from 14.9% to 7.2%", 
               color = "black", face = "bold", size = 14))
ggsave(filename = "figures/suppfig7.pdf", plot = suppfig5, device = "pdf", width = 20, units = "cm")
ggsave(filename = "figures/suppfig7.png", plot = suppfig5, device = "png", width = 20, units = "cm")
```

## Supplementary figure 6a
Decreased ART coverage to 64.2%

```{r, supp fig 6a, echo=FALSE}

suppfig6a <- art_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "HIVinc15to49",
         year >= 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100),
         future_value == 0.07, 
         future_variability == "art_deterioration"
         ) %>% mutate(test_reduction = factor(as.character(test_reduction), labels = c("0", "25", "50", "75", "100"), levels = c("0", "25", "50", "75", "100"))) %>% 
  ggplot(aes(year, mean, group = test_reduction, lty = scenario)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_line(data = filter(art_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "HIVinc15to49",
              year >= 2020,
              test_reduction %in% c(0),
              future_value == 0.07,
              future_variability == "art_deterioration"),
            aes(year, mean, lty = scenario)) +
  geom_ribbon(data = filter(art_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "HIVinc15to49",
              year >= 2020,
              test_reduction %in% c(0),
              future_value == 0.07,
              future_variability == "art_deterioration"),
              aes(ymin = lower_CI, ymax = upper_CI), alpha = 0.10, show.legend = F) +
  geom_hline(aes(yintercept = 0.001), lty = "dotted") +
  scale_x_continuous("", expand = c(0,0)) +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  scale_y_continuous("HIV incidence per 1000", labels =(function(l) {round(l*1e3,1)}), breaks = c(0, 0.001, 0.002, 0.003, 0.004, 0.005, 0.006, 0.007),expand = c(0,0)) +
  scale_fill_manual(name = "General\nHTS\nreduction", breaks = c("baseline", "0", "25", "50", "75", "100"), values = c("baseline" = "black", "0" = "#e41a1c", "25" = "#377eb8", "50" = "#4daf4a", "75" = "#984ea3",  "100" = "#ff7f00"), labels= c("Status quo", "None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill")) + 
  scale_linetype_manual(values = c("baseline" = "dashed", "intervention" = "solid"), 
                        name = "ART\ninterruption\nrate",
                        breaks = c("baseline", "intervention"),
                        labels = c("Status quo", "Increased")) +
  ggtitle("HIV incidence \n(per 1000; 15-49 years)")
suppfig6a
```

## Supplementary Figure 6b

```{r, supp fig 6b, echo=FALSE}

suppfig6b <- art_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "Prev15to49",
         year >= 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100),
         future_value == 0.07, 
         future_variability == "art_deterioration"
         ) %>% mutate(test_reduction = factor(as.character(test_reduction), labels = c("0", "25", "50", "75", "100"), levels = c("0", "25", "50", "75", "100"))) %>% 
  ggplot(aes(year, mean, group = test_reduction, lty = scenario)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_line(data = filter(art_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "Prev15to49",
              year >= 2020,
              test_reduction %in% c(0),
              future_value == 0.07,
              future_variability == "art_deterioration"),
            aes(year, mean, lty = scenario)) +
  geom_ribbon(data = filter(art_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "Prev15to49",
              year >= 2020,
              test_reduction %in% c(0),
              future_value == 0.07,
              future_variability == "art_deterioration"),
              aes(ymin = lower_CI, ymax = upper_CI), alpha = 0.10, show.legend = F) +
  scale_x_continuous("", expand = c(0,0)) +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  scale_y_continuous("HIV prevalence (%)", labels =(function(l) {round(l*1e2,1)}),expand = c(0,0), limits = c(0,0.2)) +
  scale_fill_manual(name = "General\nHTS\nreduction", breaks = c("baseline", "0", "25", "50", "75", "100"), values = c("baseline" = "black", "0" = "#e41a1c", "25" = "#377eb8", "50" = "#4daf4a", "75" = "#984ea3",  "100" = "#ff7f00"), labels= c("Status quo", "None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill")) + 
  scale_linetype_manual(values = c("baseline" = "dashed", "intervention" = "solid"), 
                        name = "ART\ninterruption\nrate",
                        breaks = c("baseline", "intervention"),
                        labels = c("Status quo", "Increased")) +
 ggtitle("HIV prevalence\n(15-49 years)")
suppfig6b

```

## Supplementary Figure 6c

```{r, supp fig 6c, echo=FALSE}

suppfig6c <- art_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "ARTcoverageAdult",
         year >= 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100),
         future_value == 0.07, 
         future_variability == "art_deterioration"
         ) %>% mutate(test_reduction = factor(as.character(test_reduction), labels = c("0", "25", "50", "75", "100"), levels = c("0", "25", "50", "75", "100"))) %>% 
  ggplot(aes(year, mean, group = test_reduction, lty = scenario)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_line(data = filter(art_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "ARTcoverageAdult",
              year >= 2020,
              test_reduction %in% c(0),
              future_value == 0.07,
              future_variability == "art_deterioration"),
            aes(year, mean, lty = scenario)) +
  geom_ribbon(data = filter(art_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "ARTcoverageAdult",
              year >= 2020,
              test_reduction %in% c(0),
              future_value == 0.07,
              future_variability == "art_deterioration"),
              aes(ymin = lower_CI, ymax = upper_CI), alpha = 0.10, show.legend = F) + scale_x_continuous("", expand = c(0,0)) +
  expand_limits(y=c(0.5, 1)) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  scale_y_continuous("ART coverage (%)", labels =(function(l) {round(l*1e2,1)}), expand = c(0,0)) +
  scale_fill_manual(name = "General\nHTS\nreduction", breaks = c("baseline", "0", "25", "50", "75", "100"), values = c("baseline" = "black", "0" = "#e41a1c", "25" = "#377eb8", "50" = "#4daf4a", "75" = "#984ea3",  "100" = "#ff7f00"), labels= c("Status quo", "None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill")) + 
  scale_linetype_manual(values = c("baseline" = "dashed", "intervention" = "solid"), 
                        name = "ART\ninterruption\nrate",
                        breaks = c("baseline", "intervention"),
                        labels = c("Status quo", "Increased")) +
  ggtitle("ART coverage\n(15+ years)")
suppfig6c

```
## Supplementary Figure 6d

```{r, supp fig 6d, echo=FALSE}

suppfig6d <- art_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "TestsPerAdult",
         year >= 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100),
         future_value == 0.07, 
         future_variability == "art_deterioration"
         ) %>% mutate(test_reduction = factor(as.character(test_reduction), labels = c("0", "25", "50", "75", "100"), levels = c("0", "25", "50", "75", "100"))) %>% 
  ggplot(aes(year, mean, group = test_reduction, lty = scenario)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_line(data = filter(art_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "TestsPerAdult",
              year >= 2020,
              test_reduction %in% c(0),
              future_value == 0.07,
              future_variability == "art_deterioration"),
            aes(year, mean, lty = scenario)) +
  geom_ribbon(data = filter(art_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "TestsPerAdult",
              year >= 2020,
              test_reduction %in% c(0),
              future_value == 0.07,
              future_variability == "art_deterioration"),
              aes(ymin = lower_CI, ymax = upper_CI), alpha = 0.10, show.legend = F) + 
  scale_x_continuous("", expand = c(0,0)) +
  expand_limits(y=c(0)) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  scale_y_continuous("HIV tests per 100", labels =(function(l) {round(l*1e2,1)}), expand = c(0,0)) +
  scale_fill_manual(name = "General\nHTS\nreduction", breaks = c("baseline", "0", "25", "50", "75", "100"), values = c("baseline" = "black", "0" = "#e41a1c", "25" = "#377eb8", "50" = "#4daf4a", "75" = "#984ea3",  "100" = "#ff7f00"), labels= c("Status quo", "None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill")) + 
  scale_linetype_manual(values = c("baseline" = "dashed", "intervention" = "solid"), 
                        name = "ART\ninterruption\nrate",
                        breaks = c("baseline", "intervention"),
                        labels = c("Status quo", "Increased")) +
  theme(legend.title = element_blank()) + ggtitle("HIV tests per 100 adults\n(15+ years)")
suppfig6d

```

## Supplementary figure 6 combined 

``` {r supp fig 6, echo = FALSE}

suppfig6 <- ggarrange(suppfig6a, suppfig6b, suppfig6c, suppfig6d, nrow = 2, ncol = 2, common.legend = TRUE, legend = "right", labels = "AUTO")
suppfig6 <- annotate_figure(suppfig6, top = text_grob("Increased ART interruption rate from 14.9% to 29.2%", 
               color = "black", face = "bold", size = 14))
ggsave(filename = "figures/suppfig10.pdf", plot = suppfig6, device = "pdf", width = 20, units = "cm")
ggsave(filename = "figures/suppfig10.png", plot = suppfig6, device = "png", width = 20, units = "cm")
```

## Supplementary figure 7a
Increased condom usage to 45.9%

```{r, supp fig 7a, echo=FALSE}

condom_change_summary <- condom_change_summary %>% mutate(test_reduction = factor(test_reduction,labels = seq(0, 100, 5), levels = as.character(seq(0, 100, 5)))) 

suppfig7a <- condom_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "HIVinc15to49",
         year >= 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100),
         future_value == 7, 
         future_variability == "condom_promotion"
         ) %>% mutate(test_reduction = factor(as.character(test_reduction), labels = c("0", "25", "50", "75", "100"), levels = c("0", "25", "50", "75", "100"))) %>% 
  ggplot(aes(year, mean, group = test_reduction, lty = scenario)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_line(data = filter(condom_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "HIVinc15to49",
              year >= 2020,
              test_reduction %in% c(0),
              future_value == 7,
              future_variability == "condom_promotion"),
            aes(year, mean, lty = scenario)) +
  geom_ribbon(data = filter(condom_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "HIVinc15to49",
              year >= 2020,
              test_reduction %in% c(0),
              future_value == 7,
              future_variability == "condom_promotion"),
              aes(ymin = lower_CI, ymax = upper_CI), alpha = 0.10, show.legend = F) +
  geom_hline(aes(yintercept = 0.001), lty = "dotted") +
  scale_x_continuous("", expand = c(0,0)) +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  scale_y_continuous("HIV incidence per 1000", labels =(function(l) {round(l*1e3,1)}), breaks = c(0, 0.001, 0.002, 0.003, 0.004, 0.005, 0.006, 0.007), expand = c(0,0)) +
  scale_fill_manual(name = "General\nHTS\nreduction", breaks = c("baseline", "0", "25", "50", "75", "100"), values = c("baseline" = "black", "0" = "#e41a1c", "25" = "#377eb8", "50" = "#4daf4a", "75" = "#984ea3",  "100" = "#ff7f00"), labels= c("Status quo", "None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill")) + 
  scale_linetype_manual(values = c("baseline" = "dashed", "intervention" = "solid"), 
                        name = "Condom\nusage\nprobability",
                        breaks = c("baseline", "intervention"),
                        labels = c("Status quo", "Increased")) +
  ggtitle("HIV incidence\n(per 1000; per 15-49 years)") 
suppfig7a
```

## Supplementary Figure 7b

```{r, supp fig 7b, echo=FALSE}

suppfig7b <- condom_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "Prev15to49",
         year >= 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100),
         future_value == 7, 
         future_variability == "condom_promotion"
         ) %>% mutate(test_reduction = factor(as.character(test_reduction), labels = c("0", "25", "50", "75", "100"), levels = c("0", "25", "50", "75", "100"))) %>% 
  ggplot(aes(year, mean, group = test_reduction, lty = scenario)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_line(data = filter(condom_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "Prev15to49",
              year >= 2020,
              test_reduction %in% c(0),
              future_value == 7,
              future_variability == "condom_promotion"),
            aes(year, mean, lty = scenario)) +
  geom_ribbon(data = filter(condom_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "Prev15to49",
              year >= 2020,
              test_reduction %in% c(0),
              future_value == 7,
              future_variability == "condom_promotion"),
              aes(ymin = lower_CI, ymax = upper_CI), alpha = 0.10, show.legend = F) +
  scale_x_continuous("", expand = c(0,0)) +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  scale_y_continuous("HIV prevalence (%)", labels =(function(l) {round(l*1e2,1)}), expand = c(0,0), limits = c(0,0.2)) +
  scale_fill_manual(name = "General\nHTS\nreduction", breaks = c("baseline", "0", "25", "50", "75", "100"), values = c("baseline" = "black", "0" = "#e41a1c", "25" = "#377eb8", "50" = "#4daf4a", "75" = "#984ea3",  "100" = "#ff7f00"), labels= c("Status quo", "None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill")) + scale_linetype_manual(values = c("baseline" = "dashed", "intervention" = "solid"), 
                        name = "Condom\nusage\nprobability",
                        breaks = c("baseline", "intervention"),
                        labels = c("Status quo", "Increased")) +
  ggtitle("HIV prevalence\n(15-49 years)")
suppfig7b

```

## Supplementary Figure 7c

```{r, supp fig 7c, echo=FALSE}

suppfig7c <- condom_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "ARTcoverageAdult",
         year >= 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100),
         future_value == 7, 
         future_variability == "condom_promotion"
         ) %>% mutate(test_reduction = factor(as.character(test_reduction), labels = c("0", "25", "50", "75", "100"), levels = c("0", "25", "50", "75", "100"))) %>% 
  ggplot(aes(year, mean, group = test_reduction, lty = scenario)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_line(data = filter(condom_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "ARTcoverageAdult",
              year >= 2020,
              test_reduction %in% c(0),
              future_value == 7,
              future_variability == "condom_promotion"),
            aes(year, mean, lty = scenario)) +
  geom_ribbon(data = filter(condom_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "ARTcoverageAdult",
              year >= 2020,
              test_reduction %in% c(0),
              future_value == 7,
              future_variability == "condom_promotion"),
              aes(ymin = lower_CI, ymax = upper_CI), alpha = 0.10, show.legend = F) + scale_x_continuous("", expand = c(0,0)) +
  expand_limits(y=c(0.5, 1)) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  scale_y_continuous("ART coverage (%)", labels =(function(l) {round(l*1e2,1)}), expand = c(0,0)) +
  scale_fill_manual(name = "General\nHTS\nreduction", breaks = c("baseline", "0", "25", "50", "75", "100"), values = c("baseline" = "black", "0" = "#e41a1c", "25" = "#377eb8", "50" = "#4daf4a", "75" = "#984ea3",  "100" = "#ff7f00"), labels= c("Status quo", "None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill")) +
  scale_linetype_manual(values = c("baseline" = "dashed", "intervention" = "solid"), 
                        name = "Condom\nusage\nprobability",
                        breaks = c("baseline", "intervention"),
                        labels = c("Status quo", "Increased")) +
  ggtitle("ART coverage\n(15+ years)")
suppfig7c

```
## Supplementary Figure 7d

```{r, supp fig 7d, echo=FALSE}

suppfig7d <- condom_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "TestsPerAdult",
         year >= 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100),
         future_value == 7, 
         future_variability == "condom_promotion"
         ) %>% mutate(test_reduction = factor(as.character(test_reduction), labels = c("0", "25", "50", "75", "100"), levels = c("0", "25", "50", "75", "100"))) %>% 
  ggplot(aes(year, mean, group = test_reduction, lty = scenario)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_line(data = filter(condom_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "TestsPerAdult",
              year >= 2020,
              test_reduction %in% c(0),
              future_value == 7,
              future_variability == "condom_promotion"),
            aes(year, mean, lty = scenario)) +
  geom_ribbon(data = filter(condom_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "TestsPerAdult",
              year >= 2020,
              test_reduction %in% c(0),
              future_value == 7,
              future_variability == "condom_promotion"),
              aes(ymin = lower_CI, ymax = upper_CI, fill = scenario), alpha = 0.10, show.legend = F) + scale_x_continuous("", expand = c(0,0)) +
  expand_limits(y=c(0)) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  scale_y_continuous("HIV tests per 100", labels =(function(l) {round(l*1e2,1)}), expand = c(0,0)) +
  scale_fill_manual(name = "", breaks = c("baseline", "0", "25", "50", "75", "100"), values = c("baseline" = "black", "0" = "#e41a1c", "25" = "#377eb8", "50" = "#4daf4a", "75" = "#984ea3",  "100" = "#ff7f00"), labels= c("Status quo", "None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill")) +
  scale_linetype_manual(values = c("baseline" = "dashed", "intervention" = "solid"), 
                        name = "Condom\nusage\nprobability",
                        breaks = c("baseline", "intervention"),
                        labels = c("Status quo", "Increased")) +
  ggtitle("HIV tests per 100 adults\n(15+ years)")
suppfig7d

```

## Supplementary figure 7 combined 

``` {r supp fig 7, echo = FALSE}

suppfig7 <- ggarrange(suppfig7a, suppfig7b, suppfig7c, suppfig7d, nrow = 2, ncol = 2, common.legend = TRUE, legend = "right", labels = "AUTO")
suppfig7 <- annotate_figure(suppfig7, top = text_grob("Increased condom usage in 2035 from 33.9% to 45.9%", 
               color = "black", face = "bold", size = 14))
ggsave(filename = "figures/suppfig9.pdf", plot = suppfig7, device = "pdf", width = 20, units = "cm")
ggsave(filename = "figures/suppfig9.png", plot = suppfig7, device = "png", width = 20, units = "cm")
```


## Supplementary figure 8a
Decreased condom usage to 23.2%

```{r, supp fig 8a, echo=FALSE}

suppfig8a <- condom_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "HIVinc15to49",
         year >= 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100),
         future_value == 7, 
         future_variability == "condom_reduction"
         ) %>% mutate(test_reduction = factor(as.character(test_reduction), labels = c("0", "25", "50", "75", "100"), levels = c("0", "25", "50", "75", "100"))) %>% 
  ggplot(aes(year, mean, group = test_reduction, lty = scenario)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_line(data = filter(condom_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "HIVinc15to49",
              year >= 2020,
              test_reduction %in% c(0),
              future_value == 7,
              future_variability == "condom_reduction"),
            aes(year, mean, lty = scenario)) +
  geom_ribbon(data = filter(condom_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "HIVinc15to49",
              year >= 2020,
              test_reduction %in% c(0),
              future_value == 7,
              future_variability == "condom_reduction"),
              aes(ymin = lower_CI, ymax = upper_CI), alpha = 0.10, show.legend = F) +
  geom_hline(aes(yintercept = 0.001), lty = "dotted") +
  scale_x_continuous("", expand = c(0,0)) +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  scale_y_continuous("HIV incidence per 1000", labels =(function(l) {round(l*1e3,1)}), breaks = c(0, 0.001, 0.002, 0.003, 0.004, 0.005, 0.006, 0.007), expand = c(0,0)) +
  scale_fill_manual(name = "General\nHTS\nreduction", breaks = c("baseline", "0", "25", "50", "75", "100"), values = c("baseline" = "black", "0" = "#e41a1c", "25" = "#377eb8", "50" = "#4daf4a", "75" = "#984ea3",  "100" = "#ff7f00"), labels= c("Status quo", "None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill")) +
  scale_linetype_manual(values = c("baseline" = "dashed", "intervention" = "solid"), 
                        name = "Condom\nusage\nprobability",
                        breaks = c("baseline", "intervention"),
                        labels = c("Status quo", "Decreased")) + ggtitle("HIV incidence\n(per 1000; 15-49 years)")
suppfig8a
```

## Supplementary Figure 8b

```{r, supp fig 8b, echo=FALSE}

suppfig8b <- condom_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "Prev15to49",
         year >= 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100),
         future_value == 7, 
         future_variability == "condom_reduction"
         ) %>% mutate(test_reduction = factor(as.character(test_reduction), labels = c("0", "25", "50", "75", "100"), levels = c("0", "25", "50", "75", "100"))) %>% 
  ggplot(aes(year, mean, group = test_reduction, lty = scenario)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_line(data = filter(condom_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "Prev15to49",
              year >= 2020,
              test_reduction %in% c(0),
              future_value == 7,
              future_variability == "condom_reduction"),
            aes(year, mean, lty = scenario)) +
  geom_ribbon(data = filter(condom_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "Prev15to49",
              year >= 2020,
              test_reduction %in% c(0),
              future_value == 7,
              future_variability == "condom_reduction"),
              aes(ymin = lower_CI, ymax = upper_CI), alpha = 0.10, show.legend = F) +
  scale_x_continuous("", expand = c(0,0)) +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  scale_y_continuous("HIV prevalence (%)", labels =(function(l) {round(l*1e2,1)}), expand = c(0,0), limits = c(0,0.2)) +
  scale_fill_manual(name = "General\nHTS\nreduction", breaks = c("baseline", "0", "25", "50", "75", "100"), values = c("baseline" = "black", "0" = "#e41a1c", "25" = "#377eb8", "50" = "#4daf4a", "75" = "#984ea3",  "100" = "#ff7f00"), labels= c("Status quo", "None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill")) +
  scale_linetype_manual(values = c("baseline" = "dashed", "intervention" = "solid"), 
                        name = "Condom\nusage\nprobability",
                        breaks = c("baseline", "intervention"),
                        labels = c("Status quo", "Decreased")) + 
  ggtitle("HIV prevalence\n(15-49 years)")
suppfig8b

```

## Supplementary Figure 8c

```{r, supp fig 8c, echo=FALSE}

suppfig8c <- condom_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "ARTcoverageAdult",
         year >= 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100),
         future_value == 7, 
         future_variability == "condom_reduction"
         ) %>% mutate(test_reduction = factor(as.character(test_reduction), labels = c("0", "25", "50", "75", "100"), levels = c("0", "25", "50", "75", "100"))) %>% 
  ggplot(aes(year, mean, group = test_reduction, lty = scenario)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_line(data = filter(condom_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "ARTcoverageAdult",
              year >= 2020,
              test_reduction %in% c(0),
              future_value == 7,
              future_variability == "condom_reduction"),
            aes(year, mean, lty = scenario)) +
  geom_ribbon(data = filter(condom_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "ARTcoverageAdult",
              year >= 2020,
              test_reduction %in% c(0),
              future_value == 7,
              future_variability == "condom_reduction"),
              aes(ymin = lower_CI, ymax = upper_CI), alpha = 0.10, show.legend = F) + scale_x_continuous("", expand = c(0,0)) +
  expand_limits(y=c(0.5, 1)) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  scale_y_continuous("ART coverage (%)", labels =(function(l) {round(l*1e2,1)}), expand = c(0,0)) +
  scale_fill_manual(name = "General\nHTS\nreduction", breaks = c("baseline", "0", "25", "50", "75", "100"), values = c("baseline" = "black", "0" = "#e41a1c", "25" = "#377eb8", "50" = "#4daf4a", "75" = "#984ea3",  "100" = "#ff7f00"), labels= c("Status quo", "None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill")) +
  scale_linetype_manual(values = c("baseline" = "dashed", "intervention" = "solid"), 
                        name = "Condom\nusage\nprobability",
                        breaks = c("baseline", "intervention"),
                        labels = c("Status quo", "Decreased")) + 
ggtitle("ART coverage\n(15+ years)")
suppfig8c

```
## Supplementary Figure 8d

```{r, supp fig 8d, echo=FALSE}

suppfig8d <- condom_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "TestsPerAdult",
         year >= 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100),
         future_value == 7, 
         future_variability == "condom_reduction"
         ) %>% mutate(test_reduction = factor(as.character(test_reduction), labels = c("0", "25", "50", "75", "100"), levels = c("0", "25", "50", "75", "100"))) %>% 
  ggplot(aes(year, mean, group = test_reduction, lty = scenario)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_line(data = filter(condom_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "TestsPerAdult",
              year >= 2020,
              test_reduction %in% c(0),
              future_value == 7,
              future_variability == "condom_reduction"),
            aes(year, mean, lty = scenario)) +
  geom_ribbon(data = filter(condom_change_summary, 
              scenario == "baseline",
              pitc_reduction_year == 2025,
              indicator == "TestsPerAdult",
              year >= 2020,
              test_reduction %in% c(0),
              future_value == 7,
              future_variability == "condom_reduction"),
              aes(ymin = lower_CI, ymax = upper_CI), alpha = 0.10, show.legend = F) + scale_x_continuous("", expand = c(0,0)) +
  expand_limits(y=c(0)) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  scale_y_continuous("HIV tests per 100", labels =(function(l) {round(l*1e2,1)}), expand = c(0,0)) +
  scale_fill_manual(name = "General\nHTS\nreduction", breaks = c("baseline", "0", "25", "50", "75", "100"), values = c("baseline" = "black", "0" = "#e41a1c", "25" = "#377eb8", "50" = "#4daf4a", "75" = "#984ea3",  "100" = "#ff7f00"), labels= c("Status quo", "None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill")) + 
  scale_linetype_manual(values = c("baseline" = "dashed", "intervention" = "solid"), 
                        name = "Condom\nusage\nprobability",
                        breaks = c("baseline", "intervention"),
                        labels = c("Status quo", "Decreased")) + 
  theme(legend.title = element_blank()) + ggtitle("HIV tests per 100 adults\n(15+ years)")
suppfig8d

```

## Supplementary figure 8 combined 

``` {r supp fig 8, echo = FALSE}

suppfig8 <- ggarrange(suppfig8a, suppfig8b, suppfig8c, suppfig8d, nrow = 2, ncol = 2, common.legend = TRUE, legend = "right", labels = "AUTO")
suppfig8 <- annotate_figure(suppfig8, top = text_grob("Reduced condom usage in 2035 from 33.9% to 23.2%", 
               color = "black", face = "bold", size = 14))
ggsave(filename = "figures/suppfig8.pdf", plot = suppfig8, device = "pdf", width = 20, units = "cm")
ggsave(filename = "figures/suppfig8.png", plot = suppfig8, device = "png", width = 20, units = "cm")
```

## Supplementary figure 9a

```{r supp fig 9a, echo=FALSE}
# paletter from colorbrewer2.org but #ffff33 was too light so switched to #yellow3
art_change_summary <- art_change_summary %>% mutate(art_coverage_2035 = as.factor(art_coverage_2035))

suppfig9a <- art_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "HIVinc15to49",
         year >= 2020, 
         test_reduction == 0,
         art_coverage_2035 %in% c(0.499, 0.602, 0.699, 0.804, 0.847, 0.916)
         ) %>%
  ggplot(aes(year, mean, group = art_coverage_2035)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = art_coverage_2035), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = art_coverage_2035), show.legend = T) +
  geom_line(data = filter(art_change_summary,scenario == "intervention",
                   pitc_reduction_year == 2025,
                   indicator == "HIVinc15to49",
                   test_reduction == 0,
                   year >= 2020,
                   art_coverage_2035 %in% c(0.767)), 
                   aes(year, mean, group = art_coverage_2035), linewidth = 0.75) +
  geom_ribbon(data = filter(art_change_summary,scenario == "intervention",
                   pitc_reduction_year == 2025,
                   indicator == "HIVinc15to49",
                   year >= 2020,
                   test_reduction == 0,
                   art_coverage_2035 %in% c(0.767)
         ), aes(ymin = lower_CI, ymax = upper_CI, fill = art_coverage_2035), alpha = 0.10, show.legend = F) +
  geom_hline(aes(yintercept = 0.001), lty = "dotted") +
  scale_x_continuous("", expand = c(0,0)) +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  ggtitle("HIV incidence\n(per 1000; 15-49 years)") +
  scale_y_continuous("HIV incidence per 1000", labels =(function(l) {round(l*1e3,1)}), breaks = c(0, 0.001, 0.002, 0.003, 0.004, 0.005, 0.006, 0.007), expand = c(0,0)) + 
  scale_fill_manual(name = "ART coverage \nin 2035", 
                    breaks = c(0.499, 0.602, 0.699, 0.767, 0.804, 0.847, 0.916), 
                    values = c(`0.499` = "#e41a1c", `0.602` = "#377eb8", `0.699` = "#4daf4a", `0.767` = "black", `0.804` = "#984ea3", `0.847` = "#ff7f00", `0.916` = "yellow3"), 
                    labels= c("50%", "60%", "70%", "77% (baseline)", "80%", "85%", "92%"), 
                    aesthetics = c("colour", "fill"))
suppfig9a
```

## Supplementary figure 9b

```{r supp fig 9b, echo=FALSE}
suppfig9b <- art_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "Prev15to49",
         year >= 2020, 
         test_reduction == 0,
         art_coverage_2035 %in% c(0.499, 0.602, 0.699, 0.804, 0.847, 0.916)
         ) %>% 
  ggplot(aes(year, mean, group = art_coverage_2035)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = art_coverage_2035), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = art_coverage_2035), show.legend = T) +
  geom_line(data = filter(art_change_summary,scenario == "intervention",
                   pitc_reduction_year == 2025,
                   indicator == "Prev15to49",
                   test_reduction == 0,
                   year >= 2020,
                   art_coverage_2035 %in% c(0.767)), 
                   aes(year, mean, group = art_coverage_2035), linewidth = 0.75) +
  geom_ribbon(data = filter(art_change_summary,scenario == "intervention",
                   pitc_reduction_year == 2025,
                   indicator == "Prev15to49",
                   year >= 2020,
                   test_reduction == 0,
                   art_coverage_2035 %in% c(0.767)
         ), aes(ymin = lower_CI, ymax = upper_CI, fill = art_coverage_2035), alpha = 0.10, show.legend = F) +
  scale_x_continuous("", expand = c(0,0)) +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  ggtitle("HIV prevalence\n(15-49 years)") +
  scale_y_continuous("HIV prevalence (%)", labels =(function(l) {round(l*1e2,1)}), expand = c(0,0)) + 
  scale_fill_manual(name = "ART coverage \nin 2035", 
                    breaks = c(0.499, 0.602, 0.699, 0.767, 0.804, 0.847, 0.916), 
                    values = c(`0.499` = "#e41a1c", `0.602` = "#377eb8", `0.699` = "#4daf4a", `0.767` = "black", `0.804` = "#984ea3", `0.847` = "#ff7f00", `0.916` = "yellow3"), 
                    labels= c("50%", "60%", "70%", "77% (baseline)", "80%", "85%", "92%"),
                    aesthetics = c("colour", "fill"))

```

## Supplementary figure 9c

```{r supp fig 9c, echo=FALSE}
suppfig9c <- art_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "ARTcoverageAdult",
         year >= 2020, 
         test_reduction == 0,
         art_coverage_2035 %in% c(0.499, 0.602, 0.699, 0.804, 0.847, 0.916)
         ) %>% 
  ggplot(aes(year, mean, group = art_coverage_2035)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = art_coverage_2035), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = art_coverage_2035), show.legend = T) +
  geom_line(data = filter(art_change_summary,scenario == "intervention",
                   pitc_reduction_year == 2025,
                   indicator == "ARTcoverageAdult",
                   test_reduction == 0,
                   year >= 2020,
                   art_coverage_2035 %in% c(0.767)), 
                   aes(year, mean, group = art_coverage_2035), linewidth = 0.75) +
  geom_ribbon(data = filter(art_change_summary,scenario == "intervention",
                   pitc_reduction_year == 2025,
                   indicator == "ARTcoverageAdult",
                   year >= 2020,
                   test_reduction == 0,
                   art_coverage_2035 %in% c(0.767)
         ), aes(ymin = lower_CI, ymax = upper_CI, fill = art_coverage_2035), alpha = 0.10, show.legend = F) +
  scale_x_continuous("", expand = c(0,0)) +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  ggtitle("ART coverage\n(15+ years)") +
  scale_y_continuous("ART coverage (%)", labels =(function(l) {round(l*1e2,1)}), expand = c(0,0)) + 
  scale_fill_manual(name = "ART coverage \nin 2035", 
                    breaks = c(0.499, 0.602, 0.699, 0.767, 0.804, 0.847, 0.916), 
                    values = c(`0.499` = "#e41a1c", `0.602` = "#377eb8", `0.699` = "#4daf4a", `0.767` = "black", `0.804` = "#984ea3", `0.847` = "#ff7f00", `0.916` = "yellow3"), 
                    labels= c("50%", "60%", "70%", "77% (baseline)", "80%", "85%", "92%"),
                    aesthetics = c("colour", "fill"))

```

## Supplementary figure 9d

```{r supp fig 9d, echo=FALSE}
suppfig9d <- art_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "CondomUsage",
         year >= 2020, 
         test_reduction == 0,
         art_coverage_2035 %in% c(0.499, 0.602, 0.699, 0.804, 0.847, 0.916)
         ) %>% 
  ggplot(aes(year, mean, group = art_coverage_2035)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = art_coverage_2035), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = art_coverage_2035), show.legend = T) +
  geom_line(data = filter(art_change_summary,scenario == "intervention",
                   pitc_reduction_year == 2025,
                   indicator == "CondomUsage",
                   test_reduction == 0,
                   year >= 2020,
                   art_coverage_2035 %in% c(0.767)), 
                   aes(year, mean, group = art_coverage_2035), linewidth = 0.75) +
  geom_ribbon(data = filter(art_change_summary,scenario == "intervention",
                   pitc_reduction_year == 2025,
                   indicator == "CondomUsage",
                   year >= 2020,
                   test_reduction == 0,
                   art_coverage_2035 %in% c(0.767)
         ), aes(ymin = lower_CI, ymax = upper_CI, fill = art_coverage_2035), alpha = 0.10, show.legend = F) +
  scale_x_continuous("", expand = c(0,0)) +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  ggtitle("Sex acts covered by condoms\n(15+ years)") +
  scale_y_continuous("Sex acts covered by condoms (%)", expand = c(0,0)) + 
  scale_fill_manual(name = "ART coverage \nin 2035", 
                    breaks = c(0.499, 0.602, 0.699, 0.767, 0.804, 0.847, 0.916), 
                    values = c(`0.499` = "#e41a1c", `0.602` = "#377eb8", `0.699` = "#4daf4a", `0.767` = "black", `0.804` = "#984ea3", `0.847` = "#ff7f00", `0.916` = "yellow3"), 
                    labels= c("50%", "60%", "70%", "77% (baseline)", "80%", "85%", "92%"),
                    aesthetics = c("colour", "fill"))

```

## Supplementary figure 9 combined 

```{r supp fig 9, echo = FALSE}

suppfig9 <- ggarrange(suppfig9a, suppfig9b, suppfig9c, suppfig9d, ncol = 2, nrow = 2, common.legend = TRUE, legend = "right", labels = "AUTO")
suppfig9 <- annotate_figure(suppfig9, top = text_grob("ART interruption rate varied", 
               color = "black", face = "bold", size = 14))
ggsave(filename = "figures/suppfig5.pdf", plot = suppfig9, device = "pdf", width = 20, units = "cm")
ggsave(filename = "figures/suppfig5.png", plot = suppfig9, device = "png", width = 20, units = "cm")
```


## Supplementary figure 10a

```{r supp fig 10a, echo=FALSE}

condom_change_summary <- condom_change_summary %>% mutate(overall_condom_usage = as.factor(overall_condom_usage))

suppfig10a <- condom_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "HIVinc15to49",
         year >= 2020, 
         test_reduction == 0,
         overall_condom_usage %in% c(14.1, 20.4, 27.6, 42.4, 50.3, 58.2)
         ) %>% 
  ggplot(aes(year, mean, group = overall_condom_usage)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = overall_condom_usage), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = overall_condom_usage), show.legend = T) +
  geom_hline(aes(yintercept = 0.001), lty = "dotted") +
  geom_line(data = filter(condom_change_summary,scenario == "intervention",
                   pitc_reduction_year == 2025,
                   indicator == "HIVinc15to49",
                   test_reduction == 0,
                   year >= 2020,
                   overall_condom_usage %in% c(33.9)), 
                   aes(year, mean, group = overall_condom_usage), linewidth = 0.75) +
  geom_ribbon(data = filter(condom_change_summary,scenario == "intervention",
                   pitc_reduction_year == 2025,
                   indicator == "HIVinc15to49",
                   year >= 2020,
                   test_reduction == 0,
                   overall_condom_usage %in% c(33.9)
         ), aes(ymin = lower_CI, ymax = upper_CI, fill = overall_condom_usage), alpha = 0.10, show.legend = F) +
  scale_x_continuous("", expand = c(0,0)) +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  ggtitle("HIV incidence\n(per 1000; 15-49 years)") +
  scale_y_continuous("HIV incidence", labels =(function(l) {round(l*1e3,1)}), breaks = c(0, 0.001, 0.002, 0.003, 0.004, 0.005, 0.006, 0.007), expand = c(0,0)) + 
    scale_fill_manual(name = "Condom usage \nin 2035", 
                    breaks = c(14.1, 20.4, 27.6,33.9, 42.4, 50.3, 58.2), 
                    values = c(`14.1` = "#e41a1c", `20.4` = "#377eb8", `27.6` = "#4daf4a", `33.9` = "black", `42.4` = "#984ea3", `50.3` = "#ff7f00", `58.2` = "yellow3"), 
                    labels= c("14%", "20%", "28%", "34% (Baseline)", "42%", "50%", "58%"), 
                    aesthetics = c("colour", "fill")) 
suppfig10a
```

## Supplementary figure 10b

```{r supp fig 10b, echo=FALSE}
suppfig10b <- condom_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "Prev15to49",
         year >= 2020, 
         test_reduction == 0,
         overall_condom_usage %in% c(14.1, 20.4, 27.6, 42.4, 50.3, 58.2)
         ) %>% 
  ggplot(aes(year, mean, group = overall_condom_usage)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = overall_condom_usage), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = overall_condom_usage), show.legend = T) +
  geom_line(data = filter(condom_change_summary,scenario == "intervention",
                   pitc_reduction_year == 2025,
                   indicator == "Prev15to49",
                   test_reduction == 0,
                   year >= 2020,
                   overall_condom_usage %in% c(33.9)), 
                   aes(year, mean, group = overall_condom_usage), linewidth = 0.75) +
  geom_ribbon(data = filter(condom_change_summary,scenario == "intervention",
                   pitc_reduction_year == 2025,
                   indicator == "Prev15to49",
                   year >= 2020,
                   test_reduction == 0,
                   overall_condom_usage %in% c(33.9)
         ), aes(ymin = lower_CI, ymax = upper_CI, fill = overall_condom_usage), alpha = 0.10, show.legend = F) +
  scale_x_continuous("", expand = c(0,0)) +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  ggtitle("HIV prevalence\n(15-49 years)") +
  scale_y_continuous("HIV prevalence (%)", labels =(function(l) {round(l*1e2,1)}), expand = c(0,0), limits = c(0, 0.2)) +
  scale_fill_manual(name = "Condom usage \nin 2035", 
                    breaks = c(14.1, 20.4, 27.6,33.9, 42.4, 50.3, 58.2), 
                    values = c(`14.1` = "#e41a1c", `20.4` = "#377eb8", `27.6` = "#4daf4a", `33.9` = "black", `42.4` = "#984ea3", `50.3` = "#ff7f00", `58.2` = "yellow3"), 
                    labels= c("14%", "20%", "28%", "34% (Baseline)", "42%", "50%", "58%"), 
                    aesthetics = c("colour", "fill")) 
suppfig10b
```

## Supplementary figure 10c

```{r supp fig 10c, echo=FALSE}
suppfig10c <- condom_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "ARTcoverageAdult",
         year >= 2020, 
         test_reduction == 0,
         overall_condom_usage %in% c(14.1, 20.4, 27.6, 42.4, 50.3, 58.2)
         ) %>% 
  ggplot(aes(year, mean, group = overall_condom_usage)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = overall_condom_usage), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = overall_condom_usage), show.legend = T) +
  geom_line(data = filter(condom_change_summary,scenario == "intervention",
                   pitc_reduction_year == 2025,
                   indicator == "ARTcoverageAdult",
                   test_reduction == 0,
                   year >= 2020,
                   overall_condom_usage %in% c(33.9)), 
                   aes(year, mean, group = overall_condom_usage), linewidth = 0.75) +
  geom_ribbon(data = filter(condom_change_summary,scenario == "intervention",
                   pitc_reduction_year == 2025,
                   indicator == "ARTcoverageAdult",
                   year >= 2020,
                   test_reduction == 0,
                   overall_condom_usage %in% c(33.9)
         ), aes(ymin = lower_CI, ymax = upper_CI, fill = overall_condom_usage), alpha = 0.10, show.legend = F) +
  scale_x_continuous("", expand = c(0,0)) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  ggtitle("ART coverage\n(15+ years)") +
  scale_y_continuous("ART coverage (%)", labels =(function(l) {round(l*1e2,1)}), expand = c(0,0), limits = c(0.5, 1)) + 
  scale_fill_manual(name = "Condom usage \nin 2035", 
                    breaks = c(14.1, 20.4, 27.6,33.9, 42.4, 50.3, 58.2), 
                    values = c(`14.1` = "#e41a1c", `20.4` = "#377eb8", `27.6` = "#4daf4a", `33.9` = "black", `42.4` = "#984ea3", `50.3` = "#ff7f00", `58.2` = "yellow3"), 
                    labels= c("14%", "20%", "28%", "34% (Baseline)", "42%", "50%", "58%"), 
                    aesthetics = c("colour", "fill")) 

```

## Supplementary figure 10d

```{r supp fig 10d, echo=FALSE}
suppfig10d <- condom_change_summary %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "CondomUsage",
         year >= 2020, 
         test_reduction == 0,
         overall_condom_usage %in% c(14.1, 20.4, 27.6, 42.4, 50.3, 58.2)
         ) %>% 
  ggplot(aes(year, mean, group = overall_condom_usage)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = overall_condom_usage), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = overall_condom_usage), show.legend = T) +
  geom_line(data = filter(condom_change_summary,scenario == "intervention",
                   pitc_reduction_year == 2025,
                   indicator == "CondomUsage",
                   test_reduction == 0,
                   year >= 2020,
                   overall_condom_usage %in% c(33.9)), 
                   aes(year, mean, group = overall_condom_usage), linewidth = 0.75) +
  geom_ribbon(data = filter(condom_change_summary,scenario == "intervention",
                   pitc_reduction_year == 2025,
                   indicator == "CondomUsage",
                   year >= 2020,
                   test_reduction == 0,
                   overall_condom_usage %in% c(33.9)
         ), aes(ymin = lower_CI, ymax = upper_CI, fill = overall_condom_usage), alpha = 0.10, show.legend = F) +
  scale_x_continuous("", expand = c(0,0)) +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  ggtitle("Sex acts coverage by condoms\n (15+ years)") +
  scale_y_continuous("Sex acts coverage by condoms (%)", expand = c(0,0)) + 
  scale_fill_manual(name = "Condom usage \nin 2035", 
                    breaks = c(14.1, 20.4, 27.6,33.9, 42.4, 50.3, 58.2), 
                    values = c(`14.1` = "#e41a1c", `20.4` = "#377eb8", `27.6` = "#4daf4a", `33.9` = "black", `42.4` = "#984ea3", `50.3` = "#ff7f00", `58.2` = "yellow3"), 
                    labels= c("14%", "20%", "28%", "34% (Baseline)", "42%", "50%", "58%"), 
                    aesthetics = c("colour", "fill")) 

```

## Supplementary figure 10 combined 

```{r supp fig 10, echo = FALSE}

suppfig10 <- ggarrange(suppfig10a, suppfig10b, suppfig10c, suppfig10d, ncol = 2, nrow = 2, common.legend = TRUE, legend = "right", labels = "AUTO")
suppfig10 <- annotate_figure(suppfig10, top = text_grob("Probabilty of condom usage varied", 
               color = "black", face = "bold", size = 14))
ggsave(filename = "figures/suppfig6.pdf", plot = suppfig10, device = "pdf", width = 20, units = "cm")
ggsave(filename = "figures/suppfig6.png", plot = suppfig10, device = "png", width = 20, units = "cm")
```

## Supplementary figure 11

Annual costs by cost source
```{r suppfig11a, echo = FALSE}

annual_cost_line <- cost_summary %>% 
  mutate(test_reduction = as.factor(test_reduction)) %>% 
  filter(indicator %in% c("cost_total", "cost_total_testing", "cost_total_treatment", "cost_total_care"),
         scenario %in% c("intervention"), 
         pitc_reduction_year == 2025,
         year >= 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100),
         discount == "undiscounted") %>% 
  ggplot(aes(year, mean, group = test_reduction, fill = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  scale_x_continuous("", expand = c(0, 0), breaks = seq(2025, 2100, 25)) +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text.y = element_text(size = 10),
        axis.text.x = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 11.5, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11),
        plot.margin = unit(c(0,0,0,0), "cm"),
        strip.text = element_text(size = 10, vjust = 1),
        strip.background = element_blank(),
        strip.placement = "outside") +
  scale_y_continuous("Cost (US$ millions)", labels =(function(l) {paste0(round(l/1e6,1))}),expand = c(0, 0)) +
  scale_fill_brewer("General\nHTS\nreduction", 
                    labels = c("None", "25%", "50%", "75%", "100%"), 
                    aesthetics = c("colour", "fill"), 
                    palette = "Set1",
                    direction = 1) + 
  ggtitle("Annual costs (2023 US$ millions)\n(Undiscounted)") + 
  facet_wrap(~factor(indicator, 
                     level = c("cost_total",
                               "cost_total_testing",
                               "cost_total_treatment",
                               "cost_total_care")), 
             scale = "free", 
             nrow = 1,
             strip.position = "top",
             labeller = as_labeller(c("cost_total_testing" = "Testing",
                                      "cost_total_treatment" = "Treatment",
                                      "cost_total_care" = "Inpatient",
                                      "cost_total" = "Total")))

```

Percentage of total annual costs by cost source
```{r supp11b, echo = FALSE}

#### annual percentage cost ####
annual_percentage_total <- cost_summary %>% 
  filter(indicator %in% c("cost_total"),
         scenario %in% c("intervention"),
         test_reduction %in% c(0, 25,50,75,100),
         discount != "8.25%", 
         year >= 2020)

annual_percentage_care <- cost_summary %>% 
  filter(indicator %in% c("cost_total_care"),
         scenario %in% c("intervention"),
         test_reduction %in% c(0, 25,50,75,100),
         discount != "8.25%", 
         year >= 2020)

annual_percentage_testing <- cost_summary %>% 
  filter(indicator %in% c("cost_total_testing"),
         scenario %in% c("intervention"),
         test_reduction %in% c(0, 25,50,75,100),
         discount != "8.25%", 
         year >= 2020)

annual_percentage_treatment <- cost_summary %>% 
  filter(indicator %in% c("cost_total_treatment"),
         scenario %in% c("intervention"),
         test_reduction %in% c(0, 25,50,75,100),
         discount != "8.25%", 
         year >= 2020)

annual_percentage_total$proportion_total <- annual_percentage_total$mean / annual_percentage_total$mean
annual_percentage_care$proportion_total <- annual_percentage_care$mean / annual_percentage_total$mean
annual_percentage_testing$proportion_total <- annual_percentage_testing$mean / annual_percentage_total$mean
annual_percentage_treatment$proportion_total <- annual_percentage_treatment$mean / annual_percentage_total$mean

annual_percentage <- bind_rows(annual_percentage_total,
                               annual_percentage_care, 
                               annual_percentage_testing,
                               annual_percentage_treatment) %>% 
  select(-c(upper_CI, lower_CI, future_variability, future_value, pitc_reduction_year, scenario)) %>% 
  mutate(cost_source = case_when(indicator == "cost_total" ~ "total",
                                 indicator == "cost_total_care" ~ "care",
                                 indicator == "cost_total_testing" ~ "testing",
                                 indicator == "cost_total_treatment" ~ "treatment")) %>% 
  relocate(cost_source, .before = indicator) %>% 
  select(-indicator) %>% 
  rename(mean_cost = mean) %>%
  mutate(percentage_total = round((proportion_total * 100),2))


annual_percentage_fig <- annual_percentage %>% 
  filter(cost_source %in% c("testing", "treatment", "care"),
         discount == "undiscounted",
         year <=2100) %>% 
  mutate(test_reduction = as.factor(test_reduction)) %>% 
  ggplot(aes(year, mean_cost, fill = cost_source, colour = cost_source)) +
  geom_bar(aes(), position =  "fill", stat = "identity", 
           width = 1
  ) +
  scale_y_continuous("",
                     labels = (function(l) {paste0(l*100,"%")}), expand = c(0,0)) +
  scale_discrete_manual("",
                        breaks = c("total", "testing", "treatment", "care"), 
                        values = c("total" = "black", "testing" = "#d95f02", "treatment" = "#1b9e77", "care" = "#7570b3"), 
                        labels= c("Total", "Testing", "Treatment", "Inpatient"), 
                        aesthetics = c("fill", "colour")) +
  scale_x_continuous("", breaks = seq(2020, 2100, 40), expand = c(0,0)) + theme_classic() +
  theme(axis.text.y = element_text(size = 10),
        axis.text.x = element_text(size = 10),
        axis.title.y = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 11.5, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_blank(),
        plot.margin = unit(c(0,0,0,0), "cm"),
        strip.text = element_text(size = 9.5, vjust = 1),
        strip.background = element_blank(),
        strip.placement = "outside") +
  facet_wrap(~test_reduction, 
             scale = "free", nrow = 1,
             labeller = as_labeller(c(
               `0` = "Status quo\ngeneral HTS",
               `25` = "25% general\nHTS reduction",
               `50` = "50% general\nHTS reduction",
               `75` = "75% general\nHTS reduction",
               `100` = "100% general\nHTS reduction")),
             strip.position = "top") + 
  ggtitle("Percentage of total annual costs\n(Undiscounted)")

```

## Combined supplementary figure 11

```{r suppfig11, echo=FALSE}
total_annual_costs <- ggarrange(annual_cost_line, annual_percentage_fig,
          ncol =1, align = "h", labels = "AUTO", widths = c(0.75, 1), 
          heights = c(0.75, 1))

ggsave(plot = total_annual_costs, 
       filename = "figures/suppfig11.png", 
       width = 21, 
       height = 15,
       device = "png", 
       units = "cm")

ggsave(plot = total_annual_costs, 
       filename = "figures/suppfig11.pdf", 
       width = 21, 
       height = 15,
       device = "pdf", 
       units = "cm")
```

## Supplementary figure 12

### Supplemenatry panels for figure 1 (SuppFig12)

Adults starting ART

```{r fig1e, echo=FALSE}
fig1e <- art_needs_costs %>% mutate(test_reduction = as.factor(test_reduction)) %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "StartingART_15",
         year >= 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100)) %>% 
  ggplot(aes(year, mean, group = test_reduction, fill = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  scale_x_continuous("",expand = c(0, 0)) +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  scale_y_continuous("Adults starting ART (thousands)", labels =(function(l) {round(l/1e3,1)}),expand = c(0, 0)) +
  scale_fill_brewer("General\nHTS\nreduction", labels = c("None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill"), palette = "Set1") + 
  ggtitle("Adults starting ART\n(thousands; 15+ years)")
fig1e
```

Total adults on ART

```{r fig1f, echo=FALSE}
fig1f <- art_needs_costs %>% mutate(test_reduction = as.factor(test_reduction)) %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "TotalAdultsOnART",
         year >= 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100)) %>% 
  ggplot(aes(year, mean, group = test_reduction, fill = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  scale_x_continuous("",expand = c(0, 0)) +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  scale_y_continuous("Adults on ART (millions)", labels =(function(l) {round(l/1e6,1)}),expand = c(0, 0)) +
  scale_fill_brewer("General\nHTS\nreduction", labels = c("None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill"), palette = "Set1") + 
  ggtitle("Adults on ART\n(millions; 15+ years)")
fig1f
```

New HIV infections

```{r fig1g, echo=FALSE}
fig1g<- art_needs_costs %>% mutate(test_reduction = as.factor(test_reduction)) %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "NewAdultHIV",
         year >= 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100)) %>% 
  ggplot(aes(year, mean, group = test_reduction, fill = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  scale_x_continuous("",expand = c(0, 0)) +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  scale_y_continuous("New HIV infections (thousands)", labels =(function(l) {round(l/1e3,1)}),expand = c(0, 0)) +
  scale_fill_brewer("General\nHTS\nreduction", labels = c("None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill"), palette = "Set1") + 
  ggtitle("New HIV infections\n(thousands; 15+ years)")
fig1g
```

AIDS-related deaths

```{r fig1h, echo=FALSE}
fig1h<- art_needs_costs %>% mutate(test_reduction = as.factor(test_reduction)) %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "TotalAIDSdeathsadult",
         year >= 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100)) %>% 
  ggplot(aes(year, mean, group = test_reduction, fill = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  scale_x_continuous("",expand = c(0, 0)) +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 11), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11), 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        aspect.ratio=1, 
        legend.title = element_text(size = 11)) +
  scale_y_continuous("AIDS-deaths (thousands)", labels =(function(l) {round(l/1e3,1)}),expand = c(0, 0)) +
  scale_fill_brewer("General\nHTS\nreduction", labels = c("None", "25%", "50%", "75%", "100%"), aesthetics = c("colour", "fill"), palette = "Set1") + 
  ggtitle("AIDS-deaths\n(thousands; 15+ years)")
fig1h
```

New infections, AIDS-deaths, starting ART and total ART over time

```{r suppfig12, echo = FALSE}


suppfig12 <- ggarrange(fig1g, fig1h, fig1e, fig1f, ncol = 2, nrow = 2, common.legend = TRUE, legend = "right", labels = "AUTO")
ggsave(plot = suppfig12, filename = "figures/suppfig12.png", device = "png", units = "cm", height = 17, width = 20)
ggsave(plot = suppfig12, filename = "figures/suppfig12.pdf", device = "pdf", units = "cm", height = 17, width = 20)

```

## Supplementary figure 13a 

```{r supp fig13a, echo=FALSE}

temp13a <- art_change_summary %>% 
  mutate(art_coverage_2035 = as.numeric(art_coverage_2035),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(pitc_reduction_year == 2030,
         year == 2100, 
         scenario == "intervention", 
         indicator == "HIVinc15to49")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp13a, test_reduction == i)$art_coverage_2035
  mean_incidence_2100 <- filter(temp13a, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y =  mean_incidence_2100, 
                                    xout = 
                                      seq(min(art_change_summary$art_coverage_2035),
                                          max(art_change_summary$art_coverage_2035),
                                          length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2030, 
           test_reduction = i)
  temp13a <- bind_rows(temp13a, interpolated) 
}

temp13a <- temp13a[which(is.na(temp13a$future_value)),]

suppfig13a <- temp13a %>% 
  ggplot(aes(test_reduction, art_coverage_2035)) + 
  with_blur(
    geom_raster(aes(fill = log(1000*mean)), interpolate = TRUE),
    sigma = 0
  ) +
  geom_contour(aes(z = 1000*mean), color = "black", binwidth = 0.5) + 
  geom_contour(aes(z = 1000*mean), color = "black", breaks = 1, linewidth = 0.80) + 
  geom_text_contour(aes(z = 1000*mean),skip = 0, stroke = 0.1, stroke.colour = "white",label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.767), lty = "dotted") +
  scale_fill_gradient2("",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red",
                       midpoint = 0,
                       labels = (function(l) {round(exp(l),2)})
  ) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  annotate(geom = "text", x=10, y=0.767, label="Baseline", parse = TRUE) + 
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("HIV incidence in 2100\n(per 1000; 15-49 years)")
suppfig13a


```

## Supplementary figure 13b

```{r suppfig13b, echo=FALSE}
temp13b <- cumulative_art_change %>% 
  mutate(art_coverage_2035 = as.numeric(art_coverage_2035),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(indicator == "elimination_year", 
         pitc_reduction_year == 2030, 
         scenario == "intervention") %>% 
  arrange(desc(art_coverage_2035)) 

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp13b, test_reduction == i)$art_coverage_2035
  elimination_year <- filter(temp13b, test_reduction == i)$median
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = elimination_year, xout = seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(median = y) %>% 
    mutate(pitc_reduction_year = 2030, 
           test_reduction = i)
  temp13b <- bind_rows(temp13b, interpolated) 
}

temp13b <- temp13b[which(is.na(temp13b$future_value)),]

temp13b[which(temp13b$median == Inf),] <- NA

suppfig13b <- temp13b %>% 
  mutate(pitc_reduction_year = as.factor(pitc_reduction_year)) %>% 
  filter(pitc_reduction_year == 2030) %>% 
  ggplot(aes(x = test_reduction, y = art_coverage_2035, z = median)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = median), 
                        interpolate = TRUE)
  ) + 
  geom_contour(color = "black") + 
  geom_text_contour(skip = 0, stroke = 0.1, 
                    stroke.colour = "white",check_overlap = TRUE,min.size = 100,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.767), lty = "dotted") +
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 2055) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  annotate(geom = "text", x=90, y=0.767, label="Baseline", parse = TRUE) + 
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("HIV elimination year\n")
suppfig13b

```

## Supplementary figure 13c

``` {r suppfig13c, echo=FALSE}
temp13c <- cumulative_art_change %>% 
  filter(indicator == "NewAdultHIV", 
         scenario == "absolute_dif")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp13c, test_reduction == i)$art_coverage_2035
  mean <- filter(temp13c, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = mean, 
                                    xout =  seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2030, 
           test_reduction = i)
  temp13c <- bind_rows(temp13c, interpolated) 
}

temp13c <- temp13c[which(is.na(temp13c$future_value)),]

suppfig13c <- temp13c %>% 
  ggplot(aes(test_reduction, art_coverage_2035, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(),breaks = c(0, 2.5),show.legend = FALSE, color = "black") + 
  geom_contour(aes(),breaks = c(2.5, 5),show.legend = FALSE, color = "grey") +
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, breaks = c(0, 2.5, 5),skip = 0,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.768), lty = "dotted") +
  annotate(geom = "text", x=50, y=0.768, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional HIV infections\n2030-2080 (millions)")
suppfig13c
```

## Supplementary Figure 13d 
``` {r suppfig13d, echo = FALSE}
temp13d <- cumulative_art_change %>% 
  filter(indicator == "TotalAIDSdeathsadult", 
         scenario == "absolute_dif")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp13d, test_reduction == i)$art_coverage_2035
  mean <- filter(temp13d, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = mean, 
                                    xout = seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2030, 
           test_reduction = i)
  temp13d <- bind_rows(temp13d, interpolated) 
}

temp13d <- temp13d[which(is.na(temp13d$future_value)),]

suppfig13d <- temp13d %>% 
  ggplot(aes(test_reduction, art_coverage_2035, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(),breaks = 0, color = "black", show.legend = FALSE) +
  geom_contour(aes(),breaks = c(0.5, 1, 1.5), color = "grey",show.legend = FALSE) +
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, breaks = c(0,0.5, 1, 1.5), skip = 0,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.768), lty = "dotted") +
  annotate(geom = "text", x=50, y=0.768, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional AIDS deaths\n2030-2080 (millions)")
suppfig13d
```

## Combined supplementary figure 13 
```{r suppfig13, echo=FALSE}
suppfig13 <- ggarrange(suppfig13a, suppfig13b, suppfig13c, suppfig13d, nrow = 2, ncol = 2, labels = "AUTO", align = "v")
suppfig13
ggsave(filename = "figures/suppfig13.pdf", plot = suppfig13, device = "pdf", width = 20, units = "cm")
ggsave(filename = "figures/suppfig13.png", plot = suppfig13, device = "png", width = 20, units = "cm")
```

## Supplementary figure 14a 

```{r supp fig14a, echo=FALSE}

temp14a <- art_change_summary %>% 
  mutate(art_coverage_2035 = as.numeric(art_coverage_2035),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(pitc_reduction_year == 2035,
         year == 2100, 
         scenario == "intervention", 
         indicator == "HIVinc15to49")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp14a, test_reduction == i)$art_coverage_2035
  mean_incidence_2100 <- filter(temp14a, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y =  mean_incidence_2100, 
                                    xout = 
                                      seq(min(art_change_summary$art_coverage_2035),
                                          max(art_change_summary$art_coverage_2035),
                                          length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2035, 
           test_reduction = i)
  temp14a <- bind_rows(temp14a, interpolated) 
}

temp14a <- temp14a[which(is.na(temp14a$future_value)),]

suppfig14a <- temp14a %>% 
  ggplot(aes(test_reduction, art_coverage_2035)) + 
  with_blur(
    geom_raster(aes(fill = log(1000*mean)), interpolate = TRUE),
    sigma = 0
  ) +
  geom_contour(aes(z = 1000*mean), color = "black", binwidth = 0.5) + 
  geom_contour(aes(z = 1000*mean), color = "black", breaks = 1, linewidth = 0.80) + 
  geom_text_contour(aes(z = 1000*mean),skip = 0, stroke = 0.1, stroke.colour = "white",label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.767), lty = "dotted") +
  scale_fill_gradient2("",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red",
                       midpoint = 0,
                       labels = (function(l) {round(exp(l),2)})
  ) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  annotate(geom = "text", x=10, y=0.767, label="Baseline", parse = TRUE) + 
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("HIV incidence in 2100\n(per 1000; 15-49 years)")
suppfig14a


```

## Supplementary figure 14b

```{r suppfig14b, echo=FALSE}
temp14b <- cumulative_art_change %>% 
  mutate(art_coverage_2035 = as.numeric(art_coverage_2035),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(indicator == "elimination_year", 
         pitc_reduction_year == 2035, 
         scenario == "intervention") %>% 
  arrange(desc(art_coverage_2035)) 

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp14b, test_reduction == i)$art_coverage_2035
  elimination_year <- filter(temp14b, test_reduction == i)$median
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = elimination_year, xout = seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(median = y) %>% 
    mutate(pitc_reduction_year = 2035, 
           test_reduction = i)
  temp14b <- bind_rows(temp14b, interpolated) 
}

temp14b <- temp14b[which(is.na(temp14b$future_value)),]

temp14b[which(temp14b$median == Inf),] <- NA

suppfig14b <- temp14b %>% 
  mutate(pitc_reduction_year = as.factor(pitc_reduction_year)) %>% 
  filter(pitc_reduction_year == 2035) %>% 
  ggplot(aes(x = test_reduction, y = art_coverage_2035, z = median)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = median), 
                        interpolate = TRUE)
  ) + 
  geom_contour(color = "black") + 
  geom_text_contour(skip = 0, stroke = 0.1, 
                    stroke.colour = "white",check_overlap = TRUE,min.size = 100,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.767), lty = "dotted") +
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 2055) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  annotate(geom = "text", x=90, y=0.767, label="Baseline", parse = TRUE) + 
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("HIV elimination year\n")
suppfig14b

```

## Supplementary figure 14c

``` {r suppfig14c, echo=FALSE}
temp14c <- cumulative_art_change %>% 
  filter(indicator == "NewAdultHIV", 
         scenario == "absolute_dif")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp14c, test_reduction == i)$art_coverage_2035
  mean <- filter(temp14c, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = mean, 
                                    xout =  seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2035, 
           test_reduction = i)
  temp14c <- bind_rows(temp14c, interpolated) 
}

temp14c <- temp14c[which(is.na(temp14c$future_value)),]

suppfig14c <- temp14c %>% 
  ggplot(aes(test_reduction, art_coverage_2035, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(),breaks = c(0, 2.5),show.legend = FALSE, color = "black") + 
  geom_contour(aes(),breaks = c(2.5, 5),show.legend = FALSE, color = "grey") +
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, breaks = c(0, 2.5, 5),skip = 0,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.768), lty = "dotted") +
  annotate(geom = "text", x=50, y=0.768, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional HIV infections\n2035-2085 (millions)")
suppfig14c
```

## Supplementary Figure 14d 
``` {r suppfig14d, echo = FALSE}
temp14d <- cumulative_art_change %>% 
  filter(indicator == "TotalAIDSdeathsadult", 
         scenario == "absolute_dif")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp14d, test_reduction == i)$art_coverage_2035
  mean <- filter(temp14d, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = mean, 
                                    xout = seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2035, 
           test_reduction = i)
  temp14d <- bind_rows(temp14d, interpolated) 
}

temp14d <- temp14d[which(is.na(temp14d$future_value)),]

suppfig14d <- temp14d %>% 
  ggplot(aes(test_reduction, art_coverage_2035, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(),breaks = 0, color = "black", show.legend = FALSE) +
  geom_contour(aes(),breaks = c(0.5, 1, 1.5), color = "grey",show.legend = FALSE) +
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, breaks = c(0,0.5, 1, 1.5), skip = 0,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.768), lty = "dotted") +
  annotate(geom = "text", x=50, y=0.768, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional AIDS deaths\n2035-2085 (millions)")
suppfig14d
```

## Combined supplementary figure 14 
```{r suppfig14, echo=FALSE}
suppfig14 <- ggarrange(suppfig14a, suppfig14b, suppfig14c, suppfig14d, nrow = 2, ncol = 2, labels = "AUTO", align = "v")
suppfig14
ggsave(filename = "figures/suppfig14.pdf", plot = suppfig14, device = "pdf", width = 20, units = "cm")
ggsave(filename = "figures/suppfig14.png", plot = suppfig14, device = "png", width = 20, units = "cm")
```

## Supplementary figure 15a 

```{r supp fig15a, echo=FALSE}

temp15a <- art_change_summary %>% 
  mutate(art_coverage_2035 = as.numeric(art_coverage_2035),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(pitc_reduction_year == 2040,
         year == 2100, 
         scenario == "intervention", 
         indicator == "HIVinc15to49")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp15a, test_reduction == i)$art_coverage_2035
  mean_incidence_2100 <- filter(temp15a, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y =  mean_incidence_2100, 
                                    xout = 
                                      seq(min(art_change_summary$art_coverage_2035),
                                          max(art_change_summary$art_coverage_2035),
                                          length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2040, 
           test_reduction = i)
  temp15a <- bind_rows(temp15a, interpolated) 
}

temp15a <- temp15a[which(is.na(temp15a$future_value)),]

suppfig15a <- temp15a %>% 
  ggplot(aes(test_reduction, art_coverage_2035)) + 
  with_blur(
    geom_raster(aes(fill = log(1000*mean)), interpolate = TRUE),
    sigma = 0
  ) +
  geom_contour(aes(z = 1000*mean), color = "black", binwidth = 0.5) + 
  geom_contour(aes(z = 1000*mean), color = "black", breaks = 1, linewidth = 0.80) + 
  geom_text_contour(aes(z = 1000*mean),skip = 0, stroke = 0.1, stroke.colour = "white",label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.767), lty = "dotted") +
  scale_fill_gradient2("",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red",
                       midpoint = 0,
                       labels = (function(l) {round(exp(l),2)})
  ) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  annotate(geom = "text", x=10, y=0.767, label="Baseline", parse = TRUE) + 
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("HIV incidence in 2100\n(per 1000; 15-49 years)")
suppfig15a


```

## Supplementary figure 15b

```{r suppfig15b, echo=FALSE}
temp15b <- cumulative_art_change %>% 
  mutate(art_coverage_2035 = as.numeric(art_coverage_2035),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(indicator == "elimination_year", 
         pitc_reduction_year == 2040, 
         scenario == "intervention") %>% 
  arrange(desc(art_coverage_2035)) 

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp15b, test_reduction == i)$art_coverage_2035
  elimination_year <- filter(temp15b, test_reduction == i)$median
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = elimination_year, xout = seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(median = y) %>% 
    mutate(pitc_reduction_year = 2040, 
           test_reduction = i)
  temp15b <- bind_rows(temp15b, interpolated) 
}

temp15b <- temp15b[which(is.na(temp15b$future_value)),]

temp15b[which(temp15b$median == Inf),] <- NA

suppfig15b <- temp15b %>% 
  mutate(pitc_reduction_year = as.factor(pitc_reduction_year)) %>% 
  filter(pitc_reduction_year == 2040) %>% 
  ggplot(aes(x = test_reduction, y = art_coverage_2035, z = median)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = median), 
                        interpolate = TRUE)
  ) + 
  geom_contour(color = "black") + 
  geom_text_contour(skip = 0, stroke = 0.1, 
                    stroke.colour = "white",check_overlap = TRUE,min.size = 100,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.767), lty = "dotted") +
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 2055) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  annotate(geom = "text", x=90, y=0.767, label="Baseline", parse = TRUE) + 
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("HIV elimination year\n")
suppfig15b

```

## Supplementary figure 15c

``` {r suppfig15c, echo=FALSE}
temp15c <- cumulative_art_change %>% 
  filter(indicator == "NewAdultHIV", 
         scenario == "absolute_dif")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp15c, test_reduction == i)$art_coverage_2035
  mean <- filter(temp15c, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = mean, 
                                    xout =  seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2040, 
           test_reduction = i)
  temp15c <- bind_rows(temp15c, interpolated) 
}

temp15c <- temp15c[which(is.na(temp15c$future_value)),]

suppfig15c <- temp15c %>% 
  ggplot(aes(test_reduction, art_coverage_2035, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(),breaks = c(0, 2.5),show.legend = FALSE, color = "black") + 
  geom_contour(aes(),breaks = c(2.5, 5),show.legend = FALSE, color = "grey") +
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, breaks = c(0, 2.5, 5),skip = 0,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.768), lty = "dotted") +
  annotate(geom = "text", x=50, y=0.768, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional HIV infections\n2040-2090 (millions)")
suppfig15c
```

## Supplementary Figure 15d 
``` {r suppfig15d, echo = FALSE}
temp15d <- cumulative_art_change %>% 
  filter(indicator == "TotalAIDSdeathsadult", 
         scenario == "absolute_dif")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp15d, test_reduction == i)$art_coverage_2035
  mean <- filter(temp15d, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = mean, 
                                    xout = seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2040, 
           test_reduction = i)
  temp15d <- bind_rows(temp15d, interpolated) 
}

temp15d <- temp15d[which(is.na(temp15d$future_value)),]

suppfig15d <- temp15d %>% 
  ggplot(aes(test_reduction, art_coverage_2035, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(),breaks = 0, color = "black", show.legend = FALSE) +
  geom_contour(aes(),breaks = c(0.5, 1, 1.5), color = "grey",show.legend = FALSE) +
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, breaks = c(0,0.5, 1, 1.5), skip = 0,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.768), lty = "dotted") +
  annotate(geom = "text", x=50, y=0.768, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional AIDS deaths\n2040-2090 (millions)")
suppfig15d
```

## Combined supplementary figure 15 
```{r suppfig15, echo=FALSE}
suppfig15 <- ggarrange(suppfig15a, suppfig15b, suppfig15c, suppfig15d, nrow = 2, ncol = 2, labels = "AUTO", align = "v")
suppfig15
ggsave(filename = "figures/suppfig15.pdf", plot = suppfig15, device = "pdf", width = 20, units = "cm")
ggsave(filename = "figures/suppfig15.png", plot = suppfig15, device = "png", width = 20, units = "cm")
```

## Supplementary figure 16a 

```{r supp fig16a, echo=FALSE}

temp14a <- art_change_summary %>% 
  mutate(art_coverage_2035 = as.numeric(art_coverage_2035),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(pitc_reduction_year == 2045,
         year == 2100, 
         scenario == "intervention", 
         indicator == "HIVinc15to49")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp14a, test_reduction == i)$art_coverage_2035
  mean_incidence_2100 <- filter(temp14a, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y =  mean_incidence_2100, 
                                    xout = 
                                      seq(min(art_change_summary$art_coverage_2035),
                                          max(art_change_summary$art_coverage_2035),
                                          length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2045, 
           test_reduction = i)
  temp14a <- bind_rows(temp14a, interpolated) 
}

temp14a <- temp14a[which(is.na(temp14a$future_value)),]

suppfig14a <- temp14a %>% 
  ggplot(aes(test_reduction, art_coverage_2035)) + 
  with_blur(
    geom_raster(aes(fill = log(1000*mean)), interpolate = TRUE),
    sigma = 0
  ) +
  geom_contour(aes(z = 1000*mean), color = "black", binwidth = 0.5) + 
  geom_contour(aes(z = 1000*mean), color = "black", breaks = 1, linewidth = 0.80) + 
  geom_text_contour(aes(z = 1000*mean),skip = 0, stroke = 0.1, stroke.colour = "white",label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.767), lty = "dotted") +
  scale_fill_gradient2("",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red",
                       midpoint = 0,
                       labels = (function(l) {round(exp(l),2)})
  ) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  annotate(geom = "text", x=10, y=0.767, label="Baseline", parse = TRUE) + 
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("HIV incidence in 2100\n(per 1000; 15-49 years)")
suppfig14a


```

## Supplementary figure 14b

```{r suppfig14b, echo=FALSE}
temp14b <- cumulative_art_change %>% 
  mutate(art_coverage_2035 = as.numeric(art_coverage_2035),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(indicator == "elimination_year", 
         pitc_reduction_year == 2045, 
         scenario == "intervention") %>% 
  arrange(desc(art_coverage_2035)) 

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp14b, test_reduction == i)$art_coverage_2035
  elimination_year <- filter(temp14b, test_reduction == i)$median
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = elimination_year, xout = seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(median = y) %>% 
    mutate(pitc_reduction_year = 2045, 
           test_reduction = i)
  temp14b <- bind_rows(temp14b, interpolated) 
}

temp14b <- temp14b[which(is.na(temp14b$future_value)),]

temp14b[which(temp14b$median == Inf),] <- NA

suppfig14b <- temp14b %>% 
  mutate(pitc_reduction_year = as.factor(pitc_reduction_year)) %>% 
  filter(pitc_reduction_year == 2045) %>% 
  ggplot(aes(x = test_reduction, y = art_coverage_2035, z = median)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = median), 
                        interpolate = TRUE)
  ) + 
  geom_contour(color = "black") + 
  geom_text_contour(skip = 0, stroke = 0.1, 
                    stroke.colour = "white",check_overlap = TRUE,min.size = 100,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.767), lty = "dotted") +
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 2055) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  annotate(geom = "text", x=90, y=0.767, label="Baseline", parse = TRUE) + 
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("HIV elimination year\n")
suppfig14b

```

## Supplementary figure 14c

``` {r suppfig14c, echo=FALSE}
temp14c <- cumulative_art_change %>% 
  filter(indicator == "NewAdultHIV", 
         scenario == "absolute_dif")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp14c, test_reduction == i)$art_coverage_2035
  mean <- filter(temp14c, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = mean, 
                                    xout =  seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2035, 
           test_reduction = i)
  temp14c <- bind_rows(temp14c, interpolated) 
}

temp14c <- temp14c[which(is.na(temp14c$future_value)),]

suppfig14c <- temp14c %>% 
  ggplot(aes(test_reduction, art_coverage_2035, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(),breaks = c(0, 2.5),show.legend = FALSE, color = "black") + 
  geom_contour(aes(),breaks = c(2.5, 5),show.legend = FALSE, color = "grey") +
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, breaks = c(0, 2.5, 5),skip = 0,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.768), lty = "dotted") +
  annotate(geom = "text", x=50, y=0.768, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional HIV infections\n2045-2095 (millions)")
suppfig14c
```

## Supplementary Figure 14d 
``` {r suppfig14d, echo = FALSE}
temp14d <- cumulative_art_change %>% 
  filter(indicator == "TotalAIDSdeathsadult", 
         scenario == "absolute_dif")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp14d, test_reduction == i)$art_coverage_2035
  mean <- filter(temp14d, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = mean, 
                                    xout = seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2035, 
           test_reduction = i)
  temp14d <- bind_rows(temp14d, interpolated) 
}

temp14d <- temp14d[which(is.na(temp14d$future_value)),]

suppfig14d <- temp14d %>% 
  ggplot(aes(test_reduction, art_coverage_2035, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(),breaks = 0, color = "black", show.legend = FALSE) +
  geom_contour(aes(),breaks = c(0.5, 1, 1.5), color = "grey",show.legend = FALSE) +
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, breaks = c(0,0.5, 1, 1.5), skip = 0,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.768), lty = "dotted") +
  annotate(geom = "text", x=50, y=0.768, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional AIDS deaths\n2045-2095 (millions)")
suppfig14d
```

## Combined supplementary figure 14 
```{r suppfig14, echo=FALSE}
suppfig14 <- ggarrange(suppfig14a, suppfig14b, suppfig14c, suppfig14d, nrow = 2, ncol = 2, labels = "AUTO", align = "v")
suppfig14
ggsave(filename = "figures/suppfig14.pdf", plot = suppfig14, device = "pdf", width = 20, units = "cm")
ggsave(filename = "figures/suppfig14.png", plot = suppfig14, device = "png", width = 20, units = "cm")
```

## Supplementary figure 15a 

```{r supp fig15a, echo=FALSE}

temp15a <- art_change_summary %>% 
  mutate(art_coverage_2035 = as.numeric(art_coverage_2035),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(pitc_reduction_year == 2050,
         year == 2100, 
         scenario == "intervention", 
         indicator == "HIVinc15to49")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp15a, test_reduction == i)$art_coverage_2035
  mean_incidence_2100 <- filter(temp15a, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y =  mean_incidence_2100, 
                                    xout = 
                                      seq(min(art_change_summary$art_coverage_2035),
                                          max(art_change_summary$art_coverage_2035),
                                          length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2050, 
           test_reduction = i)
  temp15a <- bind_rows(temp15a, interpolated) 
}

temp15a <- temp15a[which(is.na(temp15a$future_value)),]

suppfig15a <- temp15a %>% 
  ggplot(aes(test_reduction, art_coverage_2035)) + 
  with_blur(
    geom_raster(aes(fill = log(1000*mean)), interpolate = TRUE),
    sigma = 0
  ) +
  geom_contour(aes(z = 1000*mean), color = "black", binwidth = 0.5) + 
  geom_contour(aes(z = 1000*mean), color = "black", breaks = 1, linewidth = 0.80) + 
  geom_text_contour(aes(z = 1000*mean),skip = 0, stroke = 0.1, stroke.colour = "white",label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.767), lty = "dotted") +
  scale_fill_gradient2("",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red",
                       midpoint = 0,
                       labels = (function(l) {round(exp(l),2)})
  ) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  annotate(geom = "text", x=10, y=0.767, label="Baseline", parse = TRUE) + 
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("HIV incidence in 2100\n(per 1000; 15-49 years)")
suppfig15a


```

## Supplementary figure 15b

```{r suppfig15b, echo=FALSE}
temp15b <- cumulative_art_change %>% 
  mutate(art_coverage_2035 = as.numeric(art_coverage_2035),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(indicator == "elimination_year", 
         pitc_reduction_year == 2050, 
         scenario == "intervention") %>% 
  arrange(desc(art_coverage_2035)) 

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp15b, test_reduction == i)$art_coverage_2035
  elimination_year <- filter(temp15b, test_reduction == i)$median
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = elimination_year, xout = seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(median = y) %>% 
    mutate(pitc_reduction_year = 2050, 
           test_reduction = i)
  temp15b <- bind_rows(temp15b, interpolated) 
}

temp15b <- temp15b[which(is.na(temp15b$future_value)),]

temp15b[which(temp15b$median == Inf),] <- NA

suppfig15b <- temp15b %>% 
  mutate(pitc_reduction_year = as.factor(pitc_reduction_year)) %>% 
  filter(pitc_reduction_year == 2050) %>% 
  ggplot(aes(x = test_reduction, y = art_coverage_2035, z = median)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = median), 
                        interpolate = TRUE)
  ) + 
  geom_contour(color = "black") + 
  geom_text_contour(skip = 0, stroke = 0.1, 
                    stroke.colour = "white",check_overlap = TRUE,min.size = 100,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.767), lty = "dotted") +
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 2055) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  annotate(geom = "text", x=90, y=0.767, label="Baseline", parse = TRUE) + 
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("HIV elimination year\n")
suppfig15b

```

## Supplementary figure 15c

``` {r suppfig15c, echo=FALSE}
temp15c <- cumulative_art_change %>% 
  filter(indicator == "NewAdultHIV", 
         scenario == "absolute_dif")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp15c, test_reduction == i)$art_coverage_2035
  mean <- filter(temp15c, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = mean, 
                                    xout =  seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2035, 
           test_reduction = i)
  temp15c <- bind_rows(temp15c, interpolated) 
}

temp15c <- temp15c[which(is.na(temp15c$future_value)),]

suppfig15c <- temp15c %>% 
  ggplot(aes(test_reduction, art_coverage_2035, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(),breaks = c(0, 2.5),show.legend = FALSE, color = "black") + 
  geom_contour(aes(),breaks = c(2.5, 5),show.legend = FALSE, color = "grey") +
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, breaks = c(0, 2.5, 5),skip = 0,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.768), lty = "dotted") +
  annotate(geom = "text", x=50, y=0.768, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional HIV infections\n2050-2100 (millions)")
suppfig15c
```

## Supplementary Figure 15d 
``` {r suppfig15d, echo = FALSE}
temp15d <- cumulative_art_change %>% 
  filter(indicator == "TotalAIDSdeathsadult", 
         scenario == "absolute_dif")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp15d, test_reduction == i)$art_coverage_2035
  mean <- filter(temp15d, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = mean, 
                                    xout = seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 1000))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2035, 
           test_reduction = i)
  temp15d <- bind_rows(temp15d, interpolated) 
}

temp15d <- temp15d[which(is.na(temp15d$future_value)),]

suppfig15d <- temp15d %>% 
  ggplot(aes(test_reduction, art_coverage_2035, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(),breaks = 0, color = "black", show.legend = FALSE) +
  geom_contour(aes(),breaks = c(0.5, 1, 1.5), color = "grey",show.legend = FALSE) +
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, breaks = c(0,0.5, 1, 1.5), skip = 0,label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 0.768), lty = "dotted") +
  annotate(geom = "text", x=50, y=0.768, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous(name ="ART coverage (%)",
                     labels =(function(l) {round(l*1e2,1)}),
                     expand = c(0,0)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional AIDS deaths\n2050-2100 (millions)")
suppfig15d
```

## Combined supplementary figure 15 
```{r suppfig15, echo=FALSE}
suppfig15 <- ggarrange(suppfig15a, suppfig15b, suppfig15c, suppfig15d, nrow = 2, ncol = 2, labels = "AUTO", align = "v")
suppfig15
ggsave(filename = "figures/suppfig15.pdf", plot = suppfig15, device = "pdf", width = 20, units = "cm")
ggsave(filename = "figures/suppfig15.png", plot = suppfig15, device = "png", width = 20, units = "cm")
```

## Supplementary figure 16a

```{r suppfig16a, echo=FALSE}
temp16a <- condom_change_summary %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(pitc_reduction_year == 2030,
         year == 2100, 
         scenario == "intervention", 
         indicator == "HIVinc15to49")

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp16a, test_reduction == i)$overall_condom_usage
  mean_incidence_2100 <- filter(temp16a, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean_incidence_2100, 
                                    xout = seq(min(condom_change_summary$overall_condom_usage), max(condom_change_summary$overall_condom_usage),length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2030, 
           test_reduction = i)
  
  
  temp16a <- bind_rows(temp16a, interpolated) 
}
temp16a <- temp16a[which(is.na(temp16a$future_value)),]

suppfig16a <- temp16a %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction), 
         log_incidence = log(1000*mean)) %>% 
  ggplot(aes(x = test_reduction, y = overall_condom_usage)) + 
  with_blur(geom_raster(aes(fill = as.numeric(log_incidence)), 
                        interpolate = TRUE),sigma=0) + 
  geom_contour(aes(z = 1000*mean), 
               color = "black", breaks = c(0.5, 1, 2, 3, 4, 5, 6, 7, 8, 9)) + 
  geom_contour(aes(z = 1000*mean), 
               color = "black", breaks = 1, linewidth = 0.80) +
  geom_text_contour(aes(z = 1000*mean),
                    skip = 0, stroke = 0.1, 
                    stroke.colour = "white",
                    breaks = c(0.5, 1, 2, 3, 4, 5, 6, 7, 8, 9), 
                    label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted")+
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red",
                       midpoint = 0,
                       labels = (function(l) {round(exp(l),2)})
  ) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("General HTS reduced from 2030") +
  annotate(geom = "text", x = 15, y = 33.9, label = "Baseline")
suppfig16a
```

## Supplementary 16b

```{r suppfig16b, echo = FALSE}

temp16b <- condom_change_cumulative %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(indicator == "elimination_year", 
         pitc_reduction_year == 2030, 
         scenario == "intervention") %>% 
  arrange(desc(overall_condom_usage)) 

temp16b[which(temp16b$median == Inf),] <- NA

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp16b, test_reduction == i)$overall_condom_usage
  elimination_year <- filter(temp16b, test_reduction == i)$median
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = elimination_year, seq(min(condom_change_cumulative$overall_condom_usage), max(condom_change_cumulative$overall_condom_usage),length.out = 1000), 
                                    method = "linear", na.rm = FALSE)) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(median = y) %>% 
    mutate(pitc_reduction_year = 2030, 
           test_reduction = i)
  temp16b <- bind_rows(temp16b, interpolated) 
}

temp16b <- temp16b[which(is.na(temp16b$future_value)),]

temp16b[which(temp16b$median == Inf),] <- NA

suppfig16b <- temp16b %>% 
  ggplot(aes(x = test_reduction, y = overall_condom_usage)) +
  with_blur(geom_raster(aes(fill = median), interpolate = TRUE, na.rm = TRUE), sigma = 0) +
  geom_contour(aes(z = median),color = "black") + 
  geom_text_contour(aes(z = median), skip = 0, 
                    stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, 
                    min.size = 100, 
                    label.placer = label_placer_fraction())+
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 2055) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted")+
  annotate(geom = "text", x=90, y=33.9, label="Baseline", parse = TRUE) + 
  ggtitle("General HTS reduced from 2030")
suppfig16b
```

## Supplementary figure 16c

```{r suppfig16c, echo=FALSE}

temp16c <- condom_change_cumulative %>% 
  filter(indicator == "NewAdultHIV", 
         scenario == "absolute_dif", 
         pitc_reduction_year == 2030)

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp16c, test_reduction == i)$overall_condom_usage
  mean <- filter(temp16c, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean, 
                                    xout = seq(min(condom_change_cumulative$overall_condom_usage),
                                               max(condom_change_cumulative$overall_condom_usage), length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2030, 
           test_reduction = i)
  temp16c <- bind_rows(temp16c, interpolated) 
}

temp16c <- temp16c[which(is.na(temp16c$future_value)),]

suppfig16c <- temp16c %>% 
ggplot(aes(test_reduction, overall_condom_usage, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(), color = "black",breaks = 0,show.legend = FALSE) + 
  geom_contour(aes(), color = "grey",breaks = c(2.5, 5, 7.5, 10),show.legend = FALSE) + 
  geom_text_contour(stroke = 0.1, 
                    stroke.colour = "white",
                    check_overlap = TRUE, 
                    breaks = c(0,2.5, 5, 7.5, 10),
                    label.placer = label_placer_fraction(), skip = 0) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted") +
  annotate(geom = "text", x=50, y=33.9, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional HIV infections\n2030-2080 (millions)")
suppfig16c


```

## Supplementary figure 16d

```{r suppfig16d, echo = FALSE}

temp16d <- condom_change_cumulative %>% 
  filter(indicator == "TotalAIDSdeathsadult", 
         scenario == "absolute_dif", 
         pitc_reduction_year == 2030)

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp16d, test_reduction == i)$overall_condom_usage
  mean <- filter(temp16d, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean, 
                                    xout = seq(min(condom_change_cumulative$overall_condom_usage), max(condom_change_cumulative$overall_condom_usage), length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2030, 
           test_reduction = i)
  temp16d <- bind_rows(temp16d, interpolated) 
}

temp16d <- temp16d[which(is.na(temp16d$future_value)),]

suppfig16d <- temp16d %>% 
  ggplot(aes(test_reduction, overall_condom_usage, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(), color = "black",breaks = 0,show.legend = FALSE) + 
  geom_contour(aes(), color = "grey",breaks = c(0.5, 1.0, 1.5, 2.0),show.legend = FALSE) + 
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, 
                    breaks = c(0, 0.5, 1.0, 1.5, 2.0), skip = 0,
                    label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted") +
  annotate(geom = "text", x=50, y=33.9, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) +
  ggtitle("Additional AIDS deaths\n2030-2080 (millions)")
suppfig16d

```

### Combined Supplemntary Figure 16

``` {r suppfig16, echo = FALSE}
suppfig16<- ggarrange(suppfig16a, suppfig16b, suppfig16c, suppfig16d, nrow = 2, ncol = 2, legend = "right", labels = "AUTO")
suppfig16
ggsave(filename = "figures/suppfig16.pdf", plot = suppfig16, device = "pdf", width = 20, units = "cm")
ggsave(filename = "figures/suppfig16.png", plot = suppfig16, device = "png", width = 20, units = "cm")
```


## Supplementary figure 17a

```{r suppfig17a, echo=FALSE}
temp17a <- condom_change_summary %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(pitc_reduction_year == 2035,
         year == 2100, 
         scenario == "intervention", 
         indicator == "HIVinc15to49")

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp17a, test_reduction == i)$overall_condom_usage
  mean_incidence_2100 <- filter(temp17a, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean_incidence_2100, 
                                    xout = seq(min(condom_change_summary$overall_condom_usage), max(condom_change_summary$overall_condom_usage),length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2035, 
           test_reduction = i)
  
  
  temp17a <- bind_rows(temp17a, interpolated) 
}
temp17a <- temp17a[which(is.na(temp17a$future_value)),]

suppfig17a <- temp17a %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction), 
         log_incidence = log(1000*mean)) %>% 
  ggplot(aes(x = test_reduction, y = overall_condom_usage)) + 
  with_blur(geom_raster(aes(fill = as.numeric(log_incidence)), 
                        interpolate = TRUE),sigma=0) + 
  geom_contour(aes(z = 1000*mean), 
               color = "black", breaks = c(0.5, 1, 2, 3, 4, 5, 6, 7, 8, 9)) + 
  geom_contour(aes(z = 1000*mean), 
               color = "black", breaks = 1, linewidth = 0.80) +
  geom_text_contour(aes(z = 1000*mean),
                    skip = 0, stroke = 0.1, 
                    stroke.colour = "white",
                    breaks = c(0.5, 1, 2, 3, 4, 5, 6, 7, 8, 9), 
                    label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted")+
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red",
                       midpoint = 0,
                       labels = (function(l) {round(exp(l),2)})
  ) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("General HTS reduced from 2035") +
  annotate(geom = "text", x = 15, y = 33.9, label = "Baseline")
suppfig17a
```

## Supplementary 17b

```{r suppfig17b, echo = FALSE}

temp17b <- condom_change_cumulative %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(indicator == "elimination_year", 
         pitc_reduction_year == 2035, 
         scenario == "intervention") %>% 
  arrange(desc(overall_condom_usage)) 

temp17b[which(temp17b$median == Inf),] <- NA

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp17b, test_reduction == i)$overall_condom_usage
  elimination_year <- filter(temp17b, test_reduction == i)$median
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = elimination_year, seq(min(condom_change_cumulative$overall_condom_usage), max(condom_change_cumulative$overall_condom_usage),length.out = 1000), 
                                    method = "linear", na.rm = FALSE)) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(median = y) %>% 
    mutate(pitc_reduction_year = 2035, 
           test_reduction = i)
  temp17b <- bind_rows(temp17b, interpolated) 
}

temp17b <- temp17b[which(is.na(temp17b$future_value)),]

temp17b[which(temp17b$median == Inf),] <- NA

suppfig17b <- temp17b %>% 
  ggplot(aes(x = test_reduction, y = overall_condom_usage)) +
  with_blur(geom_raster(aes(fill = median), interpolate = TRUE, na.rm = TRUE), sigma = 0) +
  geom_contour(aes(z = median),color = "black") + 
  geom_text_contour(aes(z = median), skip = 0, 
                    stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, 
                    min.size = 100, 
                    label.placer = label_placer_fraction())+
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 2055) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted")+
  annotate(geom = "text", x=90, y=33.9, label="Baseline", parse = TRUE) + 
  ggtitle("General HTS reduced from 2035")
suppfig17b
```

## Supplementary figure 17c

```{r suppfig17c, echo=FALSE}

temp17c <- condom_change_cumulative %>% 
  filter(indicator == "NewAdultHIV", 
         scenario == "absolute_dif",
         pitc_reduction_year == 2035)

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp17c, test_reduction == i)$overall_condom_usage
  mean <- filter(temp17c, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean, 
                                    xout = seq(min(condom_change_cumulative$overall_condom_usage),
                                               max(condom_change_cumulative$overall_condom_usage), length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2035, 
           test_reduction = i)
  temp17c <- bind_rows(temp17c, interpolated) 
}

temp17c <- temp17c[which(is.na(temp17c$future_value)),]

suppfig17c <- temp17c %>% 
ggplot(aes(test_reduction, overall_condom_usage, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(), color = "black",breaks = 0,show.legend = FALSE) + 
  geom_contour(aes(), color = "grey",breaks = c(2.5, 5, 7.5, 10),show.legend = FALSE) + 
  geom_text_contour(stroke = 0.1, 
                    stroke.colour = "white",
                    check_overlap = TRUE, 
                    breaks = c(0,2.5, 5, 7.5, 10),
                    label.placer = label_placer_fraction(), skip = 0) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted") +
  annotate(geom = "text", x=50, y=33.9, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional HIV infections\n2035-2085 (millions)")
suppfig17c


```

## Supplementary figure 17d

```{r suppfig17d, echo = FALSE}

temp17d <- condom_change_cumulative %>% 
  filter(indicator == "TotalAIDSdeathsadult", 
         scenario == "absolute_dif",
         pitc_reduction_year == 2035)

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp17d, test_reduction == i)$overall_condom_usage
  mean <- filter(temp17d, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean, 
                                    xout = seq(min(condom_change_cumulative$overall_condom_usage), max(condom_change_cumulative$overall_condom_usage), length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2035, 
           test_reduction = i)
  temp17d <- bind_rows(temp17d, interpolated) 
}

temp17d <- temp17d[which(is.na(temp17d$future_value)),]

suppfig17d <- temp17d %>% 
  ggplot(aes(test_reduction, overall_condom_usage, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(), color = "black",breaks = 0,show.legend = FALSE) + 
  geom_contour(aes(), color = "grey",breaks = c(0.5, 1.0, 1.5, 2.0),show.legend = FALSE) + 
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, 
                    breaks = c(0, 0.5, 1.0, 1.5, 2.0), skip = 0,
                    label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted") +
  annotate(geom = "text", x=50, y=33.9, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) +
  ggtitle("Additional AIDS deaths\n2035-2085 (millions)")
suppfig17d

```

### Combined Supplemntary Figure 17

``` {r suppfig17, echo = FALSE}
suppfig17<- ggarrange(suppfig17a, suppfig17b, suppfig17c, suppfig17d, nrow = 2, ncol = 2, legend = "right", labels = "AUTO")
suppfig17
ggsave(filename = "figures/suppfig17.pdf", plot = suppfig17, device = "pdf", width = 20, units = "cm")
ggsave(filename = "figures/suppfig17.png", plot = suppfig17, device = "png", width = 20, units = "cm")
```

## Supplementary figure 18a

```{r suppfig18a, echo=FALSE}
temp18a <- condom_change_summary %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(pitc_reduction_year == 2040,
         year == 2100, 
         scenario == "intervention", 
         indicator == "HIVinc15to49")

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp18a, test_reduction == i)$overall_condom_usage
  mean_incidence_2100 <- filter(temp18a, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean_incidence_2100, 
                                    xout = seq(min(condom_change_summary$overall_condom_usage), max(condom_change_summary$overall_condom_usage),length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2040, 
           test_reduction = i)
  
  
  temp18a <- bind_rows(temp18a, interpolated) 
}
temp18a <- temp18a[which(is.na(temp18a$future_value)),]

suppfig18a <- temp18a %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction), 
         log_incidence = log(1000*mean)) %>% 
  ggplot(aes(x = test_reduction, y = overall_condom_usage)) + 
  with_blur(geom_raster(aes(fill = as.numeric(log_incidence)), 
                        interpolate = TRUE),sigma=0) + 
  geom_contour(aes(z = 1000*mean), 
               color = "black", breaks = c(0.5, 1, 2, 3, 4, 5, 6, 7, 8, 9)) + 
  geom_contour(aes(z = 1000*mean), 
               color = "black", breaks = 1, linewidth = 0.80) +
  geom_text_contour(aes(z = 1000*mean),
                    skip = 0, stroke = 0.1, 
                    stroke.colour = "white",
                    breaks = c(0.5, 1, 2, 3, 4, 5, 6, 7, 8, 9), 
                    label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted")+
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red",
                       midpoint = 0,
                       labels = (function(l) {round(exp(l),2)})
  ) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("General HTS reduced from 2040") +
  annotate(geom = "text", x = 15, y = 33.9, label = "Baseline")
suppfig18a
```

## Supplementary 18b

```{r suppfig18b, echo = FALSE}

temp18b <- condom_change_cumulative %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(indicator == "elimination_year", 
         pitc_reduction_year == 2040, 
         scenario == "intervention") %>% 
  arrange(desc(overall_condom_usage)) 

temp18b[which(temp18b$median == Inf),] <- NA

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp18b, test_reduction == i)$overall_condom_usage
  elimination_year <- filter(temp18b, test_reduction == i)$median
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = elimination_year, seq(min(condom_change_cumulative$overall_condom_usage), max(condom_change_cumulative$overall_condom_usage),length.out = 1000), 
                                    method = "linear", na.rm = FALSE)) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(median = y) %>% 
    mutate(pitc_reduction_year = 2040, 
           test_reduction = i)
  temp18b <- bind_rows(temp18b, interpolated) 
}

temp18b <- temp18b[which(is.na(temp18b$future_value)),]

temp18b[which(temp18b$median == Inf),] <- NA

suppfig18b <- temp18b %>% 
  ggplot(aes(x = test_reduction, y = overall_condom_usage)) +
  with_blur(geom_raster(aes(fill = median), interpolate = TRUE, na.rm = TRUE), sigma = 0) +
  geom_contour(aes(z = median),color = "black") + 
  geom_text_contour(aes(z = median), skip = 0, 
                    stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, 
                    min.size = 100, 
                    label.placer = label_placer_fraction())+
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 2055) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted")+
  annotate(geom = "text", x=90, y=33.9, label="Baseline", parse = TRUE) + 
  ggtitle("General HTS reduced from 2040")
suppfig18b
```

## Supplementary figure 18c

```{r suppfig18c, echo=FALSE}

temp18c <- condom_change_cumulative %>% 
  filter(indicator == "NewAdultHIV", 
         scenario == "absolute_dif",
         pitc_reduction_year == 2040)

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp18c, test_reduction == i)$overall_condom_usage
  mean <- filter(temp18c, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean, 
                                    xout = seq(min(condom_change_cumulative$overall_condom_usage),
                                               max(condom_change_cumulative$overall_condom_usage), length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2040, 
           test_reduction = i)
  temp18c <- bind_rows(temp18c, interpolated) 
}

temp18c <- temp18c[which(is.na(temp18c$future_value)),]

suppfig18c <- temp18c %>% 
ggplot(aes(test_reduction, overall_condom_usage, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(), color = "black",breaks = 0,show.legend = FALSE) + 
  geom_contour(aes(), color = "grey",breaks = c(2.5, 5, 7.5, 10),show.legend = FALSE) + 
  geom_text_contour(stroke = 0.1, 
                    stroke.colour = "white",
                    check_overlap = TRUE, 
                    breaks = c(0,2.5, 5, 7.5, 10),
                    label.placer = label_placer_fraction(), skip = 0) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted") +
  annotate(geom = "text", x=50, y=33.9, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional HIV infections\n2040-2090 (millions)")
suppfig18c


```

## Supplementary figure 18d

```{r suppfig18d, echo = FALSE}

temp18d <- condom_change_cumulative %>% 
  filter(indicator == "TotalAIDSdeathsadult", 
         scenario == "absolute_dif",
         pitc_reduction_year == 2040)

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp18d, test_reduction == i)$overall_condom_usage
  mean <- filter(temp18d, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean, 
                                    xout = seq(min(condom_change_cumulative$overall_condom_usage), max(condom_change_cumulative$overall_condom_usage), length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2040, 
           test_reduction = i)
  temp18d <- bind_rows(temp18d, interpolated) 
}

temp18d <- temp18d[which(is.na(temp18d$future_value)),]

suppfig18d <- temp18d %>% 
  ggplot(aes(test_reduction, overall_condom_usage, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(), color = "black",breaks = 0,show.legend = FALSE) + 
  geom_contour(aes(), color = "grey",breaks = c(0.5, 1.0, 1.5, 2.0),show.legend = FALSE) + 
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, 
                    breaks = c(0, 0.5, 1.0, 1.5, 2.0), skip = 0,
                    label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted") +
  annotate(geom = "text", x=50, y=33.9, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) +
  ggtitle("Additional AIDS deaths\n2040-2090 (millions)")
suppfig18d

```

### Combined Supplemntary Figure 18

``` {r suppfig18, echo = FALSE}
suppfig18<- ggarrange(suppfig18a, suppfig18b, suppfig18c, suppfig18d, nrow = 2, ncol = 2, legend = "right", labels = "AUTO")
suppfig18
ggsave(filename = "figures/suppfig18.pdf", plot = suppfig18, device = "pdf", width = 20, units = "cm")
ggsave(filename = "figures/suppfig18.png", plot = suppfig18, device = "png", width = 20, units = "cm")
```


## Supplementary figure 19a

```{r suppfig19a, echo=FALSE}
temp19a <- condom_change_summary %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(pitc_reduction_year == 2045,
         year == 2100, 
         scenario == "intervention", 
         indicator == "HIVinc15to49")

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp19a, test_reduction == i)$overall_condom_usage
  mean_incidence_2100 <- filter(temp19a, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean_incidence_2100, 
                                    xout = seq(min(condom_change_summary$overall_condom_usage), max(condom_change_summary$overall_condom_usage),length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2045, 
           test_reduction = i)
  
  
  temp19a <- bind_rows(temp19a, interpolated) 
}
temp19a <- temp19a[which(is.na(temp19a$future_value)),]

suppfig19a <- temp19a %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction), 
         log_incidence = log(1000*mean)) %>% 
  ggplot(aes(x = test_reduction, y = overall_condom_usage)) + 
  with_blur(geom_raster(aes(fill = as.numeric(log_incidence)), 
                        interpolate = TRUE),sigma=0) + 
  geom_contour(aes(z = 1000*mean), 
               color = "black", breaks = c(0.5, 1, 2, 3, 4, 5, 6, 7, 8, 9)) + 
  geom_contour(aes(z = 1000*mean), 
               color = "black", breaks = 1, linewidth = 0.80) +
  geom_text_contour(aes(z = 1000*mean),
                    skip = 0, stroke = 0.1, 
                    stroke.colour = "white",
                    breaks = c(0.5, 1, 2, 3, 4, 5, 6, 7, 8, 9), 
                    label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted")+
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red",
                       midpoint = 0,
                       labels = (function(l) {round(exp(l),2)})
  ) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("General HTS reduced from 2045") +
  annotate(geom = "text", x = 15, y = 33.9, label = "Baseline")
suppfig19a
```

## Supplementary 19b

```{r suppfig19b, echo = FALSE}

temp19b <- condom_change_cumulative %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(indicator == "elimination_year", 
         pitc_reduction_year == 2045, 
         scenario == "intervention") %>% 
  arrange(desc(overall_condom_usage)) 

temp19b[which(temp19b$median == Inf),] <- NA

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp19b, test_reduction == i)$overall_condom_usage
  elimination_year <- filter(temp19b, test_reduction == i)$median
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = elimination_year, seq(min(condom_change_cumulative$overall_condom_usage), max(condom_change_cumulative$overall_condom_usage),length.out = 1000), 
                                    method = "linear", na.rm = FALSE)) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(median = y) %>% 
    mutate(pitc_reduction_year = 2045, 
           test_reduction = i)
  temp19b <- bind_rows(temp19b, interpolated) 
}

temp19b <- temp19b[which(is.na(temp19b$future_value)),]

temp19b[which(temp19b$median == Inf),] <- NA

suppfig19b <- temp19b %>% 
  ggplot(aes(x = test_reduction, y = overall_condom_usage)) +
  with_blur(geom_raster(aes(fill = median), interpolate = TRUE, na.rm = TRUE), sigma = 0) +
  geom_contour(aes(z = median),color = "black") + 
  geom_text_contour(aes(z = median), skip = 0, 
                    stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, 
                    min.size = 20, 
                    label.placer = label_placer_fraction())+
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 2055) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted")+
  annotate(geom = "text", x=90, y=33.9, label="Baseline", parse = TRUE) + 
  ggtitle("General HTS reduced from 2045")
suppfig19b
```

## Supplementary figure 19c

```{r suppfig19c, echo=FALSE}

temp19c <- condom_change_cumulative %>% 
  filter(indicator == "NewAdultHIV", 
         scenario == "absolute_dif",
         pitc_reduction_year == 2045)

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp19c, test_reduction == i)$overall_condom_usage
  mean <- filter(temp19c, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean, 
                                    xout = seq(min(condom_change_cumulative$overall_condom_usage),
                                               max(condom_change_cumulative$overall_condom_usage), length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2045, 
           test_reduction = i)
  temp19c <- bind_rows(temp19c, interpolated) 
}

temp19c <- temp19c[which(is.na(temp19c$future_value)),]

suppfig19c <- temp19c %>% 
ggplot(aes(test_reduction, overall_condom_usage, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(), color = "black",breaks = 0,show.legend = FALSE) + 
  geom_contour(aes(), color = "grey",breaks = c(2.5, 5, 7.5, 10),show.legend = FALSE) + 
  geom_text_contour(stroke = 0.1, 
                    stroke.colour = "white",
                    check_overlap = TRUE, 
                    breaks = c(0,2.5, 5, 7.5, 10),
                    label.placer = label_placer_fraction(), skip = 0) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted") +
  annotate(geom = "text", x=50, y=33.9, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional HIV infections\n2045-2095 (millions)")
suppfig19c


```

## Supplementary figure 19d

```{r suppfig19d, echo = FALSE}

temp19d <- condom_change_cumulative %>% 
  filter(indicator == "TotalAIDSdeathsadult", 
         scenario == "absolute_dif",
         pitc_reduction_year == 2045)

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp19d, test_reduction == i)$overall_condom_usage
  mean <- filter(temp19d, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean, 
                                    xout = seq(min(condom_change_cumulative$overall_condom_usage), max(condom_change_cumulative$overall_condom_usage), length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2045, 
           test_reduction = i)
  temp19d <- bind_rows(temp19d, interpolated) 
}

temp19d <- temp19d[which(is.na(temp19d$future_value)),]

suppfig19d <- temp19d %>% 
  ggplot(aes(test_reduction, overall_condom_usage, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(), color = "black",breaks = 0,show.legend = FALSE) + 
  geom_contour(aes(), color = "grey",breaks = c(0.5, 1.0, 1.5, 2.0),show.legend = FALSE) + 
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, 
                    breaks = c(0, 0.5, 1.0, 1.5, 2.0), skip = 0,
                    label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted") +
  annotate(geom = "text", x=50, y=33.9, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) +
  ggtitle("Additional AIDS deaths\n2045-2095 (millions)")
suppfig19d

```

### Combined Supplemntary Figure 19

``` {r suppfig19, echo = FALSE}
suppfig19<- ggarrange(suppfig19a, suppfig19b, suppfig19c, suppfig19d, nrow = 2, ncol = 2, legend = "right", labels = "AUTO")
suppfig19
ggsave(filename = "figures/suppfig19.pdf", plot = suppfig19, device = "pdf", width = 20, units = "cm")
ggsave(filename = "figures/suppfig19.png", plot = suppfig19, device = "png", width = 20, units = "cm")
```

## Supplementary figure 20a

```{r suppfig20a, echo=FALSE}
temp20a <- condom_change_summary %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(pitc_reduction_year == 2050,
         year == 2100, 
         scenario == "intervention", 
         indicator == "HIVinc15to49")

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp20a, test_reduction == i)$overall_condom_usage
  mean_incidence_2100 <- filter(temp20a, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean_incidence_2100, 
                                    xout = seq(min(condom_change_summary$overall_condom_usage), max(condom_change_summary$overall_condom_usage),length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2050, 
           test_reduction = i)
  
  
  temp20a <- bind_rows(temp20a, interpolated) 
}
temp20a <- temp20a[which(is.na(temp20a$future_value)),]

suppfig20a <- temp20a %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction), 
         log_incidence = log(1000*mean)) %>% 
  ggplot(aes(x = test_reduction, y = overall_condom_usage)) + 
  with_blur(geom_raster(aes(fill = as.numeric(log_incidence)), 
                        interpolate = TRUE),sigma=0) + 
  geom_contour(aes(z = 1000*mean), 
               color = "black", breaks = c(0.5, 1, 2, 3, 4, 5, 6, 7, 8, 9)) + 
  geom_contour(aes(z = 1000*mean), 
               color = "black", breaks = 1, linewidth = 0.80) +
  geom_text_contour(aes(z = 1000*mean),
                    skip = 0, stroke = 0.1, 
                    stroke.colour = "white",
                    breaks = c(0.5, 1, 2, 3, 4, 5, 6, 7, 8, 9), 
                    label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted")+
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red",
                       midpoint = 0,
                       labels = (function(l) {round(exp(l),2)})
  ) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("General HTS reduced from 2050") +
  annotate(geom = "text", x = 15, y = 33.9, label = "Baseline")
suppfig20a
```

## Supplementary 20b

```{r suppfig20b, echo = FALSE}

temp20b <- condom_change_cumulative %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(indicator == "elimination_year", 
         pitc_reduction_year == 2050, 
         scenario == "intervention") %>% 
  arrange(desc(overall_condom_usage)) 

temp20b[which(temp20b$median == Inf),] <- NA

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp20b, test_reduction == i)$overall_condom_usage
  elimination_year <- filter(temp20b, test_reduction == i)$median
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = elimination_year, seq(min(condom_change_cumulative$overall_condom_usage), max(condom_change_cumulative$overall_condom_usage),length.out = 1000), 
                                    method = "linear", na.rm = FALSE)) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(median = y) %>% 
    mutate(pitc_reduction_year = 2050, 
           test_reduction = i)
  temp20b <- bind_rows(temp20b, interpolated) 
}

temp20b <- temp20b[which(is.na(temp20b$future_value)),]

temp20b[which(temp20b$median == Inf),] <- NA

suppfig20b <- temp20b %>% 
  ggplot(aes(x = test_reduction, y = overall_condom_usage)) +
  with_blur(geom_raster(aes(fill = median), interpolate = TRUE, na.rm = TRUE), sigma = 0) +
  geom_contour(aes(z = median),color = "black") + 
  geom_text_contour(aes(z = median), skip = 0, 
                    stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, 
                    min.size = 20, 
                    label.placer = label_placer_fraction())+
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 2055) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted")+
  annotate(geom = "text", x=90, y=33.9, label="Baseline", parse = TRUE) + 
  ggtitle("General HTS reduced from 2050")
suppfig20b
```

## Supplementary figure 20c

```{r suppfig20c, echo=FALSE}

temp20c <- condom_change_cumulative %>% 
  filter(indicator == "NewAdultHIV", 
         scenario == "absolute_dif",
         pitc_reduction_year == 2050)

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp20c, test_reduction == i)$overall_condom_usage
  mean <- filter(temp20c, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean, 
                                    xout = seq(min(condom_change_cumulative$overall_condom_usage),
                                               max(condom_change_cumulative$overall_condom_usage), length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2050, 
           test_reduction = i)
  temp20c <- bind_rows(temp20c, interpolated) 
}

temp20c <- temp20c[which(is.na(temp20c$future_value)),]

suppfig20c <- temp20c %>% 
ggplot(aes(test_reduction, overall_condom_usage, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(), color = "black",breaks = 0,show.legend = FALSE) + 
  geom_contour(aes(), color = "grey",breaks = c(2.5, 5, 7.5, 10),show.legend = FALSE) + 
  geom_text_contour(stroke = 0.1, 
                    stroke.colour = "white",
                    check_overlap = TRUE, 
                    breaks = c(0,2.5, 5, 7.5, 10),
                    label.placer = label_placer_fraction(), skip = 0) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted") +
  annotate(geom = "text", x=50, y=33.9, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) + 
  ggtitle("Additional HIV infections\n2050-2100 (millions)")
suppfig20c

```

## Supplementary figure 20d

```{r suppfig20d, echo = FALSE}

temp20d <- condom_change_cumulative %>% 
  filter(indicator == "TotalAIDSdeathsadult", 
         scenario == "absolute_dif",
         pitc_reduction_year == 2050)

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp20d, test_reduction == i)$overall_condom_usage
  mean <- filter(temp20d, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean, 
                                    xout = seq(min(condom_change_cumulative$overall_condom_usage), max(condom_change_cumulative$overall_condom_usage), length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2050, 
           test_reduction = i)
  temp20d <- bind_rows(temp20d, interpolated) 
}

temp20d <- temp20d[which(is.na(temp20d$future_value)),]

suppfig20d <- temp20d %>% 
  ggplot(aes(test_reduction, overall_condom_usage, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(), color = "black",breaks = 0,show.legend = FALSE) + 
  geom_contour(aes(), color = "grey",breaks = c(0.5, 1.0, 1.5, 2.0),show.legend = FALSE) + 
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, 
                    breaks = c(0, 0.5, 1.0, 1.5, 2.0), skip = 0,
                    label.placer = label_placer_fraction()) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted") +
  annotate(geom = "text", x=50, y=33.9, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2(" ",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous("Overall condom usage (%)", 
                     trans = "identity",
                     expand = c(0,0), 
                     breaks = seq(15, 60 ,5), 
                     labels = seq(15, 60 ,5)) +
  scale_x_continuous("General HTS reduction (%)", expand = c(0,0)) + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11),
        plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.margin=margin(0,0,0,0),
        legend.box.spacing = unit(5, "pt"),
        aspect.ratio=1) +
  ggtitle("Additional AIDS deaths\n2050-2100 (millions)")
suppfig20d

```

### Combined Supplemntary Figure 20

``` {r suppfig20, echo = FALSE}
suppfig20<- ggarrange(suppfig20a, suppfig20b, suppfig20c, suppfig20d, nrow = 2, ncol = 2, legend = "right", labels = "AUTO")
suppfig20
ggsave(filename = "figures/suppfig20.pdf", plot = suppfig20, device = "pdf", width = 20, units = "cm")
ggsave(filename = "figures/suppfig20.png", plot = suppfig20, device = "png", width = 20, units = "cm")
```

### HIV incidence in 2100 by testing reduction year - condom change

```{r suppfig21, echo = FALSE}

suppfig21<- ggarrange(fig4a, suppfig16a, suppfig17a, suppfig18a, suppfig19a, suppfig20a, nrow = 3, ncol = 2, legend = "right", labels = "AUTO", common.legend = TRUE) 
suppfig21 <- annotate_figure(suppfig21, top = text_grob("HIV incidence in 2100 (per 1000; 15-49 years)", 
               color = "black", face = "bold", size = 15))
ggsave(filename = "figures/suppfig21.pdf", plot = suppfig21, device = "pdf", width = 20, height = 29, units = "cm")
ggsave(filename = "figures/suppfig21.png", plot = suppfig21, device = "png", width = 20, height = 29, units = "cm")

```

### Elimination year by testing reduction year - condom change

```{r suppfig22, echo = FALSE}

suppfig22<- ggarrange(fig4b, suppfig16b, suppfig17b, suppfig18b, suppfig19b, suppfig20b, nrow = 3, ncol = 2, legend = "right", labels = "AUTO", common.legend = TRUE) 
suppfig22 <- annotate_figure(suppfig22, top = text_grob("HIV elimination year", 
               color = "black", face = "bold", size = 15))
suppfig22
ggsave(filename = "figures/suppfig22.pdf", plot = suppfig22, device = "pdf", width = 20, height = 29, units = "cm")
ggsave(filename = "figures/suppfig22.png", plot = suppfig22, device = "png", width = 20, height = 29, units = "cm")

```

### Additional infections by testing reduction year - condom change

```{r suppfig23, echo = FALSE}

suppfig23<- ggarrange(fig4c, suppfig16c, suppfig17c, suppfig18c, suppfig19c, suppfig20c, nrow = 3, ncol = 2, legend = "right", labels = "AUTO", common.legend = TRUE) 
suppfig23 <- annotate_figure(suppfig23, top = text_grob("Additional HIV infections (millions)", 
               color = "black", face = "bold", size = 15))
suppfig23
ggsave(filename = "figures/suppfig23.pdf", plot = suppfig23, device = "pdf", width = 20, height = 29, units = "cm")
ggsave(filename = "figures/suppfig23.png", plot = suppfig23, device = "png", width = 20, height = 29, units = "cm")

```

### Additional infections by testing reduction year - condom change

```{r suppfig24, echo = FALSE}

suppfig24<- ggarrange(fig4d, suppfig16d, suppfig17d, suppfig18d, suppfig19d, suppfig20d, nrow = 3, ncol = 2, legend = "right", labels = "AUTO", common.legend = TRUE) 
suppfig24 <- annotate_figure(suppfig24, top = text_grob("Additional AIDS deaths (millions)", 
               color = "black", face = "bold", size = 15))
suppfig24
ggsave(filename = "figures/suppfig24.pdf", plot = suppfig24, device = "pdf", width = 20, height = 29, units = "cm")
ggsave(filename = "figures/suppfig24.png", plot = suppfig24, device = "png", width = 20, height = 29, units = "cm")

```

# Results in text

Baseline incidence in 2025 & 2100
``` {r result1}
test_reduction_only %>% filter(indicator == "HIVinc15to49", 
                               year %in% c(2025,2100), 
                               scenario == "baseline", 
                               test_reduction == 0,
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(1000*mean,2), 
         lower_CI = round(1000*lower_CI,2), 
         upper_CI = round(1000*upper_CI,2)) %>% 
  select(year, mean, lower_CI, upper_CI)
```

Baseline elimination year
```{r result2}
test_reduction_cumulative %>% filter(indicator == "elimination_year", 
                               scenario == "baseline", 
                               test_reduction == 0,
                               pitc_reduction_year == 2025) %>%
  select(median, lower_CI, upper_CI)
```

Baseline HIV prevalence in 2025, 2055 and 2100
``` {r results3}
test_reduction_only %>% filter(indicator == "Prev15to49", 
                               year %in% c(2025,2055,2100), 
                               scenario == "baseline", 
                               test_reduction == 0,
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(100*mean,2), 
         lower_CI = round(100*lower_CI,2), 
         upper_CI = round(100*upper_CI,2)) %>% 
  select(year, mean, lower_CI, upper_CI)
```

Baseline total HIV test in 2025, 2055 and 2100
``` {r results4}
test_reduction_only %>% filter(indicator == "TotalHIVtests", 
                               year %in% c(2025,2055,2100), 
                               scenario == "baseline", 
                               test_reduction == 0,
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(mean/10**6,2), 
         lower_CI = round(lower_CI/10**6,2), 
         upper_CI = round(upper_CI/10**6,2)) %>% 
  select(year, mean, lower_CI, upper_CI)
```

Baseline cumulative HIV infections and deaths between 2025 and 2075
```{r result4.5}
test_reduction_cumulative %>% filter(indicator%in% c("NewAdultHIV", "TotalAIDSdeathsadult"), 
                               scenario == "baseline", 
                               test_reduction == 0,
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(mean/10^6,2), 
         lower_CI = round(lower_CI/10^6,2), 
         upper_CI = round(upper_CI/10^6,2)) %>% 
  select(indicator, mean, lower_CI, upper_CI)
```

Baseline ART coverage in 2076 (max) and 2100
``` {r results5}
test_reduction_only %>% filter(indicator == "ARTcoverageAdult", 
                               year %in% c(2076, 2100), 
                               scenario == "baseline", 
                               test_reduction%in% 0,
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(mean*100,1), 
         lower_CI = round(lower_CI*100,1), 
         upper_CI = round(upper_CI*100,1)) %>% 
  select(year, mean, lower_CI, upper_CI)
```



Testing reduced ART coverage in 2100
``` {r results6}
test_reduction_only %>% filter(indicator == "ARTcoverageAdult", 
                               year %in% c(2100), 
                               scenario == "intervention", 
                               test_reduction%in% c(25, 50, 75, 100),
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(mean*100,1), 
         lower_CI = round(lower_CI*100,1), 
         upper_CI = round(upper_CI*100,1)) %>% 
  select(test_reduction, mean, lower_CI, upper_CI)
```

HIV tests per 100 adult when testing reduced by 0% and 100% 

```{r results 6.5}
test_reduction_only %>% filter(indicator == "TestsPerAdult", 
                               year %in% c(2024, 2026), 
                               scenario == "intervention", 
                               test_reduction%in% c(0, 100),
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(mean*100,1), 
         lower_CI = round(lower_CI*100,1), 
         upper_CI = round(upper_CI*100,1)) %>% 
  select(year, test_reduction, mean, lower_CI, upper_CI)

```


Testing reduced incidence in 2100
``` {r results7}
test_reduction_only %>% filter(indicator == "HIVinc15to49", 
                               year %in% c(2100), 
                               scenario == "intervention", 
                               test_reduction%in% c(25, 50, 75, 100),
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(mean*1000,2), 
         lower_CI = round(lower_CI*1000,2), 
         upper_CI = round(upper_CI*1000,2)) %>% 
  select(test_reduction, mean, lower_CI, upper_CI)
```

HIV elimination year delay when testing reduced

``` {r results8}
test_reduction_cumulative %>% filter(indicator == "elimination_year",
                               scenario == "intervention", 
                               test_reduction%in% c(25, 50, 75, 100),
                               pitc_reduction_year == 2025) %>%
  mutate(median = round(median-2055,2)) %>% 
  select(test_reduction, median)
```

Baseline prevalence in 2025

``` {r results9}
test_reduction_only %>% filter(indicator == "Prev15to49", 
                               year %in% c(2025), 
                               scenario == "baseline", 
                               test_reduction%in% c(0),
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(mean*100,2), 
         lower_CI = round(lower_CI*100,2), 
         upper_CI = round(upper_CI*100,2)) %>% 
  select(year, mean, lower_CI, upper_CI)
```


Testing reduced prevalence in 2100
``` {r results10}
test_reduction_only %>% filter(indicator == "Prev15to49", 
                               year %in% c(2100), 
                               scenario == "intervention", 
                               test_reduction%in% c(0, 25, 50, 75, 100),
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(mean*100,2), 
         lower_CI = round(lower_CI*100,2), 
         upper_CI = round(upper_CI*100,2)) %>% 
  select(year, test_reduction, mean, lower_CI, upper_CI)
```

Baseline cumulative HIV infections (millions) over 50 years

``` {r results11}
test_reduction_cumulative %>% filter(indicator == "NewAdultHIV",
                                     scenario == "baseline",
                               test_reduction%in% c(0),
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(mean/10**6,2),
         lower_CI = round(lower_CI/10**6,2), 
         upper_CI = round(upper_CI/10**6,2)) %>% 
  select(scenario, mean, lower_CI, upper_CI)
```

Baseline cumulative deaths (millions) over 50 years

``` {r results12}
test_reduction_cumulative %>% filter(indicator == "TotalAIDSdeathsadult",
                                     scenario == "baseline",
                               test_reduction%in% c(0),
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(mean/10**6,2),
         lower_CI = round(lower_CI/10**6,2), 
         upper_CI = round(upper_CI/10**6,2)) %>% 
  select(scenario, mean, lower_CI, upper_CI)
```

Testing reduced additional HIV infections (thousands) over 50 years

``` {r results13}
test_reduction_cumulative %>% filter(indicator == "NewAdultHIV",
                                     scenario == "absolute_dif",
                               test_reduction%in% c(25, 50, 75, 100),
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(mean/10**3,0),
         lower_CI = round(lower_CI/10**3,0), 
         upper_CI = round(upper_CI/10**3,0)) %>% 
  select(test_reduction, mean, lower_CI, upper_CI)
```

Testing reduced additional AIDS deaths (thousands) over 50 years
```{r results14}
test_reduction_cumulative %>% filter(indicator == "TotalAIDSdeathsadult",
                                     scenario == "absolute_dif",
                               test_reduction%in% c(25, 50, 75, 100),
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(mean/10**3,0),
         lower_CI = round(lower_CI/10**3,0), 
         upper_CI = round(upper_CI/10**3,0)) %>% 
  select(test_reduction, mean, lower_CI, upper_CI)
```

Testing reduced by 50% in 2050 vs 2025 HIV incidence in 2100
```{r results15}
test_reduction_only %>% filter(indicator == "HIVinc15to49", 
                               year %in% c(2100), 
                               scenario == "intervention", 
                               test_reduction %in% c(50),
                               pitc_reduction_year %in% c(2025,2050)) %>%
  mutate(mean = round(mean*1000,2), 
         lower_CI = round(lower_CI*1000,2), 
         upper_CI = round(upper_CI*1000,2)) %>% 
  select(pitc_reduction_year, mean, lower_CI, upper_CI)

```

Testing reduced by 50% in 2025 & 2030 additional HIV infections
```{r results16}
additional_2025 <- test_reduction_cumulative %>% 
  filter(indicator %in% c("NewAdultHIV"),
         scenario == "absolute_dif",
         test_reduction%in% c(50),
         pitc_reduction_year %in% c(2025)) %>%
  select(indicator, pitc_reduction_year, mean, lower_CI, upper_CI)
additional_2025 %>% mutate(mean = round(mean/10**3,0),
         lower_CI = round(lower_CI/10**3,0), 
         upper_CI = round(upper_CI/10**3,0))
additional_2030 <- test_reduction_cumulative %>% 
  filter(indicator %in% c("NewAdultHIV"),
         scenario == "absolute_dif",
         test_reduction%in% c(50),
         pitc_reduction_year %in% c(2030)) %>%
  select(indicator, pitc_reduction_year, mean, lower_CI, upper_CI)
additional_2030 %>% mutate(mean = round(mean/10**3,0),
         lower_CI = round(lower_CI/10**3,0), 
         upper_CI = round(upper_CI/10**3,0))
paste0("Decreased by ", round(((additional_2025$mean - additional_2030$mean) / additional_2025$mean)*100,0), "%")
```

Testing reduced by 50% in 2025 & 2030 additional AIDS deaths
```{r results17}
additional_2025 <- test_reduction_cumulative %>% 
  filter(indicator %in% c("TotalAIDSdeathsadult"),
         scenario == "absolute_dif",
         test_reduction%in% c(50),
         pitc_reduction_year %in% c(2025)) %>%
  select(indicator, pitc_reduction_year, mean, lower_CI, upper_CI)
additional_2025 %>% mutate(mean = round(mean/10**3,0),
         lower_CI = round(lower_CI/10**3,0), 
         upper_CI = round(upper_CI/10**3,0))
additional_2030 <- test_reduction_cumulative %>% 
  filter(indicator %in% c("TotalAIDSdeathsadult"),
         scenario == "absolute_dif",
         test_reduction%in% c(50),
         pitc_reduction_year %in% c(2030)) %>%
  select(indicator, pitc_reduction_year, mean, lower_CI, upper_CI)
additional_2030 %>% mutate(mean = round(mean/10**3,0),
         lower_CI = round(lower_CI/10**3,0), 
         upper_CI = round(upper_CI/10**3,0))
paste0("Decreased by ", round(((additional_2025$mean - additional_2030$mean) / additional_2025$mean)*100,0), "%")
```

Testing reduced by 50% in 2025 & 2050 additional HIV infections
```{r results18}
additional_2025 <- test_reduction_cumulative %>% 
  filter(indicator %in% c("NewAdultHIV"),
         scenario == "absolute_dif",
         test_reduction%in% c(50),
         pitc_reduction_year %in% c(2025)) %>%
  select(indicator, pitc_reduction_year, mean, lower_CI, upper_CI)
additional_2025 %>% mutate(mean = round(mean/10**3,0),
         lower_CI = round(lower_CI/10**3,0), 
         upper_CI = round(upper_CI/10**3,0))
additional_2050 <- test_reduction_cumulative %>% 
  filter(indicator %in% c("NewAdultHIV"),
         scenario == "absolute_dif",
         test_reduction%in% c(50),
         pitc_reduction_year %in% c(2050)) %>%
  select(indicator, pitc_reduction_year, mean, lower_CI, upper_CI)
additional_2050 %>% mutate(mean = round(mean/10**3,0),
         lower_CI = round(lower_CI/10**3,0), 
         upper_CI = round(upper_CI/10**3,0))
paste0("Decreased by ", round(((additional_2025$mean - additional_2050$mean) / additional_2025$mean)*100,0), "%")
```

Testing reduced by 50% in 2025 & 2050 additional AIDS deaths
```{r results19}
additional_2025 <- test_reduction_cumulative %>% 
  filter(indicator %in% c("TotalAIDSdeathsadult"),
         scenario == "absolute_dif",
         test_reduction%in% c(50),
         pitc_reduction_year %in% c(2025)) %>%
  select(indicator, pitc_reduction_year, mean, lower_CI, upper_CI)
additional_2025 %>% mutate(mean = round(mean/10**3,0),
         lower_CI = round(lower_CI/10**3,0), 
         upper_CI = round(upper_CI/10**3,0))
additional_2050 <- test_reduction_cumulative %>% 
  filter(indicator %in% c("TotalAIDSdeathsadult"),
         scenario == "absolute_dif",
         test_reduction%in% c(50),
         pitc_reduction_year %in% c(2050)) %>%
  select(indicator, pitc_reduction_year, mean, lower_CI, upper_CI)
additional_2050 %>% mutate(mean = round(mean/10**3,0),
         lower_CI = round(lower_CI/10**3,0), 
         upper_CI = round(upper_CI/10**3,0))
paste0("Decreased by ", round(((additional_2025$mean - additional_2050$mean) / additional_2025$mean)*100,0), "%")
```

ART change lowest ART coverage in 2035

```{r results20}

min(art_coverage_range)

```

50% ART coverage with no testing reduction 2100 incidence in 2025 vs 2100

``` {r results21}
art_change_summary %>% filter(indicator == "HIVinc15to49",
                              pitc_reduction_year %in% c(2025),
                              test_reduction == 100,
                              year %in% c(2025, 2100),
                              scenario == "intervention",
                              future_variability == "art_deterioration",
                              future_value == 0.14
                              ) %>% 
  mutate(mean = round(mean*1000,2), 
         lower_CI = round(lower_CI*1000,2), 
         upper_CI = round(upper_CI*1000,2)) %>% 
  select(year,test_reduction, mean, lower_CI, upper_CI, art_coverage_2035)
```

Elimination year closest to 2070 ART interruption, coverage and elimination year

``` {r results22} 

cumulative_art_change %>% filter(indicator == "elimination_year",
                              pitc_reduction_year %in% c(2025),
                              test_reduction == 0,
                              scenario %in% c("intervention"),
                              future_variability == "art_deterioration",
                              future_value %in% c(0,0.065)) %>% 
  select(median, lower_CI, upper_CI, art_int_rate, art_coverage_2035)
# this needs updating once final results are in 
```


ART coverage at 80% test reduction at 25%, elimination year

``` {r results23}
cumulative_art_change %>% filter(indicator == "elimination_year",
                              pitc_reduction_year %in% c(2025),
                              test_reduction == 25,
                              scenario == "intervention",
                              future_variability == "art_improvement",
                              future_value == 0.025)%>% 
  select(scenario, test_reduction, median, lower_CI, upper_CI, art_coverage_2035)

```

ART coverage at 90% test reduction at 25%, elimination year

``` {r results23}
cumulative_art_change %>% filter(indicator == "elimination_year",
                              pitc_reduction_year %in% c(2025),
                              test_reduction == 100,
                              scenario == "intervention",
                              future_variability == "art_improvement",
                              future_value == 0.12)%>% 
  select(scenario, test_reduction, median, lower_CI, upper_CI, art_coverage_2035)

```
ART change Calculate slope additional deaths 

``` {r results24, echo = FALSE}

max_coverage <- temp3d %>% 
  filter(test_reduction == 60, 
         mean < 1000, 
         mean >-1) %>% 
  select(art_coverage_2035)
60 / (max_coverage$art_coverage_2035 - 0.767) / 100


```


Condom usage reduced to 14% - decline in HIV incidence 

```{r results25}

condom_change_summary %>% filter(indicator == "HIVinc15to49",
                              pitc_reduction_year %in% c(2025),
                              test_reduction == 0,
                              year %in% c(2025, 2100),
                              scenario == "intervention",
                              future_variability == "condom_reduction",
                              future_value == 14
                              ) %>% 
  mutate(mean = round(mean*1000,2), 
         lower_CI = round(lower_CI*1000,2), 
         upper_CI = round(upper_CI*1000,2)) %>% 
  select(year, mean, lower_CI, upper_CI, overall_condom_usage)

```

Condom usage reduced to delay elimination to 2070 and prevent it

```{r results26}

condom_change_cumulative %>% 
  filter(indicator == "elimination_year",
                              pitc_reduction_year %in% c(2025),
                              test_reduction == 0,
                              scenario == "intervention",
                              future_variability == "condom_reduction",
                              future_value %in% c(5,8.5)) %>% 
  select(scenario, test_reduction, median, lower_CI, upper_CI, overall_condom_usage)
  

```
Min and max condom usage additional infections and deaths no testing reduction 

```{r results27}

condom_change_cumulative %>% 
  filter(indicator %in% c("NewAdultHIV", "TotalAIDSdeathsadult"),
                              pitc_reduction_year %in% c(2025),
                              test_reduction == 0,
                              scenario == "absolute_dif",
                              future_value %in% c(14)) %>% 
  mutate(mean = round(mean/1000, 0),
         lower_CI = round(lower_CI/1000,0),
         upper_CI = round(upper_CI/1000,0)) %>% 
  select(indicator, test_reduction, mean, lower_CI, upper_CI, overall_condom_usage)
  

```


```{r results28}

condom_change_cumulative %>% 
  filter(indicator %in% c("NewAdultHIV", "TotalAIDSdeathsadult"),
                              pitc_reduction_year %in% c(2025),
                              test_reduction == 100,
                              scenario == "absolute_dif",
                              future_value %in% c(14)) %>% 
  mutate(mean = round(mean/1000, 0),
         lower_CI = round(lower_CI/1000,0),
         upper_CI = round(upper_CI/1000,0)) %>% 
  select(indicator, test_reduction, mean, lower_CI, upper_CI, overall_condom_usage)
  

```

Condom change Calculate slope additional deaths 

``` {r resultsxx, echo = FALSE}

max_condom <- temp4d %>% 
  filter(test_reduction == 60, 
         mean < 500, 
         mean >-1) %>% 
  select(overall_condom_usage)
60 / (max_condom$overall_condom_usage - 33.9) 


```