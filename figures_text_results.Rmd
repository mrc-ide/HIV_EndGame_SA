---
title: "Figures and text results"
output: html_document
date: "2023-05-22"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(dplyr)
library(tidyr)
library(readr)
library(ggplot2)
library(gridExtra)
library(metR)
library(ggpubr)
library(ggfx)

```
# Figures 
## Figure 1

load data
```{r fig1 data, echo = TRUE, include=FALSE,eval = TRUE}
setwd("/Users/stefan/Documents/HIV_EndGame_SA/")
test_reduction_only <- read_csv("results/test_reduction_only_summary.csv")
```

### Figure 1a

Incidence over time

```{r fig1a, eval=TRUE}
fig1a <- test_reduction_only %>% mutate(test_reduction = as.factor(test_reduction)) %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "HIVinc15to49",
         year > 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100)) %>% 
  ggplot(aes(year, mean, group = test_reduction, fill = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_hline(aes(yintercept = 0.001), lty = "dotted") +
  xlab("") +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 12), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12)) +
  scale_y_continuous("HIV incidence per 1000 \n(15-49 years)\n", labels =(function(l) {round(l*1e3,1)}), breaks = c(0, 0.001, 0.002, 0.003, 0.004, 0.005, 0.006)) +
  scale_fill_discrete(labels = c("No Testing reduction", "25% Testing reduction", "50% Testing reduction", "75% Testing reduction",  "100% Testing reduction"),) + 
  scale_color_discrete(labels = c("No Testing reduction", "25% Testing reduction", "50% Testing reduction", "75% Testing reduction", "100% Testing reduction")) + 
  theme(legend.title = element_blank()) 
```

### Figure 1b

Prevalence over time

```{r fig1b, echo=FALSE}
fig1b <- test_reduction_only %>% mutate(test_reduction = as.factor(test_reduction)) %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "Prev15to49",
         year > 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100)) %>% 
  ggplot(aes(year, mean, group = test_reduction, fill = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  xlab("") +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 12), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12)) +
  scale_y_continuous("HIV prevalence (%) \n(15-49 years)", labels =(function(l) {round(l*1e2,1)})) +
  scale_fill_discrete(labels = c("No Testing reduction", "25% Testing reduction", "50% Testing reduction", "75% Testing reduction",  "100% Testing reduction"),) + 
  scale_color_discrete(labels = c("No Testing reduction", "25% Testing reduction", "50% Testing reduction", "75% Testing reduction", "100% Testing reduction")) + 
  theme(legend.title = element_blank())
```

### Figure 1c

ART coverage over time

```{r fig1c, echo=FALSE}
fig1b <- test_reduction_only %>% mutate(test_reduction = as.factor(test_reduction)) %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "Prev15to49",
         year > 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100)) %>% 
  ggplot(aes(year, mean, group = test_reduction, fill = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  xlab("") +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 12), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12)) +
  scale_y_continuous("HIV prevalence (%) \n(15-49 years)", labels =(function(l) {round(l*1e2,1)})) +
  scale_fill_discrete(labels = c("No Testing reduction", "25% Testing reduction", "50% Testing reduction", "75% Testing reduction",  "100% Testing reduction"),) + 
  scale_color_discrete(labels = c("No Testing reduction", "25% Testing reduction", "50% Testing reduction", "75% Testing reduction", "100% Testing reduction")) + 
  theme(legend.title = element_blank())
```

### Figure 1d

Tests per 100 adults

```{r fig1d, echo=FALSE}
fig1d <- test_reduction_only %>% mutate(test_reduction = as.factor(test_reduction)) %>% 
  filter(scenario == "intervention", 
         pitc_reduction_year == 2025, 
         indicator == "TestsPerAdult",
         year > 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100)) %>% 
  ggplot(aes(year, mean, group = test_reduction, fill = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  xlab("") +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 12), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12)) +
  scale_y_continuous("Annual HIV tests per 100 \n(15+ years)", labels =(function(l) {round(l*1e2,1)})) +
  scale_fill_discrete(labels = c("No Testing reduction", "25% Testing reduction", "50% Testing reduction", "75% Testing reduction",  "100% Testing reduction"),) + 
  scale_color_discrete(labels = c("No Testing reduction", "25% Testing reduction", "50% Testing reduction", "75% Testing reduction", "100% Testing reduction")) + 
  theme(legend.title = element_blank()) 

```

## Figure 2

Impact of timing of testing reductions on long-term incidence and epi costs

load data
``` {r fig2 data, include = FALSE}
test_reduction_cumulative <- read_csv("results/test_reduction_only_cumulative.csv")
test_reduction_only_inc_elim <- read_csv("results/test_reduction_only_inc_elim.csv")
```

### Figure 2a

Incidence in 2100 when testing reduced at different times 

```{r fig2a, include = FALSE}

fig2a <- test_reduction_only_inc_elim %>% 
  mutate(pitc_reduction_year = as.factor(pitc_reduction_year), 
         pitc_reduction_percentage = as.factor(pitc_reduction_percentage)) %>% 
  filter(pitc_reduction_percentage %in% c(0, 25, 50, 75, 100)) %>% 
  ggplot(aes(pitc_reduction_percentage, mean_incidence_2100, group = pitc_reduction_year, fill = pitc_reduction_year)) + 
  geom_col(aes(color = pitc_reduction_year), position =  position_dodge(width = 0.85), width = 0.85, alpha = 0.75) +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci), show.legend = F, position =  position_dodge(width = 0.85), alpha = 0.5) +
  xlab("Testing reduction (%)") + 
  theme_classic() + 
  scale_y_continuous("HIV incidence in 2100 \nper 1000 (15-49 years)", labels = (function(l) {round(l*1e3,1)})) + 
  expand_limits(y = 0) +
  geom_hline(aes(yintercept = 0.001), lty = "dotted") +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11)) + 
  scale_color_brewer("Testing \nreduction \nyear",palette = "Dark2",direction = -1) +
  scale_fill_brewer("Testing \nreduction \nyear", palette = "Dark2",direction = -1)
```

### Figure 2b 

Additional HIV infections when testing reduced at different times

``` {r fig2b, echo = FALSE}

fig2b <- test_reduction_cumulative %>% 
  filter(indicator == "NewAdultHIV", 
         scenario == "absolute_dif", 
         test_reduction %in% c(0, 25, 50, 75, 100)) %>% 
  mutate(pitc_reduction_year = as.factor(pitc_reduction_year), 
         test_reduction = as.factor(test_reduction)) %>% 
  ggplot(aes(test_reduction, mean, group = pitc_reduction_year, fill = pitc_reduction_year)) +
  geom_col(aes(color = pitc_reduction_year), position =  position_dodge(width = 0.85), width = 0.85, alpha = 0.75) +
  geom_errorbar(aes(ymin = lower_CI, ymax = upper_CI), show.legend = F, position =  position_dodge(width = 0.85), alpha = 0.5) +
  scale_y_continuous("Additional HIV \ninfections (millions)", 
                     labels = (function(l) {round(l/1e6,1)})) +
  scale_color_brewer("Testing \nreduction \nyear",palette = "Dark2",direction = -1) +
  scale_fill_brewer("Testing \nreduction \nyear", palette = "Dark2",direction = -1) +
  xlab("Testing reduction (%)") + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11))

```

### Figure 2c 

Additional AIDS-related deaths when testing reduced at different times

``` {r fig2c, echo = FALSE}

fig2c <- test_reduction_cumulative %>% 
  filter(indicator == "TotalAIDSdeathsadult", 
         scenario == "absolute_dif", 
         test_reduction %in% c(0, 25, 50, 75, 100)) %>% 
  mutate(pitc_reduction_year = as.factor(pitc_reduction_year), 
         test_reduction = as.factor(test_reduction)) %>% 
  ggplot(aes(test_reduction, mean, group = pitc_reduction_year, fill = pitc_reduction_year)) +
  geom_col(aes(color = pitc_reduction_year), position =  position_dodge(width = 0.85), width = 0.85, alpha = 0.75) +
  geom_errorbar(aes(ymin = lower_CI, ymax = upper_CI), show.legend = F, position =  position_dodge(width = 0.85), alpha = 0.5) +
  scale_y_continuous("Additional AIDS-related \ndeaths (millions)", labels = (function(l) {round(l/1e6,1)})) +
  scale_color_brewer("Testing \nreduction \nyear",palette = "Dark2",direction = -1) +
  scale_fill_brewer("Testing \nreduction \nyear", palette = "Dark2",direction = -1) +
  xlab("Testing reduction (%)") + theme_classic() +
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11))

```

### Combined figure 2

``` {r fig2, echo = FALSE}

ggarrange(fig2a, fig2b, fig2c, nrow = 1, ncol = 3, common.legend = TRUE, legend = "right", labels = "AUTO")

```

## Figure 3

Effect of altered ART coverage on impact of testing reductions

load data of decrease and increase scenarios and combine

``` {r combined art change summary, echo = FALSE}
decrease_art_retention_summary <- read_csv("results/art_deterioration_summary.csv")
increase_art_retention_summary <- read_csv("results/art_improvement_summary.csv")
art_change_summary <- bind_rows(increase_art_retention_summary, decrease_art_retention_summary)
art_change_summary <- art_change_summary %>% mutate(art_int_rate = case_when(
  future_variability == "art_deterioration" ~ (0.1486*((1+(as.numeric(future_value/100)))**10)),
  future_variability == "art_improvement" ~ (0.1486*((1-(as.numeric(future_value/100)))**10))))
art_change_summary <- art_change_summary %>% mutate(art_ret_rate = 1 - art_int_rate)
write_csv(art_change_summary,"results/art_change_summary.csv")

art_change_inc_elim <- bind_rows(read_csv("results/art_improvement_inc_elim.csv"), read_csv("results/art_deterioration_inc_elim.csv"))

art_change_inc_elim <- art_change_inc_elim %>% 
  mutate(art_int_rate = case_when(
  future_variability == "art_deterioration" ~ (0.1486*((1+(as.numeric(future_value/100)))**10)),
  future_variability == "art_improvement" ~ (0.1486*((1-(as.numeric(future_value/100)))**10)))) %>% 
  mutate(art_ret_rate = 1 - art_int_rate)
write_csv(art_change_inc_elim,"results/art_change_inc_elim.csv")

cumulative_art_change <- bind_rows(read_csv("results/art_improvement_cumulative.csv"),                           read_csv("results/art_deterioration_cumulative.csv"))

cumulative_art_change <- cumulative_art_change %>% 
  mutate(art_int_rate = case_when(
  future_variability == "art_deterioration" ~ (0.1486*((1+(as.numeric(future_value/100)))**10)),
  future_variability == "art_improvement" ~ (0.1486*((1-(as.numeric(future_value/100)))**10)))) %>% 
  mutate(art_ret_rate = 1 - art_int_rate)

write_csv(cumulative_art_change, "results/art_change_cumulative.csv")
```

Summary: Add column for ART coverage in 2035
``` {r add columns art summary, echo = FALSE}
art_coverage_range <- art_change_summary %>% filter(indicator == "ARTcoverageAdult", 
                                                    test_reduction == 0, pitc_reduction_year == 2025,
                                                    year == 2035, scenario == "intervention") %>% select(mean)
art_coverage_labels <- round(art_coverage_range$mean,3)
unique_future_values_art <- unique(art_change_summary$future_value)
art_change_summary <- art_change_summary %>% mutate(art_coverage_2035 = case_when(future_value == unique_future_values_art[1] & future_variability == "art_improvement" ~ art_coverage_labels[1],
                                                                                  future_value == unique_future_values_art[2]  & future_variability == "art_improvement" ~ art_coverage_labels[2],
                                                                                  future_value == unique_future_values_art[3]  & future_variability == "art_improvement" ~ art_coverage_labels[3],
                                                                                  future_value == unique_future_values_art[4]  & future_variability == "art_improvement" ~ art_coverage_labels[4],
                                                                                  future_value == unique_future_values_art[5]  & future_variability == "art_improvement" ~ art_coverage_labels[5],
                                                                                  future_value == unique_future_values_art[6]  & future_variability == "art_improvement" ~ art_coverage_labels[6],
                                                                                  future_value == unique_future_values_art[7]  & future_variability == "art_improvement" ~ art_coverage_labels[7],
                                                                                  future_value == unique_future_values_art[8]  & future_variability == "art_improvement" ~ art_coverage_labels[8],
                                                                                  future_value == unique_future_values_art[9]  & future_variability == "art_improvement" ~ art_coverage_labels[9],
                                                                                  future_value == unique_future_values_art[10]  & future_variability == "art_improvement" ~ art_coverage_labels[10],
                                                                                  future_value == unique_future_values_art[11]  & future_variability == "art_improvement" ~ art_coverage_labels[11],
                                                                                  future_value == unique_future_values_art[12]  & future_variability == "art_improvement" ~ art_coverage_labels[12],
                                                                                  future_value == unique_future_values_art[13]  & future_variability == "art_improvement" ~ art_coverage_labels[13],
                                                                                  future_value == unique_future_values_art[14]  & future_variability == "art_improvement" ~ art_coverage_labels[14],
                                                                                  future_value == unique_future_values_art[15]  & future_variability == "art_improvement" ~ art_coverage_labels[15],
                                                                                  future_value == unique_future_values_art[16]  & future_variability == "art_improvement" ~ art_coverage_labels[16],
                                                                                  future_value == unique_future_values_art[17]  & future_variability == "art_improvement" ~ art_coverage_labels[17],
                                                                                  future_value == unique_future_values_art[18]  & future_variability == "art_improvement" ~ art_coverage_labels[18],
                                                                                  future_value == unique_future_values_art[19]  & future_variability == "art_improvement" ~ art_coverage_labels[19],
                                                                                  future_value == unique_future_values_art[20]  & future_variability == "art_improvement" ~ art_coverage_labels[20],
                                                                                  future_value == unique_future_values_art[21]  & future_variability == "art_improvement" ~ art_coverage_labels[21],
                                                                                  future_value == unique_future_values_art[22]  & future_variability == "art_improvement" ~ art_coverage_labels[22],
                                                                                  future_value == unique_future_values_art[23]  & future_variability == "art_improvement" ~ art_coverage_labels[23],
                                                                                  future_value == unique_future_values_art[24]  & future_variability == "art_improvement" ~ art_coverage_labels[24],
                                                                                  future_value == unique_future_values_art[25]  & future_variability == "art_improvement" ~ art_coverage_labels[25],
                                                                                  future_value == unique_future_values_art[26]  & future_variability == "art_improvement" ~ art_coverage_labels[26],
                                                                                  future_value == unique_future_values_art[27]  & future_variability == "art_improvement" ~ art_coverage_labels[27],
                                                                                  future_value == unique_future_values_art[28]  & future_variability == "art_improvement" ~ art_coverage_labels[28],
                                                                                  future_value == unique_future_values_art[29]  & future_variability == "art_improvement" ~ art_coverage_labels[29],
                                                                                  future_value == unique_future_values_art[1] & future_variability == "art_deterioration" ~ art_coverage_labels[30],
                                                                                  future_value == unique_future_values_art[2]  & future_variability == "art_deterioration" ~ art_coverage_labels[31],
                                                                                  future_value == unique_future_values_art[3]  & future_variability == "art_deterioration" ~ art_coverage_labels[32],
                                                                                  future_value == unique_future_values_art[4]  & future_variability == "art_deterioration" ~ art_coverage_labels[33],
                                                                                  future_value == unique_future_values_art[5]  & future_variability == "art_deterioration" ~ art_coverage_labels[34],
                                                                                  future_value == unique_future_values_art[6]  & future_variability == "art_deterioration" ~ art_coverage_labels[35],
                                                                                  future_value == unique_future_values_art[7]  & future_variability == "art_deterioration" ~ art_coverage_labels[36],
                                                                                  future_value == unique_future_values_art[8]  & future_variability == "art_deterioration" ~ art_coverage_labels[37],
                                                                                  future_value == unique_future_values_art[9]  & future_variability == "art_deterioration" ~ art_coverage_labels[38],
                                                                                  future_value == unique_future_values_art[10]  & future_variability == "art_deterioration" ~ art_coverage_labels[39],
                                                                                  future_value == unique_future_values_art[11]  & future_variability == "art_deterioration" ~ art_coverage_labels[40],
                                                                                  future_value == unique_future_values_art[12]  & future_variability == "art_deterioration" ~ art_coverage_labels[41],
                                                                                  future_value == unique_future_values_art[13]  & future_variability == "art_deterioration" ~ art_coverage_labels[42],
                                                                                  future_value == unique_future_values_art[14]  & future_variability == "art_deterioration" ~ art_coverage_labels[43],
                                                                                  future_value == unique_future_values_art[15]  & future_variability == "art_deterioration" ~ art_coverage_labels[44],
                                                                                  future_value == unique_future_values_art[16]  & future_variability == "art_deterioration" ~ art_coverage_labels[45],
                                                                                  future_value == unique_future_values_art[17]  & future_variability == "art_deterioration" ~ art_coverage_labels[46],
                                                                                  future_value == unique_future_values_art[18]  & future_variability == "art_deterioration" ~ art_coverage_labels[47],
                                                                                  future_value == unique_future_values_art[19]  & future_variability == "art_deterioration" ~ art_coverage_labels[48],
                                                                                  future_value == unique_future_values_art[20]  & future_variability == "art_deterioration" ~ art_coverage_labels[49],
                                                                                  future_value == unique_future_values_art[21]  & future_variability == "art_deterioration" ~ art_coverage_labels[50],
                                                                                  future_value == unique_future_values_art[22]  & future_variability == "art_deterioration" ~ art_coverage_labels[51],
                                                                                  future_value == unique_future_values_art[23]  & future_variability == "art_deterioration" ~ art_coverage_labels[52],
                                                                                  future_value == unique_future_values_art[24]  & future_variability == "art_deterioration" ~ art_coverage_labels[53],
                                                                                  future_value == unique_future_values_art[25]  & future_variability == "art_deterioration" ~ art_coverage_labels[54],
                                                                                  future_value == unique_future_values_art[26]  & future_variability == "art_deterioration" ~ art_coverage_labels[55],
                                                                                  future_value == unique_future_values_art[27]  & future_variability == "art_deterioration" ~ art_coverage_labels[56],
                                                                                  future_value == unique_future_values_art[28]  & future_variability == "art_deterioration" ~ art_coverage_labels[57],
                                                                                  future_value == unique_future_values_art[29]  & future_variability == "art_deterioration" ~ art_coverage_labels[58]))

write_csv(art_change_summary, "results/art_change_summary.csv")
```
Inc_elim: Add column for ART coverage in 2035
```{r add cols art_inc_elim, echo = FALSE}
art_change_inc_elim <- art_change_inc_elim %>% mutate(art_coverage_2035 = case_when(future_value == unique_future_values_art[1] & future_variability == "art_improvement" ~ art_coverage_labels[1],
                                                                                  future_value == unique_future_values_art[2]  & future_variability == "art_improvement" ~ art_coverage_labels[2],
                                                                                  future_value == unique_future_values_art[3]  & future_variability == "art_improvement" ~ art_coverage_labels[3],
                                                                                  future_value == unique_future_values_art[4]  & future_variability == "art_improvement" ~ art_coverage_labels[4],
                                                                                  future_value == unique_future_values_art[5]  & future_variability == "art_improvement" ~ art_coverage_labels[5],
                                                                                  future_value == unique_future_values_art[6]  & future_variability == "art_improvement" ~ art_coverage_labels[6],
                                                                                  future_value == unique_future_values_art[7]  & future_variability == "art_improvement" ~ art_coverage_labels[7],
                                                                                  future_value == unique_future_values_art[8]  & future_variability == "art_improvement" ~ art_coverage_labels[8],
                                                                                  future_value == unique_future_values_art[9]  & future_variability == "art_improvement" ~ art_coverage_labels[9],
                                                                                  future_value == unique_future_values_art[10]  & future_variability == "art_improvement" ~ art_coverage_labels[10],
                                                                                  future_value == unique_future_values_art[11]  & future_variability == "art_improvement" ~ art_coverage_labels[11],
                                                                                  future_value == unique_future_values_art[12]  & future_variability == "art_improvement" ~ art_coverage_labels[12],
                                                                                  future_value == unique_future_values_art[13]  & future_variability == "art_improvement" ~ art_coverage_labels[13],
                                                                                  future_value == unique_future_values_art[14]  & future_variability == "art_improvement" ~ art_coverage_labels[14],
                                                                                  future_value == unique_future_values_art[15]  & future_variability == "art_improvement" ~ art_coverage_labels[15],
                                                                                  future_value == unique_future_values_art[16]  & future_variability == "art_improvement" ~ art_coverage_labels[16],
                                                                                  future_value == unique_future_values_art[17]  & future_variability == "art_improvement" ~ art_coverage_labels[17],
                                                                                  future_value == unique_future_values_art[18]  & future_variability == "art_improvement" ~ art_coverage_labels[18],
                                                                                  future_value == unique_future_values_art[19]  & future_variability == "art_improvement" ~ art_coverage_labels[19],
                                                                                  future_value == unique_future_values_art[20]  & future_variability == "art_improvement" ~ art_coverage_labels[20],
                                                                                  future_value == unique_future_values_art[21]  & future_variability == "art_improvement" ~ art_coverage_labels[21],
                                                                                  future_value == unique_future_values_art[22]  & future_variability == "art_improvement" ~ art_coverage_labels[22],
                                                                                  future_value == unique_future_values_art[23]  & future_variability == "art_improvement" ~ art_coverage_labels[23],
                                                                                  future_value == unique_future_values_art[24]  & future_variability == "art_improvement" ~ art_coverage_labels[24],
                                                                                  future_value == unique_future_values_art[25]  & future_variability == "art_improvement" ~ art_coverage_labels[25],
                                                                                  future_value == unique_future_values_art[26]  & future_variability == "art_improvement" ~ art_coverage_labels[26],
                                                                                  future_value == unique_future_values_art[27]  & future_variability == "art_improvement" ~ art_coverage_labels[27],
                                                                                  future_value == unique_future_values_art[28]  & future_variability == "art_improvement" ~ art_coverage_labels[28],
                                                                                  future_value == unique_future_values_art[29]  & future_variability == "art_improvement" ~ art_coverage_labels[29],
                                                                                  future_value == unique_future_values_art[1] & future_variability == "art_deterioration" ~ art_coverage_labels[30],
                                                                                  future_value == unique_future_values_art[2]  & future_variability == "art_deterioration" ~ art_coverage_labels[31],
                                                                                  future_value == unique_future_values_art[3]  & future_variability == "art_deterioration" ~ art_coverage_labels[32],
                                                                                  future_value == unique_future_values_art[4]  & future_variability == "art_deterioration" ~ art_coverage_labels[33],
                                                                                  future_value == unique_future_values_art[5]  & future_variability == "art_deterioration" ~ art_coverage_labels[34],
                                                                                  future_value == unique_future_values_art[6]  & future_variability == "art_deterioration" ~ art_coverage_labels[35],
                                                                                  future_value == unique_future_values_art[7]  & future_variability == "art_deterioration" ~ art_coverage_labels[36],
                                                                                  future_value == unique_future_values_art[8]  & future_variability == "art_deterioration" ~ art_coverage_labels[37],
                                                                                  future_value == unique_future_values_art[9]  & future_variability == "art_deterioration" ~ art_coverage_labels[38],
                                                                                  future_value == unique_future_values_art[10]  & future_variability == "art_deterioration" ~ art_coverage_labels[39],
                                                                                  future_value == unique_future_values_art[11]  & future_variability == "art_deterioration" ~ art_coverage_labels[40],
                                                                                  future_value == unique_future_values_art[12]  & future_variability == "art_deterioration" ~ art_coverage_labels[41],
                                                                                  future_value == unique_future_values_art[13]  & future_variability == "art_deterioration" ~ art_coverage_labels[42],
                                                                                  future_value == unique_future_values_art[14]  & future_variability == "art_deterioration" ~ art_coverage_labels[43],
                                                                                  future_value == unique_future_values_art[15]  & future_variability == "art_deterioration" ~ art_coverage_labels[44],
                                                                                  future_value == unique_future_values_art[16]  & future_variability == "art_deterioration" ~ art_coverage_labels[45],
                                                                                  future_value == unique_future_values_art[17]  & future_variability == "art_deterioration" ~ art_coverage_labels[46],
                                                                                  future_value == unique_future_values_art[18]  & future_variability == "art_deterioration" ~ art_coverage_labels[47],
                                                                                  future_value == unique_future_values_art[19]  & future_variability == "art_deterioration" ~ art_coverage_labels[48],
                                                                                  future_value == unique_future_values_art[20]  & future_variability == "art_deterioration" ~ art_coverage_labels[49],
                                                                                  future_value == unique_future_values_art[21]  & future_variability == "art_deterioration" ~ art_coverage_labels[50],
                                                                                  future_value == unique_future_values_art[22]  & future_variability == "art_deterioration" ~ art_coverage_labels[51],
                                                                                  future_value == unique_future_values_art[23]  & future_variability == "art_deterioration" ~ art_coverage_labels[52],
                                                                                  future_value == unique_future_values_art[24]  & future_variability == "art_deterioration" ~ art_coverage_labels[53],
                                                                                  future_value == unique_future_values_art[25]  & future_variability == "art_deterioration" ~ art_coverage_labels[54],
                                                                                  future_value == unique_future_values_art[26]  & future_variability == "art_deterioration" ~ art_coverage_labels[55],
                                                                                  future_value == unique_future_values_art[27]  & future_variability == "art_deterioration" ~ art_coverage_labels[56],
                                                                                  future_value == unique_future_values_art[28]  & future_variability == "art_deterioration" ~ art_coverage_labels[57],
                                                                                  future_value == unique_future_values_art[29]  & future_variability == "art_deterioration" ~ art_coverage_labels[58]))

write_csv(art_change_inc_elim, "results/art_change_inc_elim.csv")
```

Cumulative: Add column for ART coverage in 2035
```{r add cols art_cumulative, echo = FALSE}
cumulative_art_change <- cumulative_art_change %>% mutate(art_coverage_2035 = case_when(future_value == unique_future_values_art[1] & future_variability == "art_improvement" ~ art_coverage_labels[1],
                                                                                  future_value == unique_future_values_art[2]  & future_variability == "art_improvement" ~ art_coverage_labels[2],
                                                                                  future_value == unique_future_values_art[3]  & future_variability == "art_improvement" ~ art_coverage_labels[3],
                                                                                  future_value == unique_future_values_art[4]  & future_variability == "art_improvement" ~ art_coverage_labels[4],
                                                                                  future_value == unique_future_values_art[5]  & future_variability == "art_improvement" ~ art_coverage_labels[5],
                                                                                  future_value == unique_future_values_art[6]  & future_variability == "art_improvement" ~ art_coverage_labels[6],
                                                                                  future_value == unique_future_values_art[7]  & future_variability == "art_improvement" ~ art_coverage_labels[7],
                                                                                  future_value == unique_future_values_art[8]  & future_variability == "art_improvement" ~ art_coverage_labels[8],
                                                                                  future_value == unique_future_values_art[9]  & future_variability == "art_improvement" ~ art_coverage_labels[9],
                                                                                  future_value == unique_future_values_art[10]  & future_variability == "art_improvement" ~ art_coverage_labels[10],
                                                                                  future_value == unique_future_values_art[11]  & future_variability == "art_improvement" ~ art_coverage_labels[11],
                                                                                  future_value == unique_future_values_art[12]  & future_variability == "art_improvement" ~ art_coverage_labels[12],
                                                                                  future_value == unique_future_values_art[13]  & future_variability == "art_improvement" ~ art_coverage_labels[13],
                                                                                  future_value == unique_future_values_art[14]  & future_variability == "art_improvement" ~ art_coverage_labels[14],
                                                                                  future_value == unique_future_values_art[15]  & future_variability == "art_improvement" ~ art_coverage_labels[15],
                                                                                  future_value == unique_future_values_art[16]  & future_variability == "art_improvement" ~ art_coverage_labels[16],
                                                                                  future_value == unique_future_values_art[17]  & future_variability == "art_improvement" ~ art_coverage_labels[17],
                                                                                  future_value == unique_future_values_art[18]  & future_variability == "art_improvement" ~ art_coverage_labels[18],
                                                                                  future_value == unique_future_values_art[19]  & future_variability == "art_improvement" ~ art_coverage_labels[19],
                                                                                  future_value == unique_future_values_art[20]  & future_variability == "art_improvement" ~ art_coverage_labels[20],
                                                                                  future_value == unique_future_values_art[21]  & future_variability == "art_improvement" ~ art_coverage_labels[21],
                                                                                  future_value == unique_future_values_art[22]  & future_variability == "art_improvement" ~ art_coverage_labels[22],
                                                                                  future_value == unique_future_values_art[23]  & future_variability == "art_improvement" ~ art_coverage_labels[23],
                                                                                  future_value == unique_future_values_art[24]  & future_variability == "art_improvement" ~ art_coverage_labels[24],
                                                                                  future_value == unique_future_values_art[25]  & future_variability == "art_improvement" ~ art_coverage_labels[25],
                                                                                  future_value == unique_future_values_art[26]  & future_variability == "art_improvement" ~ art_coverage_labels[26],
                                                                                  future_value == unique_future_values_art[27]  & future_variability == "art_improvement" ~ art_coverage_labels[27],
                                                                                  future_value == unique_future_values_art[28]  & future_variability == "art_improvement" ~ art_coverage_labels[28],
                                                                                  future_value == unique_future_values_art[29]  & future_variability == "art_improvement" ~ art_coverage_labels[29],
                                                                                  future_value == unique_future_values_art[1] & future_variability == "art_deterioration" ~ art_coverage_labels[30],
                                                                                  future_value == unique_future_values_art[2]  & future_variability == "art_deterioration" ~ art_coverage_labels[31],
                                                                                  future_value == unique_future_values_art[3]  & future_variability == "art_deterioration" ~ art_coverage_labels[32],
                                                                                  future_value == unique_future_values_art[4]  & future_variability == "art_deterioration" ~ art_coverage_labels[33],
                                                                                  future_value == unique_future_values_art[5]  & future_variability == "art_deterioration" ~ art_coverage_labels[34],
                                                                                  future_value == unique_future_values_art[6]  & future_variability == "art_deterioration" ~ art_coverage_labels[35],
                                                                                  future_value == unique_future_values_art[7]  & future_variability == "art_deterioration" ~ art_coverage_labels[36],
                                                                                  future_value == unique_future_values_art[8]  & future_variability == "art_deterioration" ~ art_coverage_labels[37],
                                                                                  future_value == unique_future_values_art[9]  & future_variability == "art_deterioration" ~ art_coverage_labels[38],
                                                                                  future_value == unique_future_values_art[10]  & future_variability == "art_deterioration" ~ art_coverage_labels[39],
                                                                                  future_value == unique_future_values_art[11]  & future_variability == "art_deterioration" ~ art_coverage_labels[40],
                                                                                  future_value == unique_future_values_art[12]  & future_variability == "art_deterioration" ~ art_coverage_labels[41],
                                                                                  future_value == unique_future_values_art[13]  & future_variability == "art_deterioration" ~ art_coverage_labels[42],
                                                                                  future_value == unique_future_values_art[14]  & future_variability == "art_deterioration" ~ art_coverage_labels[43],
                                                                                  future_value == unique_future_values_art[15]  & future_variability == "art_deterioration" ~ art_coverage_labels[44],
                                                                                  future_value == unique_future_values_art[16]  & future_variability == "art_deterioration" ~ art_coverage_labels[45],
                                                                                  future_value == unique_future_values_art[17]  & future_variability == "art_deterioration" ~ art_coverage_labels[46],
                                                                                  future_value == unique_future_values_art[18]  & future_variability == "art_deterioration" ~ art_coverage_labels[47],
                                                                                  future_value == unique_future_values_art[19]  & future_variability == "art_deterioration" ~ art_coverage_labels[48],
                                                                                  future_value == unique_future_values_art[20]  & future_variability == "art_deterioration" ~ art_coverage_labels[49],
                                                                                  future_value == unique_future_values_art[21]  & future_variability == "art_deterioration" ~ art_coverage_labels[50],
                                                                                  future_value == unique_future_values_art[22]  & future_variability == "art_deterioration" ~ art_coverage_labels[51],
                                                                                  future_value == unique_future_values_art[23]  & future_variability == "art_deterioration" ~ art_coverage_labels[52],
                                                                                  future_value == unique_future_values_art[24]  & future_variability == "art_deterioration" ~ art_coverage_labels[53],
                                                                                  future_value == unique_future_values_art[25]  & future_variability == "art_deterioration" ~ art_coverage_labels[54],
                                                                                  future_value == unique_future_values_art[26]  & future_variability == "art_deterioration" ~ art_coverage_labels[55],
                                                                                  future_value == unique_future_values_art[27]  & future_variability == "art_deterioration" ~ art_coverage_labels[56],
                                                                                  future_value == unique_future_values_art[28]  & future_variability == "art_deterioration" ~ art_coverage_labels[57],
                                                                                  future_value == unique_future_values_art[29]  & future_variability == "art_deterioration" ~ art_coverage_labels[58]))
write_csv(cumulative_art_change, "results/art_change_cumulative.csv")
```

Load combined ART change data
``` {r fig 3 data, echo = FALSE}
art_change_summary <- read_csv("results/art_change_summary.csv")
art_change_inc_elim <- read_csv("results/art_change_inc_elim.csv")
cumulative_art_change <- read_csv("results/art_change_cumulative.csv")
```

### Figure 3a
Heatmap of 2100 incidence under altered ART coverage

``` {r fig3a, echo = FALSE}

temp3a <- art_change_inc_elim %>% 
  mutate(elimination_year = as.numeric(elimination_year),
         art_coverage_2035 = as.numeric(art_coverage_2035),
         pitc_reduction_percentage = as.numeric(pitc_reduction_percentage)) %>% 
  filter(pitc_reduction_year == 2025)

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp3a, pitc_reduction_percentage == i)$art_coverage_2035
  mean_incidence_2100 <- filter(temp3a, pitc_reduction_percentage == i)$mean_incidence_2100
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = mean_incidence_2100, 
                                    n = 100)) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean_incidence_2100 = y) %>% 
    mutate(pitc_reduction_year = 2025, 
           pitc_reduction_percentage = i)
  temp3a <- bind_rows(temp3a, interpolated) 
}

temp3a <- temp3a[which(is.na(temp3a$future_value)),]

fig3a <- temp3a %>% 
  ggplot(aes(pitc_reduction_percentage, art_coverage_2035)) + 
  with_blur(
    geom_raster(aes(fill = log(1000*mean_incidence_2100)), interpolate = TRUE),
    sigma = 0
  ) +
  geom_contour(aes(z = 1000*mean_incidence_2100), color = "black", binwidth = 0.5) + 
  geom_contour(aes(z = 1000*mean_incidence_2100), color = "black", breaks = 1, linewidth = 0.80) + 
  geom_text_contour(aes(z = 1000*mean_incidence_2100),skip = 0, stroke = 0.1, stroke.colour = "white") +
  geom_hline(aes(yintercept = 0.768), lty = "dotted") +
  scale_fill_gradient2("Mean HIV \nincidence \n(15-49y) \nper 1000 \nin 2100",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red",
                       midpoint = 0,
                       labels = (function(l) {round(exp(l),2)})
  ) +
  scale_y_continuous(name ="ART coverage (%)",
                     breaks = c(0.1, 0.2, 0.3, 0.40, 0.45, 0.50, 0.55, 0.60, 0.65, 0.70, 0.75, 0.80, 0.85, 0.768, 0.90, 0.95, 1),
                     labels = c("10", "20", "30", "40", "45","50", "55", "60", "65", "70", "75", "80", "85", "", "90", "95", "100"),
                     trans = "identity") +
  xlab("Testing reduction (%)") + theme_classic() +
  annotate(geom = "text", x=10, y=0.768, label="Baseline", parse = TRUE) + 
  theme(axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 11),
        axis.title.x = element_text(size = 11),
        legend.text = element_text(size = 11))

```

### Figure 3b 
Heatmap of HIV elimination year under altered ART coverage

```{r fig3b, echo = FALSE}
# this needs to change to cumulative_art_change 
# with indicator == elimination_year
temp3b <- art_change_inc_elim %>% 
  mutate(elimination_year = as.numeric(elimination_year),
         art_coverage_2035 = as.numeric(art_coverage_2035),
         pitc_reduction_percentage = as.numeric(pitc_reduction_percentage)) %>% 
  filter(pitc_reduction_year == 2025) %>% arrange(desc(art_coverage_2035)) 

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp3b, pitc_reduction_percentage == i)$art_coverage_2035
  elimination_year <- filter(temp3b, pitc_reduction_percentage == i)$elimination_year
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = elimination_year, xout = seq(min(art_change_inc_elim$art_coverage_2035), max(art_change_inc_elim$art_coverage_2035),length.out = 100), 
                                    method = "linear", na.rm = FALSE)) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(elimination_year = y) %>% 
    mutate(pitc_reduction_year = 2025, 
           pitc_reduction_percentage = i)
  temp3b <- bind_rows(temp3b, interpolated) 
}

temp3b <- temp3b[which(is.na(temp3b$future_value)),]

fig3b <- temp3b %>% 
  mutate(elimination_year = as.numeric(elimination_year), 
         pitc_reduction_year = as.factor(pitc_reduction_year)) %>% 
  filter(pitc_reduction_year == 2025) %>% 
  ggplot(aes(x = pitc_reduction_percentage, y = art_coverage_2035, z = elimination_year)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = elimination_year), interpolate = TRUE)
  ) + 
  geom_contour(color = "black") + 
  geom_text_contour(skip = 0, stroke = 0.1, stroke.colour = "white",check_overlap = TRUE) +
  geom_hline(aes(yintercept = 0.768), lty = "dotted") +
  scale_fill_gradient2("HIV \nelimination \nyear",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 2055) +
  scale_y_continuous(name ="ART coverage (%)",
                     breaks = c(0.1, 0.2, 0.3, 0.40, 0.45, 0.50, 0.55, 0.60, 0.65, 0.70, 0.75, 0.80, 0.85, 0.768, 0.90, 0.95, 1),
                     labels = c("10", "20", "30", "40", "45","50", "55", "60", "65", "70", "75", "80", "85", "", "90", "95", "100"),
                     trans = "identity") +
  xlab("Testing reduction (%)") + 
  annotate(geom = "text", x=90, y=0.768, label="Baseline", parse = TRUE) + 
  theme_classic() + theme(axis.text = element_text(size = 11),
                          axis.title.y = element_text(size = 11),
                          axis.title.x = element_text(size = 11),
                          legend.text = element_text(size = 11))
```

### Figure 3c
Heatmap of additional HIV infections under altered ART coverage

``` {r fig3c, echo = FALSE}

temp3c <- cumulative_art_change %>% 
  filter(indicator == "NewAdultHIV", 
         scenario == "absolute_dif")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp3c, test_reduction == i)$art_coverage_2035
  mean <- filter(temp3c, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = mean, 
                                    xout =  seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 100))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2025, 
           test_reduction = i)
  temp3c <- bind_rows(temp3c, interpolated) 
}

temp3c <- temp3c[which(is.na(temp3c$future_value)),]

fig3c <- temp3c %>% 
  ggplot(aes(test_reduction, art_coverage_2035, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(color = "No additional \nHIV infections"),breaks = 0,show.legend = FALSE) + 
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, breaks = 0) +
  geom_hline(aes(yintercept = 0.768), lty = "dotted") +
  annotate(geom = "text", x=50, y=0.768, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2("Additional \nHIV \ninfections \n(millions)",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous(name ="ART coverage (%)",
                     breaks = c(0.1, 0.2, 0.3, 0.40, 0.45, 0.50, 0.55, 0.60, 0.65, 0.70, 0.75, 0.80, 0.85, 0.768, 0.90, 0.95, 1),
                     labels = c("10", "20", "30", "40", "45","50", "55", "60", "65", "70", "75", "80", "85", "", "90", "95", "100"),
                     trans = "identity") +
  xlab("Testing reduction (%)") + theme_classic() + theme(axis.text = element_text(size = 11),
                                                          axis.title.y = element_text(size = 11),
                                                          axis.title.x = element_text(size = 11),
                                                          legend.text = element_text(size = 11)) + 
  scale_color_discrete("",type = "black")

```


### Figure 3d
Heatmap of additional AIDS-related deaths under altered ART coverage

```{r fig3d, echo=FALSE}

temp3d <- cumulative_art_change %>% 
  filter(indicator == "TotalAIDSdeathsadult", 
         scenario == "absolute_dif")

for (i in seq(0, 100, 5)){
  art_coverage_2035 <- filter(temp3d, test_reduction == i)$art_coverage_2035
  mean <- filter(temp3d, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = art_coverage_2035, 
                                    y = mean, 
                                    xout = seq(min(cumulative_art_change$art_coverage_2035), max(cumulative_art_change$art_coverage_2035),length.out = 100))) %>% 
    rename(art_coverage_2035 = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2025, 
           test_reduction = i)
  temp3d <- bind_rows(temp3d, interpolated) 
}

temp3d <- temp3d[which(is.na(temp3d$future_value)),]

fig3d <- temp3d %>% 
  ggplot(aes(test_reduction, art_coverage_2035, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(color = "No additional \nAIDS-related \ndeaths"),breaks = 0,show.legend = FALSE) + 
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, breaks = 0) +
  geom_hline(aes(yintercept = 0.768), lty = "dotted") +
  annotate(geom = "text", x=50, y=0.768, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2("Additional \nAIDS \nrelated \ndeaths \n(millions)",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  scale_y_continuous(name ="ART coverage (%)",
                     breaks = c(0.1, 0.2, 0.3, 0.40, 0.45, 0.50, 0.55, 0.60, 0.65, 0.70, 0.75, 0.80, 0.85, 0.768, 0.90, 0.95, 1),
                     labels = c("10", "20", "30", "40", "45","50", "55", "60", "65", "70", "75", "80", "85", "", "90", "95", "100"),
                     trans = "identity") +
  xlab("Testing reduction (%)") + theme_classic() + theme(axis.text = element_text(size = 11),
                                                          axis.title.y = element_text(size = 11),
                                                          axis.title.x = element_text(size = 11),
                                                          legend.text = element_text(size = 11)) + 
  scale_color_discrete("",type = "black")

```

### Combined Figure 3


```{r fig3, echo = FALSE}

fig3 <- ggarrange(fig3a, fig3b, fig3c, fig3d, nrow = 2, ncol = 2, legend = "right", labels = "auto")

```


## Figure 4

Effect of altered condom usage on impact of testing reductions

laod reduction and promotion scenarios and combine

```{r condom combine scenarios, echo = FALSE}

#### read csv from cluster ####
condom_reduction_summary <- read_csv("results/condom_reduction_summary.csv")
condom_reduction_inc_elim <- read_csv("results/condom_reduction_inc_elim.csv")
unique_future_values <- unique(condom_reduction_summary$future_value)


#### calculating absolute condom usage values
overall_condom_usage_range <- condom_reduction_summary %>% filter(indicator == "CondomUsage", 
                                                                  test_reduction == 0, pitc_reduction_year == 2025,
                                                                  year == 2035, scenario == "intervention") %>% select(mean)
condom_usage_reduction_labels <- round(overall_condom_usage_range$mean,1)

condom_reduction_summary <- condom_reduction_summary %>% mutate(overall_condom_usage = case_when(future_value == unique_future_values[1] ~ condom_usage_reduction_labels[1],
                                                                                                 future_value == unique_future_values[2] ~ condom_usage_reduction_labels[2],
                                                                                                 future_value == unique_future_values[3] ~ condom_usage_reduction_labels[3],
                                                                                                 future_value == unique_future_values[4] ~ condom_usage_reduction_labels[4],
                                                                                                 future_value == unique_future_values[5] ~ condom_usage_reduction_labels[5],
                                                                                                 future_value == unique_future_values[6] ~ condom_usage_reduction_labels[6],
                                                                                                 future_value == unique_future_values[7] ~ condom_usage_reduction_labels[7],
                                                                                                 future_value == unique_future_values[8] ~ condom_usage_reduction_labels[8],
                                                                                                 future_value == unique_future_values[9] ~ condom_usage_reduction_labels[9],
                                                                                                 future_value == unique_future_values[10] ~ condom_usage_reduction_labels[10],
                                                                                                 future_value == unique_future_values[11] ~ condom_usage_reduction_labels[11],
                                                                                                 future_value == unique_future_values[12] ~ condom_usage_reduction_labels[12],
                                                                                                 future_value == unique_future_values[13] ~ condom_usage_reduction_labels[13],
                                                                                                 future_value == unique_future_values[14] ~ condom_usage_reduction_labels[14],
                                                                                                 future_value == unique_future_values[15] ~ condom_usage_reduction_labels[15],
                                                                                                 future_value == unique_future_values[16] ~ condom_usage_reduction_labels[16],
                                                                                                 future_value == unique_future_values[17] ~ condom_usage_reduction_labels[17],
                                                                                                 future_value == unique_future_values[18] ~ condom_usage_reduction_labels[18],
                                                                                                 future_value == unique_future_values[19] ~ condom_usage_reduction_labels[19],
                                                                                                 future_value == unique_future_values[20] ~ condom_usage_reduction_labels[20],
                                                                                                 future_value == unique_future_values[21] ~ condom_usage_reduction_labels[21],
                                                                                                 future_value == unique_future_values[22] ~ condom_usage_reduction_labels[22],
                                                                                                 future_value == unique_future_values[23] ~ condom_usage_reduction_labels[23],
                                                                                                 future_value == unique_future_values[24] ~ condom_usage_reduction_labels[24],
                                                                                                 future_value == unique_future_values[25] ~ condom_usage_reduction_labels[25],
                                                                                                 future_value == unique_future_values[26] ~ condom_usage_reduction_labels[26],
                                                                                                 future_value == unique_future_values[27] ~ condom_usage_reduction_labels[27],
                                                                                                 future_value == unique_future_values[28] ~ condom_usage_reduction_labels[28],
                                                                                                 future_value == unique_future_values[29] ~ condom_usage_reduction_labels[29],
                                                                                                 future_value == unique_future_values[30] ~ condom_usage_reduction_labels[30]))

condom_reduction_inc_elim <- condom_reduction_inc_elim %>% mutate(overall_condom_usage = case_when(future_value == unique_future_values[1] ~ condom_usage_reduction_labels[1],
                                                                                                   future_value == unique_future_values[2] ~ condom_usage_reduction_labels[2],
                                                                                                   future_value == unique_future_values[3] ~ condom_usage_reduction_labels[3],
                                                                                                   future_value == unique_future_values[4] ~ condom_usage_reduction_labels[4],
                                                                                                   future_value == unique_future_values[5] ~ condom_usage_reduction_labels[5],
                                                                                                   future_value == unique_future_values[6] ~ condom_usage_reduction_labels[6],
                                                                                                   future_value == unique_future_values[7] ~ condom_usage_reduction_labels[7],
                                                                                                   future_value == unique_future_values[8] ~ condom_usage_reduction_labels[8],
                                                                                                   future_value == unique_future_values[9] ~ condom_usage_reduction_labels[9],
                                                                                                   future_value == unique_future_values[10] ~ condom_usage_reduction_labels[10],
                                                                                                   future_value == unique_future_values[11] ~ condom_usage_reduction_labels[11],
                                                                                                   future_value == unique_future_values[12] ~ condom_usage_reduction_labels[12],
                                                                                                   future_value == unique_future_values[13] ~ condom_usage_reduction_labels[13],
                                                                                                   future_value == unique_future_values[14] ~ condom_usage_reduction_labels[14],
                                                                                                   future_value == unique_future_values[15] ~ condom_usage_reduction_labels[15],
                                                                                                   future_value == unique_future_values[16] ~ condom_usage_reduction_labels[16],
                                                                                                   future_value == unique_future_values[17] ~ condom_usage_reduction_labels[17],
                                                                                                   future_value == unique_future_values[18] ~ condom_usage_reduction_labels[18],
                                                                                                   future_value == unique_future_values[19] ~ condom_usage_reduction_labels[19],
                                                                                                   future_value == unique_future_values[20] ~ condom_usage_reduction_labels[20],
                                                                                                   future_value == unique_future_values[21] ~ condom_usage_reduction_labels[21],
                                                                                                   future_value == unique_future_values[22] ~ condom_usage_reduction_labels[22],
                                                                                                   future_value == unique_future_values[23] ~ condom_usage_reduction_labels[23],
                                                                                                   future_value == unique_future_values[24] ~ condom_usage_reduction_labels[24],
                                                                                                   future_value == unique_future_values[25] ~ condom_usage_reduction_labels[25],
                                                                                                   future_value == unique_future_values[26] ~ condom_usage_reduction_labels[26],
                                                                                                   future_value == unique_future_values[27] ~ condom_usage_reduction_labels[27],
                                                                                                   future_value == unique_future_values[28] ~ condom_usage_reduction_labels[28],
                                                                                                   future_value == unique_future_values[29] ~ condom_usage_reduction_labels[29],
                                                                                                   future_value == unique_future_values[30] ~ condom_usage_reduction_labels[30]))
#### condom promotion ####

#### read csv from cluster ####
condom_promotion_summary <- read_csv("results/condom_promotion_summary.csv")
condom_promotion_inc_elim <- read_csv("results/condom_promotion_inc_elim.csv")
unique_future_values <- unique(condom_promotion_summary$future_value)
overall_condom_usage_range <- condom_promotion_summary %>% filter(indicator == "CondomUsage", 
                                                                  test_reduction == 0, pitc_reduction_year == 2025,
                                                                  year == 2035, scenario == "intervention") %>% select(mean)
condom_usage_reduction_labels <- round(overall_condom_usage_range$mean,1)
condom_promotion_summary <- condom_promotion_summary %>% mutate(overall_condom_usage = case_when(future_value == unique_future_values[1] ~ condom_usage_reduction_labels[1],
                                                                                                 future_value == unique_future_values[2] ~ condom_usage_reduction_labels[2],
                                                                                                 future_value == unique_future_values[3] ~ condom_usage_reduction_labels[3],
                                                                                                 future_value == unique_future_values[4] ~ condom_usage_reduction_labels[4],
                                                                                                 future_value == unique_future_values[5] ~ condom_usage_reduction_labels[5],
                                                                                                 future_value == unique_future_values[6] ~ condom_usage_reduction_labels[6],
                                                                                                 future_value == unique_future_values[7] ~ condom_usage_reduction_labels[7],
                                                                                                 future_value == unique_future_values[8] ~ condom_usage_reduction_labels[8],
                                                                                                 future_value == unique_future_values[9] ~ condom_usage_reduction_labels[9],
                                                                                                 future_value == unique_future_values[10] ~ condom_usage_reduction_labels[10],
                                                                                                 future_value == unique_future_values[11] ~ condom_usage_reduction_labels[11],
                                                                                                 future_value == unique_future_values[12] ~ condom_usage_reduction_labels[12],
                                                                                                 future_value == unique_future_values[13] ~ condom_usage_reduction_labels[13],
                                                                                                 future_value == unique_future_values[14] ~ condom_usage_reduction_labels[14],
                                                                                                 future_value == unique_future_values[15] ~ condom_usage_reduction_labels[15],
                                                                                                 future_value == unique_future_values[16] ~ condom_usage_reduction_labels[16],
                                                                                                 future_value == unique_future_values[17] ~ condom_usage_reduction_labels[17],
                                                                                                 future_value == unique_future_values[18] ~ condom_usage_reduction_labels[18],
                                                                                                 future_value == unique_future_values[19] ~ condom_usage_reduction_labels[19],
                                                                                                 future_value == unique_future_values[20] ~ condom_usage_reduction_labels[20],
                                                                                                 future_value == unique_future_values[21] ~ condom_usage_reduction_labels[21],
                                                                                                 future_value == unique_future_values[22] ~ condom_usage_reduction_labels[22],
                                                                                                 future_value == unique_future_values[23] ~ condom_usage_reduction_labels[23],
                                                                                                 future_value == unique_future_values[24] ~ condom_usage_reduction_labels[24],
                                                                                                 future_value == unique_future_values[25] ~ condom_usage_reduction_labels[25],
                                                                                                 future_value == unique_future_values[26] ~ condom_usage_reduction_labels[26],
                                                                                                 future_value == unique_future_values[27] ~ condom_usage_reduction_labels[27],
                                                                                                 future_value == unique_future_values[28] ~ condom_usage_reduction_labels[28],
                                                                                                 future_value == unique_future_values[29] ~ condom_usage_reduction_labels[29],
                                                                                                 future_value == unique_future_values[30] ~ condom_usage_reduction_labels[30]))

condom_promotion_inc_elim <- condom_promotion_inc_elim %>% mutate(overall_condom_usage = case_when(future_value == unique_future_values[1] ~ condom_usage_reduction_labels[1],
                                                                                                   future_value == unique_future_values[2] ~ condom_usage_reduction_labels[2],
                                                                                                   future_value == unique_future_values[3] ~ condom_usage_reduction_labels[3],
                                                                                                   future_value == unique_future_values[4] ~ condom_usage_reduction_labels[4],
                                                                                                   future_value == unique_future_values[5] ~ condom_usage_reduction_labels[5],
                                                                                                   future_value == unique_future_values[6] ~ condom_usage_reduction_labels[6],
                                                                                                   future_value == unique_future_values[7] ~ condom_usage_reduction_labels[7],
                                                                                                   future_value == unique_future_values[8] ~ condom_usage_reduction_labels[8],
                                                                                                   future_value == unique_future_values[9] ~ condom_usage_reduction_labels[9],
                                                                                                   future_value == unique_future_values[10] ~ condom_usage_reduction_labels[10],
                                                                                                   future_value == unique_future_values[11] ~ condom_usage_reduction_labels[11],
                                                                                                   future_value == unique_future_values[12] ~ condom_usage_reduction_labels[12],
                                                                                                   future_value == unique_future_values[13] ~ condom_usage_reduction_labels[13],
                                                                                                   future_value == unique_future_values[14] ~ condom_usage_reduction_labels[14],
                                                                                                   future_value == unique_future_values[15] ~ condom_usage_reduction_labels[15],
                                                                                                   future_value == unique_future_values[16] ~ condom_usage_reduction_labels[16],
                                                                                                   future_value == unique_future_values[17] ~ condom_usage_reduction_labels[17],
                                                                                                   future_value == unique_future_values[18] ~ condom_usage_reduction_labels[18],
                                                                                                   future_value == unique_future_values[19] ~ condom_usage_reduction_labels[19],
                                                                                                   future_value == unique_future_values[20] ~ condom_usage_reduction_labels[20],
                                                                                                   future_value == unique_future_values[21] ~ condom_usage_reduction_labels[21],
                                                                                                   future_value == unique_future_values[22] ~ condom_usage_reduction_labels[22],
                                                                                                   future_value == unique_future_values[23] ~ condom_usage_reduction_labels[23],
                                                                                                   future_value == unique_future_values[24] ~ condom_usage_reduction_labels[24],
                                                                                                   future_value == unique_future_values[25] ~ condom_usage_reduction_labels[25],
                                                                                                   future_value == unique_future_values[26] ~ condom_usage_reduction_labels[26],
                                                                                                   future_value == unique_future_values[27] ~ condom_usage_reduction_labels[27],
                                                                                                   future_value == unique_future_values[28] ~ condom_usage_reduction_labels[28],
                                                                                                   future_value == unique_future_values[29] ~ condom_usage_reduction_labels[29],
                                                                                                   future_value == unique_future_values[30] ~ condom_usage_reduction_labels[30]))

#### condom usage reductions ####

condom_reduction_cumulative <- read_csv("results/condom_reduction_cumulative.csv")

unique_future_values <- unique(condom_reduction_summary$future_value)
overall_condom_usage_range <- condom_reduction_summary %>% filter(indicator == "CondomUsage", 
                                                                  test_reduction == 0, pitc_reduction_year == 2025,
                                                                  year == 2035, scenario == "intervention") %>% select(mean)
condom_usage_reduction_labels <- round(overall_condom_usage_range$mean,1)
condom_reduction_cumulative <- condom_reduction_cumulative %>% mutate(overall_condom_usage = case_when(future_value == unique_future_values[1] ~ condom_usage_reduction_labels[1],
                                                                                                 future_value == unique_future_values[2] ~ condom_usage_reduction_labels[2],
                                                                                                 future_value == unique_future_values[3] ~ condom_usage_reduction_labels[3],
                                                                                                 future_value == unique_future_values[4] ~ condom_usage_reduction_labels[4],
                                                                                                 future_value == unique_future_values[5] ~ condom_usage_reduction_labels[5],
                                                                                                 future_value == unique_future_values[6] ~ condom_usage_reduction_labels[6],
                                                                                                 future_value == unique_future_values[7] ~ condom_usage_reduction_labels[7],
                                                                                                 future_value == unique_future_values[8] ~ condom_usage_reduction_labels[8],
                                                                                                 future_value == unique_future_values[9] ~ condom_usage_reduction_labels[9],
                                                                                                 future_value == unique_future_values[10] ~ condom_usage_reduction_labels[10],
                                                                                                 future_value == unique_future_values[11] ~ condom_usage_reduction_labels[11],
                                                                                                 future_value == unique_future_values[12] ~ condom_usage_reduction_labels[12],
                                                                                                 future_value == unique_future_values[13] ~ condom_usage_reduction_labels[13],
                                                                                                 future_value == unique_future_values[14] ~ condom_usage_reduction_labels[14],
                                                                                                 future_value == unique_future_values[15] ~ condom_usage_reduction_labels[15],
                                                                                                 future_value == unique_future_values[16] ~ condom_usage_reduction_labels[16],
                                                                                                 future_value == unique_future_values[17] ~ condom_usage_reduction_labels[17],
                                                                                                 future_value == unique_future_values[18] ~ condom_usage_reduction_labels[18],
                                                                                                 future_value == unique_future_values[19] ~ condom_usage_reduction_labels[19],
                                                                                                 future_value == unique_future_values[20] ~ condom_usage_reduction_labels[20],
                                                                                                 future_value == unique_future_values[21] ~ condom_usage_reduction_labels[21],
                                                                                                 future_value == unique_future_values[22] ~ condom_usage_reduction_labels[22],
                                                                                                 future_value == unique_future_values[23] ~ condom_usage_reduction_labels[23],
                                                                                                 future_value == unique_future_values[24] ~ condom_usage_reduction_labels[24],
                                                                                                 future_value == unique_future_values[25] ~ condom_usage_reduction_labels[25],
                                                                                                 future_value == unique_future_values[26] ~ condom_usage_reduction_labels[26],
                                                                                                 future_value == unique_future_values[27] ~ condom_usage_reduction_labels[27],
                                                                                                 future_value == unique_future_values[28] ~ condom_usage_reduction_labels[28],
                                                                                                 future_value == unique_future_values[29] ~ condom_usage_reduction_labels[29],
                                                                                                 future_value == unique_future_values[30] ~ condom_usage_reduction_labels[30]))


condom_promotion_cumulative <- read_csv("results/condom_promotion_cumulative.csv")

unique_future_values <- unique(condom_promotion_summary$future_value)
overall_condom_usage_range <- condom_promotion_summary %>% filter(indicator == "CondomUsage", 
                                                                  test_reduction == 0, pitc_reduction_year == 2025,
                                                                  year == 2035, scenario == "intervention") %>% select(mean)


unique_future_values <- unique(condom_promotion_summary$future_value)
overall_condom_usage_range <- condom_promotion_summary %>% filter(indicator == "CondomUsage", 
                                                                  test_reduction == 0, pitc_reduction_year == 2025,
                                                                  year == 2035, scenario == "intervention") %>% select(mean)
condom_usage_promotion_labels <- round(overall_condom_usage_range$mean,1)
condom_promotion_cumulative <- condom_promotion_cumulative %>% mutate(overall_condom_usage = case_when(future_value == unique_future_values[1] ~ condom_usage_reduction_labels[1],
                                                                                                       future_value == unique_future_values[2] ~ condom_usage_reduction_labels[2],
                                                                                                       future_value == unique_future_values[3] ~ condom_usage_reduction_labels[3],
                                                                                                       future_value == unique_future_values[4] ~ condom_usage_reduction_labels[4],
                                                                                                       future_value == unique_future_values[5] ~ condom_usage_reduction_labels[5],
                                                                                                       future_value == unique_future_values[6] ~ condom_usage_reduction_labels[6],
                                                                                                       future_value == unique_future_values[7] ~ condom_usage_reduction_labels[7],
                                                                                                       future_value == unique_future_values[8] ~ condom_usage_reduction_labels[8],
                                                                                                       future_value == unique_future_values[9] ~ condom_usage_reduction_labels[9],
                                                                                                       future_value == unique_future_values[10] ~ condom_usage_reduction_labels[10],
                                                                                                       future_value == unique_future_values[11] ~ condom_usage_reduction_labels[11],
                                                                                                       future_value == unique_future_values[12] ~ condom_usage_reduction_labels[12],
                                                                                                       future_value == unique_future_values[13] ~ condom_usage_reduction_labels[13],
                                                                                                       future_value == unique_future_values[14] ~ condom_usage_reduction_labels[14],
                                                                                                       future_value == unique_future_values[15] ~ condom_usage_reduction_labels[15],
                                                                                                       future_value == unique_future_values[16] ~ condom_usage_reduction_labels[16],
                                                                                                       future_value == unique_future_values[17] ~ condom_usage_reduction_labels[17],
                                                                                                       future_value == unique_future_values[18] ~ condom_usage_reduction_labels[18],
                                                                                                       future_value == unique_future_values[19] ~ condom_usage_reduction_labels[19],
                                                                                                       future_value == unique_future_values[20] ~ condom_usage_reduction_labels[20],
                                                                                                       future_value == unique_future_values[21] ~ condom_usage_reduction_labels[21],
                                                                                                       future_value == unique_future_values[22] ~ condom_usage_reduction_labels[22],
                                                                                                       future_value == unique_future_values[23] ~ condom_usage_reduction_labels[23],
                                                                                                       future_value == unique_future_values[24] ~ condom_usage_reduction_labels[24],
                                                                                                       future_value == unique_future_values[25] ~ condom_usage_reduction_labels[25],
                                                                                                       future_value == unique_future_values[26] ~ condom_usage_reduction_labels[26],
                                                                                                       future_value == unique_future_values[27] ~ condom_usage_reduction_labels[27],
                                                                                                       future_value == unique_future_values[28] ~ condom_usage_reduction_labels[28],
                                                                                                       future_value == unique_future_values[29] ~ condom_usage_reduction_labels[29],
                                                                                                       future_value == unique_future_values[30] ~ condom_usage_reduction_labels[30]))
condom_change_cumulative <- bind_rows(condom_reduction_cumulative, condom_promotion_cumulative)

#### joining condom usage dfs ####

condom_change_summary <- bind_rows(condom_promotion_summary,
                                   condom_reduction_summary)

condom_change_inc_elim <- bind_rows(condom_promotion_inc_elim,
                                    condom_reduction_inc_elim)

condom_change_cumulative <- bind_rows(condom_promotion_cumulative, 
                                      condom_reduction_cumulative)

write_csv(condom_change_summary, "results/condom_change_summary.csv")
write_csv(condom_change_inc_elim, "results/condom_change_inc_elim.csv")
write_csv(condom_change_cumulative, "results/condom_change_cumulative.csv")

```

load combined condom data

``` {r fig4 data, echo = FALSE}
condom_change_summary <- read_csv("results/condom_change_summary.csv")
condom_change_inc_elim <- read_csv("results/condom_change_inc_elim.csv")
condom_change_cumulative <- read_csv("results/condom_change_cumulative.csv")

```


### Figure 4a

Heatmap of 2100 incidence under altered condom usage 

``` {r fig4a, echo = FALSE}

temp4a <- condom_change_inc_elim %>% 
  mutate(elimination_year = as.numeric(elimination_year),
         overall_condom_usage = as.numeric(overall_condom_usage),
         pitc_reduction_percentage = as.numeric(pitc_reduction_percentage)) %>% 
  filter(pitc_reduction_year == 2025)

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp4a, pitc_reduction_percentage == i)$overall_condom_usage
  mean_incidence_2100 <- filter(temp4a, pitc_reduction_percentage == i)$mean_incidence_2100
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean_incidence_2100, 
                                    xout = seq(min(condom_change_inc_elim$overall_condom_usage), max(condom_change_inc_elim$overall_condom_usage),length.out = 1000))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean_incidence_2100 = y) %>% 
    mutate(pitc_reduction_year = 2025, 
           pitc_reduction_percentage = i)
  
  
  temp4a <- bind_rows(temp4a, interpolated) 
}
temp4a <- temp4a[which(is.na(temp4a$future_value)),]

fig4a <- temp4a %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         pitc_reduction_percentage = as.numeric(pitc_reduction_percentage), 
         log_incidence = log(1000*mean_incidence_2100)) %>% 
  filter(!overall_condom_usage %in% condom_usage_labels) %>% 
  ggplot(aes(x = pitc_reduction_percentage, y = overall_condom_usage)) + 
  with_blur(geom_raster(aes(fill = as.numeric(log_incidence)), interpolate = TRUE),sigma=0) + 
  geom_contour(aes(z = 1000*mean_incidence_2100), color = "black", breaks = c(0.5, 1, 2, 3, 4, 5, 6, 7, 8, 9)) + 
  geom_contour(aes(z = 1000*mean_incidence_2100), color = "black", breaks = 1, linewidth = 0.80) +
  geom_text_contour(aes(z = 1000*mean_incidence_2100),skip = 0, stroke = 0.1, stroke.colour = "white",breaks = c(0.5, 1, 2, 3, 4, 5, 6, 7, 8, 9)) +
  geom_hline(aes(yintercept = 33.9), lty = "dotted")+
  scale_fill_gradient2("Mean HIV \nincidence \n(15-49y) \nper 1000 \nin 2100",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red",
                       midpoint = 0,
                       labels = (function(l) {round(exp(l),2)})
  ) +
  ylab("Overall condom usage (%)") + 
  scale_y_continuous(trans = "identity", breaks = c(10, 15, 20, 25, 30, 33, 35, 40, 45, 50, 55), labels = c("10", "15", "20","25", "30", "", 35, "40", "45", "50", "55")) +
  xlab("Testing reduction (%)") + theme_classic() +
  theme_classic() + theme(axis.text = element_text(size = 11),
                          axis.title.y = element_text(size = 11),
                          axis.title.x = element_text(size = 11),
                          legend.text = element_text(size = 11)) +
  annotate(geom = "text", x = 15, y = 33, label = "Baseline")

```

### Figure 4b

Heatmap of HIV elimination year under altered condom usage 

``` {r fig4b, echo = FALSE}

temp4b <- condom_change_cumulative %>% 
  mutate(overall_condom_usage = as.numeric(overall_condom_usage),
         test_reduction = as.numeric(test_reduction)) %>% 
  filter(pitc_reduction_year == 2025) %>% arrange(desc(overall_condom_usage)) 

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp4b, test_reduction == i)$overall_condom_usage
  elimination_year <- filter(temp4b, test_reduction == i)$elimination_year
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = elimination_year, seq(min(condom_change_inc_elim$overall_condom_usage), max(condom_change_inc_elim$overall_condom_usage),length.out = 1000), 
                                    method = "linear", na.rm = FALSE)) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(elimination_year = y) %>% 
    mutate(pitc_reduction_year = 2025, 
           test_reduction = i)
  temp4b <- bind_rows(temp4b, interpolated) 
}

temp4b <- temp4b[which(is.na(temp4b$future_value)),]

fig4b <- temp4b %>% 
  ggplot(aes(x = pitc_reduction_percentage, y = overall_condom_usage)) +
  with_blur(geom_raster(aes(fill = elimination_year), interpolate = TRUE, na.rm = TRUE), sigma = 0) +
  geom_contour(aes(z = elimination_year),color = "black") + 
  geom_text_contour(aes(z = elimination_year), skip = 0, 
                    stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, 
                    min.size = 10, label.placer = label_placer_flattest()) +
  scale_fill_gradient2("HIV \nelimination \nyear",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 2055) +
  ylab("Overall condom usage (%)") + 
  scale_y_continuous(trans = "identity", breaks = c(10, 15, 20, 25, 30, 33, 35, 40, 45, 50, 55), labels = c("10", "15", "20","25", "30", "", 35, "40", "45", "50", "55")) +
  xlab("Testing reduction (%)") +
  geom_hline(aes(yintercept = 33.9), lty = "dotted")+
  annotate(geom = "text", x=90, y=33, label="Baseline", parse = TRUE) + 
  theme_classic() + theme(axis.text = element_text(size = 11),
                          axis.title.y = element_text(size = 11),
                          axis.title.x = element_text(size = 11),
                          legend.text = element_text(size = 11))

```

### Figure 4c

Heatmap of additional HIV infections under altered condom usage 

``` {r fig4c, echo = FALSE}

temp4c <- condom_change_cumulative %>% 
  filter(indicator == "NewAdultHIV", 
         scenario == "absolute_dif")

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp4c, test_reduction == i)$overall_condom_usage
  mean <- filter(temp4c, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean, 
                                    xout = seq(min(condom_usage_labels), max(condom_usage_labels), length.out = 100))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2025, 
           test_reduction = i)
  temp4c <- bind_rows(temp4c, interpolated) 
}

temp4c <- temp4c[which(is.na(temp4c$future_value)),]

fig4c <- temp4c %>% 
ggplot(aes(test_reduction, overall_condom_usage, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(color = "No additional \nHIV infections"),breaks = 0,show.legend = FALSE) + 
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, breaks = 0) +
  geom_hline(aes(yintercept = 33), lty = "dotted") +
  annotate(geom = "text", x=50, y=33, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2("Additional \nHIV \ninfections \n(millions)",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  ylab("Overall condom usage (%)") + scale_y_continuous(trans = "identity", breaks = c(10, 15, 20, 25, 30, 33, 35, 40, 45, 50, 55), labels = c("10", "15", "20","25", "30", "", 35, "40", "45", "50", "55")) +
  xlab("Testing reduction (%)") + theme_classic() + theme(axis.text = element_text(size = 11),
                                                          axis.title.y = element_text(size = 11),
                                                          axis.title.x = element_text(size = 11),
                                                          legend.text = element_text(size = 11)) + 
  scale_color_discrete("",type = "black")

```

### Figure 4c

Heatmap of additional AIDS-related deaths under altered condom usage 

``` {r fig4c, echo = FALSE}

temp4d <- condom_change_cumulative %>% 
  filter(indicator == "TotalAIDSdeathsadult", 
         scenario == "absolute_dif")

for (i in seq(0, 100, 5)){
  overall_condom_usage <- filter(temp4d, test_reduction == i)$overall_condom_usage
  mean <- filter(temp4d, test_reduction == i)$mean
  interpolated <- data.frame(approx(x = overall_condom_usage, 
                                    y = mean, 
                                    xout = seq(min(condom_usage_labels), max(condom_usage_labels), length.out = 100))) %>% 
    rename(overall_condom_usage = x) %>% 
    rename(mean = y) %>% 
    mutate(pitc_reduction_year = 2025, 
           test_reduction = i)
  temp4d <- bind_rows(temp4d, interpolated) 
}

temp4d <- temp4d[which(is.na(temp4d$future_value)),]

fig4d <- temp4d %>% 
  ggplot(aes(test_reduction, overall_condom_usage, z = mean/10**6)) + 
  with_blur(sigma = 0,
            geom_raster(aes(fill = mean/10**6), interpolate = TRUE)) +
  geom_contour(aes(color = "No additional \nAIDS-related \ndeaths"),breaks = 0,show.legend = FALSE) + 
  geom_text_contour(stroke = 0.1, stroke.colour = "white",check_overlap = TRUE, breaks = 0) +
  geom_hline(aes(yintercept = 33), lty = "dotted") +
  annotate(geom = "text", x=50, y=33, label="Baseline", parse = TRUE) + 
  scale_fill_gradient2("Additional \nAIDS \nrelated \ndeaths \n(millions)",
                       low = "blue",
                       mid = "lightyellow",
                       high = "red", 
                       midpoint = 0) +
  ylab("Overall condom usage (%)") + scale_y_continuous(trans = "identity", breaks = c(10, 15, 20, 25, 30, 33, 35, 40, 45, 50, 55), labels = c("10", "15", "20","25", "30", "", 35, "40", "45", "50", "55")) +
  xlab("Testing reduction (%)") + theme_classic() + theme(axis.text = element_text(size = 11),
                                                          axis.title.y = element_text(size = 11),
                                                          axis.title.x = element_text(size = 11),
                                                          legend.text = element_text(size = 11)) + 
  scale_color_discrete("",type = "black")

```

### Combined Figure 4


``` {r fig4, echo = FALSE}
fig4 <- ggarrange(fig4a, fig4b, fig4c, fig4d, nrow = 2, ncol = 2, legend = "right", labels = "auto")
```

## Supplementary Figure 1
Incidence when testing is reduced at different times

``` {r supp fig 1, echo = FALSE}

suppfig1 <- test_reduction_only %>% mutate(test_reduction = as.factor(test_reduction)) %>% 
  filter(scenario == "intervention", 
         indicator == "HIVinc15to49",
         year > 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100)) %>% 
  ggplot(aes(year, mean, group = test_reduction, fill = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  geom_hline(aes(yintercept = 0.001), lty = "dotted") +
  xlab("") +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 12), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12)) +
  scale_y_continuous("HIV incidence per 1000 (15-49 years)", labels =(function(l) {round(l*1e3,1)}), breaks = c(0, 0.001, 0.002, 0.003, 0.004, 0.005, 0.006)) +
  scale_fill_discrete(labels = c("No Testing reduction", "25% Testing reduction", "50% Testing reduction", "75% Testing reduction",  "100% Testing reduction"),) + 
  scale_color_discrete(labels = c("No Testing reduction", "25% Testing reduction", "50% Testing reduction", "75% Testing reduction", "100% Testing reduction")) + 
  theme(legend.title = element_blank()) + 
  facet_wrap(vars(pitc_reduction_year),labeller = as_labeller(c(`2025` = "Testing reduced from 2025",
                                                                `2030` = "Testing reduced from 2030",
                                                                `2035` = "Testing reduced from 2035",
                                                                `2040` = "Testing reduced from 2040", 
                                                                `2045` = "Testing reduced from 2045", 
                                                                `2050` = "Testing reduced from 2050")))


```


## Supplementary Figure 2
Prevalence when testing is reduced at different times

``` {r supp fig 2, echo = FALSE}

suppfig2 <- test_reduction_only %>% mutate(test_reduction = as.factor(test_reduction)) %>% 
  filter(scenario == "intervention", 
         indicator == "Prev15to49",
         year > 2020, 
         test_reduction %in% c(0, 25, 50, 75, 100)) %>% 
  ggplot(aes(year, mean, group = test_reduction, fill = test_reduction)) +
  geom_ribbon(aes(ymin = lower_CI, ymax = upper_CI, fill = test_reduction), alpha = 0.10, show.legend = F) +
  geom_line(aes(colour = test_reduction), show.legend = T) +
  xlab("") +
  expand_limits(y=0) + theme_classic() + 
  theme(axis.text = element_text(size = 12), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12)) +
  scale_y_continuous("HIV prevalence (%) \n(15-49 years)", labels =(function(l) {round(l*1e2,1)})) +
  scale_fill_discrete(labels = c("No Testing reduction", "25% Testing reduction", "50% Testing reduction", "75% Testing reduction",  "100% Testing reduction"),) + 
  scale_color_discrete(labels = c("No Testing reduction", "25% Testing reduction", "50% Testing reduction", "75% Testing reduction", "100% Testing reduction")) + 
  theme(legend.title = element_blank()) +
  facet_wrap(vars(pitc_reduction_year),labeller = as_labeller(c(`2025` = "Testing reduced from 2025",
                                                                `2030` = "Testing reduced from 2030",
                                                                `2035` = "Testing reduced from 2035",
                                                                `2040` = "Testing reduced from 2040", 
                                                                `2045` = "Testing reduced from 2045", 
                                                                `2050` = "Testing reduced from 2050")))

```

## Supplementary Figure 2
ART coverage when testing is reduced at different times

# Results in text

Baseline incidence in 2025 & 2100
``` {r result1}
test_reduction_only %>% filter(indicator == "HIVinc15to49", 
                               year %in% c(2025,2100), 
                               scenario == "baseline", 
                               test_reduction == 0,
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(1000*mean,2), 
         lower_CI = round(1000*lower_CI,2), 
         upper_CI = round(1000*upper_CI,2)) %>% 
  select(year, mean, lower_CI, upper_CI)
```

Baseline elimination year
```{r result2}
test_reduction_cumulative %>% filter(indicator == "elimination_year", 
                               scenario == "baseline", 
                               test_reduction == 0,
                               pitc_reduction_year == 2025) %>%
  select(median, lower_CI, upper_CI)
```

Baseline HIV prevalence in 2025, 2055 and 2100
``` {r results3}
test_reduction_only %>% filter(indicator == "Prev15to49", 
                               year %in% c(2025,2055,2100), 
                               scenario == "baseline", 
                               test_reduction == 0,
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(100*mean,2), 
         lower_CI = round(100*lower_CI,2), 
         upper_CI = round(100*upper_CI,2)) %>% 
  select(year, mean, lower_CI, upper_CI)
```

Baseline total HIV test in 2025, 2055 and 2100
``` {r results4}
test_reduction_only %>% filter(indicator == "TotalHIVtests", 
                               year %in% c(2025,2055,2100), 
                               scenario == "baseline", 
                               test_reduction == 0,
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(mean/10**6,2), 
         lower_CI = round(lower_CI/10**6,2), 
         upper_CI = round(upper_CI/10**6,2)) %>% 
  select(year, mean, lower_CI, upper_CI)
```

Baseline ART coverage in 2076 (max) and 2100
``` {r results5}
test_reduction_only %>% filter(indicator == "ARTcoverageAdult", 
                               year %in% c(2076, 2100), 
                               scenario == "baseline", 
                               test_reduction%in% 0,
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(mean*100,2), 
         lower_CI = round(lower_CI*100,2), 
         upper_CI = round(upper_CI*100,2)) %>% 
  select(year, mean, lower_CI, upper_CI)
```

Testing reduced ART coverage in 2100
``` {r results6}
test_reduction_only %>% filter(indicator == "ARTcoverageAdult", 
                               year %in% c(2100), 
                               scenario == "intervention", 
                               test_reduction%in% c(25, 50, 75, 100),
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(mean*100,2), 
         lower_CI = round(lower_CI*100,2), 
         upper_CI = round(upper_CI*100,2)) %>% 
  select(test_reduction, mean, lower_CI, upper_CI)
```
Testing reduced incidence in 2100
``` {r results7}
test_reduction_only %>% filter(indicator == "HIVinc15to49", 
                               year %in% c(2100), 
                               scenario == "intervention", 
                               test_reduction%in% c(25, 50, 75, 100),
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(mean*1000,2), 
         lower_CI = round(lower_CI*1000,2), 
         upper_CI = round(upper_CI*1000,2)) %>% 
  select(test_reduction, mean, lower_CI, upper_CI)
```

HIV elimination year delay when testing reduced

``` {r results8}
test_reduction_cumulative %>% filter(indicator == "elimination_year",
                               scenario == "intervention", 
                               test_reduction%in% c(25, 50, 75, 100),
                               pitc_reduction_year == 2025) %>%
  mutate(median = round(median-2055,2)) %>% 
  select(test_reduction, median)
```

Baseline prevalence in 2025

``` {r results9}
test_reduction_only %>% filter(indicator == "Prev15to49", 
                               year %in% c(2025), 
                               scenario == "baseline", 
                               test_reduction%in% c(0),
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(mean*100,2), 
         lower_CI = round(lower_CI*100,2), 
         upper_CI = round(upper_CI*100,2)) %>% 
  select(year, mean, lower_CI, upper_CI)
```


Testing reduced prevalence in 2100
``` {r results10}
test_reduction_only %>% filter(indicator == "Prev15to49", 
                               year %in% c(2100), 
                               scenario == "intervention", 
                               test_reduction%in% c(0, 25, 50, 75, 100),
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(mean*100,2), 
         lower_CI = round(lower_CI*100,2), 
         upper_CI = round(upper_CI*100,2)) %>% 
  select(year, test_reduction, mean, lower_CI, upper_CI)
```

Baseline cumulative HIV infections (millions) over 50 years

``` {r results11}
test_reduction_cumulative %>% filter(indicator == "NewAdultHIV",
                                     scenario == "baseline",
                               test_reduction%in% c(0),
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(mean/10**6,2),
         lower_CI = round(lower_CI/10**6,2), 
         upper_CI = round(upper_CI/10**6,2)) %>% 
  select(scenario, mean, lower_CI, upper_CI)
```

Baseline cumulative deaths (millions) over 50 years

``` {r results12}
test_reduction_cumulative %>% filter(indicator == "TotalAIDSdeathsadult",
                                     scenario == "baseline",
                               test_reduction%in% c(0),
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(mean/10**6,2),
         lower_CI = round(lower_CI/10**6,2), 
         upper_CI = round(upper_CI/10**6,2)) %>% 
  select(scenario, mean, lower_CI, upper_CI)
```

Testing reduced additional HIV infections (thousands) over 50 years

``` {r results13}
test_reduction_cumulative %>% filter(indicator == "NewAdultHIV",
                                     scenario == "absolute_dif",
                               test_reduction%in% c(25, 50, 75, 100),
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(mean/10**3,0),
         lower_CI = round(lower_CI/10**3,0), 
         upper_CI = round(upper_CI/10**3,0)) %>% 
  select(test_reduction, mean, lower_CI, upper_CI)
```

Testing reduced additional AIDS deaths (thousands) over 50 years
```{r results14}
test_reduction_cumulative %>% filter(indicator == "TotalAIDSdeathsadult",
                                     scenario == "absolute_dif",
                               test_reduction%in% c(25, 50, 75, 100),
                               pitc_reduction_year == 2025) %>%
  mutate(mean = round(mean/10**3,0),
         lower_CI = round(lower_CI/10**3,0), 
         upper_CI = round(upper_CI/10**3,0)) %>% 
  select(test_reduction, mean, lower_CI, upper_CI)
```

Testing reduced by 50% in 2050 vs 2025 HIV incidence in 2100
```{r results15}
test_reduction_only %>% filter(indicator == "HIVinc15to49", 
                               year %in% c(2100), 
                               scenario == "intervention", 
                               test_reduction %in% c(50),
                               pitc_reduction_year %in% c(2025,2050)) %>%
  mutate(mean = round(mean*1000,2), 
         lower_CI = round(lower_CI*1000,2), 
         upper_CI = round(upper_CI*1000,2)) %>% 
  select(pitc_reduction_year, mean, lower_CI, upper_CI)

```

Testing reduced by 50% in 2025 & 2030 additional HIV infections
```{r results16}
additional_2025 <- test_reduction_cumulative %>% 
  filter(indicator %in% c("NewAdultHIV"),
         scenario == "absolute_dif",
         test_reduction%in% c(50),
         pitc_reduction_year %in% c(2025)) %>%
  select(indicator, pitc_reduction_year, mean, lower_CI, upper_CI)
additional_2025 %>% mutate(mean = round(mean/10**3,0),
         lower_CI = round(lower_CI/10**3,0), 
         upper_CI = round(upper_CI/10**3,0))
additional_2030 <- test_reduction_cumulative %>% 
  filter(indicator %in% c("NewAdultHIV"),
         scenario == "absolute_dif",
         test_reduction%in% c(50),
         pitc_reduction_year %in% c(2030)) %>%
  select(indicator, pitc_reduction_year, mean, lower_CI, upper_CI)
additional_2030 %>% mutate(mean = round(mean/10**3,0),
         lower_CI = round(lower_CI/10**3,0), 
         upper_CI = round(upper_CI/10**3,0))
paste0("Decreased by ", round(((additional_2025$mean - additional_2030$mean) / additional_2025$mean)*100,0), "%")
```

Testing reduced by 50% in 2025 & 2030 additional AIDS deaths
```{r results17}
additional_2025 <- test_reduction_cumulative %>% 
  filter(indicator %in% c("TotalAIDSdeathsadult"),
         scenario == "absolute_dif",
         test_reduction%in% c(50),
         pitc_reduction_year %in% c(2025)) %>%
  select(indicator, pitc_reduction_year, mean, lower_CI, upper_CI)
additional_2025 %>% mutate(mean = round(mean/10**3,0),
         lower_CI = round(lower_CI/10**3,0), 
         upper_CI = round(upper_CI/10**3,0))
additional_2030 <- test_reduction_cumulative %>% 
  filter(indicator %in% c("TotalAIDSdeathsadult"),
         scenario == "absolute_dif",
         test_reduction%in% c(50),
         pitc_reduction_year %in% c(2030)) %>%
  select(indicator, pitc_reduction_year, mean, lower_CI, upper_CI)
additional_2030 %>% mutate(mean = round(mean/10**3,0),
         lower_CI = round(lower_CI/10**3,0), 
         upper_CI = round(upper_CI/10**3,0))
paste0("Decreased by ", round(((additional_2025$mean - additional_2030$mean) / additional_2025$mean)*100,0), "%")
```

Testing reduced by 50% in 2025 & 2050 additional HIV infections
```{r results18}
additional_2025 <- test_reduction_cumulative %>% 
  filter(indicator %in% c("NewAdultHIV"),
         scenario == "absolute_dif",
         test_reduction%in% c(50),
         pitc_reduction_year %in% c(2025)) %>%
  select(indicator, pitc_reduction_year, mean, lower_CI, upper_CI)
additional_2025 %>% mutate(mean = round(mean/10**3,0),
         lower_CI = round(lower_CI/10**3,0), 
         upper_CI = round(upper_CI/10**3,0))
additional_2050 <- test_reduction_cumulative %>% 
  filter(indicator %in% c("NewAdultHIV"),
         scenario == "absolute_dif",
         test_reduction%in% c(50),
         pitc_reduction_year %in% c(2050)) %>%
  select(indicator, pitc_reduction_year, mean, lower_CI, upper_CI)
additional_2050 %>% mutate(mean = round(mean/10**3,0),
         lower_CI = round(lower_CI/10**3,0), 
         upper_CI = round(upper_CI/10**3,0))
paste0("Decreased by ", round(((additional_2025$mean - additional_2050$mean) / additional_2025$mean)*100,0), "%")
```

Testing reduced by 50% in 2025 & 2050 additional AIDS deaths
```{r results19}
additional_2025 <- test_reduction_cumulative %>% 
  filter(indicator %in% c("TotalAIDSdeathsadult"),
         scenario == "absolute_dif",
         test_reduction%in% c(50),
         pitc_reduction_year %in% c(2025)) %>%
  select(indicator, pitc_reduction_year, mean, lower_CI, upper_CI)
additional_2025 %>% mutate(mean = round(mean/10**3,0),
         lower_CI = round(lower_CI/10**3,0), 
         upper_CI = round(upper_CI/10**3,0))
additional_2050 <- test_reduction_cumulative %>% 
  filter(indicator %in% c("TotalAIDSdeathsadult"),
         scenario == "absolute_dif",
         test_reduction%in% c(50),
         pitc_reduction_year %in% c(2050)) %>%
  select(indicator, pitc_reduction_year, mean, lower_CI, upper_CI)
additional_2050 %>% mutate(mean = round(mean/10**3,0),
         lower_CI = round(lower_CI/10**3,0), 
         upper_CI = round(upper_CI/10**3,0))
paste0("Decreased by ", round(((additional_2025$mean - additional_2050$mean) / additional_2025$mean)*100,0), "%")
```

ART change lowest ART coverage in 2035

```{r results20}

min(art_coverage_range)

```

50% ART coverage with no testing reduction 2100 incidence in 2025 vs 2100

``` {r results21}
art_change_summary %>% filter(indicator == "HIVinc15to49",
                              pitc_reduction_year %in% c(2025),
                              test_reduction == 0,
                              year %in% c(2025, 2100),
                              scenario == "intervention",
                              future_variability == "art_deterioration",
                              future_value == 14
                              ) %>% 
  mutate(mean = round(mean*1000,2), 
         lower_CI = round(lower_CI*1000,2), 
         upper_CI = round(upper_CI*1000,2)) %>% 
  select(pitc_reduction_year, mean, lower_CI, upper_CI)
```

Elimination year closest to 2070 ART interruption, coverage and elimination year

``` {r results22} 

cumulative_art_change %>% filter(indicator == "elimination_year",
                              pitc_reduction_year %in% c(2025),
                              test_reduction == 0,
                              scenario == "intervention",
                              future_variability == "art_deterioration",
                              future_value == 3)
# this needs updating once final results are in 
```


ART coverage at 80% test reduction at 25%, elimination year

``` {r results23}
cumulative_art_change %>% filter(indicator == "elimination_year",
                              pitc_reduction_year %in% c(2025),
                              test_reduction == 0,
                              scenario == "intervention",
                              future_variability == "art_deterioration",
                              art_coverage_2035 > 0.79, 
                              art_coverage_2035 < 0.81)
# this needs updating once final results are in 

```


